<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta name="renderer" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <link rel="dns-prefetch" href="http://example.com">
  <title>开图的山巨人の领地</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="开图的山巨人の领地">
<meta property="og:url" content="http://example.com/page/2/index.html">
<meta property="og:site_name" content="开图的山巨人の领地">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="ght">
<meta name="twitter:card" content="summary">
  
    <link rel="alternative" href="/atom.xml" title="开图的山巨人の领地" type="application/atom+xml">
  
  
    <link rel="icon" href="/assets/other-images/avatar.jpg">
  
  <link rel="stylesheet" type="text/css" href="/./main.0cf68a.css">
  <style type="text/css">
  
    #container.show {
      background: linear-gradient(200deg,#a0cfe4,#e8c37e);
    }
  </style>
  

  

<meta name="generator" content="Hexo 5.4.2"></head>

<body>
  <div id="container" q-class="show:isCtnShow">
    <canvas id="anm-canvas" class="anm-canvas"></canvas>
    <div class="left-col" q-class="show:isShow">
      
<div class="overlay" style="background: #4d4d4d"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
<!-- 			<img src="/assets/other-images/avatar.jpg" class="js-avatar"> -->
			<img src="/assets/other-images/avatar.jpg" class="js-avatar">

		</a>
		<hgroup>
		  <h1 class="header-author"><a href="/"></a></h1>
		</hgroup>
		
		<p class="header-subtitle">开图的山巨人の领地</p>
		

		<nav class="header-menu">
			<ul>
			
				<li><a href="/">主页</a></li>
	        
			</ul>
		</nav>
		<nav class="header-smart-menu">
    		
    			
    			<a q-on="click: openSlider(e, 'innerArchive')" href="javascript:void(0)">所有文章</a>
    			
            
		</nav>
		<nav class="header-nav">
			<div class="social">
				
					<a class="github" target="_blank" href="#" title="github"><i class="icon-github"></i></a>
		        
					<a class="weibo" target="_blank" href="#" title="weibo"><i class="icon-weibo"></i></a>
		        
					<a class="rss" target="_blank" href="#" title="rss"><i class="icon-rss"></i></a>
		        
					<a class="zhihu" target="_blank" href="#" title="zhihu"><i class="icon-zhihu"></i></a>
		        
			</div>
		</nav>
	</header>
</div>

    </div>
    <div class="mid-col" q-class="show:isShow,hide:isShow|isFalse">
      
<nav id="mobile-nav">
  	<div class="overlay js-overlay" style="background: #4d4d4d"></div>
	<div class="btnctn js-mobile-btnctn">
  		<div class="slider-trigger list" q-on="click: openSlider(e)"><i class="icon icon-sort"></i></div>
	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img src="/assets/other-images/avatar.jpg" class="js-avatar">
			</div>
			<hgroup>
			  <h1 class="header-author js-header-author"></h1>
			</hgroup>
			
			<p class="header-subtitle"><i class="icon icon-quo-left"></i>开图的山巨人の领地<i class="icon icon-quo-right"></i></p>
			
			
			
				
			
			

			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="#" title="github"><i class="icon-github"></i></a>
			        
						<a class="weibo" target="_blank" href="#" title="weibo"><i class="icon-weibo"></i></a>
			        
						<a class="rss" target="_blank" href="#" title="rss"><i class="icon-rss"></i></a>
			        
						<a class="zhihu" target="_blank" href="#" title="zhihu"><i class="icon-zhihu"></i></a>
			        
				</div>
			</nav>

			<nav class="header-menu js-header-menu">
				<ul style="width: 50%">
				
				
					<li style="width: 100%"><a href="/">主页</a></li>
		        
				</ul>
			</nav>
		</header>
	</div>
	<div class="mobile-mask" style="display:none" q-show="isShow"></div>
</nav>

      <div id="wrapper" class="body-wrap">
        <div class="menu-l">
          <div class="canvas-wrap">
            <canvas data-colors="#eaeaea" data-sectionHeight="100" data-contentId="js-content" id="myCanvas1" class="anm-canvas"></canvas>
          </div>
          <div id="js-content" class="content-ll">
            
  
    <article id="post-Https" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2023/05/29/Https/">Https</a>
    </h1>
  

        
        <a href="/2023/05/29/Https/" class="archive-article-date">
  	<time datetime="2023-05-29T02:03:48.082Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2023-05-29</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="OSI七层网络结构"><a href="#OSI七层网络结构" class="headerlink" title="OSI七层网络结构"></a>OSI七层网络结构</h2><h3 id="OSI的七层协议与TCP-IP体系结构"><a href="#OSI的七层协议与TCP-IP体系结构" class="headerlink" title="OSI的七层协议与TCP/IP体系结构"></a>OSI的七层协议与TCP/IP体系结构</h3><p>如下图可见，是OSI七层协议体系与TCP/IP的体系结构，<strong>实际上，TCP/IP的体系结构是四层</strong>，如图b。但是一般在学习<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C&spm=1001.2101.3001.7020">计算机网络</a>的原理时往往会采取折中的方法，<strong>综合OSI与TCP/IP的优点</strong>，就会<strong>采用五层协议</strong>的体系结构，如图c：</p>
<p><img src="/assets/doc-images/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2Zlc2ZzZWZncw==,size_16,color_FFFFFF,t_70.png" alt="在这里插入图片描述"></p>
<p><strong>注：</strong> <em>五层协议体系结构只是为了介绍网络原理设计的，实际应用的还是TCP/IP四层体系结构。</em></p>
<h3 id="各层协议和功能"><a href="#各层协议和功能" class="headerlink" title="各层协议和功能"></a>各层协议和功能</h3><ul>
<li><p>应用层： 针对特定应用的协议，为应用程序提供服务并规定应用程序中通信相关的细节。包括文件传输、电子邮件、远程登录等协议。</p>
</li>
<li><p>表示层： 将来自下一层的数据转换为上层能够处理的格式。负责数据转换、格式化、文本压缩等。</p>
</li>
<li><p>会话层： 负责建立和断开通信连接（数据流动的逻辑通路），以及数据的分割等数据传输相关的管理。</p>
</li>
<li><p>传输层： 管理两个节点之间的数据传输。</p>
</li>
<li><p>网络层： 地址管理和路由选择。</p>
</li>
<li><p>数据链路层： 互联设备之间传送和识别帧。</p>
</li>
<li><p>物理层： 以二进制形式在在物理媒体上传输数据。</p>
<p><img src="/assets/doc-images/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2Zlc2ZzZWZncw==,size_16,color_FFFFFF,t_70-20220418111718743.png" alt="在这里插入图片描述"></p>
<p><img src="/assets/doc-images/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2Zlc2ZzZWZncw==,size_16,color_FFFFFF,t_70-20220418111732713.png" alt="在这里插入图片描述"></p>
</li>
</ul>
<p>其中WIFI是网络接口层。</p>
<h1 id="Http和Https区别"><a href="#Http和Https区别" class="headerlink" title="Http和Https区别"></a>Http和Https区别</h1><p>超文本传输协议HTTP协议被用于在Web浏览器和网站服务器之间传递信息，HTTP协议以明文方式发送内容，不提供任何方式的数据加密，如果攻击者截取了Web浏览器和网站服务器之间的传输报文，就可以直接读懂其中的信息，因此，HTTP协议不适合传输一些敏感信息，比如：信用卡号、密码等支付信息。</p>
<p>为了解决HTTP协议的这一缺陷，需要使用另一种协议：安全套接字层超文本传输协议HTTPS，为了数据传输的安全，HTTPS在HTTP的基础上加入了SSL协议，SSL依靠证书来验证服务器的身份，并为浏览器和服务器之间的通信加密。</p>
<p><strong>一、HTTP和HTTPS的基本概念</strong></p>
<p>HTTP：是互联网上应用最为广泛的一种网络协议，是一个客户端和服务器端请求和应答的标准（TCP），用于从WWW服务器传输超文本到本地浏览器的传输协议，它可以使浏览器更加高效，使网络传输减少。</p>
<p>HTTPS：是以安全为目标的HTTP通道，简单讲是HTTP的安全版，即HTTP下加入SSL层，HTTPS的安全基础是SSL，因此加密的详细内容就需要SSL。</p>
<p>HTTPS协议的主要作用可以分为两种：一种是建立一个信息安全通道，来保证数据传输的安全；另一种就是确认网站的真实性。</p>
<p><strong>二、HTTP与HTTPS有什么区别？</strong></p>
<p>HTTP协议传输的数据都是未加密的，也就是明文的，因此使用HTTP协议传输隐私信息非常不安全，为了保证这些隐私数据能加密传输，于是网景公司设计了SSL（Secure Sockets Layer）协议用于对HTTP协议传输的数据进行加密，从而就诞生了HTTPS。简单来说，HTTPS协议是由SSL+HTTP协议构建的可进行加密传输、身份认证的网络协议，要比http协议安全。</p>
<p>HTTPS和HTTP的区别主要如下：</p>
<p>1、https协议需要到ca申请证书，一般免费证书较少，因而需要一定费用。</p>
<p>2、http是超文本传输协议，信息是明文传输，https则是具有安全性的ssl加密传输协议。</p>
<p>3、http和https使用的是完全不同的连接方式，用的端口也不一样，前者是80，后者是443。</p>
<p>4、http的连接很简单，是无状态的；HTTPS协议是由SSL+HTTP协议构建的可进行加密传输、身份认证的网络协议，比http协议安全。</p>
<p><strong>三、HTTPS的工作原理</strong></p>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/6844903545272041479">过程详解</a></p>
<p>我们都知道HTTPS能够加密信息，以免敏感信息被第三方获取，所以很多银行网站或电子邮箱等等安全级别较高的服务都会采用HTTPS协议。</p>
<p><img src="/assets/doc-images/1-150H120343I41.jpg" alt="HTTP与HTTPS的区别-马海祥博客"></p>
<p>客户端在使用HTTPS方式与Web服务器通信时有以下几个步骤，如图所示。</p>
<p>（1）客户使用https的URL访问Web服务器，要求与Web服务器建立SSL连接。</p>
<p>（2）Web服务器收到客户端请求后，会将网站的证书信息（证书中包含公钥）传送一份给客户端。</p>
<p>（3）客户端的浏览器与Web服务器开始协商SSL连接的安全等级，也就是信息加密的等级。</p>
<p>（4）客户端的浏览器根据双方同意的安全等级，建立会话密钥，然后利用网站的公钥将会话密钥加密，并传送给网站。</p>
<p>（5）Web服务器利用自己的私钥解密出会话密钥。</p>
<p>（6）Web服务器利用会话密钥加密与客户端之间的通信。</p>
<p><img src="/assets/doc-images/160c5b10d3f27e00~tplv-t2oaga2asx-zoom-in-crop-mark:1304:0:0:0.awebp" alt="img"></p>
<p><img src="/assets/doc-images/2012071410212142.gif" alt="img"></p>
<p><strong>四、HTTPS的优点</strong></p>
<p>尽管HTTPS并非绝对安全，掌握根证书的机构、掌握加密算法的组织同样可以进行中间人形式的攻击，但HTTPS仍是现行架构下最安全的解决方案，主要有以下几个好处：</p>
<p>（1）使用HTTPS协议可认证用户和服务器，确保数据发送到正确的客户机和服务器；</p>
<p>（2）HTTPS协议是由SSL+HTTP协议构建的可进行加密传输、身份认证的网络协议，要比http协议安全，可防止数据在传输过程中不被窃取、改变，确保数据的完整性。</p>
<p>（3）HTTPS是现行架构下最安全的解决方案，虽然不是绝对安全，但它大幅增加了中间人攻击的成本。</p>
<p>（4）谷歌曾在2014年8月份调整搜索引擎算法，并称“比起同等HTTP网站，采用HTTPS加密的网站在搜索结果中的排名将会更高”。</p>
<p><strong>五、HTTPS的缺点</strong></p>
<p>虽然说HTTPS有很大的优势，但其相对来说，还是存在不足之处的：</p>
<p>（1）HTTPS协议握手阶段比较费时，会使页面的加载时间延长近50%，增加10%到20%的耗电；</p>
<p>（2）HTTPS连接缓存不如HTTP高效，会增加数据开销和功耗，甚至已有的安全措施也会因此而受到影响；</p>
<p>（3）SSL证书需要钱，功能越强大的证书费用越高，个人网站、小网站没有必要一般不会用。</p>
<p>（4）SSL证书通常需要绑定IP，不能在同一IP上绑定多个域名，IPv4资源不可能支撑这个消耗。</p>
<p>（5）HTTPS协议的加密范围也比较有限，在黑客攻击、拒绝服务攻击、服务器劫持等方面几乎起不到什么作用。最关键的，SSL证书的信用链体系并不安全，特别是在某些国家可以控制CA根证书的情况下，中间人攻击一样可行。</p>
<p><strong>六、http切换到HTTPS</strong></p>
<p>如果需要将网站从http切换到https到底该如何实现呢？</p>
<p>这里需要将页面中所有的链接，例如js，css，图片等等链接都由http改为https。例如：<a target="_blank" rel="noopener" href="http://www.baidu.com改为https//www.baidu.com">http://www.baidu.com改为https://www.baidu.com</a></p>
<p>BTW，这里虽然将http切换为了https，还是建议保留http。所以我们在切换的时候可以做http和https的兼容，具体实现方式是，去掉页面链接中的http头部，这样可以自动匹配http头和https头。例如：将<a target="_blank" rel="noopener" href="http://www.baidu.com改为//www.baidu.com%E3%80%82%E7%84%B6%E5%90%8E%E5%BD%93%E7%94%A8%E6%88%B7%E4%BB%8Ehttp%E7%9A%84%E5%85%A5%E5%8F%A3%E8%BF%9B%E5%85%A5%E8%AE%BF%E9%97%AE%E9%A1%B5%E9%9D%A2%E6%97%B6%EF%BC%8C%E9%A1%B5%E9%9D%A2%E5%B0%B1%E6%98%AFhttp%EF%BC%8C%E5%A6%82%E6%9E%9C%E7%94%A8%E6%88%B7%E6%98%AF%E4%BB%8Ehttps%E7%9A%84%E5%85%A5%E5%8F%A3%E8%BF%9B%E5%85%A5%E8%AE%BF%E9%97%AE%E9%A1%B5%E9%9D%A2%EF%BC%8C%E9%A1%B5%E9%9D%A2%E5%8D%B3%E4%BD%BFhttps%E7%9A%84%E3%80%82">http://www.baidu.com改为//www.baidu.com。然后当用户从http的入口进入访问页面时，页面就是http，如果用户是从https的入口进入访问页面，页面即使https的。</a></p>
<p><strong>七、 Http调用详细过程</strong></p>
<ul>
<li><p>地址解析；浏览器会根据请求地址解析出需要请求的具体域名信息；</p>
</li>
<li><p>域名解析：请求发起方需要先知道请求的服务器具体地址，所以在正式请求前需要做域名解析，先发送一个DNS请求以获取目标服务器地址；</p>
<ul>
<li>应用层会先构造出DNS的请求报文并调用下层网传输层接口将请求报文向下传递封装最后进行发送；</li>
<li>传输层收到上层传输的报文数据后，会在其基础上增加一个本层协议的请求头，DNS请求使用UDP作为传输层协议所以会加上UPD的请求头标识；</li>
<li>网络层收到上层传输数据后会在再增加一个IP的请求头再把数据向下传递；</li>
<li>数据链路层会在自身的market和目标market信息加上去再通过物理层传输出去；</li>
<li>一般是路由器进行接收，接收到请求后进行解析判断目标market是否是自己，如果不是丢弃，如果是一路向上解析到网络层判断下一个路由节点market信息是多少知道找到目标具体地址；</li>
</ul>
</li>
<li><p>请求方收到具体地址信息后应用层开始封装http报文信息；</p>
</li>
<li><p>数据一路向下封装到物理层中进行传输；</p>
</li>
</ul>
<p><img src="/assets/doc-images/5b766a58b3844740a15383ca476ce134.png" alt="在这里插入图片描述"></p>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color1">计算机基础</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2023/05/29/Https/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>

<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>




  
    <article id="post-Mybatis源码阅读(七)两级缓存" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2023/05/29/Mybatis%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB(%E4%B8%83)%E4%B8%A4%E7%BA%A7%E7%BC%93%E5%AD%98/">Mybatis源码阅读(七)两级缓存</a>
    </h1>
  

        
        <a href="/2023/05/29/Mybatis%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB(%E4%B8%83)%E4%B8%A4%E7%BA%A7%E7%BC%93%E5%AD%98/" class="archive-article-date">
  	<time datetime="2023-05-29T02:03:48.082Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2023-05-29</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Mybatis两级缓存"><a href="#Mybatis两级缓存" class="headerlink" title="Mybatis两级缓存"></a>Mybatis两级缓存</h1><p><img src="/assets/doc-images/17395c6a3f7005e4~tplv-t2oaga2asx-zoom-in-crop-mark:1304:0:0:0.awebp" alt="img"></p>
<h2 id="一级缓存"><a href="#一级缓存" class="headerlink" title="一级缓存"></a>一级缓存</h2><p> SqlSession是MyBatis对外提供的，操作数据库的唯一接口。当我们从SqlSessionFactory打开一个新的回话时，一个新的SqlSession实例将被创建。SqlSession内置了一个Executor，它是MyBatis提供的操作数据库的执行器，当我们执行数据库查询时，最终会调用<code>Executor.query()</code>方法，它在查询数据库前会先判断是否命中一级缓存，如果命中就直接返回，否则才真的发起查询操作。</p>
<p><img src="/assets/doc-images/836908ef51d04511babd2597033a1c60~tplv-k3u1fbpfcp-zoom-in-crop-mark:1304:0:0:0.awebp" alt="Mybatis的一级缓存和二级缓存，看完不再懵逼"></p>
<p>一级缓存是基于SqlSession的，当一个会话被打开时，它会同时创建一个Executor，Executor内部持有一个PerpetualCache，PerpetualCache底层使用一个HashMap容器来维护缓存结果集。HashMap中Key存储的是CacheKey，它是MyBatis提供的缓存键，因为判断是否命中缓存涉及的条件非常多，因此CacheKey使用一个List来保存条件对象，只有当所有的条件都匹配时，才能命中缓存。 </p>
<p>MyBatis的一级缓存其实还是比较鸡肋的，在多会话的场景下存在脏数据的问题，SessionA读了一遍数据，SessionB修改了该数据，SessionA再去读仍然是旧数据。不过，如果你使用Spring整合MyBatis就不用担心这个问题了。</p>
<h2 id="二级缓存"><a href="#二级缓存" class="headerlink" title="二级缓存"></a>二级缓存</h2><p>二级缓存是全局的，也就是说；多个请求可以共用一个缓存，二级缓存需要手动开启，有2种方式配置二级缓存，</p>
<ul>
<li><p>缓存会先放在一级缓存中，当sqlSession会话提交或者关闭时才会将一级缓存刷新到二级缓存中；</p>
</li>
<li><p>开启二级缓存后，用户查询时，会先去二级缓存中找，找不到在去一级缓存中找；</p>
</li>
</ul>
<p><img src="/assets/doc-images/d39ffd1edde9435f8373efa763cd935f~tplv-k3u1fbpfcp-zoom-in-crop-mark:1304:0:0:0.awebp" alt="Mybatis的一级缓存和二级缓存，看完不再懵逼"></p>
<p>单个mapper配置，主需要在需要开启二级缓存的mapper.xml文件中加入以下配置即可开启</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 开启单个mapper的二级缓存，也叫全局缓存--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">cache</span> /&gt;</span></span><br></pre></td></tr></table></figure>


      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">Mybatis</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2023/05/29/Mybatis%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB(%E4%B8%83)%E4%B8%A4%E7%BA%A7%E7%BC%93%E5%AD%98/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>

<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>




  
    <article id="post-设计模式概念和七大原则" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2023/05/28/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E6%A6%82%E5%BF%B5%E5%92%8C%E4%B8%83%E5%A4%A7%E5%8E%9F%E5%88%99/">设计模式概念和七大原则</a>
    </h1>
  

        
        <a href="/2023/05/28/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E6%A6%82%E5%BF%B5%E5%92%8C%E4%B8%83%E5%A4%A7%E5%8E%9F%E5%88%99/" class="archive-article-date">
  	<time datetime="2023-05-28T07:44:19.153Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2023-05-28</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="什么是设计模式"><a href="#什么是设计模式" class="headerlink" title="什么是设计模式"></a>什么是设计模式</h1><p>在GoF(Gang of Four)的书籍《Design Patterns - Elements of Reusable Object-Oriented Software(设计模式-可复用面向对象软件的基础)》中是这样定义设计模式的：Christopher Alexander说过：“每一个模式描述了一个在我们周围不断重复发生的问题以及该问题的解决方案的核心。这样，你就能一次又一次地使用该方案而不必做重复劳动” [AIS+77，第10页]。<br>尽管Alexander所指的是城市和建筑模式，但他的思想也同样适用于面向对象设计模式，只是在面向对象的解决方案里， 我们用对象和接口代替了墙壁和门窗。两类模式的核心都在于提供了相关问题的解决方案。一般而言，设计模式有四个基本要素：</p>
<ul>
<li>模式名称(pattern name)：一个助记名，它用一两个词来描述模式的问题、解决方案和效果。</li>
<li>问题(problem)：描述了应该在何时使用模式。</li>
<li>解决方案(solution)：描述了设计的组成成分，它们之间的相关关系以及各自的职责和协作方案。</li>
<li>效果(consequences)：描述了模式应用的效果以及使用模式应该权衡的问题。<br>设计模式的创始人很明确地指出了设计模式的基本要素，但是由于现实中浮躁、偏向过度设计等因素的干扰，开发者很多时候会重点关注第1和第3点要素(过度关注设计模式和设计模式的实现)，忽略第2和第4点要素(忽视使用设计模式的场景和目标)，导致设计出来的编码逻辑可能过于复杂或者达不到预期的效果。</li>
</ul>
<p>总的来说，设计模式(Design Pattern)是一套被反复使用、多数人知晓的、经过分类编目的、代码设计经验的总结。也就是本来并不存在所谓设计模式，用的人多了，也便成了设计模式。</p>
<h1 id="设计模式的七大原则"><a href="#设计模式的七大原则" class="headerlink" title="设计模式的七大原则"></a>设计模式的七大原则</h1><p>面向对象的设计模式有七大基本原则：</p>
<ul>
<li>开闭原则（Open Closed Principle，OCP）</li>
<li>单一职责原则（Single Responsibility Principle, SRP）</li>
<li>里氏代换原则（Liskov Substitution Principle，LSP）</li>
<li>依赖倒转原则（Dependency Inversion Principle，DIP）</li>
<li>接口隔离原则（Interface Segregation Principle，ISP）</li>
<li>合成/聚合复用原则（Composite/Aggregate Reuse Principle，CARP）</li>
<li>最少知识原则（Least Knowledge Principle，LKP）或者迪米特法则（Law of  Demeter，LOD）</li>
</ul>
<table>
<thead>
<tr>
<th align="left">标记</th>
<th align="left">设计模式原则名称</th>
<th align="left">简单定义</th>
</tr>
</thead>
<tbody><tr>
<td align="left">OCP</td>
<td align="left">开闭原则</td>
<td align="left">对扩展开放，对修改关闭</td>
</tr>
<tr>
<td align="left">SRP</td>
<td align="left">单一职责原则</td>
<td align="left">一个类只负责一个功能领域中的相应职责</td>
</tr>
<tr>
<td align="left">LSP</td>
<td align="left">里氏代换原则</td>
<td align="left">所有引用基类的地方必须能透明地使用其子类的对象</td>
</tr>
<tr>
<td align="left">DIP</td>
<td align="left">依赖倒转原则</td>
<td align="left">依赖于抽象，不能依赖于具体实现</td>
</tr>
<tr>
<td align="left">ISP</td>
<td align="left">接口隔离原则</td>
<td align="left">类之间的依赖关系应该建立在最小的接口上</td>
</tr>
<tr>
<td align="left">CARP</td>
<td align="left">合成/聚合复用原则</td>
<td align="left">尽量使用合成/聚合，而不是通过继承达到复用的目的</td>
</tr>
<tr>
<td align="left">LOD</td>
<td align="left">迪米特法则</td>
<td align="left">一个软件实体应当尽可能少的与其他实体发生相互作用</td>
</tr>
</tbody></table>
<p>其中，单一职责原则、开闭原则、迪米特法则、里氏代换原则和接口隔离原则就是我们平常熟知的SOLID。</p>
<p>这个表格看起来有点抽象，下面逐条分析。</p>
<h2 id="开闭原则"><a href="#开闭原则" class="headerlink" title="开闭原则"></a>开闭原则</h2><h3 id="开闭原则（Open-Closed-Principle，OCP）的定义是："><a href="#开闭原则（Open-Closed-Principle，OCP）的定义是：" class="headerlink" title="开闭原则（Open Closed Principle，OCP）的定义是："></a>开闭原则（Open Closed Principle，OCP）的定义是：</h3><p>一个软件实体如类、模块和函数应该对扩展开放，对修改关闭。模块应尽量在不修改原（是”原”，指原来的代码）代码的情况下进行扩展。</p>
<h3 id="开闭原则的意义"><a href="#开闭原则的意义" class="headerlink" title="开闭原则的意义"></a>开闭原则的意义</h3><p>在软件的生命周期内，因为变化、升级和维护等原因需要对软件原有代码进行修改时，可能会给旧代码中引入错误，也可能会使我们不得不对整个功能进行重构，并且需要原有代码经过重新测试。当软件需要变化时，尽量通过扩展软件实体的行为来实现变化，而不是通过修改已有的代码来实现变化。</p>
<h3 id="如何实现对扩展开放，对修改关闭"><a href="#如何实现对扩展开放，对修改关闭" class="headerlink" title="如何实现对扩展开放，对修改关闭"></a>如何实现对扩展开放，对修改关闭</h3><p>要实现对扩展开放，对修改关闭，即遵循开闭原则，需要对系统进行抽象化设计，抽象可以基于抽象类或者接口。一般来说需要做到几点：</p>
<p>通过接口或者抽象类约束扩展，对扩展进行边界限定，不允许出现在接口或抽象类中不存在的public方法，也就是扩展必须添加具体实现而不是改变具体的方法。<br>参数类型、引用对象尽量使用接口或者抽象类，而不是实现类，这样就能尽量保证抽象层是稳定的。<br>一般抽象模块设计完成(例如接口的方法已经敲定)，不允许修改接口或者抽象方法的定义。<br>下面通过一个例子遵循开闭原则进行设计，场景是这样：某系统的后台需要监测业务数据展示图表，如柱状图、折线图等，在未来需要支持图表的着色操作。在开始设计的时候，代码可能是这样的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BarChart</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">draw</span><span class="params">()</span>&#123;</span><br><span class="line">		System.out.println(<span class="string">&quot;Draw bar chart...&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LineChart</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">draw</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Draw line chart...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">App</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">drawChart</span><span class="params">(String type)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (type.equalsIgnoreCase(<span class="string">&quot;line&quot;</span>))&#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">LineChart</span>().draw();</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span> (type.equalsIgnoreCase(<span class="string">&quot;bar&quot;</span>))&#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">BarChart</span>().draw();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样做在初期是能满足业务需要的，开发效率也十分高，但是当后面需要新增一个饼状图的时候，既要添加一个饼状图的类，原来的客户端App类的drawChart()方法也要新增一个else if分支，这样做就是修改了原有客户端类库的方法，是十分不合理的。如果这个时候，在图中加入一个颜色属性，复杂性也大大提高。基于此，需要引入一个抽象Chart类AbstractChart，App类在画图的时候总是把相关的操作委托到具体的AbstractChart的派生类实例，这样的话App类的代码就不用修改：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AbstractChart</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">draw</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BarChart</span> <span class="keyword">extends</span> <span class="title class_">AbstractChart</span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">draw</span><span class="params">()</span> &#123;</span><br><span class="line">		System.out.println(<span class="string">&quot;Draw bar chart...&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LineChart</span> <span class="keyword">extends</span> <span class="title class_">AbstractChart</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">draw</span><span class="params">()</span> &#123;</span><br><span class="line">		System.out.println(<span class="string">&quot;Draw line chart...&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">App</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">drawChart</span><span class="params">(AbstractChart chart)</span>&#123;</span><br><span class="line">		chart.draw();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果新加一种图，只需要新增一个AbstractChart的子类即可。客户端类App不需要改变原来的逻辑。修改后的设计符合开闭原则，因为整个系统在扩展时原有的代码没有做任何修改。</p>
<h2 id="单一职责原则"><a href="#单一职责原则" class="headerlink" title="单一职责原则"></a>单一职责原则</h2><h3 id="单一职责原则（Single-Responsibility-Principle-SRP）的定义是："><a href="#单一职责原则（Single-Responsibility-Principle-SRP）的定义是：" class="headerlink" title="单一职责原则（Single Responsibility Principle, SRP）的定义是："></a>单一职责原则（Single Responsibility Principle, SRP）的定义是：</h3><p>指一个类或者模块应该有且只有一个改变的原因。如果一个类承担的职责过多，就等于把这些职责耦合在一起了。一个职责的变化可能会削弱或者抑制这个类完成其他职责的能力。这种耦合会导致脆弱的设计，当发生变化时，设计会遭受到意想不到的破坏。而如果想要避免这种现象的发生，就要尽可能的遵守单一职责原则。此原则的核心就是解耦和增强内聚性。</p>
<h3 id="单一职责原则的意义"><a href="#单一职责原则的意义" class="headerlink" title="单一职责原则的意义"></a>单一职责原则的意义</h3><p>单一职责原则告诉我们：一个类不能做太多的东西。在软件系统中，一个类(一个模块、或者一个方法)承担的职责越多，那么其被复用的可能性就会越低。一个很典型的例子就是万能类。其实可以说一句大实话：任何一个常规的MVC项目，在极端的情况下，可以用一个类(甚至一个方法)完成所有的功能。但是这样做就会严重耦合，甚至牵一发动全身。一个类承(一个模块、或者一个方法)担的职责过多，就相当于将这些职责耦合在一起，当其中一个职责变化时，可能会影响其他职责的运作，因此要将这些职责进行分离，将不同的职责封装在不同的类中，即将不同的变化原因封装在不同的类中，如果多个职责总是同时发生改变则可将它们封装在同一类中。</p>
<p>不过说实话，其实有的时候很难去衡量一个类的职责，主要是很难确定职责的粒度。这一点不仅仅体现在一个类或者一个模块中，也体现在采用微服务的分布式系统中。这也就是为什么我们在实施微服务拆分的时候经常会撕逼：”这个功能不应该发在A服务中，它不做这个领域的东西，应该放在B服务中”诸如此类的争论。存在争论是合理的，不过最好不要不了了之，而应该按照领域定义好每个服务的职责(职责的粒度最好找业务和架构专家咨询)，得出相对合理的职责分配。</p>
<p>下面通过一个很简单的实例说明一下单一职责原则：</p>
<p>在一个项目系统代码编写的时候，由于历史原因和人为的不规范，导致项目没有分层，一个Service类的伪代码是这样的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Service</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> UserDTO <span class="title function_">findUser</span><span class="params">(String name)</span>&#123;</span><br><span class="line">		<span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> getConnection();</span><br><span class="line">		<span class="type">PreparedStatement</span> <span class="variable">preparedStatement</span> <span class="operator">=</span> connection.prepareStatement(<span class="string">&quot;SELECT * FROM t_user WHERE name = ?&quot;</span>);</span><br><span class="line">		preparedStatement.setObject(<span class="number">1</span>, name);</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="comment">//处理结果</span></span><br><span class="line">        <span class="type">UserDTO</span> <span class="variable">dto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserDTO</span>();</span><br><span class="line">        <span class="comment">//entity值拷贝到dto</span></span><br><span class="line">        <span class="keyword">return</span> dto;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里出现一个问题，Service做了太多东西，包括数据库连接的管理，Sql的执行这些业务层不应该接触到的逻辑，更可怕的是，例如到时候如果数据库换成了Oracle，这个方法将会大改。因此，拆分出新的DataBaseUtils类用于专门管理数据库资源，Dao类用于专门执行查询和查询结果封装，改造后Service类的伪代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Service</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Dao dao;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> UserDTO <span class="title function_">findUser</span><span class="params">(String name)</span>&#123;</span><br><span class="line">       <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span>  dao.findUserByName(name);</span><br><span class="line">       <span class="type">UserDTO</span> <span class="variable">dto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserDTO</span>();</span><br><span class="line">        <span class="comment">//entity值拷贝到dto</span></span><br><span class="line">       <span class="keyword">return</span> dto;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Dao</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">findUserByName</span><span class="params">(String name)</span>&#123;</span><br><span class="line">       <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> DataBaseUtils.getConnnection();</span><br><span class="line">       <span class="type">PreparedStatement</span> <span class="variable">preparedStatement</span> <span class="operator">=</span> connection.prepareStatement(<span class="string">&quot;SELECT * FROM t_user WHERE name = ?&quot;</span>);</span><br><span class="line">		preparedStatement.setObject(<span class="number">1</span>, name);</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="comment">//处理结果</span></span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在，如果有查询封装的变动只需要修改Dao类，数据库相关变动只需要修改DataBaseUtils类，每个类的职责分明。这个时候，如果我们要把底层的存储结构缓成Redis或者MongoDB怎么办，这样显然要重建整个Dao类，这种情况下，需要进行接口隔离，下面分析接口隔离原则的时候再详细分析。</p>
<h2 id="里氏代换原则"><a href="#里氏代换原则" class="headerlink" title="里氏代换原则"></a>里氏代换原则</h2><h3 id="里氏代换原则（Liskov-Substitution-Principle，LSP）的定义是："><a href="#里氏代换原则（Liskov-Substitution-Principle，LSP）的定义是：" class="headerlink" title="里氏代换原则（Liskov Substitution Principle，LSP）的定义是："></a>里氏代换原则（Liskov Substitution Principle，LSP）的定义是：</h3><p>所有引用基类的地方必须能透明地使用其子类的对象，也可以简单理解为任何基类可以出现的地方，子类一定可以出现。</p>
<h3 id="里氏代换原则的意义"><a href="#里氏代换原则的意义" class="headerlink" title="里氏代换原则的意义"></a>里氏代换原则的意义</h3><p>只有当衍生类可以替换掉基类，软件单位的功能不受到影响时，基类才能真正被复用，而衍生类也能够在基类的基础上增加新的行为。里氏代换原则是对”开-闭”原则的补充。实现”开-闭”原则的关键步骤就是抽象化。而基类与子类的继承关系就是抽象化的具体实现，所以里氏代换原则是对实现抽象化的具体步骤的规范。当然，如果反过来，软件单位使用的是一个子类对象的话，那么它不一定能够使用基类对象。举个很简单的例子说明这个问题：如果一个方法接收Map类型参数，那么它一定可以接收Map的子类参数例如HashMap、LinkedHashMap、ConcurrentHashMap类型的参数；但是反过来，如果另一个方法只接收HashMap类型的参数，那么它一定不能接收所有Map类型的参数，否则它可以接收LinkedHashMap、ConcurrentHashMap类型的参数。</p>
<h3 id="子类为什么可以替换基类的位置"><a href="#子类为什么可以替换基类的位置" class="headerlink" title="子类为什么可以替换基类的位置"></a>子类为什么可以替换基类的位置</h3><p>其实原因很简单，只要存在继承关系，基类的所有非私有属性或者方法，子类都可以通过继承获得(白箱复用)，反过来不成立，因为子类很有可能扩充自身的非私有属性或者方法，这个时候不能用基类获取子类新增的这些属性或者方法。</p>
<p>里氏代换原则是实现开闭原则的基础，它告诉我们在设计程序的时候进可能使用基类进行对象的定义和引用，在运行时再决定基类的具体子类型。</p>
<p>举个简单的例子，假设一种会呼吸的动物作为父类，子类猪和鸟也有自身的呼吸方式：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">Animal</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">breathe</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Bird</span> <span class="keyword">extends</span> <span class="title class_">Animal</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">breathe</span><span class="params">()</span> &#123;</span><br><span class="line">		System.out.println(<span class="string">&quot;Bird breathes...&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Pig</span> <span class="keyword">extends</span> <span class="title class_">Animal</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">breathe</span><span class="params">()</span> &#123;</span><br><span class="line">		System.out.println(<span class="string">&quot;Pig breathes...&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">App</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		<span class="type">Animal</span> <span class="variable">bird</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Bird</span>();</span><br><span class="line">		bird.breathe();</span><br><span class="line">		<span class="type">Animal</span> <span class="variable">pig</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Pig</span>();</span><br><span class="line">		pig.breathe();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="依赖倒转原则"><a href="#依赖倒转原则" class="headerlink" title="依赖倒转原则"></a>依赖倒转原则</h2><h3 id="依赖倒转原则（Dependency-Inversion-Principle，DIP）的定义："><a href="#依赖倒转原则（Dependency-Inversion-Principle，DIP）的定义：" class="headerlink" title="依赖倒转原则（Dependency Inversion Principle，DIP）的定义："></a>依赖倒转原则（Dependency Inversion Principle，DIP）的定义：</h3><p>程序要依赖于抽象接口，不要依赖于具体实现。简单的说就是要求对抽象进行编程，不要对实现进行编程，这样就降低了客户与实现模块间的耦合。</p>
<h3 id="依赖倒转原则的意义"><a href="#依赖倒转原则的意义" class="headerlink" title="依赖倒转原则的意义"></a>依赖倒转原则的意义</h3><p>依赖倒转原则要求我们在程序代码中传递参数时或在关联关系中，尽量引用层次高的抽象层类，即使用接口和抽象类进行变量类型声明、参数类型声明、方法返回类型声明，以及数据类型的转换等，而不要用具体类来做这些事情。为了确保该原则的应用，一个具体类应当只实现接口或抽象类中声明过的方法，而不要给出多余的方法，否则将无法调用到在子类中增加的新方法。在引入抽象层后，系统将具有很好的灵活性，在程序中尽量使用抽象层进行编程，而将具体类写在配置文件中，这样一来，如果系统行为发生变化，只需要对抽象层进行扩展，并修改配置文件，而无须修改原有系统的源代码，在不修改的情况下来扩展系统的功能，满足开闭原则的要求。</p>
<h3 id="依赖倒转原则的注意事项"><a href="#依赖倒转原则的注意事项" class="headerlink" title="依赖倒转原则的注意事项"></a>依赖倒转原则的注意事项</h3><p>高层模块不应该依赖低层模块，高层模块和低层模块都应该依赖于抽象。<br>抽象不应该依赖于具体，具体应该依赖于抽象。<br>在实现依赖倒转原则时，我们需要针对抽象层编程，而将具体类的对象通过依赖注入(DependencyInjection, DI)的方式注入到其他对象中，依赖注入是指当一个对象要与其他对象发生依赖关系时，通过抽象来注入所依赖的对象。常用的注入方式有三种，分别是：构造注入，设值注入（Setter注入）和接口注入。Spring的IOC是此实现的典范。</p>
<p>从Java角度看待依赖倒转原则的本质就是：面向接口(抽象)编程。</p>
<ul>
<li>每个具体的类都应该有其接口或者基类，或者两者都具备。</li>
<li>类中的引用对象应该是接口或者基类。</li>
<li>任何具体类都不应该派生出子类。</li>
<li>尽量不要覆写基类中的方法。</li>
<li>结合里氏代换原则使用。<br>遵循依赖倒转原则的一个例子，场景是司机开车：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Driver</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">void</span> <span class="title function_">drive</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">void</span> <span class="title function_">setCar</span><span class="params">(Car car)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Car</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DefaultDriver</span> <span class="keyword">implements</span> <span class="title class_">Driver</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Car car;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">drive</span><span class="params">()</span> &#123;</span><br><span class="line">		car.run();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCar</span><span class="params">(Car car)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.car = car;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Bmw</span> <span class="keyword">implements</span> <span class="title class_">Car</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">		System.out.println(<span class="string">&quot;Bmw runs...&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Benz</span> <span class="keyword">implements</span> <span class="title class_">Car</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">		System.out.println(<span class="string">&quot;Benz runs...&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">App</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		<span class="type">Driver</span> <span class="variable">driver</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultDriver</span>();</span><br><span class="line">		<span class="type">Car</span> <span class="variable">car</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Benz</span>();</span><br><span class="line">		driver.setCar(car);</span><br><span class="line">		driver.drive();</span><br><span class="line">		car = <span class="keyword">new</span> <span class="title class_">Bmw</span>();</span><br><span class="line">		driver.setCar(car);</span><br><span class="line">		driver.drive();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样实现了一个司机可以开各种类型的车，如果还有其他类型的车，只需要新加一个Car的实现即可。</p>
<h2 id="接口隔离原则"><a href="#接口隔离原则" class="headerlink" title="接口隔离原则"></a>接口隔离原则</h2><h3 id="接口隔离原则（Interface-Segregation-Principle，ISP）的定义："><a href="#接口隔离原则（Interface-Segregation-Principle，ISP）的定义：" class="headerlink" title="接口隔离原则（Interface Segregation Principle，ISP）的定义："></a>接口隔离原则（Interface Segregation Principle，ISP）的定义：</h3><p>是客户端不应该依赖它不需要的接口，类间的依赖关系应该建立在最小的接口上。简单来说就是建立单一的接口，不要建立臃肿庞大的接口。也就是接口尽量细化，同时接口中的方法尽量少。</p>
<h3 id="如何看待接口隔离原则和单一职责原则"><a href="#如何看待接口隔离原则和单一职责原则" class="headerlink" title="如何看待接口隔离原则和单一职责原则"></a>如何看待接口隔离原则和单一职责原则</h3><p>单一职责原则注重的是类和接口的职责单一，这里职责是从业务逻辑上划分的，但是在接口隔离原则要求当一个接口太大时，我们需要将它分割成一些更细小的接口，使用该接口的客户端仅需知道与之相关的方法即可。也就是说，我们在设计接口的时候有可能满足单一职责原则但是不满足接口隔离原则。</p>
<h3 id="接口隔离原则的规范"><a href="#接口隔离原则的规范" class="headerlink" title="接口隔离原则的规范"></a>接口隔离原则的规范</h3><ul>
<li>使用接口隔离原则前首先需要满足单一职责原则。</li>
<li>接口需要高内聚，也就是提高接口、类、模块的处理能力，少对外发布public的方法。</li>
<li>定制服务，只提供访问者需要的方法。</li>
<li>接口设计是有限度的，接口的设计粒度越小，系统越灵活，但是值得注意不能过小，否则变成”字节码编程”。<br>如果有用过spring-data-redis的人就知道，RedisTemplate中持有一些列的基类，分别是ValueOperations(处理K-V)、ListOperations(处理Hash)、SetOperations(处理集合)等等。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ValueOperations</span>&lt;K, V&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">set</span><span class="params">(K key, V value)</span>;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">set</span><span class="params">(K key, V value, <span class="type">long</span> timeout, TimeUnit unit)</span>;</span><br><span class="line">    <span class="comment">//....</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="合成-聚合复用原则"><a href="#合成-聚合复用原则" class="headerlink" title="合成/聚合复用原则"></a>合成/聚合复用原则</h2><h3 id="合成-聚合复用原则（Composite-Aggregate-Reuse-Principle，CARP）一般也叫合成复用原则-Composite-Reuse-Principle-CRP-，定义是："><a href="#合成-聚合复用原则（Composite-Aggregate-Reuse-Principle，CARP）一般也叫合成复用原则-Composite-Reuse-Principle-CRP-，定义是：" class="headerlink" title="合成/聚合复用原则（Composite/Aggregate Reuse Principle，CARP）一般也叫合成复用原则(Composite Reuse Principle, CRP)，定义是："></a>合成/聚合复用原则（Composite/Aggregate Reuse Principle，CARP）一般也叫合成复用原则(Composite Reuse Principle, CRP)，定义是：</h3><p>尽量使用合成/聚合，而不是通过继承达到复用的目的。</p>
<p>合成/聚合复用原则就是在一个新的对象里面使用一些已有的对象，使之成为新对象的一部分；新的对象通过向内部持有的这些对象的委派达到复用已有功能的目的，而不是通过继承来获得已有的功能。</p>
<h3 id="聚合-Aggregate-的概念"><a href="#聚合-Aggregate-的概念" class="headerlink" title="聚合(Aggregate)的概念"></a>聚合(Aggregate)的概念</h3><p>聚合表示一种弱的”拥有”关系，一般表现为松散的整体和部分的关系，其实，所谓整体和部分也可以是完全不相关的。例如A对象持有B对象，B对象并不是A对象的一部分，也就是B对象的生命周期是B对象自身管理，和A对象不相关。</p>
<h3 id="合成-Composite-的概念"><a href="#合成-Composite-的概念" class="headerlink" title="合成(Composite)的概念"></a>合成(Composite)的概念</h3><p>合成表示一种强的”拥有”关系，一般表现为严格的整体和部分的关系，部分和整体的生命周期是一样的。</p>
<h3 id="聚合和合成的关系"><a href="#聚合和合成的关系" class="headerlink" title="聚合和合成的关系"></a>聚合和合成的关系</h3><p>这里用山羊举例说明聚合和合成的关系：<br><a href="/assets/doc-images/design_pattern.png">聚合和合成关系</a></p>
<h3 id="为什么要用合成-聚合来替代继承达到复用的目的"><a href="#为什么要用合成-聚合来替代继承达到复用的目的" class="headerlink" title="为什么要用合成/聚合来替代继承达到复用的目的"></a>为什么要用合成/聚合来替代继承达到复用的目的</h3><p>继承复用破坏包装，因为继承将基类的实现细节暴露给派生类，基类的内部细节通常对子类来说是可见的，这种复用也称为”白箱复用”。这里有一个明显的问题是：派生类继承自基类，如果基类的实现发生改变，将会影响到所有派生类的实现；如果从基类继承而来的实现是静态的，不可能在运行时发生改变，不够灵活。</p>
<p>由于合成或聚合关系可以将已有的对象，一般叫成员对象，纳入到新对象中，使之成为新对象的一部分，因此新对象可以调用已有对象的功能，这样做可以使得成员对象的内部实现细节对于新对象不可见，所以这种复用又称为”黑箱”复用，相对继承关系而言，其耦合度相对较低，成员对象的变化对新对象的影响不大，可以在新对象中根据实际需要有选择性地调用成员对象的操作；合成/聚合复用可以在运行时动态进行，新对象可以动态地引用与成员对象类型相同的其他对象。</p>
<p>如果有阅读过《Effective Java 2nd》的同学就知道，此书也建议慎用继承。一般情况下，只有明确知道派生类和基类满IS A的时候才选用继承，当满足HAS A或者不能判断的情况下应该选用合成/聚合。</p>
<p>下面举个很极端的例子说明一下如果在非IS A的情况下使用继承会出现什么问题：</p>
<p>先定义一个抽象手，手有一个摇摆的方法，然后定义左右手继承抽象手，实现摇摆方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AbstractHand</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">swing</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LeftHand</span> <span class="keyword">extends</span> <span class="title class_">AbstractHand</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">swing</span><span class="params">()</span> &#123;</span><br><span class="line">		System.out.println(<span class="string">&quot;Left hand swings...&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RightHand</span> <span class="keyword">extends</span> <span class="title class_">AbstractHand</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">swing</span><span class="params">()</span> &#123;</span><br><span class="line">		System.out.println(<span class="string">&quot;Right hand swings...&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在看起来没有任何问题，实现也十分正确，现在出现了人(Person)这个类，具备摇左右手的功能，如果不考虑IS A的关系，很有可能有人会这样做：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AbstractSwingHand</span> <span class="keyword">extends</span> <span class="title class_">AbstractHand</span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">swing</span><span class="params">()</span> &#123;</span><br><span class="line">		System.out.println(<span class="string">&quot; hand swings...&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> <span class="keyword">extends</span> <span class="title class_">AbstractSwingHand</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">swingLeftHand</span><span class="params">()</span>&#123;</span><br><span class="line">		System.out.print(<span class="string">&quot;Left &quot;</span>);</span><br><span class="line">		<span class="built_in">super</span>.swing();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">swingRightHand</span><span class="params">()</span>&#123;</span><br><span class="line">		System.out.print(<span class="string">&quot;Right &quot;</span>);</span><br><span class="line">		<span class="built_in">super</span>.swing();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面Person的实现让人觉得百思不得其解，但是往往这会出现在真实的环境中，因为Hand不是Person，所以Person继承Hand一定会出现曲线实现等奇葩逻辑。Hand和Person是严格的部分和整体的关系，或者说Person和Hand是HAS A的关系，如果使用合成，逻辑将会十分清晰：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span>  &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> AbstractHand leftHand;</span><br><span class="line">	<span class="keyword">private</span> AbstractHand rightHand;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_">Person</span><span class="params">()</span> &#123;</span><br><span class="line">		leftHand = <span class="keyword">new</span> <span class="title class_">LeftHand</span>();</span><br><span class="line">		rightHand = <span class="keyword">new</span> <span class="title class_">RightHand</span>();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">swingLeftHand</span><span class="params">()</span>&#123;</span><br><span class="line">		leftHand.swing();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">swingRightHand</span><span class="params">()</span>&#123;</span><br><span class="line">		rightHand.swing();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里使用了合成，说明了Person和AbstractHand实例的生命周期是一致的。</p>
<h2 id="迪米特法则"><a href="#迪米特法则" class="headerlink" title="迪米特法则"></a>迪米特法则</h2><h3 id="迪米特法则（Law-of-Demeter，LOD），有时候也叫做最少知识原则（Least-Knowledge-Principle，LKP），它的定义是："><a href="#迪米特法则（Law-of-Demeter，LOD），有时候也叫做最少知识原则（Least-Knowledge-Principle，LKP），它的定义是：" class="headerlink" title="迪米特法则（Law of Demeter，LOD），有时候也叫做最少知识原则（Least Knowledge Principle，LKP），它的定义是："></a>迪米特法则（Law of Demeter，LOD），有时候也叫做最少知识原则（Least Knowledge Principle，LKP），它的定义是：</h3><p>一个软件实体应当尽可能少地与其他实体发生相互作用。每一个软件单位对其他的单位都只有最少的知识，而且局限于那些与本单位密切相关的软件单位。迪米特法则的初衷在于降低类之间的耦合。由于每个类尽量减少对其他类的依赖，因此，很容易使得系统的功能模块功能独立，相互之间不存在（或很少有）依赖关系。迪米特法则不希望类之间建立直接的联系。如果真的有需要建立联系，也希望能通过它的友元类（中间类或者跳转类）来转达。</p>
<h3 id="迪米特法则的规则"><a href="#迪米特法则的规则" class="headerlink" title="迪米特法则的规则"></a>迪米特法则的规则</h3><p>Only talk to your immediate friends(只与直接的朋友通讯)，一个对象的”朋友”包括他本身(this)、它持有的成员对象、入参对象、它所创建的对象。<br>尽量少发布public的变量和方法，一旦公开的属性和方法越多，修改的时候影响的范围越大。<br>“是自己的就是自己的”，如果一个方法放在本类中，既不产生新的类间依赖，也不造成负面的影响，那么次方法就应该放在本类中。<br>迪米特法则的意义<br>迪米特法则的核心观念就是类间解耦，也就降低类之间的耦合，只有类处于弱耦合状态，类的复用率才会提高。所谓降低类间耦合，实际上就是尽量减少对象之间的交互，如果两个对象之间不必彼此直接通信，那么这两个对象就不应当发生任何直接的相互作用，如果其中的一个对象需要调用另一个对象的某一个方法的话，可以通过第三者转发这个调用。简言之，就是通过引入一个合理的第三者来降低现有对象之间的耦合度。但是这样会引发一个问题，有可能产生大量的中间类或者跳转类，导致系统的复杂性提高，可维护性降低。如果一味追求极度解耦，那么最终有可能变成面向字节码编程甚至是面向二进制的0和1编程。</p>
<p>举个很简单的例子，体育老师要知道班里面女生的人数，他委托体育课代表点清女生的人数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Girl</span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GroupLeader</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> List&lt;Girl&gt; girls;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_">GroupLeader</span><span class="params">(List&lt;Girl&gt; girls)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.girls = girls;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">countGirls</span><span class="params">()</span> &#123;</span><br><span class="line">		System.out.println(<span class="string">&quot;The sum of girls is &quot;</span> + girls.size());</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Teacher</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">command</span><span class="params">(GroupLeader leader)</span>&#123;</span><br><span class="line">		leader.countGirls();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">App</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		<span class="type">Teacher</span> <span class="variable">teacher</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Teacher</span>();</span><br><span class="line">		<span class="type">GroupLeader</span> <span class="variable">groupLeader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GroupLeader</span>(Arrays.asList(<span class="keyword">new</span> <span class="title class_">Girl</span>(), <span class="keyword">new</span> <span class="title class_">Girl</span>()));</span><br><span class="line">		teacher.command(groupLeader);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个例子中，体育课代表就是中间类，体育课代表对于体育老师来说就是”直接的朋友”，如果去掉体育课代表这个中间类，体育老师必须亲自清点女生的人数(实际上就数人数这个功能，体育老师是不必要获取所有女生的对象列表)，这样做会违反迪米特法则。</p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>说实话，设计模式的七大原则理解是比较困难的，我们在设计模式的学习和应用中经常会听到或者看到”XXX模式符合XXX原则”、”YYY模式不符合YYY原则”这样的语句。因此，为了分析设计模式的合理性和完善我们日常的编码，掌握和理解这七大原则是十分必要的。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p>《Java设计模式》<br>《设计模式之禅-2nd》<br>《设计模式-可复用面向对象软件的基础》</p>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color2">Java基础</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2023/05/28/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E6%A6%82%E5%BF%B5%E5%92%8C%E4%B8%83%E5%A4%A7%E5%8E%9F%E5%88%99/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>

<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>




  
    <article id="post-内存和IO" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2023/05/24/%E5%86%85%E5%AD%98%E5%92%8CIO/">内存和IO</a>
    </h1>
  

        
        <a href="/2023/05/24/%E5%86%85%E5%AD%98%E5%92%8CIO/" class="archive-article-date">
  	<time datetime="2023-05-24T10:01:54.661Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2023-05-24</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="文件类型"><a href="#文件类型" class="headerlink" title="文件类型"></a>文件类型</h1><p>man [man,1,tcp…..]：系统文档<br><img src="/assets/doc-images/io_1.png" alt="前缀"></p>
<ul>
<li><p>-普通文件（图片，视频，可执行文件）</p>
</li>
<li><p>d：目录</p>
</li>
<li><p>b：块设备 硬盘驱动器，光驱或软驱等设备</p>
</li>
<li><p>l：连接</p>
<ul>
<li>软连接，类似于windows的快捷方式，实际上是通过ln命令将某一文件链接到另外一个文件，但是两个文件Inode号是相同的，删除指向文件就会报错   ln -s /aa/a.txt /bb/b.txt</li>
<li>硬链接：磁盘中实际存在文件，虚拟地址中和原始的文件Inode号不同但是实际物理地址指向同一个地方，但是在删除指向文件的时候并不会报错。   ln /aa/a.txt /bb/b.txt</li>
</ul>
</li>
</ul>
<p>stat /b.txt 可以看到文件的元数据</p>
<ul>
<li><p>c：字符设备 终端，里面存储不能被切割的字符型数据</p>
</li>
<li><p>s：socket</p>
</li>
<li><p>p：管道<br>前面的输出是后面的输入，| 的前后都会单独启动子进程，将子进程的执行结果交给| 后面的命令中，当做输入。可以用块命令实现（{echo $BASHPID ; read x;} | {cat ; echo $BASHPID; read y}）<br>$$ 优先级比 | 高，所以解释器先翻译执行$$,而$BASHPID也是代表当前Bash的进程ID，但是在解释器执行的时候优先级要比 | 低。</p>
</li>
<li><p>lsof -p /$/$(进程号) 查看某个进程打开的哪些文件（$ 当前bash），也可以看到对应文件的文件描述符。</p>
</li>
<li><p>pcstat  -pid $$ :内存中缓存页的状态（大小，编号等等）</p>
</li>
<li><p>read  x:通过键盘数据复制变量</p>
</li>
<li><p>dd：拷贝文件到固定地址或者文件中 dd if=/dev/zero of=mydisk.img bs=1048576 count=100</p>
</li>
<li><p>proc(目录)：映射的内核的虚拟文件系统，其中包含变量和所有程序的文件信息包括所有文件描述，开启的文件等等。</p>
</li>
<li><p>pcstat  /bin/bash ：可以看某个文件夹下被缓存数据页的数量和比例 佛挡杀佛</p>
</li>
<li><p>strace -ff -o out java ： 追踪线程的内核操作指令[strace -ff -o out java OSFileIO 0<br>指定文件名称可以跟踪这个文件所有相关的线程并打印其命令到文件中]</p>
</li>
<li><p>ldd：分析文件所依赖的所有源文件</p>
</li>
<li><p>挂载：将文件挂载到另一个文件目录下，那对于当前目录的一个拓展，再不改变其文件结构的基础下，将新挂载的目录就会成为文件内容的新区域。<br>losetup：losetup /dev/loop0 mydisk.image (把文件虚拟成块设备，模拟整个文件系统)<br>mount：它用于挂载Linux系统外的文件</p>
</li>
<li><p>重定向：Linux万物皆文件，所以对于每个命令和应用程序其实都是文件，而其中文件描述符（fd）可以用来该进程下不同线程对于IO的操作不同，0代表标准输入，1代表标准输出，2代表标准报错。每个进程或程序在运行的时候都有属于自己的VFS，所以进程之间是互相隔离的，只能通过内核来访问其他进程的信息。(read x 0&gt; test.txt)<br>重定向则是通过劫持每个进程fd来重新制定数据或者结果的来源或方向。&lt;代表读，&gt;代表写，&lt;&gt;代表读写。 重定向符号和fd中间不能有空白符或者其他符号。</p>
</li>
</ul>
<p><img src="/assets/doc-images/io_2.png" alt="追踪线程的内核指令生成的文件"><br><img src="/assets/doc-images/io_3.png" alt="线程内核操作指令"></p>
<h1 id="磁盘IO操作"><a href="#磁盘IO操作" class="headerlink" title="磁盘IO操作"></a>磁盘IO操作</h1><ul>
<li>OutputStream:在每次写入时，如果有新数据产生就会调用内核命令write写入内存。</li>
<li>BufferOutputStream:会存在一个8K的缓冲区，只有当8K的缓冲区存满后才会调用内核命令write,减少内核态和用户态的切换次数。<h2 id="pageCache"><a href="#pageCache" class="headerlink" title="pageCache"></a>pageCache</h2><img src="/assets/doc-images/io_4.png" alt="在这里插入图片描述"><br><img src="/assets/doc-images/io_5.png" alt="在这里插入图片描述"></li>
</ul>
<p><img src="/assets/doc-images/io_6.png" alt="在这里插入图片描述"></p>
<h1 id="网络IO"><a href="#网络IO" class="headerlink" title="网络IO"></a>网络IO</h1><ul>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/d9162722f189">tcpdump</a> -nn -i etho port 9090 :是一个用于截取网络分组，并输出分组内容的工具。</li>
<li>netstat inatp：查看网络端口状态</li>
<li>tcp：面向连接的可靠地传输协议<ul>
<li>连接：三次握手，内核开辟资源</li>
</ul>
</li>
<li>socket：四元组（CIP CPORT + SIP SPORT）,内核级的。</li>
<li><img src="/assets/doc-images/io_7.png" alt="在这里插入图片描述"><br><img src="/assets/doc-images/io_8.png" alt="在这里插入图片描述"><br>ifconfig：可以看到某个网卡对于网络通信的限制，<br>MTU：数据包大小<br>MSS：数据内容大小</li>
</ul>
<p>socket建立连接，服务端内核指令<br><img src="/assets/doc-images/io_9.png" alt="socket建立连接，内核指令"></p>
<h2 id="BIO"><a href="#BIO" class="headerlink" title="BIO"></a>BIO</h2><h5 id="模型图"><a href="#模型图" class="headerlink" title="模型图"></a>模型图</h5><p><img src="/assets/doc-images/io_10.png" alt="BIO下的socket"></p>
<h5 id="socket-建立连接步骤"><a href="#socket-建立连接步骤" class="headerlink" title="socket 建立连接步骤"></a>socket 建立连接步骤</h5><p>1.new Socket对象（fd3 = new Socket()），向内核请求生成一个文件描述符<br>2.进行本机端口号的bind(bingd(fd3,8090))，fd和Port<br>3.监听(listen fd3)    该端口上所有的事件<br>PS：以上步骤进行完才能通过netstat -natp 看到本机端口的状态，使用状态还是监听状态<br>4.阻塞式接受客户端连接（accept）</p>
<h2 id="NIO"><a href="#NIO" class="headerlink" title="NIO"></a>NIO</h2><p>非阻塞IO模型，在服务端accept连接的时候不会像BIO一样，阻塞线程直到有客户端建立连接。而是返回数值为-1的文件描述符来表示此时未有需要建立建立连接的客户端，如果有则返回大于0的文件描述符，并保存该链接到集合中，后面可以循环遍历连接来读取数据。<br><img src="/assets/doc-images/io_11.png" alt="在这里插入图片描述"></p>
<h2 id="多路复用器"><a href="#多路复用器" class="headerlink" title="多路复用器"></a>多路复用器</h2><p>同步：app自己进行IO 的RW<br>异步：kenel完成RW，程序没有访问IO，只访问了buffer。目前只有Windows上的IOCP是纯异步的<br>阻塞：BIO<br>非阻塞：NIO<br>无论什么多路复用器都要遍历所有IO，询问。只不过NIO是每次遍历都要用户态内核态的进行切换。<br>不负责读写，只负责记录是否有可读可写的状态，可读（客户端信息发送），可写（send_que这个队列是空的，能往里写）</p>
<h3 id="select"><a href="#select" class="headerlink" title="select"></a>select</h3><p>多路复用器，有文件描述符数量限制。在遍历所有IO的时候只进行了一次的用户态内核态的切换，过程中把fds传给内核，内核根据这次传递的fds来遍历和修改状态。<br><img src="/assets/doc-images/io_12.png" alt="在这里插入图片描述"></p>
<h3 id="poll"><a href="#poll" class="headerlink" title="poll"></a>poll</h3><p>在遍历所有IO的时候只进行了一次的用户态内核态的切换，过程中把fds传给内核，内核根据这次传递的fds来遍历和修改状态。</p>
<h3 id="epoll"><a href="#epoll" class="headerlink" title="epoll"></a>epoll</h3><p>Epoll在IO模型在建立Server端时，首先对于监听的端口申请到一个文件描述符，并使用该文件描述符绑定监听端口。在实现端口的监听后Server会调用epoll_create命令建立epoll相关信息（例如内核中用来保存每个链接FD的红黑树，用来保存红黑树的epoll的文件描述符RPFD等等epoll相关的信息）,其中EPFD用来保存被监听的FD所建立的所有新FD的数值，状态等等信息。创建了epoll所必须的信息后，通过epoll_ctl命令将监听端口的FD加入到红黑树中（每当有新的链接建立即分配新的FD时都会建立一个新的FD链表由红黑树进行数据的添加，链表主要是用来表示是否有需要读取的数据）。当Clinent端有新连接是都会在对应的红黑树中增加相应的文件描述符，如果有新数据进行传输时会将实际是数据写入分配给该文件描述符的buffer中还会将该连接的FD保存到对应的链表中，Server在进行读取时不用遍历所有已经建立连接的IO而是遍历链表中的所有IO。<img src="https://img-blog.csdnimg.cn/20200811220616691.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0dLVERTUg==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br><img src="/assets/doc-images/io_13.png" alt="在这里插入图片描述"></p>
<h3 id="java-多路复用器封装"><a href="#java-多路复用器封装" class="headerlink" title="java 多路复用器封装"></a>java 多路复用器封装</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.bjmashibing.system.io;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.net.InetSocketAddress;</span><br><span class="line"><span class="keyword">import</span> java.nio.ByteBuffer;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.*;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SocketMultiplexingSingleThreadv1</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//马老师的坦克 一 二期</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">ServerSocketChannel</span> <span class="variable">server</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">Selector</span> <span class="variable">selector</span> <span class="operator">=</span> <span class="literal">null</span>;   <span class="comment">//linux 多路复用器（select poll    epoll kqueue） nginx  event&#123;&#125;</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">port</span> <span class="operator">=</span> <span class="number">9090</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initServer</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            server = ServerSocketChannel.open();</span><br><span class="line">            server.configureBlocking(<span class="literal">false</span>);</span><br><span class="line">            server.bind(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(port));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="comment">//如果在epoll模型下，open--》  epoll_create -&gt; fd3</span></span><br><span class="line">            selector = Selector.open();  <span class="comment">//  select  poll  *epoll  优先选择：epoll  但是可以 -D修正</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">//server 约等于 listen状态的 fd4</span></span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">            register</span></span><br><span class="line"><span class="comment">            如果：</span></span><br><span class="line"><span class="comment">            select，poll：jvm里开辟一个数组 fd4 放进去</span></span><br><span class="line"><span class="comment">            epoll：  epoll_ctl(fd3,ADD,fd4,EPOLLIN</span></span><br><span class="line"><span class="comment">            实际上是懒加载，只有在实际使用的时候才会真的去调用命令进行监听FD的注册</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            server.register(selector, SelectionKey.OP_ACCEPT);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> &#123;</span><br><span class="line">        initServer();</span><br><span class="line">        System.out.println(<span class="string">&quot;服务器启动了。。。。。&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;  <span class="comment">//死循环</span></span><br><span class="line"></span><br><span class="line">                Set&lt;SelectionKey&gt; keys = selector.keys();</span><br><span class="line">                System.out.println(keys.size()+<span class="string">&quot;   size&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                <span class="comment">//1,调用多路复用器(select,poll  or  epoll  (epoll_wait))</span></span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                select()是啥意思：</span></span><br><span class="line"><span class="comment">                1，select，poll  其实  内核的select（fd4）  poll(fd4)</span></span><br><span class="line"><span class="comment">                2，epoll：  其实 内核的 epoll_wait()</span></span><br><span class="line"><span class="comment">                *, 参数可以带时间：没有时间，0  ：  阻塞，有时间设置一个超时</span></span><br><span class="line"><span class="comment">                selector.wakeup()  结果返回0</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">                懒加载：</span></span><br><span class="line"><span class="comment">                其实再触碰到selector.select()调用的时候触发了epoll_ctl的调用</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                <span class="keyword">while</span> (selector.select() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    Set&lt;SelectionKey&gt; selectionKeys = selector.selectedKeys();  <span class="comment">//返回的有状态的fd集合</span></span><br><span class="line">                    Iterator&lt;SelectionKey&gt; iter = selectionKeys.iterator();</span><br><span class="line">                    <span class="comment">//so，管你啥多路复用器，你呀只能给我状态，我还得一个一个的去处理他们的R/W。同步好辛苦！！！！！！！！</span></span><br><span class="line">                    <span class="comment">//  NIO  自己对着每一个fd调用系统调用，浪费资源，那么你看，这里是不是调用了一次select方法，知道具体的那些可以R/W了？</span></span><br><span class="line">                    <span class="comment">//幕兰，是不是很省力？</span></span><br><span class="line">                    <span class="comment">//我前边可以强调过，socket：  listen   通信 R/W</span></span><br><span class="line">                    <span class="keyword">while</span> (iter.hasNext()) &#123;</span><br><span class="line">                        <span class="type">SelectionKey</span> <span class="variable">key</span> <span class="operator">=</span> iter.next();</span><br><span class="line">                        iter.remove(); <span class="comment">//set  不移除会重复循环处理</span></span><br><span class="line">                        <span class="keyword">if</span> (key.isAcceptable()) &#123;</span><br><span class="line">                            <span class="comment">//看代码的时候，这里是重点，如果要去接受一个新的连接</span></span><br><span class="line">                            <span class="comment">//语义上，accept接受连接且返回新连接的FD对吧？</span></span><br><span class="line">                            <span class="comment">//那新的FD怎么办？</span></span><br><span class="line">                            <span class="comment">//select，poll，因为他们内核没有空间，那么在jvm中保存和前边的fd4那个listen的一起</span></span><br><span class="line">                            <span class="comment">//epoll： 我们希望通过epoll_ctl把新的客户端fd注册到内核空间</span></span><br><span class="line">                            acceptHandler(key);</span><br><span class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (key.isReadable()) &#123;</span><br><span class="line">                            readHandler(key);  <span class="comment">//连read 还有 write都处理了</span></span><br><span class="line">                            <span class="comment">//在当前线程，这个方法可能会阻塞  ，如果阻塞了十年，其他的IO早就没电了。。。</span></span><br><span class="line">                            <span class="comment">//所以，为什么提出了 IO THREADS</span></span><br><span class="line">                            <span class="comment">//redis  是不是用了epoll，redis是不是有个io threads的概念 ，redis是不是单线程的</span></span><br><span class="line">                            <span class="comment">//tomcat 8,9  异步的处理方式  IO  和   处理上  解耦</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">acceptHandler</span><span class="params">(SelectionKey key)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ServerSocketChannel</span> <span class="variable">ssc</span> <span class="operator">=</span> (ServerSocketChannel) key.channel();</span><br><span class="line">            <span class="type">SocketChannel</span> <span class="variable">client</span> <span class="operator">=</span> ssc.accept(); <span class="comment">//来啦，目的是调用accept接受客户端  fd7</span></span><br><span class="line">            client.configureBlocking(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">            <span class="type">ByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">8192</span>);  <span class="comment">//前边讲过了</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 0.0  我类个去</span></span><br><span class="line">            <span class="comment">//你看，调用了register</span></span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">            select，poll：jvm里开辟一个数组 fd7 放进去</span></span><br><span class="line"><span class="comment">            epoll：  epoll_ctl(fd3,ADD,fd7,EPOLLIN</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            client.register(selector, SelectionKey.OP_READ, buffer);</span><br><span class="line">            System.out.println(<span class="string">&quot;-------------------------------------------&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;新客户端：&quot;</span> + client.getRemoteAddress());</span><br><span class="line">            System.out.println(<span class="string">&quot;-------------------------------------------&quot;</span>);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">readHandler</span><span class="params">(SelectionKey key)</span> &#123;</span><br><span class="line">        <span class="type">SocketChannel</span> <span class="variable">client</span> <span class="operator">=</span> (SocketChannel) key.channel();</span><br><span class="line">        <span class="type">ByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> (ByteBuffer) key.attachment();</span><br><span class="line">        buffer.clear();</span><br><span class="line">        <span class="type">int</span> <span class="variable">read</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                read = client.read(buffer);</span><br><span class="line">                <span class="keyword">if</span> (read &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    buffer.flip();</span><br><span class="line">                    <span class="keyword">while</span> (buffer.hasRemaining()) &#123;</span><br><span class="line">                        client.write(buffer);</span><br><span class="line">                    &#125;</span><br><span class="line">                    buffer.clear();</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (read == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    client.close();</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">SocketMultiplexingSingleThreadv1</span> <span class="variable">service</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SocketMultiplexingSingleThreadv1</span>();</span><br><span class="line">        service.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color2">Java基础</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2023/05/24/%E5%86%85%E5%AD%98%E5%92%8CIO/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>

<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>




  
    <article id="post-RocketMQ" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2023/05/24/RocketMQ/">RocketMQ</a>
    </h1>
  

        
        <a href="/2023/05/24/RocketMQ/" class="archive-article-date">
  	<time datetime="2023-05-24T09:22:10.014Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2023-05-24</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="RocketMQ"><a href="#RocketMQ" class="headerlink" title="RocketMQ"></a>RocketMQ</h2><p><img src="/assets/doc-images/rocket_mq_structs.png" alt="RocketMQ部署图"></p>
<h3 id="RocketMQ结构组成"><a href="#RocketMQ结构组成" class="headerlink" title="RocketMQ结构组成"></a>RocketMQ结构组成</h3><p>RockMQ由四个部分构成：</p>
<h4 id="NamerServer"><a href="#NamerServer" class="headerlink" title="NamerServer"></a>NamerServer</h4><p>无状态节点，可集群部署，但是节点之间无通信。该节点主要存储Producer和Customer的配置信息和状态信息、Broker集群配置信息和元信息。相比于Zookeeper的分布式协调，NameServer更加轻量级不会存在自动选举能力，因为MasterBroker中不会保存所有的Topic所以集群式的NameServer失去选举机制的意义而且又是跟轻量级的任务协调框架。</p>
<h4 id="Broker"><a href="#Broker" class="headerlink" title="Broker"></a>Broker</h4><p>消息存储者和转发者，Broker主要提供服务的部分。单个Broker会对所有NameServer节点保持长连接心跳，并且会定时将Topic信息注册到NameServer中。Broker同样还负责存储消息，以Topic为维度支持轻量级队列，支持消息推拉模型。(Broker实际上可以支持几十万队列消息存储，并可以保证严格顺序。</p>
<h5 id="部署模式"><a href="#部署模式" class="headerlink" title="部署模式"></a>部署模式</h5><ul>
<li>单Master模式，只有单个节点，很脆弱。存在单点故障。</li>
<li>单Master多Slave模式，该模式相比于单Master模式增加读的性能，但是依然存在单点故障。</li>
<li>多Master模式，多个Master节点组成的集群，单个Master宕机或者重启都不会对Product和Customer产生影响。在所有模式中该模式性能最高，但是被宕机的Master在回复之前其中保存的消息不会被消费。但是在Master节点的磁盘刷新模式上会有要求：<ul>
<li>同步刷新磁盘：当Broker收到生产者发送的消息时，数据就会同步刷新进入磁盘中。刷新完成后才会向生产者返回成功状态，所以当生产者收到返回状态时消息已经被保存进入磁盘不会丢失。</li>
<li>异步刷新磁盘：当Broker收到生产者发送的消息会先保存到机器内存中不会实时写入到磁盘，并且同时会向生产者发送成功的状态，只有当内存达到阈值才会批量写入磁盘中。所以这种方式会造成Master宕机后小批量消息丢失。</li>
</ul>
<ul>
<li>多Master多Slave模式：多个Master节点构成且每个Master节点都至少存在一个或者更多个Salve节点，这样的模式下不但可以保证不会出现单点故障且某个Master节点发生故障时，消费者会从Slave节点消费消息，所以不会对消息实时处理产生影响。但是Master和Salve之间的主备方式选择会影响消息处理的效率以及消息完整性：<ul>
<li>异步复制：Master节点写成功生产者的消息就返回给生产者成功的状态，当生产者收到成功状态的响应时Master的消息不一定会同步到Slave中。所以如果此时Master宕机那么Slave就会丢失一部分数据而无法消费，缺失的消息还保存再Master中，可能不会丢失。（如果是异步刷新的话可能消息会丢失）。性能和多Master差不多。</li>
<li>同步复制：只有在Master和Slave消息都写入后才会向生产者相应成功的状态。这种方式如果Master宕机消息从Slave继续消费，不会影响消息的实时消费。但是同步写入会增加数据写入延迟，降低消息的吞吐量。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="Topic与Broker存储关系"><a href="#Topic与Broker存储关系" class="headerlink" title="Topic与Broker存储关系"></a>Topic与Broker存储关系</h4><p>在Broker中保存每个队列的消息会先按照Topic分片，Topic中是是消息订阅的最小颗粒度，一个Group可以订阅多个Topic,Topic创建方式有两种：</p>
<ul>
<li>自动创建：Producter在发送消息时会先从NamerServer拉去Topic路由信息，如果路由信息不存在则会拉去Broker创建时默认的“TBW102”的Topic。</li>
<li>手动创建：在创建Broker集群和NameServer集群后，在每个Broker上通过命令来创建Topic并指定Topic中相关的参数(<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/345aaa18f71d">Topic参数创建</a>)。或者通过RocketMQ Console来创建Topic。创建的时候可以指定该Topic中队列的数量。<br><img src="/assets/doc-images/rocket_mq_topic.png" alt="队列结构图"><h4 id="Broker实际物理结构"><a href="#Broker实际物理结构" class="headerlink" title="Broker实际物理结构"></a>Broker实际物理结构</h4>Broker中存储所有RocketMQ消息，其中Broker的存储数据结构主要分为三个部分commitLog,customerQueue,index的索引文件。<h5 id="commitLog"><a href="#commitLog" class="headerlink" title="commitLog"></a>commitLog</h5>commitLog是实际存储队列消息的物理文件单个commitLog文件大小为1G，消息写入commitLog的时候采用的是尾部追加的方式写入数据，而customerQueue的数据信息写入是在commitLog写入信息后才构建的。commitLog先从mappedFileQueue获取最后一个MappedFile文件，如果为空就创建一个commitLog对应的MappedFile文件，文件命名以实际以文件大小命名，分别是00000000000000000000、00000000001073741824、00000000002147483648，文件名之间差1G=1024<em>1024</em>1224B=1073741824。每个commitLog的MappedFile文件大小是1G，剩余多余无非存入新消息就用填充字符填充到1G。<h5 id="customerQueue"><a href="#customerQueue" class="headerlink" title="customerQueue"></a>customerQueue</h5>存储的是逻辑队列(其中存储着每条消息的物理存储地址，每个Topic下的MessageQueue都有一个对应的customerQueue文件)。<h5 id="index文件"><a href="#index文件" class="headerlink" title="index文件"></a>index文件</h5>每个索引文件大致包含三部分header，Hash slot,index：<br><img src="/assets/doc-images/rocket_mq_index.png" alt="在这里插入图片描述"></li>
</ul>
<ul>
<li>header：文件主要保存该索引文件元数据：</li>
</ul>
<ul>
<li> beginTimestamp : 该索引文件的第一个消息(Message)的存储时间(落盘时间)  物理位置(pos: 0-7) 8bytes</li>
<li>endTimestamp : 该索引文件的最后一个消息(Message)的存储时间(落盘时间)  物理位置(pos: 8-15) 8bytes</li>
<li>beginPhyoffset : 该索引文件第一个消息(Message)的在CommitLog(消息存储文件)的物理位置偏移量(可以通过该物理偏移直接获取到该消息) 物理位置(pos: 16-23) 8bytes</li>
<li>beginPhyoffset : 该索引文件最后一个消息(Message)的在CommitLog(消息存储文件)的物理位置偏移量 (pos: 24-31) 8bytes</li>
<li>hashSlotCount : 该索引文件目前的hash slot的个数 (pos: 32-35) 4bytes</li>
<li>indexCount : 该索引文件目前的索引个数 (pos: 36-39) 4bytes</li>
</ul>
<p>在新存储消息的过程中，每个消息存储的时候都会检查一下header中已存索引数是否已经达到最大值，如果达到则重新建立新索引文件。</p>
<ul>
<li>solt Table：用来保存每个哈希值的索引数量，但是在初始化时就已经固定大小和数量4bytes*5000000</li>
<li>index：实际存储索引信息：<ul>
<li>key hash value: message key的hash值</li>
<li>phyOffset: message在CommitLog的物理文件地址, 可以直接查询到该消息(索引的核心机制)</li>
<li>timeDiff: message的落盘时间与header里的beginTimestamp的差值(为了节省存储空间，如果直接存message的落盘时间就得8bytes)</li>
<li>prevIndex: hash冲突处理的关键之处, 相同hash值上一个消息索引的index(如果当前消息索引是该hash值的第一个索引，则prevIndex=0, 也是消息索引查找时的停止条件。)</li>
</ul>
</li>
</ul>
<p>其中soltTable中的soltValue偏移量主要是用于在查找对应的索引时提供偏移量，找到该索引最后一个index，再逐个向前开始遍历直到找到对应的值。<br><img src="/assets/doc-images/rocket_mq_broker.png" alt="Broker数据结构"></p>
<h4 id="Customer"><a href="#Customer" class="headerlink" title="Customer"></a>Customer</h4><h5 id="连接"><a href="#连接" class="headerlink" title="连接"></a>连接</h5><ul>
<li>Customer与NameServer集群中的某一个保持长连接，定时从NameServer中拉去相关Topic信息，如果被连接的NameServer挂了则自动轮询下一个NameServer建立连接，直到轮询了所有的NameServer集群，定时拉去Topic信息时间可以由参数来控制(DefaultMQPushConsumer的pollNameServerInteval)。</li>
<li>Customer会与Customer关联的所有Broker建立长连接，默认情况下每隔30s会向所有Customer相关联的Broker发送心跳(DefaultMQPushConsumer的heartbeatBrokerInterval来控制发送心跳的间隔)，Broker每隔10s(固定时间，无法更改)会检查所有的连接所有的连接存活状态，如果某个连接超过2min(无法更改，最新更新时间和当前时间差值)没有收到心跳则断开该链接，并向CustomerGroup发送通知，分组内的消费者重新分配队列继续消费。<h5 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h5>一个CustomerGroup多台机器共同消费一个topic中的多个队列，但是一个队列只会被一个消费者消费，如果某个Customer宕机则分组内的其他消费者会接替宕机的 消费者进行消费。客户端会自行负载均衡拉去消息。(<a target="_blank" rel="noopener" href="https://blog.csdn.net/notOnlyRush/article/details/80358426">负载均衡</a>)<h5 id="消费机制"><a href="#消费机制" class="headerlink" title="消费机制"></a>消费机制</h5>消费者不断从Broker拉去需要消费的消息，消息拉取到本地的消息队列，Customer线程消费本地消息队列内的消息。其中拉去和消费本地这两个步骤是异步的，所以拉取线程不会等待消费线程从而降低消息队列相应时间，解耦合。其中本地消息队列大小、消息拉取到本地间隔时间、消费消息数量都可以手动控制。如果一个消费者绑定了多个队列那在拉取Broker中队列的消息时，会将所有队列都拉去到本地进行消费，但是在拉取的时候是一个个队列轮询拉取，等全部队列都拉去完成后再将拉取任务放到队尾，循环执行拉取。<br>消费者消费消息时会存在两种消费模式Push和Pull两种消费模式本质上都是使用的Pull模式来获取Broker中的消息进行消费：</li>
</ul>
<ul>
<li>Pull模式：该模式下主动权在消费者，Customer会主动拉去对应Topic中Queue的消息(默认间隔时间是5s，但是这个时间可以通过setPullNextDelayTimeMillis来调整，但是最小时间是5s)。每个Queue在拉取的时候都会记录当先消费消息的偏移量、拉去消息量的大小、拉去的间隔时间，各个Customer使用偏移量的来确认每个消费者消费消息的进度以确保消息不会被重复消费。</li>
<li>Push模式：该模式实际上也是由Pull模式实现的，不过在这种模式下，每个Customer都会在本地注册一个监听器用来监听Broker中对应队列的的消息情况，当Broker的customerQueue中新增消息的时候会触发监听器customesMessage()进行消息的消费，所以看起来是Broker把消息推到Customer中。</li>
</ul>
<h4 id="Producer"><a href="#Producer" class="headerlink" title="Producer"></a>Producer</h4><p>与NamerServer和Broker的连接机制和Customer相同。发送分布式事务消息时，如果Producer中途意外宕机，Broker会主动回调Producer Group内的任意一台机器来确认事务状态。</p>
<h3 id="RocketMQ消息有序性"><a href="#RocketMQ消息有序性" class="headerlink" title="RocketMQ消息有序性"></a>RocketMQ消息有序性</h3><p>RocketMQ顺序消息由两个部分构成顺序发布和顺序消费，但是对于保证消息的顺序性Rocket有两种不同的方案：</p>
<ul>
<li>全局顺序：一个Topic内所有的消息按照先进先出的顺序进行发布和消费,单个Topic中只存在一个Queue，但是因为只有一个Queue所以无论生产者或者消费者增加数量始终都会收到Queue性能限制，吞吐量影响较大；</li>
<li>局部顺序：增加消息ID，根据ID来区分消息类型并发送到同一个Queue中可以让消费者按照顺序来进行消费。在Customer集群在消费消息的时候就可以按照顺序进行消费，每个Customer只有在消费的成功的时候才会返回给Broker确认相应。<ul>
<li>Producter处理：只需要保证顺序发布，每个Producter通过实现MessageQueueSelector来决定消息队列具体的分区。<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment">// 例如订单顺序均为下单，付款，发货即可，只要保证单个订单消息顺序消费</span></span><br><span class="line">  <span class="type">SendResult</span> <span class="variable">sendResult1</span> <span class="operator">=</span> producer.send(msg1, <span class="keyword">new</span> <span class="title class_">MessageQueueSelector</span>() &#123;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> MessageQueue <span class="title function_">select</span><span class="params">(List&lt;MessageQueue&gt; mqs, Message msg, Object arg)</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;, order.orderId);</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li>Customer处理：Customer在接收消息时有两种模式Pull和Push，默认Pull方式去拉取。<ul>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/fuyuwei2015/category_7093136.html">PushCustomer</a>：Broker主动向Customer推送消息，在应用中创建Customer队列需要为消费者队列增加Linstener监听器。Push方法里面Customer把轮询方式封装了，并注册了MessageLinstener监听器，获取到消息后唤醒MessageLinstener的CustomerMessage()来消费，对于用户的体验就是被推过来。但是这样的方式每个Customer处理消息的时间就变成了RocketMQ的最大瓶颈，如果某个Customer消费消息所需时间远远大于生产者，那么Broker中消息就会大量堆积，甚至某一消息在CustomerGroup中的所有Customer中被挨个reject和error。</li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/fuyuwei2015/category_7093136.html">PullCustomer</a>：Customer主动去拉取Broker中的定量的消息进行批量消费，消费者首先通过关联的Topic拿到MessageQueue集合，通过遍历MessageQueue来获取指定队列消息，Pull模式中消费者获取消息需要用户自行定义。因为每次是批量拉去消息，所以Broker不用记录每个消息的状态所以在Customer拉去一定量消息时Broker只会记录消息的偏移量和所有消息队列即可。针对慢消息也大大缓解其中Broker消息堆积的压力。针对Customer拉去消息的空档期RocketMQ采用长连接轮询Pull，如果有有某次Pull失败或者为空则不会直接return，而会把该线程挂起wait，直到服务端有新消息到来把连接notify起来。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="RocketMq事务消息的实现机制"><a href="#RocketMq事务消息的实现机制" class="headerlink" title="RocketMq事务消息的实现机制"></a>RocketMq事务消息的实现机制</h3><p>RocketMQ的事务消息主要分为两个阶段prepare和commit/rollback。</p>
<ul>
<li>prepare：发送一个消息到Broker中，但是该消息只会保存在commitLog中，而不会像正常的消息一样回写到messageQueue中，所以对于事务消息这个阶段customer是不可见的。发送到Broker中的消息会存在RMQ_SYS_TRANS_HALF_TOPIC这个Topic中，并备份原有的Topic以便commit消息时还原，修改消息queueId为0，并备份消息原有queueId，供后续commit消息时还原消息queueId使用。</li>
<li>commit/rollback：该阶段会在发送一个commit消息或者rollback消息到rocketMQ中<ul>
<li>commit：消息会将prepare阶段发送的消息会写到messageQueue中使得customer可以进行递送消费；</li>
<li>rollback：消息则Broker不会投递该消息存储在Broker中三天自动删除（实际是将消息存入RMQ_SYS_TRANS_OP_HALF_TOPIC这个Topic中）。</li>
<li>事务回查：Broker未收到任何commit或rollback消息，RocketMQBroker会主动定时进行同一个Group下的Producter进行发送回查消息，而每个Producter需要自行定义TransactionListener并编写其中的checkLocalTransaction方法来实现事务的检查，不过每个事务消息在传递的时候都会附带上transactionId以方便进行事务回查。<a target="_blank" rel="noopener" href="https://blog.csdn.net/hosaos/article/details/90240260">事务回查</a></li>
</ul>
</li>
</ul>
<h3 id="RocketMq会有重复消费的问题吗？"><a href="#RocketMq会有重复消费的问题吗？" class="headerlink" title="RocketMq会有重复消费的问题吗？"></a>RocketMq会有重复消费的问题吗？</h3><p>会存在重复消费消息的情况，原因在于Customer在消费消息的时候会保存Broker中消息队列中已消费消息的偏移量，但是在每个Customer重启时为了负载均衡新Customer都要去同步消息消费偏移量以确定是否还有未消费的的消息。如果此时C2正在消费消息，在未消费完时C1进行重启，C1在重新计算消费消息偏移量时因为C2还未发送消息消费完成的消息Broker中的偏移量任然是上一个所以相同消息就会被发往C1一份，导致C1，C2消费相同的消息。其实引起消费重复的消息的原因还有很多例如：Broker在消费消息的同时重启、Broker水平扩容、不遵守先订阅后生产消息的原则都会使得消息消费重复。<br>为了解决消费者重复消费问题，消费者应该在消费消息的业务逻辑中增加幂等逻辑。针对每条消息都有唯一的消息ID并且保证消息消费成功与消息去重表的同事出现。</p>
<h3 id="RocketMq支持什么级别的延迟消息？"><a href="#RocketMq支持什么级别的延迟消息？" class="headerlink" title="RocketMq支持什么级别的延迟消息？"></a>RocketMq支持什么级别的延迟消息？</h3><p>Rocket可以支持秒级别的延迟消息，但是RocketMQ的延迟消息不支持自定义时间，而是在broker创建的时候通过自定义每层Leavel延迟的时间实现的。所以在Broker启动后，如果需要使用延迟消息则再Producter中设置消息时就指定该消息的延迟级别来指定该消息延迟的时间长短。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在Server端的Broker的配置文件中加入以下配置，在使用的是leavel=1就代表延迟1s,level=2就代表延迟5s以此类推。</span></span><br><span class="line"><span class="comment">// 以下设置为Broker中的默认配置，Broker也支持自定义配置级别但是最小只能从1s开始。</span></span><br><span class="line"><span class="comment">// 延迟时间单位从 s（秒）,m（分钟）,h（小时）,d（天）</span></span><br><span class="line">messageDelayLevel=1s 5s 10s 30s 1m 2m 3m 4m 5m 6m 7m 8m 9m 10m 20m 30m 1h 2h</span><br><span class="line"></span><br><span class="line"><span class="comment">// Producter使用延迟消息</span></span><br><span class="line"><span class="type">Message</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Message</span>(topic, tags, keys, body);</span><br><span class="line"><span class="comment">// 设置延迟级别</span></span><br><span class="line">msg.setDelayTimeLevel(<span class="number">3</span>);</span><br></pre></td></tr></table></figure>
<h4 id="延迟消息实现"><a href="#延迟消息实现" class="headerlink" title="延迟消息实现"></a>延迟消息实现</h4><ol>
<li>Producter发送延迟消息到Broker中，Broker将消息只保存到commitLog中使得消息暂时不可见，返回Producter确认消息；</li>
<li>消费线程将消息保存到SCHEDULE_TOPIC_XXX的Topic中的队列中，并会根据消息的延迟粒度(上面提到的额延迟级别)来当做queueId；</li>
<li>Borker启动定时任务针对SCHEDULE_TOPIC_XXX下每个队列都启动一个线程进行消费，定时任务每隔0.1s就会检查每个队列中的消息的延迟时间和当前时间来判断是否已经到达时间，如果到达时间则将该消息写入customerQueue中(消息可见)。<br>(SCHEDULE_TOPIC_XXX中保存的消息只是针对commitLog中消息位置的偏移量进行了一层封装，Broker中实际的消息存储位置只会是commitLog)</li>
</ol>
<h3 id="RocketMQ是推模型还是拉模型？"><a href="#RocketMQ是推模型还是拉模型？" class="headerlink" title="RocketMQ是推模型还是拉模型？"></a>RocketMQ是推模型还是拉模型？</h3><p>RocketMq的消费者支持Push和Pull两种消息消费模式，但是实际上Push模式也是通过Pull模式和Customer注册监听器实现的。所以RocketMQ实际上是由Pull模型实现的。</p>
<h3 id="Consumer的负载均衡是怎么样的？"><a href="#Consumer的负载均衡是怎么样的？" class="headerlink" title="Consumer的负载均衡是怎么样的？"></a>Consumer的负载均衡是怎么样的？</h3><p>RocketMQ的消费负载均衡是在Customer中实现的，而不是在Broker中，Broker只起到转发和保存消息队列数据作用。Customer通过AllocateMessageQueueStrategy 来进行队列的分配，并提供了多种已集成的实现：AllocateMessageQueueAveragely（平均分配，默认），AllocateMessageQueueAveragelyByCircle（循环分配）、AllocateMessageQueueConsistentHash（一致性哈希）、AllocateMessageQueueByConfig（更具配置进行分配），AllocateMessageQueueByMachineRoom（根据机房分配）、AllocateMachineRoomNearby（就近分配）。<br>以AllocateMessageQueueAveragely为例：</p>
<ul>
<li>queue个数大于Consumer个数，且queue个数能整除Consumer个数的话， 那么Consumer会平均分配queue。（比如上面表格的Consumer有2个 可以整除部分）</li>
<li>queue个数大于Consumer个数，且queue个数不能整除Consumer个数的话， 那么会有一个Consumer多消费1个queue，其余Consumer平均分配。（比如上面表格的Consumer有3个 不可整除部分）</li>
<li>queue个数小于Consumer个数，那么会有Consumer闲置，就是浪费掉了，其余Consumer平均分配到queue上。（比如上面表格的Consumer有5个 无法都分配部分）<br> 当一个consumer出现宕机后，默认最多20s，其它机器将重新消费已宕机的机器消费的queue。</li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">MQ</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2023/05/24/RocketMQ/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>

<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>




  
    <article id="post-JVM" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2023/05/24/JVM/">JVM</a>
    </h1>
  

        
        <a href="/2023/05/24/JVM/" class="archive-article-date">
  	<time datetime="2023-05-24T09:10:19.975Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2023-05-24</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="JVM"><a href="#JVM" class="headerlink" title="JVM"></a>JVM</h1><h2 id="内存结构"><a href="#内存结构" class="headerlink" title="内存结构"></a>内存结构</h2><ul>
<li><p>类加载子系统：负责从文件系统或者远端网络加载Class信息，加载子系统会将Class信息存放到方法区中。</p>
</li>
<li><p>Java堆：java虚拟机运行时主要的内存空间，虚拟机启动时被创建出来，用来存放几乎所有实例对象。堆空间是对所有线程共享的。虚拟机启动时分配并占用大部分内存，线程共享。其中堆内存在分为Eden区，新生代，老年代。</p>
<ul>
<li>Eden区：负责收容新生对象，但是若是创建时需要较大内存则会被直接交给老年代进行分配内存；</li>
<li>新生代：新生代内部会创建两个大小相同的Survivor区（from,to），Eden创建对象后经过一次Minor GC后就会被转移到某一个Survivor区，新生代使用复制算法来不断在两个Survivor区不断转移对象，直到被转移至老年代。</li>
<li>老年代：老年代会存放两种对象：<ul>
<li>1、创建时过大的对象会直接被分配到老年代</li>
<li>2、新生代经过可控次数（默认15次）转移后的对象会被下放到老年代<br>老年代的内存不足时使用Full GC(标记-清除)来进行内存回收。</li>
</ul>
</li>
</ul>
</li>
<li><p>直接内存：直接内存却别与Java堆，是直接向虚拟机进行申请内存的，所以读写性能会比Java堆更好，而且不会受JVM的参数Xms影响，所能分配的大小只取决于当前系统所能分配的最大内存。</p>
</li>
<li><p>垃圾回收系统：JVM的内存回收系统，用来处理JVM运行时已经不再引用的对象或者方法。用来保证JVM正常运行所需内存大小。JVM再GC时会对方法区和Java堆同时进行扫描和清理。</p>
</li>
<li><p>Java栈：每个虚拟机线线程都有一个私有的Java栈，在线程被创建时创建。其中保存帧信息，局部变量，方法参数，同时和Java方法调用和返回也有密切的关系。</p>
</li>
<li><p>本地方法栈：类似于Java栈，但是Java栈是用于方法的调用，而本地方法栈是用于本地方法的调用，JVM虚拟机允许Java的方法直接调用本地方法（native修饰的方法，其方法是由非Java构成的，用于与JVM以外的部分进行交互，比如硬件，操作系统等等）</p>
</li>
<li><p>PC寄存器（程序计数器）：每个线程都保存有一个私有的程序计数器，其内存空间占用非常小，实际上就是一个指针用来只想下一个将要执行的指令代码。</p>
</li>
<li><p>执行引擎：负责执行虚拟机的机器码，实际上Java在编译.java文件的时候会将其中方法和变量都编译成JVM的机器码的class文件，class文件其中存储的其实就是二进制的机器码。<br><img src="/assets/doc-images/jvm_structs.png" alt="JVM所有结构"><br>但是在实际运行时，JVM内存大致只会划分为五部分 方法区(线程共享)、Java堆(线程共享)、Java栈(线程私有)、本地方法栈(线程私有)、(程序计数器)</p>
</li>
</ul>
<h3 id="程序运行内存分配"><a href="#程序运行内存分配" class="headerlink" title="程序运行内存分配"></a>程序运行内存分配</h3><h2 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h2><p>在JVM中引用从强到弱分为四类强引用、软引用、弱引用、虚引用。</p>
<ul>
<li>强引用： 类似于 Object a = new Object()，只要a的生命周期没有结束或者a的指针没有指向null，该对象就永远不会被GC。</li>
<li>软引用：Java中使用SoftReference来时实现软引用，在内存充足的时候和强引用没有区别，在内存不足需要GC是，软引用会被GC回收。一般适用于缓存。memchare,JVM自带的缓存</li>
<li>弱引用：Java中使用WeakReference来实现弱引用，无论内存是否充足，在下一次GC的时候都会被回收。一般用在容器里，例如ThreadLocal，ThreadLocal中的ThreadLocalMap的Key是弱引用指向了ThreadLocal（Key被置为null但是其Value引用依然存在但是无法取出就会产生内存泄漏，所以使用完必须清空ThreadLocal）。</li>
<li>虚引用：JDK使用PhantomReference来实现虚引用，无法通过虚引用来获取实例对象，随时会被GC回收。虚引用的存在不会对对象的生存时间构成任何影响，为一个对象设置虚引用的唯一目的就是能在这个对象被收集器回收时收到一个系统通知。堆外内存</li>
</ul>
<h2 id="类加载"><a href="#类加载" class="headerlink" title="类加载"></a>类加载</h2><h3 id="加载流程"><a href="#加载流程" class="headerlink" title="加载流程"></a>加载流程</h3><p>装载–&gt;验证–&gt;准备–&gt;解析–&gt;初始化</p>
<h4 id="1-装载："><a href="#1-装载：" class="headerlink" title="1.装载："></a>1.装载：</h4><p>(1).通过一个类的全限定名来获取定义此类的二进制字节流。</p>
<p>(2).将这个字节流所代表的静态存储结构转化为方法区的运行时数据结构。</p>
<p>(3).在内存中生成一个代表这个类的java.lang.Class对象，作为方法区这个类的各种数据的访问入口。</p>
<h4 id="2-验证："><a href="#2-验证：" class="headerlink" title="2.验证："></a>2.验证：</h4><p>确定class文件字节流符合JVM要求，安检。主要检查其中文件格式（文件开头格式、版本号、变量类型、语义、符号等等）</p>
<h5 id="1-文件格式验证："><a href="#1-文件格式验证：" class="headerlink" title="1.文件格式验证："></a>1.文件格式验证：</h5><p>（1）是否以魔数0xCAFEBABE开头。<br>（2）主、次版本号是否在当前虚拟机处理范围之内。<br>（3）常量池的常量中是否有不被支持的常量类型（检查常量tag标志）。<br>（4）指向常量的各种索引值中是否有指向不存在的常量或不符合类型的常量。<br>（5）CONSTANT_Utf8_info型的常量中是否有不符合UTF8编码的数据。<br>（6）Class文件中各个部分及文件本身是否有被删除的或附加的其他信息。<br>……</p>
<h5 id="2-元数据验证："><a href="#2-元数据验证：" class="headerlink" title="2.元数据验证："></a>2.元数据验证：</h5><p>（1）这个类是否有父类（除了java.lang.Object之外，所有类都应当有父类）。<br>（2）这个类是否继承了不允许被继承的类（被final修饰的类）。<br>（3）如果这个类不是抽象类，是否实现了其父类或接口之中所要求实现的所有方法。<br>（4）类中的字段、方法是否与父类产生矛盾（例如覆盖了父类的final字段，或者出现不符合规则的方法重载，例如方法参数都一致，但返回值类型却不同等等）。<br>……</p>
<h5 id="3-字节码验证："><a href="#3-字节码验证：" class="headerlink" title="3.字节码验证："></a>3.字节码验证：</h5><p>主要目的是通过数据流和控制流分析，确定程序语义是合法的、符合逻辑的。这个阶段将对类的方法体进行校验分析，保证被校验类的方法在运行时不会产生危害虚拟机安全的事件，例如：<br>（1）保证任意时刻操作数栈的数据类型与指令代码序列都能配合工作，例如不会出现类似这样的情况：在操作数栈放置了一个int类型的数据，使用时却按long类型来加载入本地变量表中。<br>（2）保证跳转指令不会跳转到方法体以外的字节码指令上。<br>（3）保证方法体中的类型转换是有效的，例如可以把一个子类对象赋值给父类数据类型，但是把父类对象赋值给子类数据类型，甚至把对象赋值给与它毫无继承关系、完全不相干的一个数据类型，则是危险不合法的。<br>……<br>(Halting Problem:通过程序去校验程序逻辑是无法做到绝对准确的——不能通过程序准确的检查出程序是否能在有限时间之内结束运行。）</p>
<h5 id="4-符号引用验证："><a href="#4-符号引用验证：" class="headerlink" title="4.符号引用验证："></a>4.符号引用验证：</h5><p>符号引用验证可以看作是类对自身以外（常量池中的各种符号引用）的信息进行匹配性校验，通常需要校验以下内容：<br>（1）符号引用中通过字符串描述的全限定名是否能够找到对应的类。<br>（2）在指定类中是否存在符合方法的字段描述符以及简单名称所描述的方法和字段。<br>（3）符号引用中的类、字段、方法的访问性（private、protected、public、default）是否可被当前类访问。</p>
<h4 id="3-准备："><a href="#3-准备：" class="headerlink" title="3.准备："></a>3.准备：</h4><p>为类变量分配内存以及变量初始化，（static 修饰过的）。实例变量不在该阶段分配内存，在实际使用(New的时候进行在JVM堆中进行分配)。</p>
<p>public static final int value;<br>特例：在虚拟准备阶段进行ConstantValue进行赋值。</p>
<h4 id="4-解析："><a href="#4-解析：" class="headerlink" title="4.解析："></a>4.解析：</h4><p>虚拟机将常量池内的符号应用变成直接应用的过程；</p>
<p>符号引用：是一组符号用来描述所应用的目标，在Class文件中它以CONSTANT_Class_info、CONSTANT_Fieldref_info、CONSTANT_Methodref_info等类型的常量出现。应用的目标不一定加载到内存当中，例如在虚拟机编译时Java文件中应用的其他类的地址时候只能用符号来代替（在org.simpe.People类中引用了org.simple.Test 类，在编译的时候实际上虚拟机很可能不知道Test类的地址，所以在编译的时候会将该类用符号进行代替，在Jvm在解析时再进行转换）各种虚拟机实现的内存布局可能有所不同，但是它们能接受的符号引用都是一致的，因为符号引用的字面量形式明确定义在Java虚拟机规范的Class文件格式中。</p>
<p>直接应用：</p>
<p>（1）直接指向目标的指针（比如，指向“类型”【Class对象】、类变量、类方法的直接引用可能是指向方法区的指针）</p>
<p>（2）相对偏移量（比如，指向实例变量、实例方法的直接引用都是偏移量）</p>
<p>（3）一个能间接定位到目标的句柄</p>
<p>直接引用是和虚拟机的布局相关的，同一个符号引用在不同的虚拟机实例上翻译出来的直接引用一般不会相同。如果有了直接引用，那引用的目标必定已经被加载入内存中了。</p>
<h4 id="5-初始化："><a href="#5-初始化：" class="headerlink" title="5.初始化："></a>5.初始化：</h4><p>类加载的最后一步，开始执行class中定义的Java代码，其中在涉及到静态变量以及静态代码块时有些地方需要注意：</p>
<p>（1）编译器收集的顺序是由代码编写的顺序决定的，静态代码块中只能访问到定义在在惊呆代码块之前的的变量，而在他之后的变量只能赋值不能访问。</p>
<p>（2）初始化方法执行的顺序：JVM会保证子类初始化方法执行之前父类的初始化执行方法已经执行完毕，所以父类的静态语句执行顺序会优先于子类静态语句。</p>
<p>（3）clinit()对于类和方法来说不是必须的，如果类和方法中没有静态语句则不会为这个类生成cilnit 方法。</p>
<p>(<clinit>方法是由编译器自动收集的，包括所有类变量（静态非final）赋值和静态语句块（static{}）)</p>
<p>（4）接口中不能使用静态语句块，接口的实现类也不会执行接口的clinit方法。父类接口中使用到定义变量在初始化阶段也子类接口也不会执行父类接口，只有在使用时才会执行。</p>
<p>（5）虚拟机会保证一个类的clinit()方法在多线程环境中被正确的加锁同步，如果多线程同时去初始化同一个变量则只有一个线程成功同步，其他线程进入阻塞。</p>
<h3 id="类加载器"><a href="#类加载器" class="headerlink" title="类加载器"></a>类加载器</h3><p>类加载器负责将二进制的字节文件加载到内存当中并生成一个java.lang.Class对象，一单一个类被加载到内存中这个类就不会被其他加载器加载。一个类在JVM中使用全限定名(包名+类名)作为唯一标识。JVM预定义的有三种类加载器：</p>
<ul>
<li>根类加载器(Bootstrap Class Loader)：该加载器用来加载Java的核心类，但并不继承java.lang.ClassLoader（该加载器负责加载java环境变量下/jre/lit/rt.jar中的class,有C++实现，所以不是ClassLoader类）。</li>
<li>扩展类加载器(Extensions Class Loader)：该加载器负责加载JRE的扩展目录，/lib/ext或者有java.ext.dirs系统属性指定目录下的JRE包。Java实现，父加载器为根类加载器，但是因为BootstrapClassLoader不是使用Java实现的所以无法继承，只能引用。</li>
<li>系统加载器(System Class Loader)：该加载器也被称为应用加载器，负责加载JVM启动参数-classpath、java.class.path或CLASSPATH所指定目录下的JRE包。父类是ExtClassLoader。也是所有自定义类加载器的父类。</li>
<li>自定义类加载器：继承ClassLoader类。<ul>
<li>findClass()方法用来实现双亲委派机制中该层加载器加载类的逻辑，即父类加载器加载失败再调用子类的findClass()；</li>
<li>createClass()方法直接加载类，因为直接获取对应Class的二进制文件所以不会再向父类加载器提交加载任务；<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyClassLoader</span> <span class="keyword">extends</span> <span class="title class_">ClassLoader</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String mLibPath;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyClassLoader</span><span class="params">(String path)</span> &#123;</span><br><span class="line">        mLibPath = path;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 双亲委派逻辑，父加载器读不到Class才会调用此方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt; findClass(String name) <span class="keyword">throws</span> ClassNotFoundException&#123;</span><br><span class="line">        <span class="type">byte</span>[] data;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            data = readClassFile( name);</span><br><span class="line">            <span class="keyword">return</span> defineClass(name,data,<span class="number">0</span>,data.length);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.findClass(name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 绕过双亲委派逻辑，直接获取Class</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Class&lt;?&gt; createClass(String name) <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">byte</span>[] data;</span><br><span class="line">        data = readClassFile(name);</span><br><span class="line">        <span class="keyword">return</span> defineClass(name,data,<span class="number">0</span>,data.length);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 读取Class文件</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">byte</span>[] readClassFile(String name) <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">fileName</span> <span class="operator">=</span> getFileName(name);</span><br><span class="line">        <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(mLibPath,fileName);</span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">is</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(file);</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">bos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> ((len = is.read()) != -<span class="number">1</span>) &#123;</span><br><span class="line">            bos.write(len);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">byte</span>[] data = bos.toByteArray();</span><br><span class="line">        is.close();</span><br><span class="line">        bos.close();</span><br><span class="line">        <span class="keyword">return</span> data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取要加载 的class文件名</span></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">getFileName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> name.lastIndexOf(<span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span>(index == -<span class="number">1</span>)&#123; </span><br><span class="line">            <span class="keyword">return</span> name+<span class="string">&quot;.class&quot;</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> name.substring(index+<span class="number">1</span>)+<span class="string">&quot;.class&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h3 id="类加载机制"><a href="#类加载机制" class="headerlink" title="类加载机制"></a>类加载机制</h3><ul>
<li>全盘负责：一个加载器加载了某个类则该类的依赖类和引用其他类都由该加载器进行加载，除非这些类中显示使用其他加载器来加载；</li>
<li>双亲委派：一个类的加载总是先由父加载器进行加载，如果父类无法加载该类则子类加载器再进行加载。假设JVM加载器除了三种预设加载器再加上一个用户自定义的加载器，当JVM需要加载某一个Class时首先自定义加载器收到加载任务，先向上传递让systemClassLoader进行加载，systemClassLoader存在父类的加载器把加载任务继续上传到父类加载器，extClassLoader收到加载器任务查询自己的加载目录下是否存在该类，如果不存在则再让子类进行加载……..<br>(PS：双亲委派机制优点在于使JVM加载器保持层级关系，不会出现重复加载问题，其次就是安全问题，Java核心API定义的类型不会被篡改，当出现自定义java.lang.Integer类是，加载器因为首先使用父类加载器所以不会加载当前自定义的Integer类)。</li>
<li>缓存：所有被加载过的Class都会被暂存再JVM的缓存，当类加载器要加载某一个Class的时候会先搜索缓存区，再去搜索对应目录。这就是为什么修改了Class必须要重启JVM，否则JVM不会重新加载修改后的类。</li>
</ul>
<h2 id="GC"><a href="#GC" class="headerlink" title="GC"></a>GC</h2><p>JVM为维持足够的运行内存，会实时的进行垃圾回收。其中GC会分为两个部分：搜索需要回收的对象，回收对象<br>虚拟机启动时分配并占用大部分内存，线程共享。其中堆内存在分为Eden区，新生代，老年代。<br>Eden区：负责收容新生对象，但是若是创建时需要较大内存则会被直接交给老年代进行分配内存；<br>新生代：新生代内部会创建两个大小相同的Survivor区（from,to），Eden创建对象后经过一次Minor GC后就会被转移到某一个Survivor区，新生代使用复制算法来不断在两个Survivor区不断转移对象，直到被转移至老年代。<br>老年代：老年代会存放两种对象：<br>1、创建时过大的对象会直接被分配到老年代<br>2、新生代经过可控次数（默认15次,因为再每个对象的头部只有4位用来记录该对象年代次数）转移后的对象会被下放到老年代<br><img src="/assets/doc-images/jvm_heap_memory.png" alt="Java堆内存"></p>
<h3 id="判断回收对象算法"><a href="#判断回收对象算法" class="headerlink" title="判断回收对象算法"></a>判断回收对象算法</h3><h4 id="1、引用计数法："><a href="#1、引用计数法：" class="headerlink" title="1、引用计数法："></a>1、引用计数法：</h4><pre><code>给每个创建出来的对象增加一个引用计数器，有新引用时+1，当引用失效是-1，当GC是如果是引用计数器为0则被回收掉，这个回收机制速度快，判断效率高，但是对于循环引用无法做到判断会产生内存堆积导致内存不足。
</code></pre>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">例子：</span><br><span class="line">    <span class="type">Object</span> <span class="variable">a</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">    <span class="type">Object</span> <span class="variable">b</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">    a = b;</span><br><span class="line">    b= a;</span><br><span class="line">    a = b = <span class="literal">null</span>;     <span class="comment">//无法GC a,b</span></span><br></pre></td></tr></table></figure>

<h4 id="2、可达性分析算法："><a href="#2、可达性分析算法：" class="headerlink" title="2、可达性分析算法："></a>2、可达性分析算法：</h4><p>通过一组GC Root作为起点，从这些起点向下进行搜索，向下搜索的路径称为引用链，对于没有引用链的GC Root对象称为不可用。<br>GC Root判定：<br>1.虚拟机栈（栈帧中本地变量表）引用的对象    –&gt; new 出来的对象<br>2.方法区中静态引用变量                    –&gt; static<br>3.方法区中常量应用变量                    –&gt; 方法或者类中定义的变量<br>4.本地方法栈（Native方法）中JNI引用对象<br>缺点：实现复杂，大量引用链分析会消耗大量的时间，且分析引用是否有效时会stw,所以会增加程序卡顿时间<br><img src="/assets/doc-images/gc.png" alt="在这里插入图片描述"></p>
<h3 id="垃圾回收算法"><a href="#垃圾回收算法" class="headerlink" title="垃圾回收算法"></a>垃圾回收算法</h3><ul>
<li>标记清除<br><img src="/assets/doc-images/gc_2.png" alt="标记清除"><ul>
<li>优点：<br>简单<br>其他都是基于这个算法进行的改性。</li>
<li>缺点：<br>效率问题，标记的和清除的效率都不高<br>空间问题，标记清除会产生大量的内存碎片，内存碎片可能存在的问题是：当有大对象需要分配时，找不到足够大的连续内存而不得不提前触发另一次垃圾收集动作。</li>
</ul>
</li>
<li>复制算法<br>它将内存按容量划分为大小相等的两块，每次只使用其中的一块。当这一块内存用完了，就将还存活的对象复制到另一块上面，然后再把已使用过的空间一次清理掉。<br><img src="/assets/doc-images/gc_3.png" alt="复制算法"></li>
<li>标记整理<br>标记阶段与 标记-清除算法 一样，但是整理阶段并不是对可回收对象进行清理，而是：让所有存活的对象向一端移动，然后直接清理掉端边界以外的内存。适用于对象存活率比较高的场景。<br><img src="/assets/doc-images/gc_4.png" alt="标记整理算法"><h3 id="GC-垃圾回收器"><a href="#GC-垃圾回收器" class="headerlink" title="GC 垃圾回收器"></a>GC 垃圾回收器</h3>除Epsilon ZGC Shenandoah之外的GC都是使用逻辑分代模型,G1是逻辑分代，物理不分代,  除此之外不仅逻辑分代，而且物理分代<br><img src="/assets/doc-images/gc_5.png" alt="在这里插入图片描述"><br>常见的组合<br>Serial+Serial Old<br>CMS + ParNew<br>Paraller Scavenge+Parallel Old<h4 id="1、Serial收集器"><a href="#1、Serial收集器" class="headerlink" title="1、Serial收集器"></a>1、Serial收集器</h4>单线程收集器，再进行GC时会暂停其他所有工作线程直到手机结束。造成效果就是如果内存较小会频繁GC且在GC的时候会造成程序卡顿。适用于client模式下的JVM，该模式下更注重速度（编译，启动）。在进行GC的时候新生代<br>采用负责算法，年老代使用标记整理算法进行回收。<br>单CPU效率最高</li>
</ul>
<h4 id="2、ParNew收集器"><a href="#2、ParNew收集器" class="headerlink" title="2、ParNew收集器"></a>2、ParNew收集器</h4><p>多线程版本的Serial收集器，该收集器在默认启东时会开启CPU核数相同的线程。多线程GC可以提高处理速度速度，缩减程序工作线程卡顿时间</p>
<h4 id="3、Parallel-Scavenge收集器"><a href="#3、Parallel-Scavenge收集器" class="headerlink" title="3、Parallel Scavenge收集器"></a>3、Parallel Scavenge收集器</h4><p>该收集器是适用于新生代收集器，使用复制算法。与ParNew收集器以减少卡顿时间为目的不同，Parallel Scavenge收集器更注重吞吐量的控制，在启动时可以控制多个收集器性能参数，例如：<br>-XX：MAXGCPauseMills 最大垃圾收集停顿时间<br>-XX：GCTimeRatio 最大吞吐量<br>-Xmn：新生代大小<br>-XX：SuvivorRatio Eden与Ser<br>-XX：PretenureSizeThreshold 晋升老年代对象大小<br>等等</p>
<h4 id="4、Serial-Old-收集器"><a href="#4、Serial-Old-收集器" class="headerlink" title="4、Serial Old 收集器"></a>4、Serial Old 收集器</h4><p>Serial收集器的老年版本，标记整理算法GC。</p>
<h4 id="5、Parallel-Old-收集器"><a href="#5、Parallel-Old-收集器" class="headerlink" title="5、Parallel Old 收集器"></a>5、Parallel Old 收集器</h4><p>Parallel Scavenge收集器老年版本，JDK1.6才开始加入，多线程版本标记整理。</p>
<h4 id="6、CMS-Concurrent-mark-sweep-收集器"><a href="#6、CMS-Concurrent-mark-sweep-收集器" class="headerlink" title="6、CMS(Concurrent mark sweep)收集器"></a>6、CMS(Concurrent mark sweep)收集器</h4><p>目的最大程度缩短收集器执行造成卡顿时间，基于标记清除算法，执行GC步骤：初始标记（标记GC Root可以直接关联的对象）–&gt;并发标记（GC Root Tracing）–&gt;重新标记(修整并发标记期间因为继续操作而露的被回收的对象，查漏补缺)-&gt;并发删除（标记完成统一删除）。<br>（初始标记与重新标记需要Stop All World ，其中重新标记时间比初始标记长，并发标记时间短）<br>缺点：<br>1、并发标记虽然不会占用工作线程时间，但是在并发执行会消耗掉很多内存，所以还是会对系统产生一定的性能影响。<br>2、无法处理浮动垃圾，浮动垃圾产生是因为在并发清除的时候没有暂停工作线程所以在清除的同时还是会产生新垃圾，这部分出现在该次标记之后所以无法处理。<br>3、标记清除算法会导致大量的内存碎片当没有连续的大空间来支持分配的时候会触发提前触发Full FC。<br><img src="/assets/doc-images/gc_6.png" alt="在这里插入图片描述"></p>
<h4 id="7、G1收集器"><a href="#7、G1收集器" class="headerlink" title="7、G1收集器"></a>7、G1收集器</h4><p>优点：<br>1、并行与并发：充分利用多CPU以及多核环境优势。使用多个CPU来缩短stop-the-word停顿时间，部分收集器原本需要停顿Java线程来执行GC动作G1收集器可以通过并发方式让Java程序继续运行。<br>2、分代收集：管理整个Java堆，采用不同方式去处理创建的新对象和已经存活一段时间熬过多次GC的旧对象。<br>3、空间整合：G1运行不会产生空间碎片。<br>4、可预测的停顿：除了减少停顿时间还会建立可预测停顿时间模型，能让明确一个长度为M毫秒的时间内消耗在垃圾收集上的时间不能超过N毫秒。</p>
<p>执行GC顺序 初始标记–&gt;并发标记–&gt;最终标记（其他和CMS相似增加合并Remembered Log 到Remembered Set中）–&gt;筛选回收（根据回收价值和成本指定进行排序指定计划并整理内存空间）</p>
<h4 id="G1-和-CMS-不同点"><a href="#G1-和-CMS-不同点" class="headerlink" title="G1 和 CMS 不同点"></a>G1 和 CMS 不同点</h4><p>1.使用范围：CMS是老年代收集器，会配合Serial或者ParNew收集器一起使用；G1收集器范围老年代和新生代，不需要配合其他收集器使用<br>2.STW时间：CMS以最小停顿时间为目标，所以在初始标记和重复标记阶段stw时间会非常短，但是可能会频繁触发FULL GC； G1可以预测停顿时间建立stw时间模型<br>3.垃圾碎片：CMS使用标记-清除算法所以会产生很多空间碎片；G1使用标记-整理算法，在GC时会不断整理空间，所以触发FULL GC频率低。<br>4.回收过程：</p>
<h2 id="JVM-1"><a href="#JVM-1" class="headerlink" title="JVM"></a>JVM</h2><h2 id="问题："><a href="#问题：" class="headerlink" title="问题："></a>问题：</h2><h4 id="对象创建过程？"><a href="#对象创建过程？" class="headerlink" title="对象创建过程？"></a>对象创建过程？</h4><ul>
<li>class loading 加载类文件到内存中</li>
<li>class linking（cerification,prepartion,resoluting） 创建类连接</li>
</ul>
<ol>
<li>Verification<ol>
<li>验证文件是否符合JVM规定</li>
</ol>
</li>
<li>Preparation<ol>
<li>静态成员变量赋默认值</li>
</ol>
</li>
<li>Resolution<ol>
<li>将类、方法、属性等符号引用解析为直接引用<br>常量池中的各种符号引用解析为指针、偏移量等内存地址的直接引用</li>
</ol>
</li>
</ol>
<ul>
<li>class intializing 调用类初始化代码 <clinit>，给静态成员变量赋初始值</li>
<li>向堆和栈申请对象内存</li>
<li>成员变量赋默认值</li>
<li>调用构造方法<ol>
<li>成员变量顺序赋初始值</li>
<li>执行构造方法语句<ol>
<li>super()</li>
<li>本类的构造方法<br><img src="/assets/doc-images/gc_7.png" alt="在这里插入图片描述"></li>
</ol>
</li>
</ol>
</li>
</ul>
<h3 id="对象中存储布局"><a href="#对象中存储布局" class="headerlink" title="对象中存储布局?"></a>对象中存储布局?</h3><h4 id="普通对象"><a href="#普通对象" class="headerlink" title="普通对象"></a>普通对象</h4><ol>
<li>对象头：markword  8</li>
<li>ClassPointer指针：-XX:+UseCompressedClassPointers 为4字节 不开启为8字节</li>
<li>实例数据<ol>
<li>引用类型：-XX:+UseCompressedOops 为4字节 不开启为8字节<br>Oops Ordinary Object Pointers</li>
</ol>
</li>
<li>Padding对齐，8的倍数</li>
</ol>
<h4 id="数组对象"><a href="#数组对象" class="headerlink" title="数组对象"></a>数组对象</h4><ol>
<li>对象头：markword 8</li>
<li>ClassPointer指针同上</li>
<li>数组长度：4字节</li>
<li>数组数据</li>
<li>对齐 8的倍数</li>
</ol>
<h3 id="对象怎么定位？"><a href="#对象怎么定位？" class="headerlink" title="对象怎么定位？"></a>对象怎么定位？</h3><p>1.句柄池：<br>2.直接引用：</p>
<h3 id="对象分配"><a href="#对象分配" class="headerlink" title="对象分配"></a>对象分配</h3><p><img src="/assets/doc-images/gc_8.png" alt="在这里插入图片描述"></p>
<h2 id="JVM调优"><a href="#JVM调优" class="headerlink" title="JVM调优"></a>JVM调优</h2><p>#JDK 命令</p>
<h3 id="jsp"><a href="#jsp" class="headerlink" title="jsp"></a>jsp</h3><p>查看当前正在运行的java进程<br>也可以用 ps -ef | grep java来代替</p>
<h3 id="jinfo"><a href="#jinfo" class="headerlink" title="jinfo"></a>jinfo</h3><p>查看pid的JVM的所有信息</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">jinfo -flags &lt;name&gt; &lt;pid&gt;</span><br><span class="line"></span><br><span class="line">jinfo -flags 7</span><br><span class="line">jinfo 7</span><br><span class="line">Attaching to process ID 7, please <span class="built_in">wait</span>...</span><br><span class="line">Debugger attached successfully.</span><br><span class="line">Server compiler detected.</span><br><span class="line">JVM version is 25.131-b11</span><br><span class="line">Java System Properties:</span><br><span class="line"></span><br><span class="line">java.runtime.name = Java(TM) SE Runtime Environment</span><br><span class="line">java.vm.version = 25.131-b11</span><br><span class="line">sun.boot.library.path = /usr/lib/jvm/java-8-oracle/jre/lib/amd64</span><br><span class="line">java.protocol.handler.pkgs = org.springframework.boot.loader</span><br><span class="line">java.vendor.url = http://java.oracle.com/</span><br><span class="line">java.vm.vendor = Oracle Corporation</span><br><span class="line">path.separator = :</span><br><span class="line">file.encoding.pkg = sun.io</span><br><span class="line">java.vm.name = Java HotSpot(TM) 64-Bit Server VM</span><br><span class="line">sun.os.patch.level = unknown</span><br><span class="line">sun.java.launcher = SUN_STANDARD</span><br><span class="line">user.dir = /</span><br><span class="line">java.vm.specification.name = Java Virtual Machine Specification</span><br><span class="line">PID = 7</span><br><span class="line">java.runtime.version = 1.8.0_131-b11</span><br><span class="line">java.awt.graphicsenv = sun.awt.X11GraphicsEnvironment</span><br><span class="line">os.arch = amd64</span><br><span class="line">java.endorsed.dirs = /usr/lib/jvm/java-8-oracle/jre/lib/endorsed</span><br><span class="line">org.jboss.logging.provider = slf4j</span><br><span class="line">line.separator =</span><br><span class="line"></span><br><span class="line">java.io.tmpdir = /tmp</span><br><span class="line">java.vm.specification.vendor = Oracle Corporation</span><br><span class="line">os.name = Linux</span><br><span class="line">LOG_LEVEL_PATTERN = %5p [bootstrap,%X&#123;X-B3-TraceId:-&#125;,%X&#123;X-B3-SpanId:-&#125;,%X&#123;X-Span-Export:-&#125;]</span><br><span class="line">sun.jnu.encoding = UTF-8</span><br><span class="line">java.library.path = /usr/java/packages/lib/amd64:/usr/lib64:/lib64:/lib:/usr/lib</span><br><span class="line">spring.beaninfo.ignore = <span class="literal">true</span></span><br><span class="line">com.netflix.servo.DefaultMonitorRegistry.registryClass = com.netflix.servo.BasicMonitorRegistry</span><br><span class="line">java.specification.name = Java Platform API Specification</span><br><span class="line">java.class.version = 52.0</span><br><span class="line">sun.management.compiler = HotSpot 64-Bit Tiered Compilers</span><br><span class="line">os.version = 3.10.0-514.21.1.el7.x86_64</span><br><span class="line">user.home = /root</span><br><span class="line">user.timezone = Asia/Shanghai</span><br><span class="line">catalina.useNaming = <span class="literal">false</span></span><br><span class="line">java.awt.printerjob = sun.print.PSPrinterJob</span><br><span class="line">file.encoding = UTF-8</span><br><span class="line">@appId = zby-svc-order</span><br><span class="line">java.specification.version = 1.8</span><br><span class="line">catalina.home = /tmp/tomcat.3003963976752067956.19004</span><br><span class="line">user.name = root</span><br><span class="line">java.class.path = /opt/app.jar</span><br><span class="line">java.vm.specification.version = 1.8</span><br><span class="line">sun.arch.data.model = 64</span><br><span class="line">sun.java.command = /opt/app.jar</span><br><span class="line">java.home = /usr/lib/jvm/java-8-oracle/jre</span><br><span class="line">user.language = en</span><br><span class="line">java.specification.vendor = Oracle Corporation</span><br><span class="line">awt.toolkit = sun.awt.X11.XToolkit</span><br><span class="line">java.vm.info = mixed mode</span><br><span class="line">java.version = 1.8.0_131</span><br><span class="line">java.ext.dirs = /usr/lib/jvm/java-8-oracle/jre/lib/ext:/usr/java/packages/lib/ext</span><br><span class="line">sun.boot.class.path = /usr/lib/jvm/java-8-oracle/jre/lib/resources.jar:/usr/lib/jvm/java-8-oracle/jre/lib/rt.jar:/usr/lib/jvm/java-8-oracle/jre/lib/sunrsasign.jar:/usr/lib/jvm/java-8-oracle/jre/lib/jsse.jar:/usr/lib/jvm/java-8-oracle/jre/lib/jce.jar:/usr/lib/jvm/java-8-oracle/jre/lib/charsets.jar:/usr/lib/jvm/java-8-oracle/jre/lib/jfr.jar:/usr/lib/jvm/java-8-oracle/jre/classes</span><br><span class="line">java.awt.headless = <span class="literal">true</span></span><br><span class="line">java.vendor = Oracle Corporation</span><br><span class="line">catalina.base = /tmp/tomcat.3003963976752067956.19004</span><br><span class="line">file.separator = /</span><br><span class="line">java.security.egd = file:/dev/./urandom</span><br><span class="line">java.vendor.url.bug = http://bugreport.sun.com/bugreport/</span><br><span class="line">sun.io.unicode.encoding = UnicodeLittle</span><br><span class="line">sun.cpu.endian = little</span><br><span class="line">sun.cpu.isalist =</span><br><span class="line"></span><br><span class="line">VM Flags:</span><br><span class="line">Non-default VM flags: -XX:CICompilerCount=4 -XX:InitialHeapSize=536870912 -XX:MaxHeapSize=1073741824 -XX:MaxNewSize=357564416 -XX:MetaspaceSize=134217728 -XX:MinHeapDeltaBytes=524288 -XX:NewSize=178782208 -XX:OldSize=358088704 -XX:+UseCompressedClassPointers -XX:+UseCompressedOops -XX:+UseParallelGC</span><br><span class="line">Command line:  -Djava.security.egd=file:/dev/./urandom -Dfile.encoding=UTF-8 -Duser.timezone=Asia/Shanghai -Xms512m -Xmx1024m -XX:MetaspaceSize=128m</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="jmap"><a href="#jmap" class="headerlink" title="jmap"></a>jmap</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">jmap [option] &lt;pid&gt;</span><br><span class="line">        (to connect to running process)</span><br><span class="line">    jmap [option] &lt;executable &lt;core&gt;</span><br><span class="line">        (to connect to a core file)</span><br><span class="line">    jmap [option] [server_id@]&lt;remote server IP or hostname&gt;</span><br><span class="line">        (to connect to remote debug server)</span><br><span class="line"></span><br><span class="line"><span class="built_in">where</span> &lt;option&gt; is one of:</span><br><span class="line">    &lt;none&gt;               <span class="comment">##  打印操作系统内存</span></span><br><span class="line">    -heap                <span class="comment">##  打印java虚拟机堆信息</span></span><br><span class="line">    -histo[:live]        to <span class="built_in">print</span> histogram of java object heap; <span class="keyword">if</span> the <span class="string">&quot;live&quot;</span></span><br><span class="line">                         suboption is specified, only count live objects</span><br><span class="line">    -clstats             to <span class="built_in">print</span> class loader statistics</span><br><span class="line">    -finalizerinfo       to <span class="built_in">print</span> information on objects awaiting finalization</span><br><span class="line">    -dump:&lt;dump-options&gt; to dump java heap <span class="keyword">in</span> hprof binary format</span><br><span class="line">                         dump-options:</span><br><span class="line">                           live         dump only live objects; <span class="keyword">if</span> not specified,</span><br><span class="line">                                        all objects <span class="keyword">in</span> the heap are dumped.</span><br><span class="line">                           format=b     binary format</span><br><span class="line">                           file=&lt;file&gt;  dump heap to &lt;file&gt;</span><br><span class="line">                         Example: jmap -dump:live,format=b,file=heap.bin &lt;pid&gt;</span><br><span class="line">    -F                   force. Use with -dump:&lt;dump-options&gt; &lt;pid&gt; or -histo</span><br><span class="line">                         to force a heap dump or histogram when &lt;pid&gt; does not</span><br><span class="line">                         respond. The <span class="string">&quot;live&quot;</span> suboption is not supported</span><br><span class="line">                         <span class="keyword">in</span> this mode.</span><br><span class="line">    -h | -<span class="built_in">help</span>           to <span class="built_in">print</span> this <span class="built_in">help</span> message</span><br><span class="line">    -J&lt;flag&gt;             to pass &lt;flag&gt; directly to the runtime system</span><br></pre></td></tr></table></figure>

<h4 id="jmap-–heap"><a href="#jmap-–heap" class="headerlink" title="jmap –heap"></a>jmap –heap</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">ttaching to process ID 7, please <span class="built_in">wait</span>...</span><br><span class="line">Debugger attached successfully.</span><br><span class="line">Server compiler detected.</span><br><span class="line">JVM version is 25.131-b11</span><br><span class="line"></span><br><span class="line">using thread-local object allocation.</span><br><span class="line">Parallel GC with 10 thread(s)</span><br><span class="line"></span><br><span class="line">Heap Configuration:</span><br><span class="line">   MinHeapFreeRatio         = 0   <span class="comment">#  指定 jvm heap 在使用率小于 n 的情况下 ,heap 进行收缩 ,Xmx==Xms 的情况下无效 , 如 :-XX:MinHeapFreeRatio=30 </span></span><br><span class="line">   MaxHeapFreeRatio         = 100  <span class="comment"># jvm heap 在使用率大于 n 的情况下 ,heap 进行扩张 ,Xmx==Xms 的情况下无效 , 如 :-XX:MaxHeapFreeRatio=70</span></span><br><span class="line">   MaxHeapSize              = 1073741824 (1024.0MB) <span class="comment">## JVM 堆空间允许的最大值。</span></span><br><span class="line">   NewSize                  = 178782208 (170.5MB) <span class="comment">## JVM 新生代堆空间的默认值。</span></span><br><span class="line">   MaxNewSize               = 357564416 (341.0MB)  <span class="comment">## JVM 新生代堆空间允许的最大值。</span></span><br><span class="line">   OldSize                  = 358088704 (341.5MB)  <span class="comment">## JVM 老年代堆空间的默认值。</span></span><br><span class="line">   NewRatio                 = 2   <span class="comment">##  新生代（2个Survivor区和Eden区 ）与老年代（不包括永久区）的堆空间比值，表示新生代：老年代=1：2</span></span><br><span class="line">   SurvivorRatio            = 8    <span class="comment">## 两个Survivor区和Eden区的堆空间比值为 8，表示 S0 ： S1 ：Eden = 1：1：8。</span></span><br><span class="line">   MetaspaceSize            = 134217728 (128.0MB)   <span class="comment">## JVM 元空间的默认值。</span></span><br><span class="line">   CompressedClassSpaceSize = 1073741824 (1024.0MB)</span><br><span class="line">   MaxMetaspaceSize         = 17592186044415 MB  <span class="comment">## JVM 元空间允许的最大值。</span></span><br><span class="line">   G1HeapRegionSize         = 0 (0.0MB)  <span class="comment">## 在使用 G1 垃圾回收算法时，JVM 会将 Heap 空间分隔为若干个 Region，该参数用来指定每个 Region 空间的大小。</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Heap Usage:</span><br><span class="line">PS Young Generation</span><br><span class="line">Eden Space:                           <span class="comment">## Eden区</span></span><br><span class="line">   capacity = 166723584 (159.0MB)</span><br><span class="line">   used     = 129490176 (123.491455078125MB)</span><br><span class="line">   free     = 37233408 (35.508544921875MB)</span><br><span class="line">   77.66758181014151% used</span><br><span class="line">From Space:                           <span class="comment">##S0区</span></span><br><span class="line">   capacity = 5767168 (5.5MB)</span><br><span class="line">   used     = 3573264 (3.4077301025390625MB)</span><br><span class="line">   free     = 2193904 (2.0922698974609375MB)</span><br><span class="line">   61.95872913707387% used</span><br><span class="line">To Space:                            <span class="comment">##S0区</span></span><br><span class="line">   capacity = 5767168 (5.5MB)</span><br><span class="line">   used     = 0 (0.0MB)</span><br><span class="line">   free     = 5767168 (5.5MB)</span><br><span class="line">   0.0% used</span><br><span class="line">PS Old Generation                        <span class="comment">## 老年代</span></span><br><span class="line">   capacity = 358088704 (341.5MB)</span><br><span class="line">   used     = 216992832 (206.94049072265625MB)</span><br><span class="line">   free     = 141095872 (134.55950927734375MB)</span><br><span class="line">   60.59750826432101% used</span><br></pre></td></tr></table></figure>

<h4 id="jmap-histo"><a href="#jmap-histo" class="headerlink" title="jmap histo"></a>jmap histo</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 打印虚拟机中对象统计，对象数内存大小等信息，如果加live则先会触发GC在进行统计</span></span><br><span class="line">jmap -histo:live 7 | grep order | <span class="built_in">head</span> -n 10</span><br><span class="line">1066:            24            960  com.zby.svc.order.enums.PlatformEnum</span><br><span class="line">1278:            18            576  com.zby.svc.order.enums.OrderStatusEnum</span><br><span class="line">1429:            13            416  com.zby.svc.order.enums.AmazonMarketPlaceEnum</span><br><span class="line">1513:            15            360  com.zby.svc.order.rabbitmq.RabbitmqConfiguration$$EnhancerBySpringCGLIB$$6733408c$$FastClassBySpringCGLIB$<span class="variable">$98f92401</span></span><br><span class="line">1514:            15            360  com.zby.svc.order.rabbitmq.RabbitmqConfiguration$$FastClassBySpringCGLIB$<span class="variable">$2d563b40</span></span><br><span class="line">1661:             1            280  com.zby.svc.order.rabbitmq.consumer.BillOpsLoggingQueueConsumer</span><br><span class="line">1662:             1            280  com.zby.svc.order.rabbitmq.consumer.CommonOpsLoggingQueueConsumer</span><br><span class="line">1663:             1            280  com.zby.svc.order.rabbitmq.consumer.CrossModuleQueueConsumer</span><br><span class="line">1910:             1            184  com.zby.svc.order.service.impl.OrderServiceImpl$$EnhancerBySpringCGLIB$<span class="variable">$98658e15</span></span><br><span class="line">2099:             1            152  com.zby.svc.order.service.impl.AfterSaleServiceImpl$$EnhancerBySpringCGLIB$<span class="variable">$c9da1536</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="jmap-clstats"><a href="#jmap-clstats" class="headerlink" title="jmap clstats"></a>jmap clstats</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 打印JVM中classLoader信息</span></span><br></pre></td></tr></table></figure>

<h4 id="jmap-finalizerinfo"><a href="#jmap-finalizerinfo" class="headerlink" title="jmap finalizerinfo"></a>jmap finalizerinfo</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 打印等待回收对象信息 实际上在JVM进行GC时都会调用对象的finalizer方法，（对象自救逻辑）</span></span><br><span class="line">jmap -finalizerinfo 7</span><br><span class="line">Attaching to process ID 7, please <span class="built_in">wait</span>...</span><br><span class="line">Debugger attached successfully.</span><br><span class="line">Server compiler detected.</span><br><span class="line">JVM version is 25.131-b11</span><br><span class="line">Number of objects pending <span class="keyword">for</span> finalization: 0</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="jmap-dump"><a href="#jmap-dump" class="headerlink" title="jmap dump"></a>jmap dump</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 导出JVM中整个内存的文件信息</span></span><br><span class="line">jmap -dump:live,format=b,file=heap.bin &lt;pid&gt;</span><br><span class="line"></span><br><span class="line">jmap -dump:live,format=utf8,file=heap.txt 7</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="jstat"><a href="#jstat" class="headerlink" title="jstat"></a>jstat</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">jstat -option</span><br><span class="line">invalid argument count</span><br><span class="line">Usage: jstat -<span class="built_in">help</span>|-options</span><br><span class="line">       jstat -&lt;option&gt; [-t] [-h&lt;lines&gt;] &lt;vmid&gt; [&lt;interval&gt; [&lt;count&gt;]]</span><br><span class="line"></span><br><span class="line">Definitions:</span><br><span class="line">  &lt;option&gt;      An option reported by the -options option</span><br><span class="line">  &lt;vmid&gt;        Virtual Machine Identifier. A vmid takes the following form:</span><br><span class="line">                     &lt;lvmid&gt;[@&lt;hostname&gt;[:&lt;port&gt;]]</span><br><span class="line">                Where &lt;lvmid&gt; is the <span class="built_in">local</span> vm identifier <span class="keyword">for</span> the target</span><br><span class="line">                Java virtual machine, typically a process <span class="built_in">id</span>; &lt;hostname&gt; is</span><br><span class="line">                the name of the host running the target Java virtual machine;</span><br><span class="line">                and &lt;port&gt; is the port number <span class="keyword">for</span> the rmiregistry on the</span><br><span class="line">                target host. See the jvmstat documentation <span class="keyword">for</span> a more complete</span><br><span class="line">                description of the Virtual Machine Identifier.</span><br><span class="line">  &lt;lines&gt;       Number of samples between header lines.</span><br><span class="line">  &lt;interval&gt;    Sampling interval. The following forms are allowed:</span><br><span class="line">                    &lt;n&gt;[<span class="string">&quot;ms&quot;</span>|<span class="string">&quot;s&quot;</span>]</span><br><span class="line">                Where &lt;n&gt; is an <span class="built_in">integer</span> and the suffix specifies the units as</span><br><span class="line">                milliseconds(<span class="string">&quot;ms&quot;</span>) or seconds(<span class="string">&quot;s&quot;</span>). The default units are <span class="string">&quot;ms&quot;</span>.</span><br><span class="line">  &lt;count&gt;       Number of samples to take before terminating.</span><br><span class="line">  -J&lt;flag&gt;      Pass &lt;flag&gt; directly to the runtime system.</span><br><span class="line"></span><br><span class="line">  jstat -options</span><br><span class="line">-class</span><br><span class="line">-compiler</span><br><span class="line">-gc</span><br><span class="line">-gccapacity</span><br><span class="line">-gccause</span><br><span class="line">-gcmetacapacity</span><br><span class="line">-gcnew</span><br><span class="line">-gcnewcapacity</span><br><span class="line">-gcold</span><br><span class="line">-gcoldcapacity</span><br><span class="line">-gcutil</span><br><span class="line">-printcompilation</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="jstat-class"><a href="#jstat-class" class="headerlink" title="jstat -class"></a>jstat -class</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 显示JVM中加载的class数量以及所占用空间等等</span></span><br><span class="line">jstat -class 7</span><br><span class="line">Loaded  Bytes  Unloaded  Bytes     Time</span><br><span class="line"> 22687 41946.1     1079  1390.2      15.15</span><br><span class="line"></span><br><span class="line"><span class="comment">## Loaded   装载类的数量</span></span><br><span class="line"><span class="comment">## Bytes    装载类所占用的字节数</span></span><br><span class="line"><span class="comment">## Unloaded 卸载类的数量</span></span><br><span class="line"><span class="comment">## Bytes    卸载类所占用的字节数</span></span><br><span class="line"><span class="comment">## Time     装载和卸载类所占用的时间</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="jstat-compiler"><a href="#jstat-compiler" class="headerlink" title="jstat -compiler"></a>jstat -compiler</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 显示JVM实时编译的数量信息</span></span><br><span class="line">jstat -compiler &lt;pid&gt;</span><br><span class="line">Compiled Failed Invalid   Time   FailedType FailedMethod</span><br><span class="line">   20983      5       0   127.73          1 org/springframework/boot/loader/jar/JarFileEntries getEntry</span><br><span class="line"></span><br><span class="line"><span class="comment">## Compiled      编译任务执行数量</span></span><br><span class="line"><span class="comment">## Failed        编译任务执行失败数量</span></span><br><span class="line"><span class="comment">## Invalid       编译任务执行失效数量</span></span><br><span class="line"><span class="comment">## Time          编译任务消耗时间</span></span><br><span class="line"><span class="comment">## FailedType    最后一个编译失败任务的类型</span></span><br><span class="line"><span class="comment">## FailedMethod  最后一个编译失败任务所在的类及方法</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="jstat-gc"><a href="#jstat-gc" class="headerlink" title="jstat -gc"></a>jstat -gc</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">jstat -gc &lt;pid&gt;</span><br><span class="line"> S0C    S1C    S0U    S1U      EC       EU        OC         OU       MC     MU    CCSC   CCSU   YGC     YGCT    FGC    FGCT     GCT</span><br><span class="line">2048.0 12800.0 1816.4  0.0   259584.0 185892.9  349696.0   276122.6  129024.0 123352.6 14592.0 13690.9    110    1.235   0      0.000    1.235</span><br><span class="line"></span><br><span class="line"><span class="comment">##  S0C   	年轻代中第一个survivor（幸存区）的容量 (字节)</span></span><br><span class="line"><span class="comment">##  S1C   	年轻代中第二个survivor（幸存区）的容量 (字节)</span></span><br><span class="line"><span class="comment">##  S0U   	年轻代中第一个survivor（幸存区）目前已使用空间 (字节)</span></span><br><span class="line"><span class="comment">##  S1U     	年轻代中第二个survivor（幸存区）目前已使用空间 (字节)</span></span><br><span class="line"><span class="comment">##  EC      	年轻代中Eden（伊甸园）的容量 (字节)</span></span><br><span class="line"><span class="comment">##  EU       	年轻代中Eden（伊甸园）目前已使用空间 (字节)</span></span><br><span class="line"><span class="comment">##  OC        	Old代的容量 (字节)</span></span><br><span class="line"><span class="comment">##  OU      	Old代目前已使用空间 (字节)</span></span><br><span class="line"><span class="comment">##  PC    	Perm(持久代)的容量 (字节)</span></span><br><span class="line"><span class="comment">##  PU	Perm(持久代)目前已使用空间 (字节)</span></span><br><span class="line"><span class="comment">##  YGC    	从应用程序启动到采样时年轻代中gc次数</span></span><br><span class="line"><span class="comment">##  YGCT   	从应用程序启动到采样时年轻代中gc所用时间(s)</span></span><br><span class="line"><span class="comment">##  FGC   	从应用程序启动到采样时old代(全gc)gc次数</span></span><br><span class="line"><span class="comment">##  FGCT    	从应用程序启动到采样时old代(全gc)gc所用时间(s)</span></span><br><span class="line"><span class="comment">##  GCT	从应用程序启动到采样时gc用的总时间(s)</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="jstat-gccapacity"><a href="#jstat-gccapacity" class="headerlink" title="jstat -gccapacity"></a>jstat -gccapacity</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">jstat -gccapacity &lt;pid&gt;</span><br><span class="line"> NGCMN    NGCMX     NGC     S0C   S1C       EC      OGCMN      OGCMX       OGC         OC       MCMN     MCMX      MC     CCSMN    CCSMX     CCSC    YGC    FGC</span><br><span class="line">174592.0 349184.0 303616.0 2048.0 12800.0 259584.0   349696.0   699392.0   349696.0   349696.0      0.0 1163264.0 129024.0      0.0 1048576.0  14592.0    110     0</span><br><span class="line"><span class="comment">##  NGCMN   	年轻代(young)中初始化(最小)的大小(字节)</span></span><br><span class="line"><span class="comment">##  NGCMX    	年轻代(young)的最大容量 (字节)</span></span><br><span class="line"><span class="comment">##  NGC    	年轻代(young)中当前的容量 (字节)</span></span><br><span class="line"><span class="comment">##  S0C  	年轻代中第一个survivor（幸存区）的容量 (字节)</span></span><br><span class="line"><span class="comment">##  S1C      	年轻代中第二个survivor（幸存区）的容量 (字节)</span></span><br><span class="line"><span class="comment">##  EC     	年轻代中Eden（伊甸园）的容量 (字节)</span></span><br><span class="line"><span class="comment">##  OGCMN     	old代中初始化(最小)的大小 (字节)</span></span><br><span class="line"><span class="comment">##  OGCMX      	old代的最大容量(字节)</span></span><br><span class="line"><span class="comment">##  OGC	old代当前新生成的容量 (字节)</span></span><br><span class="line"><span class="comment">##  OC     	Old代的容量 (字节)</span></span><br><span class="line"><span class="comment">##  PGCMN   	perm代中初始化(最小)的大小 (字节)</span></span><br><span class="line"><span class="comment">##  PGCMX    	perm代的最大容量 (字节)  </span></span><br><span class="line"><span class="comment">##  PGC      	perm代当前新生成的容量 (字节)</span></span><br><span class="line"><span class="comment">##  PC    	Perm(持久代)的容量 (字节)</span></span><br><span class="line"><span class="comment">##  YGC   	从应用程序启动到采样时年轻代中gc次数</span></span><br><span class="line"><span class="comment">##  FGC	从应用程序启动到采样时old代(全gc)gc次数</span></span><br></pre></td></tr></table></figure>

<h4 id="jstat-gcutil"><a href="#jstat-gcutil" class="headerlink" title="jstat -gcutil"></a>jstat -gcutil</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">jstat -gcutil &lt;pid&gt;</span><br><span class="line"><span class="comment">##  S0    	年轻代中第一个survivor（幸存区）已使用的占当前容量百分比</span></span><br><span class="line"><span class="comment">##  S1    	年轻代中第二个survivor（幸存区）已使用的占当前容量百分比</span></span><br><span class="line"><span class="comment">##  E     	年轻代中Eden（伊甸园）已使用的占当前容量百分比</span></span><br><span class="line"><span class="comment">##  O     	old代已使用的占当前容量百分比</span></span><br><span class="line"><span class="comment">##  P    	perm代已使用的占当前容量百分比</span></span><br><span class="line"><span class="comment">##  YGC    	从应用程序启动到采样时年轻代中gc次数</span></span><br><span class="line"><span class="comment">##  YGCT   	从应用程序启动到采样时年轻代中gc所用时间(s)</span></span><br><span class="line"><span class="comment">##  FGC   	从应用程序启动到采样时old代(全gc)gc次数</span></span><br><span class="line"><span class="comment">##  FGCT    	从应用程序启动到采样时old代(全gc)gc所用时间(s)</span></span><br><span class="line"><span class="comment">##  GCT	从应用程序启动到采样时gc用的总时间(s)</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="jstat-gcnew-gcold"><a href="#jstat-gcnew-gcold" class="headerlink" title="jstat -gcnew/-gcold"></a>jstat -gcnew/-gcold</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">jstat -gcnew/ -gcold  &lt;pid&gt;</span><br><span class="line"><span class="comment">##  S0C   	年轻代中第一个survivor（幸存区）的容量 (字节)</span></span><br><span class="line"><span class="comment">##  S1C   	年轻代中第二个survivor（幸存区）的容量 (字节)</span></span><br><span class="line"><span class="comment">##  S0U   	年轻代中第一个survivor（幸存区）目前已使用空间 (字节)</span></span><br><span class="line"><span class="comment">##  S1U  	年轻代中第二个survivor（幸存区）目前已使用空间 (字节)</span></span><br><span class="line"><span class="comment">##  TT	持有次数限制</span></span><br><span class="line"><span class="comment">##  MTT 	最大持有次数限制</span></span><br><span class="line"><span class="comment">##  EC      	年轻代中Eden（伊甸园）的容量 (字节)</span></span><br><span class="line"><span class="comment">##  EU    	年轻代中Eden（伊甸园）目前已使用空间 (字节)</span></span><br><span class="line"><span class="comment">##  YGC    	从应用程序启动到采样时年轻代中gc次数</span></span><br><span class="line"><span class="comment">##  YGCT	从应用程序启动到采样时年轻代中gc所用时间(s)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">##  PC      	Perm(持久代)的容量 (字节)</span></span><br><span class="line"><span class="comment">##  PU       	Perm(持久代)目前已使用空间 (字节)</span></span><br><span class="line"><span class="comment">##  OC         	Old代的容量 (字节)</span></span><br><span class="line"><span class="comment">##  OU      	Old代目前已使用空间 (字节)</span></span><br><span class="line"><span class="comment">##  YGC   	从应用程序启动到采样时年轻代中gc所用时间次数</span></span><br><span class="line"><span class="comment">##  FGC   	从应用程序启动到采样时old代(全gc)gc次数</span></span><br><span class="line"><span class="comment">##  FGCT    	从应用程序启动到采样时old代(全gc)gc所用时间(s)</span></span><br><span class="line"><span class="comment">##  GCT	从应用程序启动到采样时gc用的总时间(s)</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="JVM检测工具"><a href="#JVM检测工具" class="headerlink" title="JVM检测工具"></a>JVM检测工具</h2><p>Arthas 阿里开源工具：</p>
<h3 id="下载安装"><a href="#下载安装" class="headerlink" title="下载安装"></a>下载安装</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1.  curl -O https://arthas.aliyun.com/arthas-boot.jar</span><br><span class="line"></span><br><span class="line">2.  sudo dpkg -i arthas*.deb</span><br><span class="line"></span><br><span class="line">3. sudo rpm -i arthas*.rpm</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1.  java -jar arthas-boot.jar</span><br><span class="line"></span><br><span class="line">2/3.  as.sh</span><br></pre></td></tr></table></figure>

<h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><p>启动后先选择要监控调试的Java进程再进入到对应页面</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[INFO] arthas-boot version: 3.4.6</span><br><span class="line">[INFO] Found existing java process, please choose one and input the serial number of the process, eg : 1. Then hit ENTER.</span><br><span class="line">* [1]: 1 /opt/app.jar  <span class="comment">## 会检测当前应用运行环境中所有Java进程，根据进程前的Index选择要监控的Java的进程</span></span><br></pre></td></tr></table></figure>

<p>进入界面</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[INFO] arthas home: /root/.arthas/lib/3.4.6/arthas</span><br><span class="line">[INFO] Try to attach process 1</span><br><span class="line">[INFO] Attach process 1 success.</span><br><span class="line">[INFO] arthas-client connect 127.0.0.1 3658</span><br><span class="line">  ,---.  ,------. ,--------.,--.  ,--.  ,---.   ,---.                           </span><br><span class="line"> /  O  \ |  .--. <span class="string">&#x27;&#x27;</span>--.  .--<span class="string">&#x27;|  &#x27;</span>--<span class="string">&#x27;  | /  O  \ &#x27;</span>   .-<span class="string">&#x27;                          </span></span><br><span class="line"><span class="string">|  .-.  ||  &#x27;</span>--<span class="string">&#x27;.&#x27;</span>   |  |   |  .--.  ||  .-.  |`.  `-.                          </span><br><span class="line">|  | |  ||  |\  \    |  |   |  |  |  ||  | |  |.-<span class="string">&#x27;    |                         </span></span><br><span class="line"><span class="string">`--&#x27;</span> `--<span class="string">&#x27;`--&#x27;</span> <span class="string">&#x27;--&#x27;</span>   `--<span class="string">&#x27;   `--&#x27;</span>  `--<span class="string">&#x27;`--&#x27;</span> `--<span class="string">&#x27;`-----&#x27;</span>                          </span><br><span class="line">                                                                                </span><br><span class="line"></span><br><span class="line">wiki      https://arthas.aliyun.com/doc                                         </span><br><span class="line">tutorials https://arthas.aliyun.com/doc/arthas-tutorials.html                   </span><br><span class="line">version   3.4.6                                                                 </span><br><span class="line">pid       1                                                                     </span><br><span class="line">time      2021-01-26 15:11:19      </span><br></pre></td></tr></table></figure>

<ul>
<li>dushboard–仪表盘</li>
</ul>
<table>
<thead>
<tr>
<th>ID</th>
<th>NAME</th>
<th>GROUP</th>
<th>PRIORITY</th>
<th>STATE</th>
<th>%CPU</th>
<th>DELTA_TIME</th>
<th>TIME</th>
<th>INTERRUPTED</th>
<th>DAMON</th>
</tr>
</thead>
<tbody><tr>
<td>线程ID（Java级别的线程ID没有ID及状态等信息）</td>
<td>线程名称（JVM内部线程：JIT编译线程(C1 CompilerThread0,C2 CompilerThread0),GC线程（GC Thread0,G2 Young RemSet Sampling）,其他内部线程（VMPeriodic Task Thread,VM Thread,Service Thread））</td>
<td>线程组名</td>
<td>优先级（1~10之间的数字，越大表示优先级越高）</td>
<td>线程状态（RUNNABLE:运行中，TIMED_WAITING:超时等待，WAITING:等待，BLOCKED:阻塞等待锁）</td>
<td>线程消耗的cpu占比，采样100ms，将所有线程在这100ms内的cpu使用量求和，再算出每个线程的cpu使用占比。</td>
<td></td>
<td>线程运行总时间</td>
<td>线程当前中断状态</td>
<td>是否是daemon线程</td>
</tr>
<tr>
<td>Memory</td>
<td>used</td>
<td>total</td>
<td>max</td>
<td>usage</td>
<td>GC</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>JVM内存信息</td>
<td>已使用内存</td>
<td>总计</td>
<td>最大</td>
<td>使用比</td>
<td>垃圾回收方法</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Runtime</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>os.name</td>
<td></td>
<td></td>
<td></td>
<td>Linux</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>os.version</td>
<td></td>
<td></td>
<td></td>
<td>3.10.0-514.21.1.el7.x86_64</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>java.version</td>
<td></td>
<td></td>
<td></td>
<td>1.8.0_202</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>java.home</td>
<td></td>
<td></td>
<td></td>
<td>/usr/lib/jvm/java-8-oracle/jre</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>systemload.average</td>
<td></td>
<td></td>
<td></td>
<td>0.21</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>processors</td>
<td></td>
<td></td>
<td></td>
<td>12</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>timestamp/uptime</td>
<td></td>
<td></td>
<td></td>
<td>Tue Jan 26 15:19:22 CST 2021/13474s</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<ul>
<li>thread–线程信息<br>打印具体线程的信息<br>-id  查看指定id线程没有ID及状态等信息（显示ID为-1）<br>-n [num] 查看当前最忙的几个线程<br>-b   找出当前阻塞其他线程的线程，如果有死锁，会有红色的字提醒着，这个阻塞的  线程已经被另外一个线程阻塞。<br>-all  显示所有匹配的线程<br>-i [num]    查看[num]ms线程CPU时间<br>-state  查看指定状态的线程    如查看WAITING状态   thread -state WAITING</li>
</ul>
<ul>
<li><p>jad–反编译<br>通过指定全限定类名来反编译正在运行的类内容 jad [com.Main]</p>
</li>
<li><p>watch–监听器</p>
</li>
</ul>
<h2 id="JVM排查问题"><a href="#JVM排查问题" class="headerlink" title="JVM排查问题"></a>JVM排查问题</h2><h3 id="CPU飙高"><a href="#CPU飙高" class="headerlink" title="CPU飙高"></a>CPU飙高</h3><ul>
<li>1.top 查看CPU占用率最高的进程/或者jps查看java的进程</li>
<li>2.top -Hp  查看对应进程内各个线程的CPU/内存的占比</li>
<li>3.jstack 定位线程情况，查看该线程下所有线程状态，检查状态查看是否由哪个抢占排他资源。重点关注WAITING，BLOCKED状态<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// jstack 同样也会记录每个线程池的详细信息：名称，状态等等</span></span><br><span class="line"> waiting on &lt;<span class="number">0x0000000088ca3310</span>&gt; (a java.lang.Object)</span><br><span class="line"></span><br><span class="line"> <span class="comment">// 定位该线程造成死锁自锁，</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="OOM"><a href="#OOM" class="headerlink" title="OOM"></a>OOM</h3><ul>
<li>1.jinfo 查看该进程虚拟机详情</li>
<li>2.jstat -gc 动态观察gc情况 / 阅读GC日志发现频繁GC / arthas观察 / jconsole/jvisualVM/ Jprofiler（最好用）<br>jstat -gc 4655 500 : 每个500个毫秒打印GC的情况</li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color2">Java基础</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2023/05/24/JVM/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>

<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>




  
    <article id="post-Dubbo源码阅读" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2023/05/24/Dubbo%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/">Dubbo源码阅读</a>
    </h1>
  

        
        <a href="/2023/05/24/Dubbo%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/" class="archive-article-date">
  	<time datetime="2023-05-24T08:58:49.943Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2023-05-24</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Dubbo"><a href="#Dubbo" class="headerlink" title="Dubbo"></a>Dubbo</h1><h2 id="结构介绍"><a href="#结构介绍" class="headerlink" title="结构介绍"></a>结构介绍</h2><p><img src="/assets/doc-images/dubbo_structs.png" alt="在这里插入图片描述"></p>
<p><img src="/assets/doc-images/dubbo_structs_2.png" alt="Dubbo层级划分"></p>
<ul>
<li>服务接口层（Service）:与实际业务逻辑相关，根据消费者和生产者业务设计对应接口和实现；</li>
<li>配置层（Config）:对外配置接口，负责Dubbo中生成各种配置类，例如协议，生产者以及具体的Bean信息的等等，方便再暴露和做负载均衡时直接使用 <a target="_blank" rel="noopener" href="https://blog.csdn.net/zhaodongchao1992/article/details/103452829">源码</a><br><img src="/assets/doc-images/code_extends.png" alt="在这里插入图片描述"></li>
<li>服务代理层（Proxy）:根据上一层生成的各个配置信息，两端根据ProxyFactory生成代理信息Invoker。</li>
<li>服务注册层（Registry）:将已经生成Invoker信息导出并注册到注册中心进行服务暴露，此时生产者提供的服务可以被发现。</li>
<li>集群层（Cluster）：封装提供者路由以及负载均衡，并连接注册中心以Invoker为中心扩展接口为Cluster,Directory,Router,LoadBalance;<ul>
<li>Invoker：是Provider的一个可调用Service的抽象，Invoker中封装了Provider地址以及Service接口信息；</li>
<li> Directory表示多个Invoker，从注册中心中不断拉去，推送变更。里面包含多个Invoker，Cluster将Directory多个相同的Invoker伪装成一个Invoker对上层透明调用，伪装的过程包含了容错逻辑，调用失败重试逻辑等等；</li>
<li> Router负责从多个Invoker中按路由规则选出子集；</li>
<li>LoadBalance负责从多个Invoker中选择一个用于本次调用，通过选择或者自定义的负载均衡算法来选择多个相同Invoker中的某一个，失败后重选；<br> <img src="/assets/doc-images/components.png" alt="在这里插入图片描述"></li>
</ul>
</li>
</ul>
<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><p>1.zookeeper注册发现中心<br>2.pom引用，客户端</p>
<h5 id="1-创建注册发现中心Zookeeper"><a href="#1-创建注册发现中心Zookeeper" class="headerlink" title="1.创建注册发现中心Zookeeper"></a>1.创建注册发现中心Zookeeper</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 拉去镜像启动，没有什么特殊参数配置</span></span><br></pre></td></tr></table></figure>

<h5 id="2-生产者"><a href="#2-生产者" class="headerlink" title="2.生产者"></a>2.生产者</h5><p>Pom引用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- Aapche Dubbo --&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">	&lt;groupId&gt;org.apache.dubbo&lt;/groupId&gt;</span><br><span class="line">	&lt;artifactId&gt;dubbo-spring-boot-starter&lt;/artifactId&gt;</span><br><span class="line">	&lt;version&gt;<span class="number">2.7</span><span class="number">.1</span>&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">	&lt;groupId&gt;org.apache.dubbo&lt;/groupId&gt;</span><br><span class="line">	&lt;artifactId&gt;dubbo&lt;/artifactId&gt;</span><br><span class="line">	&lt;version&gt;<span class="number">2.7</span><span class="number">.1</span>&lt;/version&gt;</span><br><span class="line">	&lt;exclusions&gt;</span><br><span class="line">		&lt;exclusion&gt;</span><br><span class="line">			&lt;groupId&gt;org.slf4j&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;slf4j-log4j12&lt;/artifactId&gt;</span><br><span class="line">		&lt;/exclusion&gt;</span><br><span class="line">	&lt;/exclusions&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
<p>基础配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">## dubbo提供服务基础包</span><br><span class="line">dubbo.scan.base-packages=com.dubbo.provide</span><br><span class="line">## dubbo远程调用时使用的协议，支持dubbo,Rmi,Hessian协议</span><br><span class="line">dubbo.protocol.name=dubbo</span><br><span class="line">## 当前生产者提供服务应用的端口</span><br><span class="line">dubbo.protocol.port=<span class="number">8081</span></span><br><span class="line">## 当前生产者提供服务应用的IP地址</span><br><span class="line">#dubbo.protocol.host=<span class="number">192.168</span><span class="number">.101</span><span class="number">.106</span></span><br><span class="line">## 当前生产者簇名称 用于消费者负载均衡</span><br><span class="line">dubbo.provider.cluster=failover</span><br><span class="line">##  注册中心，发现中心</span><br><span class="line">dubbo.registry.address=zookeeper:<span class="comment">//39.108.151.72:2181</span></span><br></pre></td></tr></table></figure>
<p>生产者</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.dubbo.provide.service;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.dubbo.config.annotation.Service;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: haitao.gao</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>:</span></span><br><span class="line"><span class="comment"> * 随机：loadbalance=&quot;random&quot;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 轮循：loadbalance=&quot;roundrobin&quot;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 最少活跃数：loadbalance=&quot;leastactive&quot;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 一致性Hash：loadbalance=&quot;consistenthash&quot;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2020/11/26 19:18</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span>: 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service(version = &quot;1.0.0&quot; , executes = 12,interfaceClass = ProvideService.class,delay = 10,weight = 50,group = &quot;test&quot;,loadbalance = &quot;roundrobin&quot;)</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProvideServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">ProvideService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">Integer</span> <span class="variable">index</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getIndex</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;这是服务一&quot;</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="3-消费者"><a href="#3-消费者" class="headerlink" title="3.消费者"></a>3.消费者</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.dubbo.provide;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.dubbo.provide.service.ProvideService;</span><br><span class="line"><span class="keyword">import</span> org.apache.dubbo.config.annotation.Reference;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMethod;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: haitao.gao</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>:</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2020/11/26 21:03</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span>: 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(value = &quot;/v1/test&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomerController</span> &#123;</span><br><span class="line"> </span><br><span class="line">     <span class="comment">// 通过version来控制相同生产者不同版本的调用</span></span><br><span class="line">     <span class="comment">// time，out来控制失败机制</span></span><br><span class="line">     <span class="comment">// group集群模式下可以指定调用某个组下的生产者进行负载均衡</span></span><br><span class="line">    <span class="meta">@Reference(version = &quot;1.0.0&quot;,timeout = 10000,retries = 3,group = &quot;test&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> ProvideService provideService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/dubbo&quot;,method = RequestMethod.GET)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">testDubbo</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;\n*****************\n&quot;</span>+provideService.getIndex().toString()+<span class="string">&quot;\n****************&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="对比SpringCloud体系"><a href="#对比SpringCloud体系" class="headerlink" title="对比SpringCloud体系"></a>对比SpringCloud体系</h2><table>
<thead>
<tr>
<th>组件/功能</th>
<th>Dubbo</th>
<th>SpringCloud</th>
</tr>
</thead>
<tbody><tr>
<td>注册中心</td>
<td>zookeeper,multicast,redis,simple</td>
<td>Eureka</td>
</tr>
<tr>
<td>服务监控</td>
<td>Dubbo-monitor</td>
<td>Admin</td>
</tr>
<tr>
<td>熔断器</td>
<td>不完善</td>
<td>Hystrix</td>
</tr>
<tr>
<td>服务网关</td>
<td>无</td>
<td>Gateway,Zuul</td>
</tr>
<tr>
<td>分布式设置</td>
<td>无</td>
<td>Config</td>
</tr>
<tr>
<td>服务追踪</td>
<td>无</td>
<td>Sleuth</td>
</tr>
<tr>
<td>消息总线</td>
<td>无</td>
<td>Bus</td>
</tr>
<tr>
<td>数据流</td>
<td>无</td>
<td>Stream</td>
</tr>
<tr>
<td>批量任务</td>
<td>无</td>
<td>Task</td>
</tr>
<tr>
<td>Dubbo使用PRC通信，可自定义通信协议，SpringCloud使用http或https进行通信，底层均使用TCP</td>
<td></td>
<td></td>
</tr>
</tbody></table>
<h2 id="注册中心"><a href="#注册中心" class="headerlink" title="注册中心"></a>注册中心</h2><table>
<thead>
<tr>
<th>Feature</th>
<th>Maturity</th>
<th>Strength</th>
<th>Problem</th>
<th>Advise</th>
<th>User</th>
</tr>
</thead>
<tbody><tr>
<td>Zookeeper注册中心</td>
<td>Stable</td>
<td>支持基于网络的集群方式，有广泛周边开源产品，建议使用dubbo-2.3.3以上版本（推荐使用）</td>
<td>依赖于Zookeeper的稳定性</td>
<td>可用于生产环境</td>
<td></td>
</tr>
<tr>
<td>Redis注册中心</td>
<td>Stable</td>
<td>支持基于客户端双写的集群方式，性能高</td>
<td>要求服务器时间同步，用于检查心跳过期脏数据</td>
<td>可用于生产环境</td>
<td></td>
</tr>
<tr>
<td>Multicast注册中心</td>
<td>Tested</td>
<td>去中心化，不需要安装注册中心</td>
<td>依赖于网络拓扑和路由，跨机房有风险</td>
<td>小规模应用或开发测试环境</td>
<td></td>
</tr>
<tr>
<td>Simple注册中心</td>
<td>Tested</td>
<td>Dogfooding，注册中心本身也是一个标准的RPC服务</td>
<td>没有集群支持，可能单点故障</td>
<td>试用</td>
<td></td>
</tr>
</tbody></table>
<h2 id="支持的协议"><a href="#支持的协议" class="headerlink" title="支持的协议"></a>支持的协议</h2><table>
<thead>
<tr>
<th>Feature</th>
<th>Maturity</th>
<th>Strength</th>
<th>Problem</th>
<th>Advise</th>
<th>User</th>
</tr>
</thead>
<tbody><tr>
<td>Simple监控中心</td>
<td>Stable</td>
<td>支持JFreeChart统计报表</td>
<td>没有集群支持，可能单点故障，但故障后不影响RPC运行</td>
<td>可用于生产环境</td>
<td></td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>Feature</th>
<th>Maturity</th>
<th>Strength</th>
<th>Problem</th>
<th>Advise</th>
<th>User</th>
</tr>
</thead>
<tbody><tr>
<td>Dubbo协议</td>
<td>Stable</td>
<td>采用NIO复用单一长连接，并使用线程池并发处理请求，减少握手和加大并发效率，性能较好（推荐使用）</td>
<td>在大文件传输时，单一连接会成为瓶颈</td>
<td>可用于生产环境</td>
<td>Alibaba</td>
</tr>
<tr>
<td>Rmi协议</td>
<td>Stable</td>
<td>可与原生RMI互操作，基于TCP协议</td>
<td>偶尔会连接失败，需重建Stub</td>
<td>可用于生产环境</td>
<td>Alibaba</td>
</tr>
<tr>
<td>Hessian协议</td>
<td>Stable</td>
<td>可与原生Hessian互操作，基于HTTP协议</td>
<td>需hessian.jar支持，http短连接的开销大</td>
<td>可用于生产环境</td>
<td></td>
</tr>
</tbody></table>
<h2 id="通信框架"><a href="#通信框架" class="headerlink" title="通信框架"></a>通信框架</h2><table>
<thead>
<tr>
<th>Feature</th>
<th>Maturity</th>
<th>Strength</th>
<th>Problem</th>
<th>Advise</th>
<th>User</th>
</tr>
</thead>
<tbody><tr>
<td>Netty Transporter</td>
<td>Stable</td>
<td>JBoss的NIO框架，性能较好（推荐使用）</td>
<td>一次请求派发两种事件，需屏蔽无用事件</td>
<td>可用于生产环境</td>
<td>Alibaba</td>
</tr>
<tr>
<td>Mina Transporter</td>
<td>Stable</td>
<td>老牌NIO框架，稳定</td>
<td>待发送消息队列派发不及时，大压力下，会出现FullGC</td>
<td>可用于生产环境</td>
<td>Alibaba</td>
</tr>
<tr>
<td>Grizzly Transporter</td>
<td>Tested</td>
<td>Sun的NIO框架，应用于GlassFish服务器中</td>
<td>线程池不可扩展，Filter不能拦截下一Filter</td>
<td>试用</td>
<td></td>
</tr>
</tbody></table>
<h2 id="序列化与反序列化方式"><a href="#序列化与反序列化方式" class="headerlink" title="序列化与反序列化方式"></a>序列化与反序列化方式</h2><table>
<thead>
<tr>
<th>Feature</th>
<th>Maturity</th>
<th>Strength</th>
<th>Problem</th>
<th>Advise</th>
<th>User</th>
</tr>
</thead>
<tbody><tr>
<td>Hessian Serialization</td>
<td>Stable</td>
<td>性能较好，多语言支持（推荐使用）</td>
<td>Hessian的各版本兼容性不好，可能和应用使用的Hessian冲突，Dubbo内嵌了hessian3.2.1的源码</td>
<td>可用于生产环境</td>
<td>Alibaba</td>
</tr>
<tr>
<td>Dubbo Serialization</td>
<td>Tested</td>
<td>通过不传送POJO的类元信息，在大量POJO传输时，性能较好</td>
<td>当参数对象增加字段时，需外部文件声明</td>
<td>试用</td>
<td></td>
</tr>
<tr>
<td>Json Serialization</td>
<td>Tested</td>
<td>纯文本，可跨语言解析，缺省采用FastJson解析</td>
<td>性能较差</td>
<td>试用</td>
<td></td>
</tr>
<tr>
<td>Java Serialization</td>
<td>Stable</td>
<td>Java原生支持</td>
<td>性能较差</td>
<td>可用于生产环境</td>
<td></td>
</tr>
</tbody></table>
<h2 id="代理对象实现"><a href="#代理对象实现" class="headerlink" title="代理对象实现"></a>代理对象实现</h2><table>
<thead>
<tr>
<th>Feature</th>
<th>Maturity</th>
<th>Strength</th>
<th>Problem</th>
<th>Advise</th>
<th>User</th>
</tr>
</thead>
<tbody><tr>
<td>Javassist ProxyFactory</td>
<td>Stable</td>
<td>通过字节码生成代替反射，性能比较好（推荐使用）</td>
<td>依赖于javassist.jar包，占用JVM的Perm内存，Perm可能要设大一些：java -XX:PermSize=128m</td>
<td>可用于生产环境</td>
<td>Alibaba</td>
</tr>
<tr>
<td>Jdk ProxyFactory</td>
<td>Stable</td>
<td>JDK原生支持</td>
<td>性能较差</td>
<td>可用于生产环境</td>
<td></td>
</tr>
</tbody></table>
<h2 id="容错机制"><a href="#容错机制" class="headerlink" title="容错机制"></a>容错机制</h2><table>
<thead>
<tr>
<th>Feature</th>
<th>Maturity</th>
<th>Strength</th>
<th>Problem</th>
<th>Advise</th>
<th>User</th>
</tr>
</thead>
<tbody><tr>
<td>Failover Cluster</td>
<td>Stable</td>
<td>失败自动切换，当出现失败，重试其它服务器，通常用于读操作（推荐使用）</td>
<td>重试会带来更长延迟</td>
<td>可用于生产环境</td>
<td>Alibaba</td>
</tr>
<tr>
<td>Failfast Cluster</td>
<td>Stable</td>
<td>快速失败，只发起一次调用，失败立即报错,通常用于非幂等性的写操作</td>
<td>如果有机器正在重启，可能会出现调用失败</td>
<td>可用于生产环境</td>
<td>Alibaba</td>
</tr>
<tr>
<td>Failsafe Cluster</td>
<td>Stable</td>
<td>失败安全，出现异常时，直接忽略，通常用于写入审计日志等操作</td>
<td>调用信息丢失</td>
<td>可用于生产环境</td>
<td>Monitor</td>
</tr>
<tr>
<td>Failback Cluster</td>
<td>Tested</td>
<td>失败自动恢复，后台记录失败请求，定时重发，通常用于消息通知操作</td>
<td>不可靠，重启丢失</td>
<td>可用于生产环境</td>
<td>Registry</td>
</tr>
<tr>
<td>Forking Cluster</td>
<td>Tested</td>
<td>并行调用多个服务器，只要一个成功即返回，通常用于实时性要求较高的读操作</td>
<td>需要浪费更多服务资源</td>
<td>可用于生产环境</td>
<td></td>
</tr>
<tr>
<td>Broadcast Cluster</td>
<td>Tested</td>
<td>广播调用所有提供者，逐个调用，任意一台报错则报错，通常用于更新提供方本地状态</td>
<td>速度慢，任意一台报错则报错</td>
<td>可用于生产环境</td>
<td></td>
</tr>
</tbody></table>
<h2 id="负载均衡策略"><a href="#负载均衡策略" class="headerlink" title="负载均衡策略"></a>负载均衡策略</h2><table>
<thead>
<tr>
<th>Feature</th>
<th>Maturity</th>
<th>Strength</th>
<th>Problem</th>
<th>Advise</th>
<th>User</th>
</tr>
</thead>
<tbody><tr>
<td>Random LoadBalance</td>
<td>Stable</td>
<td>随机，按权重设置随机概率（推荐使用）</td>
<td>在一个截面上碰撞的概率高，重试时，可能出现瞬间压力不均</td>
<td>可用于生产环境</td>
<td>Alibaba</td>
</tr>
<tr>
<td>RoundRobin LoadBalance</td>
<td>Stable</td>
<td>轮询，按公约后的权重设置轮询比率</td>
<td>存在慢的机器累积请求问题，极端情况可能产生雪崩</td>
<td>可用于生产环境</td>
<td></td>
</tr>
<tr>
<td>LeastActive LoadBalance</td>
<td>Stable</td>
<td>最少活跃调用数，相同活跃数的随机，活跃数指调用前后计数差，使慢的机器收到更少请求</td>
<td>不支持权重，在容量规划时，不能通过权重把压力导向一台机器压测容量</td>
<td>可用于生产环境</td>
<td></td>
</tr>
<tr>
<td>ConsistentHash LoadBalance</td>
<td>Stable</td>
<td>一致性Hash，相同参数的请求总是发到同一提供者，当某一台提供者挂时，原本发往该提供者的请求，基于虚拟节点，平摊到其它提供者，不会引起剧烈变动</td>
<td>压力分摊不均</td>
<td>可用于生产环境</td>
<td></td>
</tr>
</tbody></table>
<h2 id="路由规则"><a href="#路由规则" class="headerlink" title="路由规则"></a>路由规则</h2><table>
<thead>
<tr>
<th>Feature</th>
<th>Maturity</th>
<th>Strength</th>
<th>Problem</th>
<th>Advise</th>
<th>User</th>
</tr>
</thead>
<tbody><tr>
<td>条件路由规则</td>
<td>Stable</td>
<td>基于条件表达式的路由规则，功能简单易用</td>
<td>有些复杂多分支条件情况，规则很难描述</td>
<td>可用于生产环境</td>
<td>Alibaba</td>
</tr>
<tr>
<td>脚本路由规则</td>
<td>Tested</td>
<td>基于脚本引擎的路由规则，功能强大</td>
<td>没有运行沙箱，脚本能力过于强大，可能成为后门</td>
<td>试用</td>
<td></td>
</tr>
</tbody></table>
<h2 id="运行容器"><a href="#运行容器" class="headerlink" title="运行容器"></a>运行容器</h2><table>
<thead>
<tr>
<th>Feature</th>
<th>Maturity</th>
<th>Strength</th>
<th>Problem</th>
<th>Advise</th>
<th>User</th>
</tr>
</thead>
<tbody><tr>
<td>Spring Container</td>
<td>Stable</td>
<td>自动加载META-INF/spring目录下的所有Spring配置</td>
<td></td>
<td>可用于生产环境</td>
<td>Alibaba</td>
</tr>
<tr>
<td>Jetty Container</td>
<td>Stable</td>
<td>启动一个内嵌Jetty，用于汇报状态</td>
<td>大量访问页面时，会影响服务器的线程和内存</td>
<td>可用于生产环境</td>
<td>Alibaba</td>
</tr>
<tr>
<td>Log4j Container</td>
<td>Stable</td>
<td>自动配置log4j的配置，在多进程启动时，自动给日志文件按进程分目录</td>
<td>用户不能控制log4j的配置，不灵活</td>
<td>可用于生产环境</td>
<td>Alibaba</td>
</tr>
</tbody></table>
<h2 id="Dubbo角色"><a href="#Dubbo角色" class="headerlink" title="Dubbo角色"></a>Dubbo角色</h2><p>Provide 服务提供方<br>Consumer 服务消费方<br>Registry 服务与注册中心</p>
<ul>
<li>TODO<br>Monitor 监控中心<br>Container 服务运行容器<br><a target="_blank" rel="noopener" href="https://img-blog.csdn.net/20181002113850939?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L21vYWt1bg==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70">!Dubbo</a></li>
</ul>
<h2 id="Dubbo-暴露服务"><a href="#Dubbo-暴露服务" class="headerlink" title="Dubbo 暴露服务"></a>Dubbo 暴露服务</h2><p>Dubbo暴露服务分为延迟暴露和非延迟暴露两种：</p>
<ul>
<li>延迟暴露：在初始化Spring中服务提供类Bean时，会对实现了InitializingBean的类回调其中的afterPropertySet()方法，设置延迟后服务发布就是在该方法中进行。</li>
<li>非延迟暴露：dubbo在Spring实例化完bean之后，在最后一步发布ContextRefreshEvent事件时，通知会对实现ApplicationListner的类进行回调onApplicationEvent方法，dubbo会在这个方法中进行发布服务。</li>
</ul>
<p>在服务发布暴露的过程中，都是使用SpringConfig的export()方法进行服务的暴露，export()会将Bean对象转换为URL格式，其中Bean的属性转换为URL的参数，发布到Dubbo的注册中心中，消费者获取可提供服务列表中获取均是该类型参数可直接进行调用。</p>
<h3 id="暴露过程"><a href="#暴露过程" class="headerlink" title="暴露过程"></a>暴露过程</h3><p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/dcfe426e9cd7">dubbo暴露服务</a></p>
<ul>
<li><p>Spring 容器初始化调用<br>当Spring容器完成实例化Bean后，在最后一步发布ContextRefreshEvent事件时，Dubbo通过ServiceBean来监听RefreshEvent事件。通过监听事件来触发Dubbo的暴露过程export()。</p>
</li>
<li><p>SpringConfig的export()</p>
<ul>
<li>服务提供者Bean中在初始化时@Service注解中各种变量都不会序列化所以可以直接使用；</li>
<li>检查是否延迟，如果是延迟发布则在该Bean中启动一个延迟线程池，延迟执行export()；<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">export</span><span class="params">()</span> &#123;</span><br><span class="line">    checkAndUpdateSubConfigs();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!shouldExport()) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (shouldDelay()) &#123;</span><br><span class="line">        delayExportExecutor.schedule(<span class="built_in">this</span>::doExport, delay, TimeUnit.MILLISECONDS);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        doExport();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>检查和设置注册和生成URL所需参数<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">checkAndUpdateSubConfigs</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 在痊愈配置中使用默认配置进行定义</span></span><br><span class="line">    <span class="comment">// 其中包括生产者所有配置，监听器，协议，等等</span></span><br><span class="line">    completeCompoundConfigs();</span><br><span class="line">    <span class="comment">// 首先启动Dubbo三大中心（注册中心，元数据中心、配置中心）之一的配置中心</span></span><br><span class="line">    <span class="comment">// 配置中心详解  https://blog.csdn.net/u012881904/article/details/95891448</span></span><br><span class="line">    <span class="comment">// 【配置中心主要负责 外部化配置(可以理解为dubbo.properties外部化存储)、服务治理(服务治理规则的存储于通知) ConfigManager.getInstance()</span></span><br><span class="line">    startConfigCenter();</span><br><span class="line">    <span class="comment">// 检查服务生产者是否存在，不过该类基本没啥用，ProvideConfig基本被废弃</span></span><br><span class="line">    checkDefault();</span><br><span class="line">    <span class="comment">// 检查当前运行容器信息,如果不存在则设置当前Bean的application信息</span></span><br><span class="line">    checkApplication();</span><br><span class="line">    <span class="comment">// 检测注册中心，将配置文件中dubbo.registry.address 的属性值，如果是多注册中心会将注册中心都分隔开用RegistryConfig保存在（protected List&lt;RegistryConfig&gt; registries;）中，所以dubbo是支持多注册中心。</span></span><br><span class="line">    checkRegistry();</span><br><span class="line">    <span class="comment">// 检查所配置协议，并把协议的相关配置转换为Protocols，方便后续在export时生成映射关系直接进行使用，Dubbo也支持多协议</span></span><br><span class="line">    checkProtocol();</span><br><span class="line">    <span class="built_in">this</span>.refresh();</span><br><span class="line">    <span class="comment">// 检查元数据中心</span></span><br><span class="line">    checkMetadataReport();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 八寸该Provider的代理类以及实际执行类在后面暴露注册服务生成URL以及Key-Value关系时会用到</span></span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isEmpty(interfaceName)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;&lt;dubbo:service interface=\&quot;\&quot; /&gt; interface not allow null!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ref <span class="keyword">instanceof</span> GenericService) &#123;</span><br><span class="line">        interfaceClass = GenericService.class;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(generic)) &#123;</span><br><span class="line">            generic = Boolean.TRUE.toString();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            interfaceClass = Class.forName(interfaceName, <span class="literal">true</span>, Thread.currentThread()</span><br><span class="line">                    .getContextClassLoader());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(e.getMessage(), e);</span><br><span class="line">        &#125;</span><br><span class="line">        checkInterfaceAndMethods(interfaceClass, methods);</span><br><span class="line">        checkRef();</span><br><span class="line">        generic = Boolean.FALSE.toString();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (local != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;true&quot;</span>.equals(local)) &#123;</span><br><span class="line">            local = interfaceName + <span class="string">&quot;Local&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Class&lt;?&gt; localClass;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            localClass = ClassHelper.forNameWithThreadContextClassLoader(local);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(e.getMessage(), e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!interfaceClass.isAssignableFrom(localClass)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;The local implementation class &quot;</span> + localClass.getName() + <span class="string">&quot; not implement interface &quot;</span> + interfaceName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (stub != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;true&quot;</span>.equals(stub)) &#123;</span><br><span class="line">            stub = interfaceName + <span class="string">&quot;Stub&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Class&lt;?&gt; stubClass;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            stubClass = ClassHelper.forNameWithThreadContextClassLoader(stub);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(e.getMessage(), e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!interfaceClass.isAssignableFrom(stubClass)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;The stub implementation class &quot;</span> + stubClass.getName() + <span class="string">&quot; not implement interface &quot;</span> + interfaceName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    checkStubAndLocal(interfaceClass);</span><br><span class="line">    checkMock(interfaceClass);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>doExport() 进行注册以及暴露服务</li>
</ul>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 线程安全的方式进行服务暴露，确保不会重复缓存</span></span><br><span class="line"> <span class="keyword">protected</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">doExport</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (unexported) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;The service &quot;</span> + interfaceClass.getName() + <span class="string">&quot; has already unexported!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (exported) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    exported = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isEmpty(path)) &#123;</span><br><span class="line">        path = interfaceName;</span><br><span class="line">    &#125;</span><br><span class="line">    doExportUrls();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>根据所配置协议，逐个向每个注册中心中进行暴露服务</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">doExportUrls</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 加载配置的所有注册中心</span></span><br><span class="line">    <span class="comment">// 检查注册中心配置是否合法，如果合法根据registres中所配置的注册中心信息来进行对应注册中心URL的生成，方便在下面注册到远程时使用</span></span><br><span class="line">    <span class="comment">// RUL 格式（registry://IP:PORT/org.apache.dubbo.registry.RegistryService?application=DemoProvider&amp;dubbo=2.0.2&amp;pid=2944&amp;qos.enable=false&amp;registry=zookeeper&amp;release=2.7.1&amp;timestamp=1608811153169）</span></span><br><span class="line">    List&lt;URL&gt; registryURLs = loadRegistries(<span class="literal">true</span>);</span><br><span class="line">    <span class="comment">// 根据配置协议进行逐个注册，实际上registres 和protocols做笛卡尔积</span></span><br><span class="line">    <span class="keyword">for</span> (ProtocolConfig protocolConfig : protocols) &#123;</span><br><span class="line">       <span class="comment">// 先拼接元数据，此时格式（test/com.dubbo.provide.service.ProvideService:1.0.0）</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">pathKey</span> <span class="operator">=</span> URL.buildKey(getContextPath(protocolConfig).map(p -&gt; p + <span class="string">&quot;/&quot;</span> + path).orElse(path), group, version);</span><br><span class="line">        <span class="comment">// 将代理类和Key保存在缓存中 providedServices，当做该类已经注册</span></span><br><span class="line">        <span class="type">ProviderModel</span> <span class="variable">providerModel</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProviderModel</span>(pathKey, ref, interfaceClass);</span><br><span class="line">        ApplicationModel.initProviderModel(pathKey, providerModel);</span><br><span class="line">        <span class="comment">// 实际暴露</span></span><br><span class="line">        doExportUrlsFor1Protocol(protocolConfig, registryURLs);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>暴露服务</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 本地暴露服务</span></span><br><span class="line"><span class="keyword">if</span> (!Constants.SCOPE_REMOTE.equalsIgnoreCase(scope)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!Constants.LOCAL_PROTOCOL.equalsIgnoreCase(url.getProtocol())) &#123;</span><br><span class="line">        <span class="comment">//这时候转成本地暴露的url：injvm://127.0.0.1/dubbo.common.hello.service.HelloService?anyhost=true&amp;</span></span><br><span class="line">        <span class="comment">//application=dubbo-provider&amp;application.version=1.0&amp;dubbo=2.5.3&amp;environment=product&amp;</span></span><br><span class="line">        <span class="comment">//interface=dubbo.common.hello.service.HelloService&amp;methods=sayHello&amp;</span></span><br><span class="line">        <span class="comment">//organization=china&amp;owner=cheng.xi&amp;pid=720&amp;side=provider&amp;timestamp=1489716708276</span></span><br><span class="line">        <span class="type">URL</span> <span class="variable">local</span> <span class="operator">=</span> URL.valueOf(url.toFullString())</span><br><span class="line">                .setProtocol(Constants.LOCAL_PROTOCOL)</span><br><span class="line">                .setHost(NetUtils.LOCALHOST)</span><br><span class="line">                .setPort(<span class="number">0</span>);</span><br><span class="line">        <span class="comment">//首先还是先获得Invoker</span></span><br><span class="line">        <span class="comment">//然后导出成Exporter，并缓存</span></span><br><span class="line">        <span class="comment">//这里的proxyFactory实际是JavassistProxyFactory</span></span><br><span class="line">        <span class="comment">//有关详细的获得Invoke以及exporter会在下面的流程解析，在本地暴露这个流程就不再说明。</span></span><br><span class="line">        Exporter&lt;?&gt; exporter = protocol.export(</span><br><span class="line">                proxyFactory.getInvoker(ref, (Class) interfaceClass, local));</span><br><span class="line">        exporters.add(exporter);</span><br><span class="line">        logger.info(<span class="string">&quot;Export dubbo service &quot;</span> + interfaceClass.getName() +<span class="string">&quot; to local registry&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 远程暴露服务</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!Constants.SCOPE_LOCAL.equalsIgnoreCase(scope)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (logger.isInfoEnabled()) &#123;</span><br><span class="line">        logger.info(<span class="string">&quot;Export dubbo service &quot;</span> + interfaceClass.getName() + <span class="string">&quot; to url &quot;</span> + url);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (CollectionUtils.isNotEmpty(registryURLs)) &#123;</span><br><span class="line">        <span class="keyword">for</span> (URL registryURL : registryURLs) &#123;</span><br><span class="line">            url = url.addParameterIfAbsent(Constants.DYNAMIC_KEY, registryURL.getParameter(Constants.DYNAMIC_KEY));</span><br><span class="line">            <span class="type">URL</span> <span class="variable">monitorUrl</span> <span class="operator">=</span> loadMonitor(registryURL);</span><br><span class="line">            <span class="keyword">if</span> (monitorUrl != <span class="literal">null</span>) &#123;</span><br><span class="line">                url = url.addParameterAndEncoded(Constants.MONITOR_KEY, monitorUrl.toFullString());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (logger.isInfoEnabled()) &#123;</span><br><span class="line">                logger.info(<span class="string">&quot;Register dubbo service &quot;</span> + interfaceClass.getName() + <span class="string">&quot; url &quot;</span> + url + <span class="string">&quot; to registry &quot;</span> + registryURL);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// For providers, this is used to enable custom proxy to generate invoker</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">proxy</span> <span class="operator">=</span> url.getParameter(Constants.PROXY_KEY);</span><br><span class="line">            <span class="keyword">if</span> (StringUtils.isNotEmpty(proxy)) &#123;</span><br><span class="line">                registryURL = registryURL.addParameter(Constants.PROXY_KEY, proxy);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 根据选择的代理工厂来将代理类和相关信息封装成Invoker类，Dubbo默认使用Javassist代理</span></span><br><span class="line">            Invoker&lt;?&gt; invoker = proxyFactory.getInvoker(ref, (Class) interfaceClass, registryURL.addParameterAndEncoded(Constants.EXPORT_KEY, url.toFullString()));</span><br><span class="line">            <span class="type">DelegateProviderMetaDataInvoker</span> <span class="variable">wrapperInvoker</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DelegateProviderMetaDataInvoker</span>(invoker, <span class="built_in">this</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 根据选择不同的协议封装成不同的Exporter,选择的dubbo协议不同则封装内容和逻辑会有差异，默认dubbo协议</span></span><br><span class="line">            Exporter&lt;?&gt; exporter = protocol.export(wrapperInvoker);</span><br><span class="line">            exporters.add(exporter);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Invoker&lt;?&gt; invoker = proxyFactory.getInvoker(ref, (Class) interfaceClass, url);</span><br><span class="line">        <span class="type">DelegateProviderMetaDataInvoker</span> <span class="variable">wrapperInvoker</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DelegateProviderMetaDataInvoker</span>(invoker, <span class="built_in">this</span>);</span><br><span class="line"></span><br><span class="line">        Exporter&lt;?&gt; exporter = protocol.export(wrapperInvoker);</span><br><span class="line">        exporters.add(exporter);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@since</span> 2.7.0</span></span><br><span class="line"><span class="comment">     * ServiceData Store</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">MetadataReportService</span> <span class="variable">metadataReportService</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> ((metadataReportService = getMetadataReportService()) != <span class="literal">null</span>) &#123;</span><br><span class="line">        metadataReportService.publishProvider(url);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>封装Invoker</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; Invoker&lt;T&gt; <span class="title function_">getInvoker</span><span class="params">(T proxy, Class&lt;T&gt; type, URL url)</span> &#123;</span><br><span class="line">    <span class="comment">// 根据proxy代理类生成Invoker的包装类Wrapper,如果$开口则使用接口类型来生成Wrapper</span></span><br><span class="line">   <span class="comment">// 被final修饰后，只有在所有引用都失效后才会被GC</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">Wrapper</span> <span class="variable">wrapper</span> <span class="operator">=</span> Wrapper.getWrapper(proxy.getClass().getName().indexOf(<span class="string">&#x27;$&#x27;</span>) &lt; <span class="number">0</span> ? proxy.getClass() : type);</span><br><span class="line">    <span class="comment">// 直接返回初始化好的Invoker对象，并重写执行指定方法的Invoker方法，使用包装类wrapper来进行方法的调用，所以只有该Invoker被回收后，他的包装类才会被回收</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">AbstractProxyInvoker</span>&lt;T&gt;(proxy, type, url) &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> Object <span class="title function_">doInvoke</span><span class="params">(T proxy, String methodName,</span></span><br><span class="line"><span class="params">                                  Class&lt;?&gt;[] parameterTypes,</span></span><br><span class="line"><span class="params">                                  Object[] arguments)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">            <span class="keyword">return</span> wrapper.invokeMethod(proxy, methodName, parameterTypes, arguments);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>导出Invoker</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">public</span> &lt;T&gt; Exporter&lt;T&gt; <span class="title function_">export</span><span class="params">(Invoker&lt;T&gt; invoker)</span> <span class="keyword">throws</span> RpcException &#123;</span><br><span class="line"> <span class="comment">//registry类型的Invoker，不需要做处理</span></span><br><span class="line"> <span class="keyword">if</span> (Constants.REGISTRY_PROTOCOL.equals(invoker.getUrl().getProtocol())) &#123;</span><br><span class="line">     <span class="keyword">return</span> protocol.export(invoker);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">//非Registry类型的Invoker，需要被监听器包装</span></span><br><span class="line"> <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ListenerExporterWrapper</span>&lt;T&gt;(protocol.export(invoker), </span><br><span class="line">         Collections.unmodifiableList(ExtensionLoader.getExtensionLoader(ExporterListener.class)</span><br><span class="line">                 .getActivateExtension(invoker.getUrl(), Constants.EXPORTER_LISTENER_KEY)));</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; Exporter&lt;T&gt; <span class="title function_">export</span><span class="params">(<span class="keyword">final</span> Invoker&lt;T&gt; originInvoker)</span> <span class="keyword">throws</span> RpcException &#123;</span><br><span class="line"> <span class="comment">//export invoker</span></span><br><span class="line"> <span class="comment">//这里就交给了具体的协议去暴露服务（先不解析，留在后面，可以先去后面看下导出过程）</span></span><br><span class="line"> <span class="keyword">final</span> ExporterChangeableWrapper&lt;T&gt; exporter = doLocalExport(originInvoker);</span><br><span class="line"> <span class="comment">//registry provider</span></span><br><span class="line"> <span class="comment">//根据invoker中的url获取Registry实例</span></span><br><span class="line"> <span class="comment">//并且连接到注册中心</span></span><br><span class="line"> <span class="comment">//此时提供者作为消费者引用注册中心核心服务RegistryService</span></span><br><span class="line"> <span class="keyword">final</span> <span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> getRegistry(originInvoker);</span><br><span class="line"> <span class="comment">//注册到注册中心的URL</span></span><br><span class="line"> <span class="keyword">final</span> <span class="type">URL</span> <span class="variable">registedProviderUrl</span> <span class="operator">=</span> getRegistedProviderUrl(originInvoker);</span><br><span class="line"> <span class="comment">//调用远端注册中心的register方法进行服务注册</span></span><br><span class="line"> <span class="comment">//若有消费者订阅此服务，则推送消息让消费者引用此服务。</span></span><br><span class="line"> <span class="comment">//注册中心缓存了所有提供者注册的服务以供消费者发现。</span></span><br><span class="line"> registry.register(registedProviderUrl);</span><br><span class="line"> <span class="comment">// 订阅override数据</span></span><br><span class="line"> <span class="comment">// FIXME 提供者订阅时，会影响同一JVM即暴露服务，又引用同一服务的的场景，因为subscribed以服务名为缓存的key，导致订阅信息覆盖。</span></span><br><span class="line"> <span class="keyword">final</span> <span class="type">URL</span> <span class="variable">overrideSubscribeUrl</span> <span class="operator">=</span> getSubscribedOverrideUrl(registedProviderUrl);</span><br><span class="line"> <span class="keyword">final</span> <span class="type">OverrideListener</span> <span class="variable">overrideSubscribeListener</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OverrideListener</span>(overrideSubscribeUrl);</span><br><span class="line"> overrideListeners.put(overrideSubscribeUrl, overrideSubscribeListener);</span><br><span class="line"> <span class="comment">//提供者向注册中心订阅所有注册服务的覆盖配置</span></span><br><span class="line"> <span class="comment">//当注册中心有此服务的覆盖配置注册进来时，推送消息给提供者，重新暴露服务，这由管理页面完成。</span></span><br><span class="line"> <span class="comment">// 根据调用策略来决定订阅逻辑</span></span><br><span class="line"> registry.subscribe(overrideSubscribeUrl, overrideSubscribeListener);</span><br><span class="line"> <span class="comment">//保证每次export都返回一个新的exporter实例</span></span><br><span class="line"> <span class="comment">//返回暴露后的Exporter给上层ServiceConfig进行缓存，便于后期撤销暴露。</span></span><br><span class="line"> <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Exporter</span>&lt;T&gt;() &#123;&#125;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> <span class="comment">//根据invoker的地址获取registry实例</span></span><br><span class="line"> <span class="keyword">private</span> Registry <span class="title function_">getRegistry</span><span class="params">(<span class="keyword">final</span> Invoker&lt;?&gt; originInvoker)</span>&#123;</span><br><span class="line">     <span class="comment">//获取invoker中的registryUrl</span></span><br><span class="line">     <span class="type">URL</span> <span class="variable">registryUrl</span> <span class="operator">=</span> originInvoker.getUrl();</span><br><span class="line">     <span class="keyword">if</span> (Constants.REGISTRY_PROTOCOL.equals(registryUrl.getProtocol())) &#123;</span><br><span class="line">         <span class="comment">//获取registry的值，这里获得是zookeeper，默认值是dubbo</span></span><br><span class="line">         <span class="type">String</span> <span class="variable">protocol</span> <span class="operator">=</span> registryUrl.getParameter(Constants.REGISTRY_KEY, Constants.DEFAULT_DIRECTORY);</span><br><span class="line">         <span class="comment">//这里获取到的url为：</span></span><br><span class="line">         <span class="comment">//zookeeper://127.0.0.1:2181/com.alibaba.dubbo.registry.RegistryService?</span></span><br><span class="line">         <span class="comment">//application=dubbo-provider&amp;application.version=1.0&amp;dubbo=2.5.3&amp;</span></span><br><span class="line">         <span class="comment">//environment=product&amp;export=dubbo%3A%2F%2F192.168.1.100%3A20880%2F</span></span><br><span class="line">         <span class="comment">//dubbo.common.hello.service.HelloService%3Fanyhost%3Dtrue%26application%3Ddubbo-provider%26</span></span><br><span class="line">         <span class="comment">//application.version%3D1.0%26dubbo%3D2.5.3%26environment%3Dproduct%26</span></span><br><span class="line">         <span class="comment">//interface%3Ddubbo.common.hello.service.HelloService%26methods%3DsayHello%26</span></span><br><span class="line">         <span class="comment">//organization%3Dchina%26owner%3Dcheng.xi%26pid%3D9457%26side%3Dprovider%26timestamp%3D1489807681627&amp;organization=china&amp;owner=cheng.xi&amp;</span></span><br><span class="line">         <span class="comment">//pid=9457&amp;timestamp=1489807680193</span></span><br><span class="line">         registryUrl = registryUrl.setProtocol(protocol).removeParameter(Constants.REGISTRY_KEY);</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="comment">//根据SPI机制获取具体的Registry实例，这里获取到的是ZookeeperRegistry</span></span><br><span class="line">     <span class="keyword">return</span> registryFactory.getRegistry(registryUrl);</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>Dubbo 会在 Spring 实例化完 bean 之后，在刷新容器最后一步发布 ContextRefreshEvent 事件的时候，通知实现了 ApplicationListener 的 ServiceBean 类进行回调 onApplicationEvent 事件方法，Dubbo 会在这个方法中调用 ServiceBean 父类 ServiceConfig 的 export 方法，而该方法真正实现了服务的（异步或者非异步）发布。</p>
</li>
</ul>
</li>
</ul>
<h1 id="Netty"><a href="#Netty" class="headerlink" title="Netty"></a>Netty</h1><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/Java-JJ/p/12692454.html">Netty</a><br><a target="_blank" rel="noopener" href="https://www.16175.com/13353.html">Netty</a></p>
<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>Netty是一款基于NIO非阻塞IO模型开发的网络通信框架，相比于BIO，Netty在性能以及内存损耗方面有很大的提升。</p>
<h2 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h2><h4 id="1-IO模型"><a href="#1-IO模型" class="headerlink" title="1.IO模型"></a>1.IO模型</h4><p>在Netty中，IO操作主要分为两个部分：Acceptor(建立连接)，write/read(IO读写操作)。而Netty可以通过选择不同的Reactor线程模型来选择提高IO效率：</p>
<ul>
<li><p>单Reactor单线程模式<br>由于Reactor模式使用是异步非阻塞IO，所以一个线程可以独立处理所有的IO相关操作。单个线程通过Acceptor接受客户端的TCP连接请求，链路建立成功后Reactor通过Dispatch将对应ByteBuffer派发到指定的Handler上进行消息消息编解码。在模式下只有单一线程进行IO处理。</p>
</li>
<li><p>单Reactor多线程模式<br>该模式下Acceptor和write/read两种操作会由不同的线程进行担任，会有一个专门NIO线程-Acceptor线程用于监听服务端，接受客户端TCP连接消息。网络IO操作（读写操作）都会由一个NIO线程池负责，线程池使用JDK线程池实现，其中还包含一个任务队列和可用线程计数器。</p>
</li>
<li><p>多Reactor多线程模式<br>该模式下用于接受客户端创建链路连接线程不再由单一线程进行担任，而是由一个独立的NIO线程池进行处理。Acceptor线程池接收到客户端TCP连接请求后，将新创建的SocketChannel注册到IO线程池中的某个IO线程上，由他进行数据的写入，编码，解码，读出工作。</p>
</li>
</ul>
<h5 id="NIO组成"><a href="#NIO组成" class="headerlink" title="NIO组成"></a>NIO组成</h5><ul>
<li><p>Buffer:与Channel进行交互，NIO面向的缓冲区。当NIO存在有效连接并进行性数据写入写出时都会与该Buffer进行交互。所以数据都是从Channel读入缓冲区，从缓冲区写入Channel中。</p>
</li>
<li><p>Channel：信道，缓冲区和IO源的连接，不同于Stream的单向传输，Channel是可以进行双向传输的。在Channel进行数据移动的时候会调用native方法，将按照数据块为单位写入/写出。相比于Stream的IO操作，Channel在效率方面会高出三分之一左右（原因还未知，但主要两方面，传输方式零拷贝，传输数据单位）。<a target="_blank" rel="noopener" href="https://my.oschina.net/u/4303561/blog/3828050">Channel VS Stream</a></p>
</li>
<li><p>Selector：多路复用器。可使用一个单独的线程管理多个Channel,串行遍历进行IO操作。其中open方用户创建Selector,register用于向Selector注册Channel。Java中的Selector默认使用Epoll但是可以通过参数来指定其他的多路复用器。</p>
</li>
<li><p>NIOEventLoopGroup：时间循环处理类，内部维护一个由EventExector children []默认大小是处理器核数*2构成的线程池。</p>
<h4 id="2-内存零拷贝"><a href="#2-内存零拷贝" class="headerlink" title="2.内存零拷贝"></a>2.内存零拷贝</h4><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/xys1228/p/6088805.html#_caption_2">零拷贝实现</a></p>
</li>
</ul>
<p>1.相比于BIO面向流开发，Netty使用NIO模型面向（堆外内存）缓冲区进行开发。Netty接收和发送ByteBuffer采用DIRECT BUFFERS(堆外缓存）,使用堆外内存进行Socket读取不用进行字节缓冲区的二次拷贝。传统堆内存进行Socket读写，JVM会将堆内存Buffer拷贝一份到直接内存中再写入Socket中，相比堆外内存，传统堆内存会多一次缓冲区内存拷贝。<br>2.Netty提供组合Buffer对象，例如CompositeByteBuf可以将报文进行粘包/切包不再像传统内存拷贝方式将几个小的Buffer合并成一个Buffer进行处理。<br>3.Netty文件传输采用transferTo方法，它可以直接将文件缓冲区的数据发送到目标Channel，避免了传统通过循环write方式导致的内存拷贝问题。</p>
<h4 id="3-串形化读写处理"><a href="#3-串形化读写处理" class="headerlink" title="3.串形化读写处理"></a>3.串形化读写处理</h4><p>Netty在IO线程内部进行串行化操作，避免了多线程竞争导致性能下降。在IO线程内部通会通过线程池启动多个串行化线程并行运行，每个线程通过串行方式遍历所有与该线程绑定的Channel,在NioEventLoop(IO线程池)读到消息后会调用ChannelPipeline的fireChannelRead进行数据的读或者写，只要线程池不主动切换线程会由NioEventLoop调用用户的Handler进行操作，期间不进行线程切换所以不会导致资源的竞争避免锁操作。</p>
<h4 id="4-高性能序列化协议"><a href="#4-高性能序列化协议" class="headerlink" title="4.高性能序列化协议"></a>4.高性能序列化协议</h4><p>Netty默认提供对Google Protobuf 的支持，可以通过扩展Netty的编解码接口，可以让用户实现其他高性能序列化框架，例如Thrift的压缩二进制编解码框架。</p>
<h4 id="5-内存池设计"><a href="#5-内存池设计" class="headerlink" title="5.内存池设计"></a>5.内存池设计</h4><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/pentiumchen/article/details/45372625">内存池原理</a><br>为了避免频繁的内存分配给系统带来负担以及GC对系统性能带来的波动，Netty使全新的内存池来管理内存的分配和回收，内存池的设计主要参考Slab(Memcached的内存池)，Buddy分配两种思路来进行内存管理。<br>Slab分配：主要思路是将内存分割成大小不等的内存块，用户线程请求内存时根据请求的内存代销分配最贴近的Size的内存块。在减少碎片的同时又能很好的避免内存浪费。<br>Buddy：在分配内存的过程中把一些内存块灯亮分割，回收时合并，尽可能保证系统中有较大的连续可分配内存。</p>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color1">Dubbo</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2023/05/24/Dubbo%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>

<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>




  
    <article id="post-Redis学习(一)基础结构" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2023/05/24/Redis%E5%AD%A6%E4%B9%A0(%E4%B8%80)%E5%9F%BA%E7%A1%80%E7%BB%93%E6%9E%84/">Redis学习(一)基础结构</a>
    </h1>
  

        
        <a href="/2023/05/24/Redis%E5%AD%A6%E4%B9%A0(%E4%B8%80)%E5%9F%BA%E7%A1%80%E7%BB%93%E6%9E%84/" class="archive-article-date">
  	<time datetime="2023-05-24T08:48:22.786Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2023-05-24</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Redis"><a href="#Redis" class="headerlink" title="Redis"></a>Redis</h1><p>Redis是一款基于内存的K-V非关系型数据库.</p>
<ul>
<li>在6.x之前Redis只使用Worker线程来进行数据的读取，计算，写入，这种只有单线程下的Redis会很大被IO瓶颈所限制还有本身会造成极大的硬件资源浪费。</li>
<li>在6.x之后Redis里面实际上并不是单线程工作，而是分为worker和io thread，其中worker只负责串行提供的计算服务，而io thread只提供数据的并行read和write这样减少了Redis的处理时间的。但是实际上每个线程再对于数据的操作还是串行的单线程。</li>
</ul>
<p>Redis是二进制安全的（在使用Redis客户端进行数据的操作时均已字节数组作为数据输入或者输出流，在传输数据时，bai保证二进制数据的信息安全，也就du是不被篡改、破译等，如果被zhi攻击，能够及时检测出来。）在Redis中保存的其实是字节并且在所需类型容积不够的情况下会进行自动的扩容。<br>Redis支持数据一致性，即在Redis中进行数据新增，修改，删除后Redis数据也会做出相应的改变，防止出现脏读的现象，QJM<br>Redis的服务是无状态的，即针对每个请求服务器都会进行无差别的处理，每个请求中都包含服务器要求的所有请求参数（有状态服务，http的session，会针对每个请求都建立一个session在请求中也会保存sessionID以便可以获取到请求上下文信息）。<br>Linux提供了一个简单的Tcp连接的命令以供服务器轻量级连接数据库。nc ip port<br><img src="/assets/doc-images/redis-io.png" alt="Redis4.x&amp;6.x对比"></p>
<h2 id="IO模型（epoll）"><a href="#IO模型（epoll）" class="headerlink" title="IO模型（epoll）"></a>IO模型（epoll）</h2><p>Redis中默认IO模型，相比于poll，epoll效率更高。服务端在收到客户端的TCP连接或者有新数据传输给服务端时，服务端在内核中维护了一个红黑树表用来记录所有有状态的文件描述符（&gt;1连接或者有数据传输的），每次再去遍历所有文件描述符(连接)的时候直接从红黑树中取对应有状态的文件描述符去读取其中的Buffer从而提高读写效率。Poll不会在内核中维护有状态的FD，所以每次遍历的时候会将所有的FD都遍历一遍。selector则效率更低会不断的切换内核态和用户态来占用CPU资源且其中FD连接有上限1024个。<br><img src="/assets/doc-images/epoll.png" alt="Epoll工作模型"></p>
<h2 id="对比memcached"><a href="#对比memcached" class="headerlink" title="对比memcached"></a>对比memcached</h2><ul>
<li>Memcached也是基于内存的的非关系型的数据库。memcached可以保存的数据库结构只有String一种，且server端不会提供任何关数据计算的逻辑，所以在接收数据进行保存的时候均是以字符串或者字符json串来进行保存。而在取数的时候总是对某个KEY的Value进行全量IO提取其中的所有数据在Client进行反序列化和计算。 数据向计算移动</li>
<li>Redis相比于Memcached虽然也是基于内存的非关系型数据库但是Redis有非常丰富的Value类型，String，List，Set，Zset（有序数组），Hash。而且每种类型都提供的Server本地的算法，减少get时对于IO的压力。计算向数据移动。<br><img src="/assets/doc-images/memcached.png" alt="memcached&amp;Redis"></li>
</ul>
<h2 id="Redis数据类型"><a href="#Redis数据类型" class="headerlink" title="Redis数据类型"></a>Redis数据类型</h2><h4 id="String（字符串）"><a href="#String（字符串）" class="headerlink" title="String（字符串）"></a>String（字符串）</h4><ul>
<li><p>字符串：append(追加字符串)、strlen(字符串的字节长度)<br>Redis中字符串保存的是字节数组，所以实际上字符串类型不仅仅可以保存字符串还可以保存JSON串，图片，文件即可以通过Redis可以形成一个基于内存的文件系统（FS）。</p>
</li>
<li><p>数值：incr(自加一)，decr(自减一)</p>
</li>
<li><p>bitmap：其中保存二进制的数值，所以客户端在get时会翻译成ascii码。<br>setbit(设置对应字符串指定偏移量上的位)，getbit(获取指定Key的ascii码)，bitop(对一个或多个二进制位的字符串进行元操作并把结果保存到新字符串上 bitop and/or/xor/not newkey key/[keys])<br>bitmap实际上通过位操作来统计矩阵中保存的信息，通过位运算可以更快的得到计算结果并保存。</p>
</li>
</ul>
<h4 id="List（列表）"><a href="#List（列表）" class="headerlink" title="List（列表）"></a>List（列表）</h4><p>List中保存的是有序且可能重复的，其底层存储的是双向链表，并且存储有链表的头尾指针，这样可以保证从头和尾双向进行操作。</p>
<h4 id="Hash（哈希表）"><a href="#Hash（哈希表）" class="headerlink" title="Hash（哈希表）"></a>Hash（哈希表）</h4><p>Redis的K-V结构中Value保存的是哈希表，也就是针对每个Value都有field来作为哈希的Key。每个 hash 可以存储 232 - 1 键值对。</p>
<h4 id="Set（集合）"><a href="#Set（集合）" class="headerlink" title="Set（集合）"></a>Set（集合）</h4><p>Set中保存的是无序的集合，不维护排序也不维护插入顺序。主要用于集合操作但也会产生随机事件。在数量小的时候是使用intTable构成集合，当数据量变大后就会由hashTable来进行存储。<br>SRANDMEMBER key count：随机取出一个结果集，如果正数则取出不重复的结果集，如果大于memers只会取出所有数据，如果负数则一定会取出固定数量但是可重复的结果集。</p>
<h4 id="ZSet（有序集合）"><a href="#ZSet（有序集合）" class="headerlink" title="ZSet（有序集合）"></a>ZSet（有序集合）</h4><p>实际上是Set集合，但是是维护可自定义顺序的集合,物理内存左小右大顺序，不会随着命令改变保存顺序。其底层实际上是由跳跃表实现的，在集合中的每个元素有三层维度（分值，数据，索引（index））该数据类型也支持集合操作交并差，再进行交并差时还会提供对于分值的处理(两分值取Max,Min或者求和，没有指定聚合函数的话默认是取sum)。其底层存储的数据结构为跳跃表实现。<br>跳跃表(类平衡树)主要有底层全数据元素构成的双向链表以及每个链表元素相同元素组成的子链表构成。但是每个链表元素相同元素的子链表的元素个数是完全随机的（随机早层），但是最大数量不超过64。其中子链表每个index下的都会与相邻最近存在相同参差得元素建立了连接。所以跳跃表查询的时候是从底层全数据构成的双向链表的最高层开始查询若是比该元素小则去一下该层的元素查询。（比目标元素小同层查询，比目标元素大降层查询    ）</p>
<h2 id="Redis持久化"><a href="#Redis持久化" class="headerlink" title="Redis持久化"></a>Redis持久化</h2><p>Redis持久化有两种方式RDB和AOF：</p>
<h3 id="RDB"><a href="#RDB" class="headerlink" title="RDB"></a>RDB</h3><p>该种方式是将当前进程产生的数据保存成二进制压缩文件保存到磁盘中，可以通过手动或者自动的方式出发：</p>
<ul>
<li>手动触发：<ul>
<li>save：阻塞当前Redis服务器，知道RDB过程结束，会对服务器和内存造成较大的影响；</li>
<li>bgsave：Redis进程会使用fork操作创建出一个子进程负责RDB的过程，完成后自动结束，该种方式只有在fork阶段会造成阻塞；</li>
</ul>
</li>
<li>自动触发：<ul>
<li> 1）使用save相关配置，如“save m n”。表示m秒内数据集存在n次修改 时，自动触发bgsave。</li>
<li> 2）如果从节点执行全量复制操作，主节点自动执行bgsave生成RDB文件并发送给从节点，更多细节见6.3节介绍的复制原理。</li>
<li>3）执行debug reload命令重新加载Redis时，也会自动触发save操作。</li>
<li>4）默认情况下执行shutdown命令时，如果没有开启AOF持久化功能则 自动执行bgsave。<br>RDB文件保存在dir配置指定的目录下，文件名通过dbfilename配 置指定。可以通过执行config set dir{newDir}和config set dbfilename{newFileName}运行期动态执行，当下次运行时RDB文件会保存到新目录。</li>
</ul>
</li>
</ul>
<h6 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h6><p>因为RDB是一个紧凑的二进制文件，代表某个时间段Redis上的快照，非常适合备份或者全量复制，但是因为时间过长所以容易造成Redis服务器阻塞但是从数据恢复速度来说RDF时间远远小于AOF。</p>
<h6 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h6><p>无法做到秒级或者实时的持久化，在不影响Redis的使用情况下频繁的持久化会创建大量子进程占用资源，且Redis不同版本中存在多种格式的RDB文件，不同版本的RDB文件无法做到兼容。<br><img src="/assets/doc-images/RDB.png" alt="在这里插入图片描述"></p>
<h3 id="AOF"><a href="#AOF" class="headerlink" title="AOF"></a>AOF</h3><p>AOF方式持久化是里独立日志的方式实时记录每次的命令，重启时再重新执行AOF文件中的命令以达到数据恢复的功能，该种方法主要数据实时持久化问题，目前主流持久化方法。<br>开启Redis的AOF持久化功能需要配置appendonly yes,默认是不开启的，AOF文件名通过appendfilename配置设定，还可以设定文件路径。AOF的工作流程大概分为四个命令写入（append）,文件同步（sync）,文件重写（rewrite）、重启加载（load）<br><img src="/assets/doc-images/AOF.png" alt="AOF工作流程"><br>其中AOF文件写入并不是直接写入到文件磁盘中，而是写入到缓存中避免将压力直接交给磁盘IO，而且Redis还提供多种缓存同步磁盘的策略可以在安全和性能方面自定义平衡。<br>AOF文件不会一直无限制的增长，而是在文件达到一定大小后会进行文件的重写，重写实际上是对AOF文件的压缩，而能产生压缩的方式有很多：</p>
<ul>
<li>Redis中超时的数据不会再写入文件中；</li>
<li>会排除无效指令 例如set att,set aaa等等；</li>
<li>对于命令进行优化合并，例如ADD a 1,ADD a 2,ADD a 3。会合并成一个命令；但是为了方式单条命令过长溢出缓冲区对于Set，List，Hash，Zset等会以64个元素作为界限；</li>
</ul>
<p>也可以用其他的方式来出发重写：</p>
<ul>
<li>手动触发：直接调用bgrewriteaof命令。</li>
<li>自动触发：根据auto-aof-rewrite-min-size和auto-aof-rewrite-percentage参数确定自动触发时机<br><img src="/assets/doc-images/aof2.png" alt="在这里插入图片描述"></li>
</ul>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/d3ba7b8ad964">Redis持久化</a></p>
<h2 id="Redis过期淘汰制"><a href="#Redis过期淘汰制" class="headerlink" title="Redis过期淘汰制"></a>Redis过期淘汰制</h2><p>Redis的过期淘汰制实际上分为两个部分：过期删除，内存淘汰</p>
<ul>
<li>过期删除：实际上是由定时删除+惰性删除构成，Redis默认是每个100ms就随机抽取一批设置了过期时间的Key进行检查删除（随机抽取减小的CPU单次检查的压力），而惰性删除则是如果该key已经超过过期时间，除非去查询该key否则的话该key会一直停留在内存之中直到定时删除。</li>
<li>内存淘汰：Redis如果存在大量为删除的过期key会造成内存溢出所以针对内存会有一系列策略来保证Redis内存健康：<ul>
<li>volatile-lru：从已设置过期时间的数据集（server.db[i].expires）中挑选最近最少使用的数据淘汰</li>
<li>volatile-ttl：从已设置过期时间的数据集（server.db[i].expires）中挑选将要过期的数据淘汰</li>
<li>volatile-random：从已设置过期时间的数据集（server.db[i].expires）中任意选择数据淘汰</li>
<li>allkeys-lru：当内存不足以容纳新写入数据时，在键空间中，移除最近最少使用的key（这个是最常用的）.</li>
<li>allkeys-random：从数据集（server.db[i].dict）中任意选择数据淘汰</li>
<li>no-eviction：禁止驱逐数据，也就是说当内存不足以容纳新写入数据时，新写入操作会报错。这个应该没人使用吧！</li>
</ul>
</li>
</ul>
<h2 id="Redis集群"><a href="#Redis集群" class="headerlink" title="Redis集群"></a>Redis集群</h2><h4 id="集群同步"><a href="#集群同步" class="headerlink" title="集群同步"></a>集群同步</h4><p>数据同步有两种模式强一致性和弱一致性：</p>
<ul>
<li>强一致性：主节点在有更新数据的命令进来后会同步阻塞将该命令同步到各个从节点，知道主节点收到所有从节点都已经同步成功后才会结束阻塞请求返回，该同步方式会破坏Redis的高可用但是不会造成数据丢失；</li>
<li>弱一致性：主节点对于从节点的数据同步采用异步方式，主节点执行完命令后异步将命令发送到各个从节点后不再阻塞二十直接返回请求，这种方式会造成从节点数据丢失；<br><img src="/assets/doc-images/slave_sync.png" alt="数据一致性"></li>
</ul>
<p> Redis集群有三种模式主从模式，哨兵模式，集群模式</p>
<ul>
<li><p>主从模式：Redis节点被主节点（负责读写）和从节点（只负责读），只能存在一个主节点。一个主节点可以绑定多个从节点但是一个从节点只能属于一个主节点，主节点挂了不影响从节点读写且不会重新自助选举，但是Redis将不再支持写数据，从节点挂了不影响读写并且重启后可以从主节点重新同步数据恢复使用。<br>从节点在启动或者重启后会向主节点发送SYNC命令，主节点会将这段时间保存的RDB快照和缓存的命令都发给从节点达到数据一致。主从模式不具备高可用<br><img src="/assets/doc-images/senstive_sync.png" alt="主从复制模式"></p>
</li>
<li><p>哨兵模式：在Redis主从节点之外会增加第三种节点Sentinel(哨兵节点)，该节点可以布置成单个也可以布置成Sentinel集群。该节点主要是用来监控和管理目前Redis中所有节点，当有主节点挂掉后哨兵节点会在剩下的所有从节点中主动选举出来，首先修改当前已经变成主节点的从节点配置文件以及账号密码等信息，其次会修改其他从节点的信息变更其从节点中所依赖主节点的信息（slaveof属性会指向新的master）。而原来之前的挂掉的主节点重启后不再担任主节点。<br>工作流程：哨兵节点启动后会持续监听Master,slave以及其他哨兵节点的心跳，以每秒一次的频率向其他节点发送ping命令。若是Master没有正常的返回(超时时间也可以设置)Ping心跳则该Master会被这个Sentinel节点标记为主观下线，如果有足够(可以手动设置)的Sentinel节点标记该Master为主观下线则该节点在Sentinel中会被标记为客观下线，一般情况下每个Sentinel每隔10S会向各个节点发送INFO命令来同步信息，当一个Master被标记为客观下线后该发送INFO给Slave消息的时间会从10S变成1s。<br>当使用Sentinel模式时，客户端连接的不再是直接连接Master或者Slave节点，而是连接Sentinel节点，通过哨兵节点找到当前Master节点信息。</p>
<ul>
<li>Sentinel选举：<br>Sentinel如果要成为集群的话至少要大于等于三个，因为Sentinel选举的最低票数计算公式为（Sentinel节点数/2 + 1）如果节点只有两个的话剩下那个节点永远不会成为主节点。<br><img src="/assets/doc-images/sentinel.png" alt="Sentinel选举"></li>
</ul>
</li>
<li><p>集群模式：该模式下由多个Master以及下属的Slave构成Redis集群，该种模式下至少由六个节点构成，每个节点之间通过ping-pong来进行通信。该模式下的数据存储使用hash槽来进行数据分片，多个Master之间存储的完全不同的数据，Redisjian将Hash的Key划分为16484个hash槽，每个Master节点映射到不同的hash槽这样Redis集群中的数据可以均匀的存储在节点中。并且在扩容或者故障转移时只需将故障节点的槽位和数据进行转移或者将已分配的槽位进行重新拆分给新的节点就可以达到故障转移和扩容，在过程中不会影响其他的Master节点运行。 该模式主要使用crc16一种校验算法来实现hash。</p>
</li>
</ul>
<h2 id="数据分片"><a href="#数据分片" class="headerlink" title="数据分片"></a>数据分片</h2><p>单节点容量优先所以就需要数据分片：<br><img src="/assets/doc-images/data_split.png" alt="在这里插入图片描述"></p>
<h2 id="问题："><a href="#问题：" class="headerlink" title="问题："></a>问题：</h2><ul>
<li>缓存穿透问题：<ul>
<li>原因：因为缓存中没有高频的请求的数据，所以请求数据的压力全部转移到了数据库导致缓存失效不再分担数据压力，在节点扩容新增节点的时候也会出现这样的问题。因为再使用一致性哈希算法进行节点分片时虽然将数据进行全量重新计算，但是还是会将该节点前后相邻的两个节点上的部分数据进行重新调整所以再调整过程中数据这些数据是无法被hash到的就会造成缓存穿透。</li>
<li>方案：可以使用布隆过滤器来进行筛选是请求数据是否被缓存到，布隆过滤器使用为预算且容量可以达到亿级别。或者从代码层级对无缓存的数据进行手动重新缓存。</li>
</ul>
</li>
<li>缓存雪崩：<ul>
<li>原因：因为某种原因造成缓存宕机导致请求压力全部到数据库而导致数据崩溃，或者在大面积更新缓存数据</li>
<li>方案：事前增加备份节点或多节点共存（哨兵模式或Cluster）,事中使用本地缓存或者使用熔断器进行降级服务，事后：持久化缓存恢复数据，</li>
</ul>
</li>
<li>缓存DB数据不一致问题：<ul>
<li>原因：高并发情况下缓存更新成功但数据库更新失败</li>
<li>方案：再进行数据更新时，使用内存队列，在数据更新之前先将该缓存数据设置过期时间， 如果此时有用到缓存的查询则去检查该缓存的Key过期时间，如果该缓存已经过期则将查询的命令加入到内存队列中，等数据库数据更新完成后再依次将内存队列中同步缓存的请求执行。</li>
</ul>
</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/miss1181248983/article/details/90056960">Redis集群详解</a></p>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color1">Redis</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2023/05/24/Redis%E5%AD%A6%E4%B9%A0(%E4%B8%80)%E5%9F%BA%E7%A1%80%E7%BB%93%E6%9E%84/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>

<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>




  
    <article id="post-MySQL基础" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2023/05/24/MySQL%E5%9F%BA%E7%A1%80/">MySQL学习(一)基础结构</a>
    </h1>
  

        
        <a href="/2023/05/24/MySQL%E5%9F%BA%E7%A1%80/" class="archive-article-date">
  	<time datetime="2023-05-24T08:46:25.927Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2023-05-24</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Mysql"><a href="#Mysql" class="headerlink" title="Mysql"></a>Mysql</h1><h2 id="SQL执行过程"><a href="#SQL执行过程" class="headerlink" title="SQL执行过程"></a>SQL执行过程</h2><p>MySQL被分为两个部分引擎层负责执行具体的SQL数据，Server层提供MySQL剩余部分，引擎层会提供各种接口来让Server层的执行器进行调用以返回所需要数据。<br>客户端 –&gt; 连接器 –&gt;  分析器   –&gt; 优化器 –&gt; 执行器 –&gt; 存储引擎   –&gt;  查询缓存</p>
<ul>
<li>Server层<ul>
<li>连接器：(管理连接，权限验证)；</li>
<li>查询缓存:(缓存SQL结果) 大部分都不建议使用，对文本修改不敏感，8.0之后彻底取消；</li>
<li>分析器：(词法分析，语法分析) “SQL syntax”报错就是在该层报出；</li>
<li>优化器：(生成执行计划，索引选择)优化查询条件优先使用索引字段进行查询范围的缩小；</li>
<li>执行器：(操作引擎，返回结果)具体的执行操作，首先进行权限判断，其次根据表引擎来调用相应的接口</li>
</ul>
</li>
<li>引擎层<ul>
<li>存储引擎：(存储数据，提供读写接口)</li>
</ul>
</li>
</ul>
<h2 id="MySQL日志"><a href="#MySQL日志" class="headerlink" title="MySQL日志"></a>MySQL日志</h2><h3 id="引擎层："><a href="#引擎层：" class="headerlink" title="引擎层："></a>引擎层：</h3><h4 id="redo-Log"><a href="#redo-Log" class="headerlink" title="redo Log"></a>redo Log</h4><p>MySQL在更新数据时逐条更新写磁盘会造成会提高IO成本以及磁盘压力，为了解决此现象引进redo log（WAL技术–&gt;Write-Ahead Logging），WAL关键在于<br>InnoDB会先写日志再写磁盘，定时批量读写磁盘。InnoDB的redo log是固定大小，可以配置my.conf文件的组数和大小，每组文件环式结构从头写到末尾又重新到<br>头开始写。在写满后会进行擦除（更新磁盘），有了redo log 可以有效防止数据库异常宕机重启（crash-safe）</p>
<h3 id="Service层"><a href="#Service层" class="headerlink" title="Service层"></a>Service层</h3><h4 id="bin-Log（归档日志），所有引擎都可以使用，主要用途与归当。"><a href="#bin-Log（归档日志），所有引擎都可以使用，主要用途与归当。" class="headerlink" title="bin Log（归档日志），所有引擎都可以使用，主要用途与归当。"></a>bin Log（归档日志），所有引擎都可以使用，主要用途与归当。</h4><h6 id="不同点："><a href="#不同点：" class="headerlink" title="不同点："></a>不同点：</h6><p>1.redo log 是InnoDB引擎特有的，bin log是serverc层实现的所有引擎都可以使用;<br>2.redo log 是物理日志，记录是在某个表上修改了什么数据，bin log记录的是执行的SQL语句;<br>3.redo log 是循环写的，空间有固定的的大小，bin log 可以追加写，再文件大小达到阈值后会自动切换到下一个文件而之前的bin log文件不会进行覆盖。</p>
<h5 id="执行SQL日志流程"><a href="#执行SQL日志流程" class="headerlink" title="执行SQL日志流程"></a>执行SQL日志流程</h5><p>update *** set *** where id = 2<br>1.执行器先找引擎ID=2这一行，如果这行数据就在内存中直接返回否者从磁盘中读入内存再返回;<br>2.执行器拿到引擎给的数据，将对应更新字段更新再调用引擎接口写入这行新数据;<br>3.引擎更新这行数据到内存中，同时将更新操作记录redo log，此时redo log 处于prepare状态，然后告知执行器已经完成SQL执行；<br>4.执行器记录已经执行的SQL语句，并将bin log写入磁盘；<br>5.执行器调用引擎提交事务接口，引擎将写入的redo log改成提交(commit)状态。</p>
<h2 id="事务"><a href="#事务" class="headerlink" title="事务"></a>事务</h2><h3 id="隔离性"><a href="#隔离性" class="headerlink" title="隔离性"></a>隔离性</h3><h4 id="1-隔离级别"><a href="#1-隔离级别" class="headerlink" title="1.隔离级别"></a>1.隔离级别</h4><p>读未提交 &lt; 读提交 &lt; 可重复读 &lt; 串心化</p>
<ul>
<li>读未提交：事务没提交，事务涉及到变更就能被别的事务看到；</li>
<li>读提交：事务提交后其中所涉及的变更才会被别的事务读到；</li>
<li>可重复读： 一个事务执行过程中看到的数据，总是跟这个事务在启动是看到的数据是一致的，在该级别下其他事物也不能看到该事务变更的数据；</li>
<li>串行化：事务所涉及到的行进行操作时，读会加“读锁”写会加“写锁”，当读写发生冲突时必须等前一个事务释放锁后续事务才能继续操作<h5 id="MySQL数据查询问题："><a href="#MySQL数据查询问题：" class="headerlink" title="MySQL数据查询问题："></a>MySQL数据查询问题：</h5></li>
<li>脏读：事务A读取了另一个事务B修改的数据，但是事务B还未提交，假设事务B回滚那么事务A的数据就是未提交数据。只有在隔离级别是读未提交时会出现。</li>
<li>不可重复读：事务A先进行查询，事务B再取更新该行数据并提交事务，那事务A所使用的数据就被事务B修改，造成事务A不可预知的后果。</li>
<li>幻读：在可重复读隔离级别下，事务A查询数据，事务B进行插入/删除数据，当事务A再去查询时被插入/删除的数据不会被感知到所以出现幻读。<br><img src="https://img-blog.csdnimg.cn/20200927141713253.png#pic_center" alt="隔离级别问题"></li>
</ul>
<h4 id="2-隔离性的实现"><a href="#2-隔离性的实现" class="headerlink" title="2.隔离性的实现"></a>2.隔离性的实现</h4><h5 id="可重复读"><a href="#可重复读" class="headerlink" title="可重复读"></a>可重复读</h5><p>mysql在每条记录更新时同时会记录一套回滚操作（正常修改1-&gt;2,回滚记录2-&gt;1），更新事务（1-&gt;2-&gt;3-&gt;4）在不同时刻启动的事务都会有不同的视图，这就意味着同一条记录在同一系统中相同时间会存在多个版本（MVCC）.</p>
<h5 id="开启事务"><a href="#开启事务" class="headerlink" title="开启事务"></a>开启事务</h5><p>begin(开启) ; commit（提交）; rollback（回滚）; 但是这种开启方式是等到一个操作表语句的时候事务才会真正启动,实质上这种启动方式是在执行第一个快照语句才能获取到一致性视图<br>start transaction with consistent snapshot(开启); commit(提交)； 执行完该条命令就可以获取到一致性视图。</p>
<h5 id="MVCC-中快照的实现"><a href="#MVCC-中快照的实现" class="headerlink" title="MVCC 中快照的实现"></a>MVCC 中快照的实现</h5><p>InnoDB里面每个事务都存在由事务系统分发的transaction id作为事务的唯一ID，并且严格按照申请顺序递增。每行数据有多个版本，每次事务更新数据时会生成一个新的数据版本，并且把当前事务的transaction id作为这个数据版本的事务ID记为 row_trx_id,同时旧的数据版本也要保留。row_trx_id会逐渐递增这样就能保证该事务可以读到最新的回滚日志和数据版本。而新事物修改数据产生新的数据版本的时候InnoDB会根据两次数据版本的不同计算出undo log并保存。<br>InnoDb会为每一个事物构造一个数组来保存这个事务启动瞬间当前”活跃“（启动还没提交）的所有事务ID，这个数据里面ID最小就是这个事务的低水位也就是当前数据的倒数第二低版本，最高的ID就是最新启动的事务，高低水位构成了当前事务的一致性视图。在事务启动构成视图数据的时候，一个数据版本的row_trx_id大致会出现三种情况：（判断高低水位线非常非常重要用来判断当前事务可读数据上下限）<br>（1）事务启动时，其他相关事务都已经提交，说明这个时候的数据版本是最新即数据是可见的;<br>（2）事务启动时，其他相关事务还未开始（begin之后是不并不是立马启动，直到有语句还是执行事务才会真正的启动），表示这个版本由将来启动的事务生成的，数据不可见；<br>（3）事务启动时，有其他相关事务正在执行还未提交：a.该数据现在的row_trx_id在数组中，表示生成这个版本的事务还没有提交。 b.若tow_trx_id 不在数据中，证明这个数据版本已经没其他事务正在操作了，数据可见。</p>
<h6 id="PPS-例子（可重复读情况下）："><a href="#PPS-例子（可重复读情况下）：" class="headerlink" title="PPS 例子（可重复读情况下）："></a>PPS 例子（可重复读情况下）：</h6><p>事务执行顺序<br>A先开始-&gt;B在开始-&gt;C开始更新-&gt;B开始更新-&gt;A开始查询并且提交事务-&gt;B提交事务</p>
<ol>
<li>事务 A 开始前，系统里面只有一个活跃事务 ID 是 99；</li>
<li>事务 A、B、C 的版本号分别是 100、101、102，且当前系统里只有这四个事务；</li>
<li>三个事务开始前，(1,1）这一行数据的 row trx_id 是 90。<br>这样，事务 A 的视图数组就是 [99,100], 事务 B 的视图数组是 [99,100,101], 事务 C 的视 图数组是 [99,100,101,102]。</li>
</ol>
<h6 id="更新逻辑：（先读后写，读当前的值称为当前读）"><a href="#更新逻辑：（先读后写，读当前的值称为当前读）" class="headerlink" title="更新逻辑：（先读后写，读当前的值称为当前读）"></a>更新逻辑：（先读后写，读当前的值称为当前读）</h6><p>对于上面的例子对于C事务在执行完就立刻提交了所以再B进行更新的时候可以读取到该行数据最新版本，从而可以准确更新而不会是C事务丢失。除了update语句外还有select语句如果加锁也是当前读，所以对于事务A加上lock in share mode 或者for update 都会获取到最新的数据。但是假设如果C事务在更新完并没有立刻提交而是延迟到B事务更新完再进行操作，当B再去前读的时候该行数据的最新版本虽然已经生成了但是数据上的写锁还没有是释放所以B事务会被阻塞直到C写锁被释放掉。<br>事务的可重复读和核心其实就是一致性读（事务进行更新数据的时候只能用用当前读，如果记录被其他事物占用就等待至其他事务释放锁）</p>
<h2 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h2><h3 id="索引实现方式"><a href="#索引实现方式" class="headerlink" title="索引实现方式"></a>索引实现方式</h3><p>1.哈希表<br>2.有序数组<br>3.搜索树</p>
<h3 id="InnoDB的索引模型"><a href="#InnoDB的索引模型" class="headerlink" title="InnoDB的索引模型"></a>InnoDB的索引模型</h3><p>在InnoDB中，使用B+树索引模型(B+树详解：<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/71700a464e97)%EF%BC%8C%E5%85%B6%E4%B8%AD%E7%B4%A2%E5%BC%95%E5%A4%A7%E8%87%B4%E5%88%86%E4%B8%BA%E4%B8%A4%E7%A7%8D%EF%BC%8C%E4%B8%BB%E9%94%AE%E7%B4%A2%E5%BC%95%E5%92%8C%E9%9D%9E%E4%B8%BB%E9%94%AE%E7%B4%A2%E5%BC%95%E3%80%82%E9%80%90%E6%B8%90%E7%B4%A2%E5%BC%95%E4%B8%AD%E5%AD%98%E6%94%BE%E7%9A%84%E6%98%AF%E8%AF%A5%E8%A1%8C%E4%BF%A1%E6%81%AF">https://www.jianshu.com/p/71700a464e97)，其中索引大致分为两种，主键索引和非主键索引。逐渐索引中存放的是该行信息</a><br>而非主键索引中存放的主要是主键信息，所以在用索引查找的时候首先通过普通索引查找到对应的主键信息再去查找主键索引所构建的树从而获取指定信息。</p>
<h3 id="索引维护"><a href="#索引维护" class="headerlink" title="索引维护"></a>索引维护</h3><p>B+树维护索引（叶子结点）有序性时，会在每次更新数据操作时候重新维护主键索引树，在主键索引树的叶子节点上都会维护一份数据页用来保存这行数据，其中如果使用自增主键<br>则在新增的时候会一定程度上减少维护主键的性能损耗（B+树再维护的时候性能使用的时候会比较稳定）。当增加该表字段后超过叶子节点初始数据页的大小后会开始分裂数据页，同<br>一行的数据会保存在两个数据页中，但这样整体空间利用率会降低50%。（所以主键长度越小普通索引叶子节点就越小，非主键索引占用空间就越小）,由于普通索引在建立树的过程中是<br>使用本身数据进行排序所以每个节点上会存在该索引数据在写SELECT语句的过程中建议多查索引字段会减少回表过程增加的时间。相比二叉搜索树B+树会大幅度减少磁盘读写平均次数以<br>及平均搜索时间。 （大量相同的元素怎么排列）</p>
<h3 id="最左前缀原则"><a href="#最左前缀原则" class="headerlink" title="最左前缀原则"></a>最左前缀原则</h3><p>在普通索引树中，索引项中的字段顺序是由创建所以时决定的，在进行查询的时候，是从该顺序最左边开始验证（必须得通过第一个索引的验证再能验证后面的联合索引其他字段），所以<br>再使用和检查联合索引的时总是从联合索引的最左边索引开始进行索引。</p>
<h4 id="失效条件："><a href="#失效条件：" class="headerlink" title="失效条件："></a>失效条件：</h4><p>1.由于联合索引在范围中只能支持一个，在执行语句时会向右直到遇到第二个索引组内的字段（&gt;,&lt;,between,like）就停止匹配使用单个索引；<br>2.=和in可以乱序都可以使用组合索引，但是!=和not in会直接使索引失效；<br>3.where条件中对该索引字段使用函数或者表达式；<br>4.or同样会使索引失效，除非or的所有条件都是索引；<br>5.like 以%开头<br>6.字符串类型的列值查询的时候不用引号会使索引失效。</p>
<h3 id="索引下推"><a href="#索引下推" class="headerlink" title="索引下推"></a>索引下推</h3><p>再MySQL 5.6之后引入索引下推优化， 在搜索索引树的过程中会将所以中包含的条件字段先做判断，返回有效的主键ID，在判断非索引字段，这样大大减少回表时间，之前版本再使用完索引后查询出主键ID再去逐个进行其他字段的比较增大回表次数。</p>
<p>组合索引在索引键排序的过程中也是遵循联合索引中的字段顺序，在order by中也是遵循最左原则的</p>
<h3 id="更新索引"><a href="#更新索引" class="headerlink" title="更新索引"></a>更新索引</h3><p>因为InnoDB的数据是按照数据页（默认大小16K）为单位来进行读写的，所以在更新的时候大致会分为两种情况：<br>1.数据页已经被读到内存中：<br>（1）普通索引：找到目标值位置插入，语句结束。<br>（2）唯一索引：找到目标值位置，判断是否该位置存在值，插入值，结束语句。<br>2.数据页没有被读到内存中：<br>（1）普通索引：更新记录在change buffer中，语句结束。其中change buffer是能被持久化的，change buffer应用到原数据页得到最新结果过程称为merge（原版本数据读入内存中应用<br>change buffer中的相关变化生成新版本）,除了访问这个数据页会出发merger系统有后台线程会定期merge。数据库正常关闭（shutdown）过程中也会执行merge。change buffer是存放<br>在buffer pool中的所以大小比例只有在数据库初始化时才会被设置的。（ innodb_change_buffer_max_size，来设置change buffer占用 buffer pool的内存）<br>（2）唯一索引： 读数据页到内存中，判断是否有冲突再插入该值。<br>change buffer 更适用于写多读少的业务场景，触发merge的概率减小不会额外增加数据库维护merge的成本。</p>
<h3 id="索引查询异常"><a href="#索引查询异常" class="headerlink" title="索引查询异常"></a>索引查询异常</h3><p>MySQL中Service中的优化器在选择最优执行方案的时候核心思想用最小的代价去执行语句。其中判断最小代价的条件包括扫描行数、是否使用临时表、是否排序（索引字段本来就是有序的）等因素去判断选择什么索引。<br>扫描行数根据统计信息来估算记录行数，统计信息就是索引的“区分度”,索引上不同的值越多索引区分度（索引上不同值的个数称为基数）越好，使用show index tableName 来查看该表上的所有索引详情，但是基数不<br>一定准确，基数并不是每条记录被更新时都会进行更新的。InnoDB默认会选择N个数据页来统计这些数据页上面的基数平均值再乘以数据页数就得到索引的基数（所以索引的区分度越高基数越准）;<br>所以在优化SQL的时候可以人为指定所需索引（select * from t index(a) where a …..），在优化SQL的时候可以通过analyze命令来修整某一个表内的索引基数（索引基数更新频率慢所以需要人为优化看到真实基数）。</p>
<h2 id="全局锁和表锁"><a href="#全局锁和表锁" class="headerlink" title="全局锁和表锁"></a>全局锁和表锁</h2><h3 id="MySQL-锁类型"><a href="#MySQL-锁类型" class="headerlink" title="MySQL 锁类型"></a>MySQL 锁类型</h3><h4 id="全局锁："><a href="#全局锁：" class="headerlink" title="全局锁："></a>全局锁：</h4><p>数据库加锁，Flush tables with read lock(只读)，释放锁 unlock tables;<br>使用一般用于全库备份，但是Mysql可以通过自带的备份工具MySQL dump来实现备份，当MySQL dump使用参数-single-transaction时候导入数据之前就会启动一个事务来获取一致性视图。set global readonly=true 可以产生<br>同样的效果，是的整个数据库处于只读状态，但是备份时不建议选这种方式，一般该字段用来区分主从库，而且该参数不能自动打断或者释放，FTWRL可以通过Exception来实现中断。</p>
<h4 id="表锁："><a href="#表锁：" class="headerlink" title="表锁："></a>表锁：</h4><p>有两种表级别锁：表锁（加锁 lock tables… read/write,该语句会限制所有线程对该表的操作包括本身线程）、元数据锁（MDL 不需要显示使用，SQL语句执行的时候会自动附加上）,在update的时候如果where条件索引失效会将行锁升级为表锁。</p>
<h4 id="行锁"><a href="#行锁" class="headerlink" title="行锁"></a>行锁</h4><p>InnoDB事务中，行锁是在需要的时候才加上，但不是不需要就立刻释放而是等到事务结束才会释放锁–两阶段锁协议</p>
<h4 id="死锁和死锁检测"><a href="#死锁和死锁检测" class="headerlink" title="死锁和死锁检测"></a>死锁和死锁检测</h4><p>1.设置innodb_lock_wait_timeout来设置锁等待时间<br>2.发起死锁检测，设置innodb_deadlock_detect = on 来开启死锁检测，当检测到死锁后会主动回滚死锁中的某一个事务</p>
<h4 id="悲观锁："><a href="#悲观锁：" class="headerlink" title="悲观锁："></a>悲观锁：</h4><p>假设每次获取资源都会有人进行修改或者占用，所以再获取的资源的时候都会加上锁直到使用完成后才会释放锁。共享资源同时只能有一个线程使用直到释放锁，MySQL中行锁，表锁，读锁，写锁都是使用的悲观锁</p>
<h4 id="乐观锁："><a href="#乐观锁：" class="headerlink" title="乐观锁："></a>乐观锁：</h4><p>假设每次获取资源的时候都没有人进行占用，所以乐观锁再获取资源的时候不会上锁，只有在更新的时候惠佳谁去判断该资源是否有修改过（比较和替换是一个原子操作）。其中乐观锁使用版本号机制和CAS算法实现，其中版本号在每次获取资源的时候会一起获取到，当修改的时候会将公共资源的版本号加一（Elastic中元数据组中version使用相同的思想），在更新的时候还会检查版本号若是不相等拒绝修改。CAS算法(compare and swap)无锁算法，其中涉及三个操作数，(需要读写的内存值V,进行比较的值A,拟写入的新值B)，有且仅当V等于A时CAS通过原子操作用B来更新V否则会进行自旋操作（不断进行重试）。</p>
<h5 id="乐观锁缺点"><a href="#乐观锁缺点" class="headerlink" title="乐观锁缺点"></a>乐观锁缺点</h5><h6 id="1-ABA问题"><a href="#1-ABA问题" class="headerlink" title="1.ABA问题"></a>1.ABA问题</h6><p>如果V的初始值是A并且在准备赋值的时候检查到它仍是A但是中间有其他的线程修改过A最后由恢复修改回来，所以A并不是没有进行过修改。</p>
<h6 id="2-循环时间开销大"><a href="#2-循环时间开销大" class="headerlink" title="2.循环时间开销大"></a>2.循环时间开销大</h6><p>不断进行自旋操作会增加CPU占用时间</p>
<h6 id="3-只能保证一个共享变量的原子操作"><a href="#3-只能保证一个共享变量的原子操作" class="headerlink" title="3.只能保证一个共享变量的原子操作"></a>3.只能保证一个共享变量的原子操作</h6><p>CAS只对单个共享变量有效，当操作涉及多个共享变量的时候CAS无效。</p>
<h4 id="间隙锁"><a href="#间隙锁" class="headerlink" title="间隙锁"></a>间隙锁</h4><p>本质上也是排它锁，为了防止出现幻读情况。间隙锁是在事务查询数据的过程中将查询到的数据前后间隙进行加锁防止前后间隙出现插入或者删除的情况。这时如果有其他其他事务在该数据相邻间隙插入数据就会产生幻读所以在事务A读取数据的过程中就会对被查询的数据相邻的间隙（相同列数据相邻不同数据之前可插入的部分称为间隙）加锁。<br>间隙锁添加的条件：</p>
<ul>
<li>必须在RR隔离级别下</li>
<li>检索条件必须有索引（否则会遍历全表造成全表的加锁）<br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/crazylqy/p/7821481.html">间隙锁</a></li>
</ul>
<h4 id="意向锁"><a href="#意向锁" class="headerlink" title="意向锁"></a>意向锁</h4><p>本质上是表锁，为了解决表锁和行锁冲突问。在事务A加完行锁后但还未释放，事务B要对该行所在的表进行加表锁，而意向锁是可以让表锁快速遍历到该表上是否存在行锁，如果存在先暂时阻塞。<br>所以Mysql在申请数据库的行锁时会先申请该表的意向锁(排他，共享)，再去申请该表或者行锁。<br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/devilwind/p/8086404.html">行锁</a></p>
<h2 id="内存管理"><a href="#内存管理" class="headerlink" title="内存管理"></a>内存管理</h2><p>MySQL中为了减少读取磁盘次数造成IO压力，实际上会在内存中缓存以数据页为单位的磁盘数据，但是只有在实际查询的时才会将磁盘中的数据页读取到内存中（数据页至少包含两行实际记录），当内存中的数据页和磁盘中数据页不一致的时候内存中的数据页称为脏页；内存中数据页写入磁盘中，数据保持了一致称该数据页为干净页。内存数据写入进磁盘的过程叫做flush。</p>
<h3 id="刷新数据页条件"><a href="#刷新数据页条件" class="headerlink" title="刷新数据页条件"></a>刷新数据页条件</h3><p>1.InnoDB 的redo log 写满了，这时系统会停止所有更新操作，推进redo log中checkpoint的位置,在推进过程中也会不断的将推进redo log中的脏页数据刷新至磁盘中。<br>2.内存满了，内存中在select的时候会去将数据页读取到内存中以减少IO压力，但是这样就会导致很多无用或者很久之前用的数据停留在内存中，从而导致内存溢出，所以该场景就是在有大量数据缓存在内存中时无法再提供新数据页就会淘汰脏页，将内存中的数据写到磁盘中。<br>3.系统空闲自动刷新。<br>4.系统shutdown。</p>
<h4 id="性能影响对比"><a href="#性能影响对比" class="headerlink" title="性能影响对比"></a>性能影响对比</h4><p>1.redo log写满要Flush脏页时，整个系统不再接受更新知道刷完checkpoint推进过程中的脏页为止。这个过程是InnoDB极力避免的。<br>2.这种情况下是系统的常态，InnoDB 使用Buffer pool管理内存，缓存池中的内存存在三种状态：未使用，使用并干净，使用并脏页，所以为了控制内存不足，InnoDB会控制内存中脏页的比例。</p>
<h4 id="InnoDB-刷脏页控制策略"><a href="#InnoDB-刷脏页控制策略" class="headerlink" title="InnoDB 刷脏页控制策略"></a>InnoDB 刷脏页控制策略</h4><p>可以通过控制数据库表参数innodb_io_capacity 来控制刷新脏页IO效率，默认是75%</p>
<h6 id="初始化例子："><a href="#初始化例子：" class="headerlink" title="初始化例子："></a>初始化例子：</h6><p>一个内存配置为 128GB、innodb_io_capacity 设置为 20000 的大规格实例，正常会建议 你将 redo log 设置成 4 个 1GB 的文件。脏页不保存在redo log中。</p>
<h2 id="MySQL-数据存储"><a href="#MySQL-数据存储" class="headerlink" title="MySQL 数据存储"></a>MySQL 数据存储</h2><p>InnoDB中的数据5.6以后默认单独存放成.ibd文件，但是允许由innodb_file_per_table来控制存放位置。该开关OFF则表数据存放在系统共享空间中（数据字典存放的位置），再删除数据后该表所占空的空间不会进行回收；该开关ON单独存放成一个文件。</p>
<h3 id="数据删除流程"><a href="#数据删除流程" class="headerlink" title="数据删除流程"></a>数据删除流程</h3><p>table里的数据实际上是以包含主键为节点的一棵B+树中，其中每个叶子节点都一个数据页，其中最少包含两行记录。<br>所以再删除数据的过程中实际上就是删除主键索引树中的叶子节点内的行数据，但是删除某一行数据后若该数据页内的数据页没有清空，该位置的记录可以被复用，当数据页整个被清空了则该数据页可以被复用，当相邻数据页的利用率很低时会合并数据页（B+数节点数据过多时会分裂数据页并且重新维护B+树），所以delete命令把记录的位置或者数据页标为可复用但是磁盘文件大小是不会变的，delete命令不能回收空间只会造成B+树空洞。</p>
<h3 id="重建表"><a href="#重建表" class="headerlink" title="重建表"></a>重建表</h3><p>做表的迁移会是空间收缩，5.5之前可以使用 alter table A engine=InnoDB来重建表（实质上是创建一张临时表B再一条条冲A表读取并插入到B中），但是在5.5之后引进Online DDL对重建表进行了优化，而Online DDL过程大致如下：<br>1.建立一个临时文件（临时文件存放于tmp_table由server层创建），扫描表A主键所有的数据页；<br>2.用数据页A中的记录生成主键索引B+树，存储到临时文件中；<br>3.生成临时文件的过程中，将所有对A的操作记录日志文件（row log）中；<br>4.临时文件生成后，将日志中的操作应用到临时文件中，得到一个逻辑数据上与表A线沟通呢的数据文件；<br>5.临时文件替换表A文件。<br>对于重建表的不同算法来说（online,inplace,copy）都是需要去创建临时文件的，但是临时文件的存放位置和执行过程就会对系统造成不同程度性能损耗。</p>
<ul>
<li>copy：临时表是由server层创建，而且在复制的过程中不能对表进行任务修改操作</li>
<li>online:相同模式的建立临时表，但是建立临时表的过程中会记录该表的修改操作，最后再进行应用就得到一张在不阻塞更新的前提下的一张新表</li>
<li>inplace:临时文件存放于InnoDB中，整个DDL都在InooDB中完成，减少了数据迁移（server-&gt;InnoDB）<br>修改表的算法指定（alter table t engine=innodb,ALGORITHM=copy）,DDL过程如果是Online的就一定是Inplace的，如果Inplace的DDL有可能不是onlined的，8.0之后添加全文索引和空间索引就是后者。</li>
</ul>
<h2 id="group-by-排序算法"><a href="#group-by-排序算法" class="headerlink" title="group by 排序算法"></a>group by 排序算法</h2><h6 id="范例SQL："><a href="#范例SQL：" class="headerlink" title="范例SQL："></a>范例SQL：</h6><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `t` (</span><br><span class="line">`id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">`city` <span class="type">varchar</span>(<span class="number">16</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">`name` <span class="type">varchar</span>(<span class="number">16</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">`age` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">`addr` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line"><span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">KEY `city` (`city`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB;</span><br><span class="line"></span><br><span class="line">查询语句：</span><br><span class="line"><span class="keyword">select</span> city,name,age <span class="keyword">from</span> t <span class="keyword">where</span> city<span class="operator">=</span><span class="string">&#x27;杭州&#x27;</span> <span class="keyword">order</span> <span class="keyword">by</span> name limit <span class="number">1000</span>  ;</span><br></pre></td></tr></table></figure>
<h3 id="全字段排序"><a href="#全字段排序" class="headerlink" title="全字段排序"></a>全字段排序</h3><p>通过执行计划可以看出SQL的执行时的优化器为SQL所做出的选择。Extra字段下可以通过描述看出是否需要排序，<br>上面范例查询语句中：<br>1、首选会初始化sort_buffer，确定防御name、city、age三个字段；<br>2、从索引树中查找出主键ID；<br>3、从主键ID索引树中取出对应ID的三个字段放入sort_buffer(这阵缓存的数据是按照city进行排序的，相对name是乱序)；<br>4、将sort_buffer中的数据进行排序；<br>5、向执行器返回所需数据结果。</p>
<h5 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h5><p>因为sort_buffer大小有限（sort_buffer_size参数来设置排序缓存的大小）所以在所选字段比较多的情况或者字段太长的情况下就需要额外的磁盘临时文件（tmp）来支持排序。外部排序一<br>般使用归并排序将分成若 干分的数据文件（sort_buffer_size越小分成的文件数量越多）进行排序生成汇总一个有序的文件。</p>
<h3 id="rowid排序"><a href="#rowid排序" class="headerlink" title="rowid排序"></a>rowid排序</h3><p>当单行大小超过阈值时（max_length_for_sort_data  控制启用rowid算法的启用大小），更换算法不在将所选字段全部放进内存中进行排序，而是将排序字段和主键ID放入sort_buffer中进行排序:<br>1、初始化sort_buffer，确认只放入排序字段和主键ID；<br>2、通过查询条件查询出满足条件的主键ID和所选字段放入sotr_buffer中；<br>3、sort_buffer排序；<br>4、取满足条件的行数再到主键索引树中取出所查询的字段；</p>
<h4 id="PS"><a href="#PS" class="headerlink" title="PS"></a>PS</h4><p>Mysql的设计思想就是如果内存大小够尽量使用内存，尽量减少磁盘访问减少IO压力，但是使用联合索引会对固定业务的排序有很大的优化，因为联合索引是针对固定字段的顺序,所以对多字段排序可以省去<br>sort_buffer排序的步骤和回表的步骤。</p>
<h4 id="order-by-rang-排序"><a href="#order-by-rang-排序" class="headerlink" title="order by rang()排序"></a>order by rang()排序</h4><p>对于取随机数Mysql需要使用临时表来进行排序和取数，（执行计划中 extra字段显示 Using temporary表示使用临时表，但是临时表分为内存和磁盘下面会详细说明）：</p>
<h4 id="内存临时表（可以理解为内存数组，因为就两列，R值可以看成下标）："><a href="#内存临时表（可以理解为内存数组，因为就两列，R值可以看成下标）：" class="headerlink" title="内存临时表（可以理解为内存数组，因为就两列，R值可以看成下标）："></a>内存临时表（可以理解为内存数组，因为就两列，R值可以看成下标）：</h4><p>1、先在内存中创建一个使用memory引擎的临时表，该表只有两个字段double的R（实际存放小于一的随机数）、varchar字段的W（存放该行数据word）；<br>2、从目标表中扫描出符合条件的数据行，生成一个0&lt;random&lt;1的R值存入临时表；<br>3、按照R值对临时表进行排序；<br>4、初始化sort_buffer，只放入两个字段R值和位置信息（rowid（系统自动生成长度为6字节的数据）或者主键）；<br>5、取出临时表内的数据存放到sort_buffer中；<br>6、sort_buffer按照R字段排序；<br>7、取出sort_buffer中前三个位置信息以次到内存表中取出word值返给客户端。</p>
<h3 id="磁盘临时表"><a href="#磁盘临时表" class="headerlink" title="磁盘临时表"></a>磁盘临时表</h3><p>理解不了 待续 17</p>
<h2 id="SQL-执行效率"><a href="#SQL-执行效率" class="headerlink" title="SQL 执行效率"></a>SQL 执行效率</h2><p>在where条件中虽然目标表可能已经创建了索引但是因为SQL语句写法存在问题导致优化器并不能准确的使用更高效的索引搜索而去扫描全表大大降低<br>效率。对索引字段做韩束操作可能会破坏优化器对于索引树的搜索，隐式类型转换、隐式字符编码转换都属于函数操作（CAST()、CONVERT()）。</p>
<h4 id="隐式类型转换"><a href="#隐式类型转换" class="headerlink" title="隐式类型转换"></a>隐式类型转换</h4><p>在字符串和数字类型作比较的时候会把字符串转换成数字类型进行比较，所以在转换时不要使用驱动表字段进行转换尽量使用条件进行函数操作。</p>
<h4 id="隐式字符编码转换"><a href="#隐式字符编码转换" class="headerlink" title="隐式字符编码转换"></a>隐式字符编码转换</h4><p>在不同表之间进行连表查询时因为不同表之间的编码格式不同所以在where条件查询的时候会进行字符集的转换，所以在查询的时候原则上尽量不要在<br>被驱动表上的字段进行函数操作，将条件转换成目标格式。<br>MySQL的优化器不会对隐式进行语句重写，例如：where id +=10 查询id=9时也不会使用索引。</p>
<h3 id="SQL-分析"><a href="#SQL-分析" class="headerlink" title="SQL 分析"></a>SQL 分析</h3><h4 id="show-processlist"><a href="#show-processlist" class="headerlink" title="show processlist"></a>show processlist</h4><p>如果有SUPER权限可以看到所有线程，否则只能看到自己发起的线程。其中各个字段解释：</p>
<ul>
<li>id: 线程ID</li>
<li>user: 线程发起用户名称</li>
<li>host: 线程发起的IP和端口</li>
<li>db: 线程连接的数据库</li>
<li>command: 当前连接执行的命令 sleep(资源未释放，但连接没有中断)，query,connect</li>
<li>time: 状态持续时间，单位：秒</li>
<li>state:  <a target="_blank" rel="noopener" href="https://blog.csdn.net/dhfzhishi/article/details/81263084%EF%BC%88%E7%8A%B6%E6%80%81%EF%BC%8C%E5%9F%BA%E6%9C%AC%E7%9B%B4%E8%AF%91%EF%BC%89">https://blog.csdn.net/dhfzhishi/article/details/81263084（状态，基本直译）</a></li>
<li>info: 当前线程执行的SQL语句<br>用 show processlist 可以看到当前所有的线程执行情况，但是无法知道具体是哪个线程发起的资源占用也就无法杀死线程疏通堵塞，需要查看sys.schema_table_lock_waits表查看造成阻塞的process_id(select blocking_pid from sys.schema_table_lock_waits )，再直接kill进程。</li>
</ul>
<h3 id="mysql-锁"><a href="#mysql-锁" class="headerlink" title="mysql 锁"></a>mysql 锁</h3><h3 id="BST和RBT区别"><a href="#BST和RBT区别" class="headerlink" title="BST和RBT区别"></a>BST和RBT区别</h3><p>二叉树搜索树：左小右大 最差情况树高n，平均Log(n)<br>红黑树（平衡二叉树）：任何一个节点都有颜色（黑或红），根节点是黑色，父子节点之间不能出现连续两个红节点，任何一个根节点遍历到他的子孙节点经过的黑节点数量必须相同，空节点被认为黑色节点。<br>左旋<br>左旋图解(x左边节点逆时针旋转)：<br>a<br>/ \<br>b   x      -&gt;        x<br>/ \              / <br>c   d            a   d<br>/ \<br>b   c<br>如图以x为中心，其父节点为a,左边兄弟节点为b，左子节点为c,右子节点为d</p>
<p>左旋就是保证x和右子节点d不变，逆时针旋转与x节点的直接相关的左边节点，也就是a,b,c<br>左旋的过程是将x的父节点a，左边兄弟节点b 逆时针旋转，<br>原来的x左节点c被x的父节点替代，<br>原来x的左子节点c逆时针方向平移后变成x的原父节点a的右子节点。</p>
<p>右旋<br>右旋图解(x右边节点顺时针旋转)：<br>a<br>/ \<br>x   b      -&gt;      x<br>/ \                / \<br>d   c              d   a<br>/ <br>c   b</p>
<h3 id="聚簇索引"><a href="#聚簇索引" class="headerlink" title="聚簇索引"></a>聚簇索引</h3><p>聚簇索引：将数据存储与索引放到了一块，找到索引也就找到了数据,不仅保存主键值还保存该行数据还保存事务ID，以及事务版本信息等等。<br>非聚簇索引：将数据存储于索引分开结构，索引结构的叶子节点指向了数据的对应行.</p>
<h3 id="B-树和B-树"><a href="#B-树和B-树" class="headerlink" title="B-树和B+树"></a>B-树和B+树</h3><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/u013411246/article/details/81088914">https://blog.csdn.net/u013411246/article/details/81088914</a><br>b+树相比于b树的查询优势：<br>b+树的中间节点不保存数据，所以磁盘页能容纳更多节点元素，更“矮胖”；<br>b+树查询必须查找到叶子节点，b树只要匹配到即可不用管元素位置，因此b+树查找更稳定（并不慢）；<br>对于范围查找来说，b+树只需遍历叶子节点链表即可，b树却需要重复地中序遍历，如下两图：</p>
<h3 id="死锁"><a href="#死锁" class="headerlink" title="死锁"></a>死锁</h3><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/tr1912/article/details/81668423">死锁案例</a> </p>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color1">MySQL</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2023/05/24/MySQL%E5%9F%BA%E7%A1%80/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>

<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>




  
    <article id="post-分布式CAP原则" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2023/05/24/%E5%88%86%E5%B8%83%E5%BC%8FCAP%E5%8E%9F%E5%88%99/">分布式CAP原则</a>
    </h1>
  

        
        <a href="/2023/05/24/%E5%88%86%E5%B8%83%E5%BC%8FCAP%E5%8E%9F%E5%88%99/" class="archive-article-date">
  	<time datetime="2023-05-24T08:45:08.455Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2023-05-24</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="分布式CAP原则"><a href="#分布式CAP原则" class="headerlink" title="分布式CAP原则"></a>分布式CAP原则</h1><ul>
<li>C（Consistency）一致性：分布式系统中所有主机在同一时刻是否可以保证数据一致，即写入一台主机后其他主机均写成功则存在一致性；</li>
<li>A（Availability）可用性：在集群中部分节点发生故障是否会影响到对客户端读写请求的详情，保证集群中部分故障不会影响到整个集群称为可用性；</li>
<li>P（Partition tolerance）分区容错性：分布式系统中一台主机称为一个分区，分布式系统各个主机可能会存在数据不一致性或可用性问题。该分布式系统对于上述两种问题的兼容性称为分区容错性。</li>
</ul>
<p>分布式系统中分区容错性是必然的要考虑的，但是一致性和可用性则是两个相互对立的方向。要保证可用性可以通过横向增加主机来实现，但是通过分布式中主机数量的增加各个主机之间数据一致性维护成本会大大提高。所以CAP三原则中分布式系统一般只会满足两项原则后尽可能向第三项原则靠拢。</p>
<h2 id="CAP常见组合"><a href="#CAP常见组合" class="headerlink" title="CAP常见组合"></a>CAP常见组合</h2><h3 id="CA"><a href="#CA" class="headerlink" title="CA"></a>CA</h3><p>严格意义上来说只保证一致性以及可用性不能被称之为分布式系统。关系型数据库的设计参考该项组合，保证数据强一致性以及系统的可用性</p>
<h3 id="CP"><a href="#CP" class="headerlink" title="CP"></a>CP</h3><p>分布式系统中保证数据一致性以及分区容错性，放弃可用性。例如Zookeeper，银行实时转账</p>
<h5 id="Zookeeper分布式原则"><a href="#Zookeeper分布式原则" class="headerlink" title="Zookeeper分布式原则"></a>Zookeeper分布式原则</h5><p>Zookeeper在Leader节点宕机后，集群会停止提供服务知道重新选举完成并恢复数据，整个过程大概在30S-120S左右。为了保证一致性在崩溃恢复期间Zookeeper集群停止提供服务不会再有数据交互的产生，其次通过选举快速选举出Leader进入数据恢复阶段，各个Follower会同步Leader（Leader节点中的数据不一定是最新的，这里还有一个选举完后查找最新数据的过程）中最新的数据信息，Zookeeper集群恢复使用，Leader节点进行数据修改再广播到各个子节点进行数据同步保证数据一致性。但是在奔溃恢复阶段则是牺牲了可用性</p>
<h3 id="AP"><a href="#AP" class="headerlink" title="AP"></a>AP</h3><p>分布式系统中保证数据的可用性以及分区容错性，放弃一致性。例如Eureka，微信提现到账</p>
<h5 id="Eureka分布式原则"><a href="#Eureka分布式原则" class="headerlink" title="Eureka分布式原则"></a>Eureka分布式原则</h5><p>Eureka注册中心专注于服务的注册和发现，相比于Zookeeper不会出现数据的竞争。Eureka在实际使用中会和各个应用进行连接，当有新应用进行注册或者应用宕机的时候注册信息新信息就会被添加或者被删除所以Eureka只保证了数据最终一致性。相比于Zookeeper的选举阶段Eureka保证了服务可用性，至于一致性也可以通过时间来保证最终数据一致性。</p>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color2">Java基础</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2023/05/24/%E5%88%86%E5%B8%83%E5%BC%8FCAP%E5%8E%9F%E5%88%99/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>

<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>




  
  
    <nav id="page-nav">
      <a class="extend prev" rel="prev" href="/">&amp;laquo; Prev</a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/3/">Next &amp;raquo;</a>
    </nav>
  


          </div>
        </div>
      </div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2023 ght
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    <script>
	var yiliaConfig = {
		mathjax: false,
		isHome: true,
		isPost: false,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: true,
		toc_hide_index: true,
		root: "/",
		innerArchive: true,
		showTags: true
	}
</script>

<script>!function(t){function n(e){if(r[e])return r[e].exports;var i=r[e]={exports:{},id:e,loaded:!1};return t[e].call(i.exports,i,i.exports,n),i.loaded=!0,i.exports}var r={};n.m=t,n.c=r,n.p="./",n(0)}([function(t,n,r){r(195),t.exports=r(191)},function(t,n,r){var e=r(3),i=r(52),o=r(27),u=r(28),c=r(53),f="prototype",a=function(t,n,r){var s,l,h,v,p=t&a.F,d=t&a.G,y=t&a.S,g=t&a.P,b=t&a.B,m=d?e:y?e[n]||(e[n]={}):(e[n]||{})[f],x=d?i:i[n]||(i[n]={}),w=x[f]||(x[f]={});d&&(r=n);for(s in r)l=!p&&m&&void 0!==m[s],h=(l?m:r)[s],v=b&&l?c(h,e):g&&"function"==typeof h?c(Function.call,h):h,m&&u(m,s,h,t&a.U),x[s]!=h&&o(x,s,v),g&&w[s]!=h&&(w[s]=h)};e.core=i,a.F=1,a.G=2,a.S=4,a.P=8,a.B=16,a.W=32,a.U=64,a.R=128,t.exports=a},function(t,n,r){var e=r(6);t.exports=function(t){if(!e(t))throw TypeError(t+" is not an object!");return t}},function(t,n){var r=t.exports="undefined"!=typeof window&&window.Math==Math?window:"undefined"!=typeof self&&self.Math==Math?self:Function("return this")();"number"==typeof __g&&(__g=r)},function(t,n){t.exports=function(t){try{return!!t()}catch(t){return!0}}},function(t,n){var r=t.exports="undefined"!=typeof window&&window.Math==Math?window:"undefined"!=typeof self&&self.Math==Math?self:Function("return this")();"number"==typeof __g&&(__g=r)},function(t,n){t.exports=function(t){return"object"==typeof t?null!==t:"function"==typeof t}},function(t,n,r){var e=r(126)("wks"),i=r(76),o=r(3).Symbol,u="function"==typeof o;(t.exports=function(t){return e[t]||(e[t]=u&&o[t]||(u?o:i)("Symbol."+t))}).store=e},function(t,n){var r={}.hasOwnProperty;t.exports=function(t,n){return r.call(t,n)}},function(t,n,r){var e=r(94),i=r(33);t.exports=function(t){return e(i(t))}},function(t,n,r){t.exports=!r(4)(function(){return 7!=Object.defineProperty({},"a",{get:function(){return 7}}).a})},function(t,n,r){var e=r(2),i=r(167),o=r(50),u=Object.defineProperty;n.f=r(10)?Object.defineProperty:function(t,n,r){if(e(t),n=o(n,!0),e(r),i)try{return u(t,n,r)}catch(t){}if("get"in r||"set"in r)throw TypeError("Accessors not supported!");return"value"in r&&(t[n]=r.value),t}},function(t,n,r){t.exports=!r(18)(function(){return 7!=Object.defineProperty({},"a",{get:function(){return 7}}).a})},function(t,n,r){var e=r(14),i=r(22);t.exports=r(12)?function(t,n,r){return e.f(t,n,i(1,r))}:function(t,n,r){return t[n]=r,t}},function(t,n,r){var e=r(20),i=r(58),o=r(42),u=Object.defineProperty;n.f=r(12)?Object.defineProperty:function(t,n,r){if(e(t),n=o(n,!0),e(r),i)try{return u(t,n,r)}catch(t){}if("get"in r||"set"in r)throw TypeError("Accessors not supported!");return"value"in r&&(t[n]=r.value),t}},function(t,n,r){var e=r(40)("wks"),i=r(23),o=r(5).Symbol,u="function"==typeof o;(t.exports=function(t){return e[t]||(e[t]=u&&o[t]||(u?o:i)("Symbol."+t))}).store=e},function(t,n,r){var e=r(67),i=Math.min;t.exports=function(t){return t>0?i(e(t),9007199254740991):0}},function(t,n,r){var e=r(46);t.exports=function(t){return Object(e(t))}},function(t,n){t.exports=function(t){try{return!!t()}catch(t){return!0}}},function(t,n,r){var e=r(63),i=r(34);t.exports=Object.keys||function(t){return e(t,i)}},function(t,n,r){var e=r(21);t.exports=function(t){if(!e(t))throw TypeError(t+" is not an object!");return t}},function(t,n){t.exports=function(t){return"object"==typeof t?null!==t:"function"==typeof t}},function(t,n){t.exports=function(t,n){return{enumerable:!(1&t),configurable:!(2&t),writable:!(4&t),value:n}}},function(t,n){var r=0,e=Math.random();t.exports=function(t){return"Symbol(".concat(void 0===t?"":t,")_",(++r+e).toString(36))}},function(t,n){var r={}.hasOwnProperty;t.exports=function(t,n){return r.call(t,n)}},function(t,n){var r=t.exports={version:"2.4.0"};"number"==typeof __e&&(__e=r)},function(t,n){t.exports=function(t){if("function"!=typeof t)throw TypeError(t+" is not a function!");return t}},function(t,n,r){var e=r(11),i=r(66);t.exports=r(10)?function(t,n,r){return e.f(t,n,i(1,r))}:function(t,n,r){return t[n]=r,t}},function(t,n,r){var e=r(3),i=r(27),o=r(24),u=r(76)("src"),c="toString",f=Function[c],a=(""+f).split(c);r(52).inspectSource=function(t){return f.call(t)},(t.exports=function(t,n,r,c){var f="function"==typeof r;f&&(o(r,"name")||i(r,"name",n)),t[n]!==r&&(f&&(o(r,u)||i(r,u,t[n]?""+t[n]:a.join(String(n)))),t===e?t[n]=r:c?t[n]?t[n]=r:i(t,n,r):(delete t[n],i(t,n,r)))})(Function.prototype,c,function(){return"function"==typeof this&&this[u]||f.call(this)})},function(t,n,r){var e=r(1),i=r(4),o=r(46),u=function(t,n,r,e){var i=String(o(t)),u="<"+n;return""!==r&&(u+=" "+r+'="'+String(e).replace(/"/g,"&quot;")+'"'),u+">"+i+"</"+n+">"};t.exports=function(t,n){var r={};r[t]=n(u),e(e.P+e.F*i(function(){var n=""[t]('"');return n!==n.toLowerCase()||n.split('"').length>3}),"String",r)}},function(t,n,r){var e=r(115),i=r(46);t.exports=function(t){return e(i(t))}},function(t,n,r){var e=r(116),i=r(66),o=r(30),u=r(50),c=r(24),f=r(167),a=Object.getOwnPropertyDescriptor;n.f=r(10)?a:function(t,n){if(t=o(t),n=u(n,!0),f)try{return a(t,n)}catch(t){}if(c(t,n))return i(!e.f.call(t,n),t[n])}},function(t,n,r){var e=r(24),i=r(17),o=r(145)("IE_PROTO"),u=Object.prototype;t.exports=Object.getPrototypeOf||function(t){return t=i(t),e(t,o)?t[o]:"function"==typeof t.constructor&&t instanceof t.constructor?t.constructor.prototype:t instanceof Object?u:null}},function(t,n){t.exports=function(t){if(void 0==t)throw TypeError("Can't call method on  "+t);return t}},function(t,n){t.exports="constructor,hasOwnProperty,isPrototypeOf,propertyIsEnumerable,toLocaleString,toString,valueOf".split(",")},function(t,n){t.exports={}},function(t,n){t.exports=!0},function(t,n){n.f={}.propertyIsEnumerable},function(t,n,r){var e=r(14).f,i=r(8),o=r(15)("toStringTag");t.exports=function(t,n,r){t&&!i(t=r?t:t.prototype,o)&&e(t,o,{configurable:!0,value:n})}},function(t,n,r){var e=r(40)("keys"),i=r(23);t.exports=function(t){return e[t]||(e[t]=i(t))}},function(t,n,r){var e=r(5),i="__core-js_shared__",o=e[i]||(e[i]={});t.exports=function(t){return o[t]||(o[t]={})}},function(t,n){var r=Math.ceil,e=Math.floor;t.exports=function(t){return isNaN(t=+t)?0:(t>0?e:r)(t)}},function(t,n,r){var e=r(21);t.exports=function(t,n){if(!e(t))return t;var r,i;if(n&&"function"==typeof(r=t.toString)&&!e(i=r.call(t)))return i;if("function"==typeof(r=t.valueOf)&&!e(i=r.call(t)))return i;if(!n&&"function"==typeof(r=t.toString)&&!e(i=r.call(t)))return i;throw TypeError("Can't convert object to primitive value")}},function(t,n,r){var e=r(5),i=r(25),o=r(36),u=r(44),c=r(14).f;t.exports=function(t){var n=i.Symbol||(i.Symbol=o?{}:e.Symbol||{});"_"==t.charAt(0)||t in n||c(n,t,{value:u.f(t)})}},function(t,n,r){n.f=r(15)},function(t,n){var r={}.toString;t.exports=function(t){return r.call(t).slice(8,-1)}},function(t,n){t.exports=function(t){if(void 0==t)throw TypeError("Can't call method on  "+t);return t}},function(t,n,r){var e=r(4);t.exports=function(t,n){return!!t&&e(function(){n?t.call(null,function(){},1):t.call(null)})}},function(t,n,r){var e=r(53),i=r(115),o=r(17),u=r(16),c=r(203);t.exports=function(t,n){var r=1==t,f=2==t,a=3==t,s=4==t,l=6==t,h=5==t||l,v=n||c;return function(n,c,p){for(var d,y,g=o(n),b=i(g),m=e(c,p,3),x=u(b.length),w=0,S=r?v(n,x):f?v(n,0):void 0;x>w;w++)if((h||w in b)&&(d=b[w],y=m(d,w,g),t))if(r)S[w]=y;else if(y)switch(t){case 3:return!0;case 5:return d;case 6:return w;case 2:S.push(d)}else if(s)return!1;return l?-1:a||s?s:S}}},function(t,n,r){var e=r(1),i=r(52),o=r(4);t.exports=function(t,n){var r=(i.Object||{})[t]||Object[t],u={};u[t]=n(r),e(e.S+e.F*o(function(){r(1)}),"Object",u)}},function(t,n,r){var e=r(6);t.exports=function(t,n){if(!e(t))return t;var r,i;if(n&&"function"==typeof(r=t.toString)&&!e(i=r.call(t)))return i;if("function"==typeof(r=t.valueOf)&&!e(i=r.call(t)))return i;if(!n&&"function"==typeof(r=t.toString)&&!e(i=r.call(t)))return i;throw TypeError("Can't convert object to primitive value")}},function(t,n,r){var e=r(5),i=r(25),o=r(91),u=r(13),c="prototype",f=function(t,n,r){var a,s,l,h=t&f.F,v=t&f.G,p=t&f.S,d=t&f.P,y=t&f.B,g=t&f.W,b=v?i:i[n]||(i[n]={}),m=b[c],x=v?e:p?e[n]:(e[n]||{})[c];v&&(r=n);for(a in r)(s=!h&&x&&void 0!==x[a])&&a in b||(l=s?x[a]:r[a],b[a]=v&&"function"!=typeof x[a]?r[a]:y&&s?o(l,e):g&&x[a]==l?function(t){var n=function(n,r,e){if(this instanceof t){switch(arguments.length){case 0:return new t;case 1:return new t(n);case 2:return new t(n,r)}return new t(n,r,e)}return t.apply(this,arguments)};return n[c]=t[c],n}(l):d&&"function"==typeof l?o(Function.call,l):l,d&&((b.virtual||(b.virtual={}))[a]=l,t&f.R&&m&&!m[a]&&u(m,a,l)))};f.F=1,f.G=2,f.S=4,f.P=8,f.B=16,f.W=32,f.U=64,f.R=128,t.exports=f},function(t,n){var r=t.exports={version:"2.4.0"};"number"==typeof __e&&(__e=r)},function(t,n,r){var e=r(26);t.exports=function(t,n,r){if(e(t),void 0===n)return t;switch(r){case 1:return function(r){return t.call(n,r)};case 2:return function(r,e){return t.call(n,r,e)};case 3:return function(r,e,i){return t.call(n,r,e,i)}}return function(){return t.apply(n,arguments)}}},function(t,n,r){var e=r(183),i=r(1),o=r(126)("metadata"),u=o.store||(o.store=new(r(186))),c=function(t,n,r){var i=u.get(t);if(!i){if(!r)return;u.set(t,i=new e)}var o=i.get(n);if(!o){if(!r)return;i.set(n,o=new e)}return o},f=function(t,n,r){var e=c(n,r,!1);return void 0!==e&&e.has(t)},a=function(t,n,r){var e=c(n,r,!1);return void 0===e?void 0:e.get(t)},s=function(t,n,r,e){c(r,e,!0).set(t,n)},l=function(t,n){var r=c(t,n,!1),e=[];return r&&r.forEach(function(t,n){e.push(n)}),e},h=function(t){return void 0===t||"symbol"==typeof t?t:String(t)},v=function(t){i(i.S,"Reflect",t)};t.exports={store:u,map:c,has:f,get:a,set:s,keys:l,key:h,exp:v}},function(t,n,r){"use strict";if(r(10)){var e=r(69),i=r(3),o=r(4),u=r(1),c=r(127),f=r(152),a=r(53),s=r(68),l=r(66),h=r(27),v=r(73),p=r(67),d=r(16),y=r(75),g=r(50),b=r(24),m=r(180),x=r(114),w=r(6),S=r(17),_=r(137),O=r(70),E=r(32),P=r(71).f,j=r(154),F=r(76),M=r(7),A=r(48),N=r(117),T=r(146),I=r(155),k=r(80),L=r(123),R=r(74),C=r(130),D=r(160),U=r(11),W=r(31),G=U.f,B=W.f,V=i.RangeError,z=i.TypeError,q=i.Uint8Array,K="ArrayBuffer",J="Shared"+K,Y="BYTES_PER_ELEMENT",H="prototype",$=Array[H],X=f.ArrayBuffer,Q=f.DataView,Z=A(0),tt=A(2),nt=A(3),rt=A(4),et=A(5),it=A(6),ot=N(!0),ut=N(!1),ct=I.values,ft=I.keys,at=I.entries,st=$.lastIndexOf,lt=$.reduce,ht=$.reduceRight,vt=$.join,pt=$.sort,dt=$.slice,yt=$.toString,gt=$.toLocaleString,bt=M("iterator"),mt=M("toStringTag"),xt=F("typed_constructor"),wt=F("def_constructor"),St=c.CONSTR,_t=c.TYPED,Ot=c.VIEW,Et="Wrong length!",Pt=A(1,function(t,n){return Tt(T(t,t[wt]),n)}),jt=o(function(){return 1===new q(new Uint16Array([1]).buffer)[0]}),Ft=!!q&&!!q[H].set&&o(function(){new q(1).set({})}),Mt=function(t,n){if(void 0===t)throw z(Et);var r=+t,e=d(t);if(n&&!m(r,e))throw V(Et);return e},At=function(t,n){var r=p(t);if(r<0||r%n)throw V("Wrong offset!");return r},Nt=function(t){if(w(t)&&_t in t)return t;throw z(t+" is not a typed array!")},Tt=function(t,n){if(!(w(t)&&xt in t))throw z("It is not a typed array constructor!");return new t(n)},It=function(t,n){return kt(T(t,t[wt]),n)},kt=function(t,n){for(var r=0,e=n.length,i=Tt(t,e);e>r;)i[r]=n[r++];return i},Lt=function(t,n,r){G(t,n,{get:function(){return this._d[r]}})},Rt=function(t){var n,r,e,i,o,u,c=S(t),f=arguments.length,s=f>1?arguments[1]:void 0,l=void 0!==s,h=j(c);if(void 0!=h&&!_(h)){for(u=h.call(c),e=[],n=0;!(o=u.next()).done;n++)e.push(o.value);c=e}for(l&&f>2&&(s=a(s,arguments[2],2)),n=0,r=d(c.length),i=Tt(this,r);r>n;n++)i[n]=l?s(c[n],n):c[n];return i},Ct=function(){for(var t=0,n=arguments.length,r=Tt(this,n);n>t;)r[t]=arguments[t++];return r},Dt=!!q&&o(function(){gt.call(new q(1))}),Ut=function(){return gt.apply(Dt?dt.call(Nt(this)):Nt(this),arguments)},Wt={copyWithin:function(t,n){return D.call(Nt(this),t,n,arguments.length>2?arguments[2]:void 0)},every:function(t){return rt(Nt(this),t,arguments.length>1?arguments[1]:void 0)},fill:function(t){return C.apply(Nt(this),arguments)},filter:function(t){return It(this,tt(Nt(this),t,arguments.length>1?arguments[1]:void 0))},find:function(t){return et(Nt(this),t,arguments.length>1?arguments[1]:void 0)},findIndex:function(t){return it(Nt(this),t,arguments.length>1?arguments[1]:void 0)},forEach:function(t){Z(Nt(this),t,arguments.length>1?arguments[1]:void 0)},indexOf:function(t){return ut(Nt(this),t,arguments.length>1?arguments[1]:void 0)},includes:function(t){return ot(Nt(this),t,arguments.length>1?arguments[1]:void 0)},join:function(t){return vt.apply(Nt(this),arguments)},lastIndexOf:function(t){return st.apply(Nt(this),arguments)},map:function(t){return Pt(Nt(this),t,arguments.length>1?arguments[1]:void 0)},reduce:function(t){return lt.apply(Nt(this),arguments)},reduceRight:function(t){return ht.apply(Nt(this),arguments)},reverse:function(){for(var t,n=this,r=Nt(n).length,e=Math.floor(r/2),i=0;i<e;)t=n[i],n[i++]=n[--r],n[r]=t;return n},some:function(t){return nt(Nt(this),t,arguments.length>1?arguments[1]:void 0)},sort:function(t){return pt.call(Nt(this),t)},subarray:function(t,n){var r=Nt(this),e=r.length,i=y(t,e);return new(T(r,r[wt]))(r.buffer,r.byteOffset+i*r.BYTES_PER_ELEMENT,d((void 0===n?e:y(n,e))-i))}},Gt=function(t,n){return It(this,dt.call(Nt(this),t,n))},Bt=function(t){Nt(this);var n=At(arguments[1],1),r=this.length,e=S(t),i=d(e.length),o=0;if(i+n>r)throw V(Et);for(;o<i;)this[n+o]=e[o++]},Vt={entries:function(){return at.call(Nt(this))},keys:function(){return ft.call(Nt(this))},values:function(){return ct.call(Nt(this))}},zt=function(t,n){return w(t)&&t[_t]&&"symbol"!=typeof n&&n in t&&String(+n)==String(n)},qt=function(t,n){return zt(t,n=g(n,!0))?l(2,t[n]):B(t,n)},Kt=function(t,n,r){return!(zt(t,n=g(n,!0))&&w(r)&&b(r,"value"))||b(r,"get")||b(r,"set")||r.configurable||b(r,"writable")&&!r.writable||b(r,"enumerable")&&!r.enumerable?G(t,n,r):(t[n]=r.value,t)};St||(W.f=qt,U.f=Kt),u(u.S+u.F*!St,"Object",{getOwnPropertyDescriptor:qt,defineProperty:Kt}),o(function(){yt.call({})})&&(yt=gt=function(){return vt.call(this)});var Jt=v({},Wt);v(Jt,Vt),h(Jt,bt,Vt.values),v(Jt,{slice:Gt,set:Bt,constructor:function(){},toString:yt,toLocaleString:Ut}),Lt(Jt,"buffer","b"),Lt(Jt,"byteOffset","o"),Lt(Jt,"byteLength","l"),Lt(Jt,"length","e"),G(Jt,mt,{get:function(){return this[_t]}}),t.exports=function(t,n,r,f){f=!!f;var a=t+(f?"Clamped":"")+"Array",l="Uint8Array"!=a,v="get"+t,p="set"+t,y=i[a],g=y||{},b=y&&E(y),m=!y||!c.ABV,S={},_=y&&y[H],j=function(t,r){var e=t._d;return e.v[v](r*n+e.o,jt)},F=function(t,r,e){var i=t._d;f&&(e=(e=Math.round(e))<0?0:e>255?255:255&e),i.v[p](r*n+i.o,e,jt)},M=function(t,n){G(t,n,{get:function(){return j(this,n)},set:function(t){return F(this,n,t)},enumerable:!0})};m?(y=r(function(t,r,e,i){s(t,y,a,"_d");var o,u,c,f,l=0,v=0;if(w(r)){if(!(r instanceof X||(f=x(r))==K||f==J))return _t in r?kt(y,r):Rt.call(y,r);o=r,v=At(e,n);var p=r.byteLength;if(void 0===i){if(p%n)throw V(Et);if((u=p-v)<0)throw V(Et)}else if((u=d(i)*n)+v>p)throw V(Et);c=u/n}else c=Mt(r,!0),u=c*n,o=new X(u);for(h(t,"_d",{b:o,o:v,l:u,e:c,v:new Q(o)});l<c;)M(t,l++)}),_=y[H]=O(Jt),h(_,"constructor",y)):L(function(t){new y(null),new y(t)},!0)||(y=r(function(t,r,e,i){s(t,y,a);var o;return w(r)?r instanceof X||(o=x(r))==K||o==J?void 0!==i?new g(r,At(e,n),i):void 0!==e?new g(r,At(e,n)):new g(r):_t in r?kt(y,r):Rt.call(y,r):new g(Mt(r,l))}),Z(b!==Function.prototype?P(g).concat(P(b)):P(g),function(t){t in y||h(y,t,g[t])}),y[H]=_,e||(_.constructor=y));var A=_[bt],N=!!A&&("values"==A.name||void 0==A.name),T=Vt.values;h(y,xt,!0),h(_,_t,a),h(_,Ot,!0),h(_,wt,y),(f?new y(1)[mt]==a:mt in _)||G(_,mt,{get:function(){return a}}),S[a]=y,u(u.G+u.W+u.F*(y!=g),S),u(u.S,a,{BYTES_PER_ELEMENT:n,from:Rt,of:Ct}),Y in _||h(_,Y,n),u(u.P,a,Wt),R(a),u(u.P+u.F*Ft,a,{set:Bt}),u(u.P+u.F*!N,a,Vt),u(u.P+u.F*(_.toString!=yt),a,{toString:yt}),u(u.P+u.F*o(function(){new y(1).slice()}),a,{slice:Gt}),u(u.P+u.F*(o(function(){return[1,2].toLocaleString()!=new y([1,2]).toLocaleString()})||!o(function(){_.toLocaleString.call([1,2])})),a,{toLocaleString:Ut}),k[a]=N?A:T,e||N||h(_,bt,T)}}else t.exports=function(){}},function(t,n){var r={}.toString;t.exports=function(t){return r.call(t).slice(8,-1)}},function(t,n,r){var e=r(21),i=r(5).document,o=e(i)&&e(i.createElement);t.exports=function(t){return o?i.createElement(t):{}}},function(t,n,r){t.exports=!r(12)&&!r(18)(function(){return 7!=Object.defineProperty(r(57)("div"),"a",{get:function(){return 7}}).a})},function(t,n,r){"use strict";var e=r(36),i=r(51),o=r(64),u=r(13),c=r(8),f=r(35),a=r(96),s=r(38),l=r(103),h=r(15)("iterator"),v=!([].keys&&"next"in[].keys()),p="keys",d="values",y=function(){return this};t.exports=function(t,n,r,g,b,m,x){a(r,n,g);var w,S,_,O=function(t){if(!v&&t in F)return F[t];switch(t){case p:case d:return function(){return new r(this,t)}}return function(){return new r(this,t)}},E=n+" Iterator",P=b==d,j=!1,F=t.prototype,M=F[h]||F["@@iterator"]||b&&F[b],A=M||O(b),N=b?P?O("entries"):A:void 0,T="Array"==n?F.entries||M:M;if(T&&(_=l(T.call(new t)))!==Object.prototype&&(s(_,E,!0),e||c(_,h)||u(_,h,y)),P&&M&&M.name!==d&&(j=!0,A=function(){return M.call(this)}),e&&!x||!v&&!j&&F[h]||u(F,h,A),f[n]=A,f[E]=y,b)if(w={values:P?A:O(d),keys:m?A:O(p),entries:N},x)for(S in w)S in F||o(F,S,w[S]);else i(i.P+i.F*(v||j),n,w);return w}},function(t,n,r){var e=r(20),i=r(100),o=r(34),u=r(39)("IE_PROTO"),c=function(){},f="prototype",a=function(){var t,n=r(57)("iframe"),e=o.length;for(n.style.display="none",r(93).appendChild(n),n.src="javascript:",t=n.contentWindow.document,t.open(),t.write("<script>document.F=Object<\/script>"),t.close(),a=t.F;e--;)delete a[f][o[e]];return a()};t.exports=Object.create||function(t,n){var r;return null!==t?(c[f]=e(t),r=new c,c[f]=null,r[u]=t):r=a(),void 0===n?r:i(r,n)}},function(t,n,r){var e=r(63),i=r(34).concat("length","prototype");n.f=Object.getOwnPropertyNames||function(t){return e(t,i)}},function(t,n){n.f=Object.getOwnPropertySymbols},function(t,n,r){var e=r(8),i=r(9),o=r(90)(!1),u=r(39)("IE_PROTO");t.exports=function(t,n){var r,c=i(t),f=0,a=[];for(r in c)r!=u&&e(c,r)&&a.push(r);for(;n.length>f;)e(c,r=n[f++])&&(~o(a,r)||a.push(r));return a}},function(t,n,r){t.exports=r(13)},function(t,n,r){var e=r(76)("meta"),i=r(6),o=r(24),u=r(11).f,c=0,f=Object.isExtensible||function(){return!0},a=!r(4)(function(){return f(Object.preventExtensions({}))}),s=function(t){u(t,e,{value:{i:"O"+ ++c,w:{}}})},l=function(t,n){if(!i(t))return"symbol"==typeof t?t:("string"==typeof t?"S":"P")+t;if(!o(t,e)){if(!f(t))return"F";if(!n)return"E";s(t)}return t[e].i},h=function(t,n){if(!o(t,e)){if(!f(t))return!0;if(!n)return!1;s(t)}return t[e].w},v=function(t){return a&&p.NEED&&f(t)&&!o(t,e)&&s(t),t},p=t.exports={KEY:e,NEED:!1,fastKey:l,getWeak:h,onFreeze:v}},function(t,n){t.exports=function(t,n){return{enumerable:!(1&t),configurable:!(2&t),writable:!(4&t),value:n}}},function(t,n){var r=Math.ceil,e=Math.floor;t.exports=function(t){return isNaN(t=+t)?0:(t>0?e:r)(t)}},function(t,n){t.exports=function(t,n,r,e){if(!(t instanceof n)||void 0!==e&&e in t)throw TypeError(r+": incorrect invocation!");return t}},function(t,n){t.exports=!1},function(t,n,r){var e=r(2),i=r(173),o=r(133),u=r(145)("IE_PROTO"),c=function(){},f="prototype",a=function(){var t,n=r(132)("iframe"),e=o.length;for(n.style.display="none",r(135).appendChild(n),n.src="javascript:",t=n.contentWindow.document,t.open(),t.write("<script>document.F=Object<\/script>"),t.close(),a=t.F;e--;)delete a[f][o[e]];return a()};t.exports=Object.create||function(t,n){var r;return null!==t?(c[f]=e(t),r=new c,c[f]=null,r[u]=t):r=a(),void 0===n?r:i(r,n)}},function(t,n,r){var e=r(175),i=r(133).concat("length","prototype");n.f=Object.getOwnPropertyNames||function(t){return e(t,i)}},function(t,n,r){var e=r(175),i=r(133);t.exports=Object.keys||function(t){return e(t,i)}},function(t,n,r){var e=r(28);t.exports=function(t,n,r){for(var i in n)e(t,i,n[i],r);return t}},function(t,n,r){"use strict";var e=r(3),i=r(11),o=r(10),u=r(7)("species");t.exports=function(t){var n=e[t];o&&n&&!n[u]&&i.f(n,u,{configurable:!0,get:function(){return this}})}},function(t,n,r){var e=r(67),i=Math.max,o=Math.min;t.exports=function(t,n){return t=e(t),t<0?i(t+n,0):o(t,n)}},function(t,n){var r=0,e=Math.random();t.exports=function(t){return"Symbol(".concat(void 0===t?"":t,")_",(++r+e).toString(36))}},function(t,n,r){var e=r(33);t.exports=function(t){return Object(e(t))}},function(t,n,r){var e=r(7)("unscopables"),i=Array.prototype;void 0==i[e]&&r(27)(i,e,{}),t.exports=function(t){i[e][t]=!0}},function(t,n,r){var e=r(53),i=r(169),o=r(137),u=r(2),c=r(16),f=r(154),a={},s={},n=t.exports=function(t,n,r,l,h){var v,p,d,y,g=h?function(){return t}:f(t),b=e(r,l,n?2:1),m=0;if("function"!=typeof g)throw TypeError(t+" is not iterable!");if(o(g)){for(v=c(t.length);v>m;m++)if((y=n?b(u(p=t[m])[0],p[1]):b(t[m]))===a||y===s)return y}else for(d=g.call(t);!(p=d.next()).done;)if((y=i(d,b,p.value,n))===a||y===s)return y};n.BREAK=a,n.RETURN=s},function(t,n){t.exports={}},function(t,n,r){var e=r(11).f,i=r(24),o=r(7)("toStringTag");t.exports=function(t,n,r){t&&!i(t=r?t:t.prototype,o)&&e(t,o,{configurable:!0,value:n})}},function(t,n,r){var e=r(1),i=r(46),o=r(4),u=r(150),c="["+u+"]",f="​",a=RegExp("^"+c+c+"*"),s=RegExp(c+c+"*$"),l=function(t,n,r){var i={},c=o(function(){return!!u[t]()||f[t]()!=f}),a=i[t]=c?n(h):u[t];r&&(i[r]=a),e(e.P+e.F*c,"String",i)},h=l.trim=function(t,n){return t=String(i(t)),1&n&&(t=t.replace(a,"")),2&n&&(t=t.replace(s,"")),t};t.exports=l},function(t,n,r){t.exports={default:r(86),__esModule:!0}},function(t,n,r){t.exports={default:r(87),__esModule:!0}},function(t,n,r){"use strict";function e(t){return t&&t.__esModule?t:{default:t}}n.__esModule=!0;var i=r(84),o=e(i),u=r(83),c=e(u),f="function"==typeof c.default&&"symbol"==typeof o.default?function(t){return typeof t}:function(t){return t&&"function"==typeof c.default&&t.constructor===c.default&&t!==c.default.prototype?"symbol":typeof t};n.default="function"==typeof c.default&&"symbol"===f(o.default)?function(t){return void 0===t?"undefined":f(t)}:function(t){return t&&"function"==typeof c.default&&t.constructor===c.default&&t!==c.default.prototype?"symbol":void 0===t?"undefined":f(t)}},function(t,n,r){r(110),r(108),r(111),r(112),t.exports=r(25).Symbol},function(t,n,r){r(109),r(113),t.exports=r(44).f("iterator")},function(t,n){t.exports=function(t){if("function"!=typeof t)throw TypeError(t+" is not a function!");return t}},function(t,n){t.exports=function(){}},function(t,n,r){var e=r(9),i=r(106),o=r(105);t.exports=function(t){return function(n,r,u){var c,f=e(n),a=i(f.length),s=o(u,a);if(t&&r!=r){for(;a>s;)if((c=f[s++])!=c)return!0}else for(;a>s;s++)if((t||s in f)&&f[s]===r)return t||s||0;return!t&&-1}}},function(t,n,r){var e=r(88);t.exports=function(t,n,r){if(e(t),void 0===n)return t;switch(r){case 1:return function(r){return t.call(n,r)};case 2:return function(r,e){return t.call(n,r,e)};case 3:return function(r,e,i){return t.call(n,r,e,i)}}return function(){return t.apply(n,arguments)}}},function(t,n,r){var e=r(19),i=r(62),o=r(37);t.exports=function(t){var n=e(t),r=i.f;if(r)for(var u,c=r(t),f=o.f,a=0;c.length>a;)f.call(t,u=c[a++])&&n.push(u);return n}},function(t,n,r){t.exports=r(5).document&&document.documentElement},function(t,n,r){var e=r(56);t.exports=Object("z").propertyIsEnumerable(0)?Object:function(t){return"String"==e(t)?t.split(""):Object(t)}},function(t,n,r){var e=r(56);t.exports=Array.isArray||function(t){return"Array"==e(t)}},function(t,n,r){"use strict";var e=r(60),i=r(22),o=r(38),u={};r(13)(u,r(15)("iterator"),function(){return this}),t.exports=function(t,n,r){t.prototype=e(u,{next:i(1,r)}),o(t,n+" Iterator")}},function(t,n){t.exports=function(t,n){return{value:n,done:!!t}}},function(t,n,r){var e=r(19),i=r(9);t.exports=function(t,n){for(var r,o=i(t),u=e(o),c=u.length,f=0;c>f;)if(o[r=u[f++]]===n)return r}},function(t,n,r){var e=r(23)("meta"),i=r(21),o=r(8),u=r(14).f,c=0,f=Object.isExtensible||function(){return!0},a=!r(18)(function(){return f(Object.preventExtensions({}))}),s=function(t){u(t,e,{value:{i:"O"+ ++c,w:{}}})},l=function(t,n){if(!i(t))return"symbol"==typeof t?t:("string"==typeof t?"S":"P")+t;if(!o(t,e)){if(!f(t))return"F";if(!n)return"E";s(t)}return t[e].i},h=function(t,n){if(!o(t,e)){if(!f(t))return!0;if(!n)return!1;s(t)}return t[e].w},v=function(t){return a&&p.NEED&&f(t)&&!o(t,e)&&s(t),t},p=t.exports={KEY:e,NEED:!1,fastKey:l,getWeak:h,onFreeze:v}},function(t,n,r){var e=r(14),i=r(20),o=r(19);t.exports=r(12)?Object.defineProperties:function(t,n){i(t);for(var r,u=o(n),c=u.length,f=0;c>f;)e.f(t,r=u[f++],n[r]);return t}},function(t,n,r){var e=r(37),i=r(22),o=r(9),u=r(42),c=r(8),f=r(58),a=Object.getOwnPropertyDescriptor;n.f=r(12)?a:function(t,n){if(t=o(t),n=u(n,!0),f)try{return a(t,n)}catch(t){}if(c(t,n))return i(!e.f.call(t,n),t[n])}},function(t,n,r){var e=r(9),i=r(61).f,o={}.toString,u="object"==typeof window&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[],c=function(t){try{return i(t)}catch(t){return u.slice()}};t.exports.f=function(t){return u&&"[object Window]"==o.call(t)?c(t):i(e(t))}},function(t,n,r){var e=r(8),i=r(77),o=r(39)("IE_PROTO"),u=Object.prototype;t.exports=Object.getPrototypeOf||function(t){return t=i(t),e(t,o)?t[o]:"function"==typeof t.constructor&&t instanceof t.constructor?t.constructor.prototype:t instanceof Object?u:null}},function(t,n,r){var e=r(41),i=r(33);t.exports=function(t){return function(n,r){var o,u,c=String(i(n)),f=e(r),a=c.length;return f<0||f>=a?t?"":void 0:(o=c.charCodeAt(f),o<55296||o>56319||f+1===a||(u=c.charCodeAt(f+1))<56320||u>57343?t?c.charAt(f):o:t?c.slice(f,f+2):u-56320+(o-55296<<10)+65536)}}},function(t,n,r){var e=r(41),i=Math.max,o=Math.min;t.exports=function(t,n){return t=e(t),t<0?i(t+n,0):o(t,n)}},function(t,n,r){var e=r(41),i=Math.min;t.exports=function(t){return t>0?i(e(t),9007199254740991):0}},function(t,n,r){"use strict";var e=r(89),i=r(97),o=r(35),u=r(9);t.exports=r(59)(Array,"Array",function(t,n){this._t=u(t),this._i=0,this._k=n},function(){var t=this._t,n=this._k,r=this._i++;return!t||r>=t.length?(this._t=void 0,i(1)):"keys"==n?i(0,r):"values"==n?i(0,t[r]):i(0,[r,t[r]])},"values"),o.Arguments=o.Array,e("keys"),e("values"),e("entries")},function(t,n){},function(t,n,r){"use strict";var e=r(104)(!0);r(59)(String,"String",function(t){this._t=String(t),this._i=0},function(){var t,n=this._t,r=this._i;return r>=n.length?{value:void 0,done:!0}:(t=e(n,r),this._i+=t.length,{value:t,done:!1})})},function(t,n,r){"use strict";var e=r(5),i=r(8),o=r(12),u=r(51),c=r(64),f=r(99).KEY,a=r(18),s=r(40),l=r(38),h=r(23),v=r(15),p=r(44),d=r(43),y=r(98),g=r(92),b=r(95),m=r(20),x=r(9),w=r(42),S=r(22),_=r(60),O=r(102),E=r(101),P=r(14),j=r(19),F=E.f,M=P.f,A=O.f,N=e.Symbol,T=e.JSON,I=T&&T.stringify,k="prototype",L=v("_hidden"),R=v("toPrimitive"),C={}.propertyIsEnumerable,D=s("symbol-registry"),U=s("symbols"),W=s("op-symbols"),G=Object[k],B="function"==typeof N,V=e.QObject,z=!V||!V[k]||!V[k].findChild,q=o&&a(function(){return 7!=_(M({},"a",{get:function(){return M(this,"a",{value:7}).a}})).a})?function(t,n,r){var e=F(G,n);e&&delete G[n],M(t,n,r),e&&t!==G&&M(G,n,e)}:M,K=function(t){var n=U[t]=_(N[k]);return n._k=t,n},J=B&&"symbol"==typeof N.iterator?function(t){return"symbol"==typeof t}:function(t){return t instanceof N},Y=function(t,n,r){return t===G&&Y(W,n,r),m(t),n=w(n,!0),m(r),i(U,n)?(r.enumerable?(i(t,L)&&t[L][n]&&(t[L][n]=!1),r=_(r,{enumerable:S(0,!1)})):(i(t,L)||M(t,L,S(1,{})),t[L][n]=!0),q(t,n,r)):M(t,n,r)},H=function(t,n){m(t);for(var r,e=g(n=x(n)),i=0,o=e.length;o>i;)Y(t,r=e[i++],n[r]);return t},$=function(t,n){return void 0===n?_(t):H(_(t),n)},X=function(t){var n=C.call(this,t=w(t,!0));return!(this===G&&i(U,t)&&!i(W,t))&&(!(n||!i(this,t)||!i(U,t)||i(this,L)&&this[L][t])||n)},Q=function(t,n){if(t=x(t),n=w(n,!0),t!==G||!i(U,n)||i(W,n)){var r=F(t,n);return!r||!i(U,n)||i(t,L)&&t[L][n]||(r.enumerable=!0),r}},Z=function(t){for(var n,r=A(x(t)),e=[],o=0;r.length>o;)i(U,n=r[o++])||n==L||n==f||e.push(n);return e},tt=function(t){for(var n,r=t===G,e=A(r?W:x(t)),o=[],u=0;e.length>u;)!i(U,n=e[u++])||r&&!i(G,n)||o.push(U[n]);return o};B||(N=function(){if(this instanceof N)throw TypeError("Symbol is not a constructor!");var t=h(arguments.length>0?arguments[0]:void 0),n=function(r){this===G&&n.call(W,r),i(this,L)&&i(this[L],t)&&(this[L][t]=!1),q(this,t,S(1,r))};return o&&z&&q(G,t,{configurable:!0,set:n}),K(t)},c(N[k],"toString",function(){return this._k}),E.f=Q,P.f=Y,r(61).f=O.f=Z,r(37).f=X,r(62).f=tt,o&&!r(36)&&c(G,"propertyIsEnumerable",X,!0),p.f=function(t){return K(v(t))}),u(u.G+u.W+u.F*!B,{Symbol:N});for(var nt="hasInstance,isConcatSpreadable,iterator,match,replace,search,species,split,toPrimitive,toStringTag,unscopables".split(","),rt=0;nt.length>rt;)v(nt[rt++]);for(var nt=j(v.store),rt=0;nt.length>rt;)d(nt[rt++]);u(u.S+u.F*!B,"Symbol",{for:function(t){return i(D,t+="")?D[t]:D[t]=N(t)},keyFor:function(t){if(J(t))return y(D,t);throw TypeError(t+" is not a symbol!")},useSetter:function(){z=!0},useSimple:function(){z=!1}}),u(u.S+u.F*!B,"Object",{create:$,defineProperty:Y,defineProperties:H,getOwnPropertyDescriptor:Q,getOwnPropertyNames:Z,getOwnPropertySymbols:tt}),T&&u(u.S+u.F*(!B||a(function(){var t=N();return"[null]"!=I([t])||"{}"!=I({a:t})||"{}"!=I(Object(t))})),"JSON",{stringify:function(t){if(void 0!==t&&!J(t)){for(var n,r,e=[t],i=1;arguments.length>i;)e.push(arguments[i++]);return n=e[1],"function"==typeof n&&(r=n),!r&&b(n)||(n=function(t,n){if(r&&(n=r.call(this,t,n)),!J(n))return n}),e[1]=n,I.apply(T,e)}}}),N[k][R]||r(13)(N[k],R,N[k].valueOf),l(N,"Symbol"),l(Math,"Math",!0),l(e.JSON,"JSON",!0)},function(t,n,r){r(43)("asyncIterator")},function(t,n,r){r(43)("observable")},function(t,n,r){r(107);for(var e=r(5),i=r(13),o=r(35),u=r(15)("toStringTag"),c=["NodeList","DOMTokenList","MediaList","StyleSheetList","CSSRuleList"],f=0;f<5;f++){var a=c[f],s=e[a],l=s&&s.prototype;l&&!l[u]&&i(l,u,a),o[a]=o.Array}},function(t,n,r){var e=r(45),i=r(7)("toStringTag"),o="Arguments"==e(function(){return arguments}()),u=function(t,n){try{return t[n]}catch(t){}};t.exports=function(t){var n,r,c;return void 0===t?"Undefined":null===t?"Null":"string"==typeof(r=u(n=Object(t),i))?r:o?e(n):"Object"==(c=e(n))&&"function"==typeof n.callee?"Arguments":c}},function(t,n,r){var e=r(45);t.exports=Object("z").propertyIsEnumerable(0)?Object:function(t){return"String"==e(t)?t.split(""):Object(t)}},function(t,n){n.f={}.propertyIsEnumerable},function(t,n,r){var e=r(30),i=r(16),o=r(75);t.exports=function(t){return function(n,r,u){var c,f=e(n),a=i(f.length),s=o(u,a);if(t&&r!=r){for(;a>s;)if((c=f[s++])!=c)return!0}else for(;a>s;s++)if((t||s in f)&&f[s]===r)return t||s||0;return!t&&-1}}},function(t,n,r){"use strict";var e=r(3),i=r(1),o=r(28),u=r(73),c=r(65),f=r(79),a=r(68),s=r(6),l=r(4),h=r(123),v=r(81),p=r(136);t.exports=function(t,n,r,d,y,g){var b=e[t],m=b,x=y?"set":"add",w=m&&m.prototype,S={},_=function(t){var n=w[t];o(w,t,"delete"==t?function(t){return!(g&&!s(t))&&n.call(this,0===t?0:t)}:"has"==t?function(t){return!(g&&!s(t))&&n.call(this,0===t?0:t)}:"get"==t?function(t){return g&&!s(t)?void 0:n.call(this,0===t?0:t)}:"add"==t?function(t){return n.call(this,0===t?0:t),this}:function(t,r){return n.call(this,0===t?0:t,r),this})};if("function"==typeof m&&(g||w.forEach&&!l(function(){(new m).entries().next()}))){var O=new m,E=O[x](g?{}:-0,1)!=O,P=l(function(){O.has(1)}),j=h(function(t){new m(t)}),F=!g&&l(function(){for(var t=new m,n=5;n--;)t[x](n,n);return!t.has(-0)});j||(m=n(function(n,r){a(n,m,t);var e=p(new b,n,m);return void 0!=r&&f(r,y,e[x],e),e}),m.prototype=w,w.constructor=m),(P||F)&&(_("delete"),_("has"),y&&_("get")),(F||E)&&_(x),g&&w.clear&&delete w.clear}else m=d.getConstructor(n,t,y,x),u(m.prototype,r),c.NEED=!0;return v(m,t),S[t]=m,i(i.G+i.W+i.F*(m!=b),S),g||d.setStrong(m,t,y),m}},function(t,n,r){"use strict";var e=r(27),i=r(28),o=r(4),u=r(46),c=r(7);t.exports=function(t,n,r){var f=c(t),a=r(u,f,""[t]),s=a[0],l=a[1];o(function(){var n={};return n[f]=function(){return 7},7!=""[t](n)})&&(i(String.prototype,t,s),e(RegExp.prototype,f,2==n?function(t,n){return l.call(t,this,n)}:function(t){return l.call(t,this)}))}
},function(t,n,r){"use strict";var e=r(2);t.exports=function(){var t=e(this),n="";return t.global&&(n+="g"),t.ignoreCase&&(n+="i"),t.multiline&&(n+="m"),t.unicode&&(n+="u"),t.sticky&&(n+="y"),n}},function(t,n){t.exports=function(t,n,r){var e=void 0===r;switch(n.length){case 0:return e?t():t.call(r);case 1:return e?t(n[0]):t.call(r,n[0]);case 2:return e?t(n[0],n[1]):t.call(r,n[0],n[1]);case 3:return e?t(n[0],n[1],n[2]):t.call(r,n[0],n[1],n[2]);case 4:return e?t(n[0],n[1],n[2],n[3]):t.call(r,n[0],n[1],n[2],n[3])}return t.apply(r,n)}},function(t,n,r){var e=r(6),i=r(45),o=r(7)("match");t.exports=function(t){var n;return e(t)&&(void 0!==(n=t[o])?!!n:"RegExp"==i(t))}},function(t,n,r){var e=r(7)("iterator"),i=!1;try{var o=[7][e]();o.return=function(){i=!0},Array.from(o,function(){throw 2})}catch(t){}t.exports=function(t,n){if(!n&&!i)return!1;var r=!1;try{var o=[7],u=o[e]();u.next=function(){return{done:r=!0}},o[e]=function(){return u},t(o)}catch(t){}return r}},function(t,n,r){t.exports=r(69)||!r(4)(function(){var t=Math.random();__defineSetter__.call(null,t,function(){}),delete r(3)[t]})},function(t,n){n.f=Object.getOwnPropertySymbols},function(t,n,r){var e=r(3),i="__core-js_shared__",o=e[i]||(e[i]={});t.exports=function(t){return o[t]||(o[t]={})}},function(t,n,r){for(var e,i=r(3),o=r(27),u=r(76),c=u("typed_array"),f=u("view"),a=!(!i.ArrayBuffer||!i.DataView),s=a,l=0,h="Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array".split(",");l<9;)(e=i[h[l++]])?(o(e.prototype,c,!0),o(e.prototype,f,!0)):s=!1;t.exports={ABV:a,CONSTR:s,TYPED:c,VIEW:f}},function(t,n){"use strict";var r={versions:function(){var t=window.navigator.userAgent;return{trident:t.indexOf("Trident")>-1,presto:t.indexOf("Presto")>-1,webKit:t.indexOf("AppleWebKit")>-1,gecko:t.indexOf("Gecko")>-1&&-1==t.indexOf("KHTML"),mobile:!!t.match(/AppleWebKit.*Mobile.*/),ios:!!t.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/),android:t.indexOf("Android")>-1||t.indexOf("Linux")>-1,iPhone:t.indexOf("iPhone")>-1||t.indexOf("Mac")>-1,iPad:t.indexOf("iPad")>-1,webApp:-1==t.indexOf("Safari"),weixin:-1==t.indexOf("MicroMessenger")}}()};t.exports=r},function(t,n,r){"use strict";var e=r(85),i=function(t){return t&&t.__esModule?t:{default:t}}(e),o=function(){function t(t,n,e){return n||e?String.fromCharCode(n||e):r[t]||t}function n(t){return e[t]}var r={"&quot;":'"',"&lt;":"<","&gt;":">","&amp;":"&","&nbsp;":" "},e={};for(var u in r)e[r[u]]=u;return r["&apos;"]="'",e["'"]="&#39;",{encode:function(t){return t?(""+t).replace(/['<> "&]/g,n).replace(/\r?\n/g,"<br/>").replace(/\s/g,"&nbsp;"):""},decode:function(n){return n?(""+n).replace(/<br\s*\/?>/gi,"\n").replace(/&quot;|&lt;|&gt;|&amp;|&nbsp;|&apos;|&#(\d+);|&#(\d+)/g,t).replace(/\u00a0/g," "):""},encodeBase16:function(t){if(!t)return t;t+="";for(var n=[],r=0,e=t.length;e>r;r++)n.push(t.charCodeAt(r).toString(16).toUpperCase());return n.join("")},encodeBase16forJSON:function(t){if(!t)return t;t=t.replace(/[\u4E00-\u9FBF]/gi,function(t){return escape(t).replace("%u","\\u")});for(var n=[],r=0,e=t.length;e>r;r++)n.push(t.charCodeAt(r).toString(16).toUpperCase());return n.join("")},decodeBase16:function(t){if(!t)return t;t+="";for(var n=[],r=0,e=t.length;e>r;r+=2)n.push(String.fromCharCode("0x"+t.slice(r,r+2)));return n.join("")},encodeObject:function(t){if(t instanceof Array)for(var n=0,r=t.length;r>n;n++)t[n]=o.encodeObject(t[n]);else if("object"==(void 0===t?"undefined":(0,i.default)(t)))for(var e in t)t[e]=o.encodeObject(t[e]);else if("string"==typeof t)return o.encode(t);return t},loadScript:function(t){var n=document.createElement("script");document.getElementsByTagName("body")[0].appendChild(n),n.setAttribute("src",t)},addLoadEvent:function(t){var n=window.onload;"function"!=typeof window.onload?window.onload=t:window.onload=function(){n(),t()}}}}();t.exports=o},function(t,n,r){"use strict";var e=r(17),i=r(75),o=r(16);t.exports=function(t){for(var n=e(this),r=o(n.length),u=arguments.length,c=i(u>1?arguments[1]:void 0,r),f=u>2?arguments[2]:void 0,a=void 0===f?r:i(f,r);a>c;)n[c++]=t;return n}},function(t,n,r){"use strict";var e=r(11),i=r(66);t.exports=function(t,n,r){n in t?e.f(t,n,i(0,r)):t[n]=r}},function(t,n,r){var e=r(6),i=r(3).document,o=e(i)&&e(i.createElement);t.exports=function(t){return o?i.createElement(t):{}}},function(t,n){t.exports="constructor,hasOwnProperty,isPrototypeOf,propertyIsEnumerable,toLocaleString,toString,valueOf".split(",")},function(t,n,r){var e=r(7)("match");t.exports=function(t){var n=/./;try{"/./"[t](n)}catch(r){try{return n[e]=!1,!"/./"[t](n)}catch(t){}}return!0}},function(t,n,r){t.exports=r(3).document&&document.documentElement},function(t,n,r){var e=r(6),i=r(144).set;t.exports=function(t,n,r){var o,u=n.constructor;return u!==r&&"function"==typeof u&&(o=u.prototype)!==r.prototype&&e(o)&&i&&i(t,o),t}},function(t,n,r){var e=r(80),i=r(7)("iterator"),o=Array.prototype;t.exports=function(t){return void 0!==t&&(e.Array===t||o[i]===t)}},function(t,n,r){var e=r(45);t.exports=Array.isArray||function(t){return"Array"==e(t)}},function(t,n,r){"use strict";var e=r(70),i=r(66),o=r(81),u={};r(27)(u,r(7)("iterator"),function(){return this}),t.exports=function(t,n,r){t.prototype=e(u,{next:i(1,r)}),o(t,n+" Iterator")}},function(t,n,r){"use strict";var e=r(69),i=r(1),o=r(28),u=r(27),c=r(24),f=r(80),a=r(139),s=r(81),l=r(32),h=r(7)("iterator"),v=!([].keys&&"next"in[].keys()),p="keys",d="values",y=function(){return this};t.exports=function(t,n,r,g,b,m,x){a(r,n,g);var w,S,_,O=function(t){if(!v&&t in F)return F[t];switch(t){case p:case d:return function(){return new r(this,t)}}return function(){return new r(this,t)}},E=n+" Iterator",P=b==d,j=!1,F=t.prototype,M=F[h]||F["@@iterator"]||b&&F[b],A=M||O(b),N=b?P?O("entries"):A:void 0,T="Array"==n?F.entries||M:M;if(T&&(_=l(T.call(new t)))!==Object.prototype&&(s(_,E,!0),e||c(_,h)||u(_,h,y)),P&&M&&M.name!==d&&(j=!0,A=function(){return M.call(this)}),e&&!x||!v&&!j&&F[h]||u(F,h,A),f[n]=A,f[E]=y,b)if(w={values:P?A:O(d),keys:m?A:O(p),entries:N},x)for(S in w)S in F||o(F,S,w[S]);else i(i.P+i.F*(v||j),n,w);return w}},function(t,n){var r=Math.expm1;t.exports=!r||r(10)>22025.465794806718||r(10)<22025.465794806718||-2e-17!=r(-2e-17)?function(t){return 0==(t=+t)?t:t>-1e-6&&t<1e-6?t+t*t/2:Math.exp(t)-1}:r},function(t,n){t.exports=Math.sign||function(t){return 0==(t=+t)||t!=t?t:t<0?-1:1}},function(t,n,r){var e=r(3),i=r(151).set,o=e.MutationObserver||e.WebKitMutationObserver,u=e.process,c=e.Promise,f="process"==r(45)(u);t.exports=function(){var t,n,r,a=function(){var e,i;for(f&&(e=u.domain)&&e.exit();t;){i=t.fn,t=t.next;try{i()}catch(e){throw t?r():n=void 0,e}}n=void 0,e&&e.enter()};if(f)r=function(){u.nextTick(a)};else if(o){var s=!0,l=document.createTextNode("");new o(a).observe(l,{characterData:!0}),r=function(){l.data=s=!s}}else if(c&&c.resolve){var h=c.resolve();r=function(){h.then(a)}}else r=function(){i.call(e,a)};return function(e){var i={fn:e,next:void 0};n&&(n.next=i),t||(t=i,r()),n=i}}},function(t,n,r){var e=r(6),i=r(2),o=function(t,n){if(i(t),!e(n)&&null!==n)throw TypeError(n+": can't set as prototype!")};t.exports={set:Object.setPrototypeOf||("__proto__"in{}?function(t,n,e){try{e=r(53)(Function.call,r(31).f(Object.prototype,"__proto__").set,2),e(t,[]),n=!(t instanceof Array)}catch(t){n=!0}return function(t,r){return o(t,r),n?t.__proto__=r:e(t,r),t}}({},!1):void 0),check:o}},function(t,n,r){var e=r(126)("keys"),i=r(76);t.exports=function(t){return e[t]||(e[t]=i(t))}},function(t,n,r){var e=r(2),i=r(26),o=r(7)("species");t.exports=function(t,n){var r,u=e(t).constructor;return void 0===u||void 0==(r=e(u)[o])?n:i(r)}},function(t,n,r){var e=r(67),i=r(46);t.exports=function(t){return function(n,r){var o,u,c=String(i(n)),f=e(r),a=c.length;return f<0||f>=a?t?"":void 0:(o=c.charCodeAt(f),o<55296||o>56319||f+1===a||(u=c.charCodeAt(f+1))<56320||u>57343?t?c.charAt(f):o:t?c.slice(f,f+2):u-56320+(o-55296<<10)+65536)}}},function(t,n,r){var e=r(122),i=r(46);t.exports=function(t,n,r){if(e(n))throw TypeError("String#"+r+" doesn't accept regex!");return String(i(t))}},function(t,n,r){"use strict";var e=r(67),i=r(46);t.exports=function(t){var n=String(i(this)),r="",o=e(t);if(o<0||o==1/0)throw RangeError("Count can't be negative");for(;o>0;(o>>>=1)&&(n+=n))1&o&&(r+=n);return r}},function(t,n){t.exports="\t\n\v\f\r   ᠎             　\u2028\u2029\ufeff"},function(t,n,r){var e,i,o,u=r(53),c=r(121),f=r(135),a=r(132),s=r(3),l=s.process,h=s.setImmediate,v=s.clearImmediate,p=s.MessageChannel,d=0,y={},g="onreadystatechange",b=function(){var t=+this;if(y.hasOwnProperty(t)){var n=y[t];delete y[t],n()}},m=function(t){b.call(t.data)};h&&v||(h=function(t){for(var n=[],r=1;arguments.length>r;)n.push(arguments[r++]);return y[++d]=function(){c("function"==typeof t?t:Function(t),n)},e(d),d},v=function(t){delete y[t]},"process"==r(45)(l)?e=function(t){l.nextTick(u(b,t,1))}:p?(i=new p,o=i.port2,i.port1.onmessage=m,e=u(o.postMessage,o,1)):s.addEventListener&&"function"==typeof postMessage&&!s.importScripts?(e=function(t){s.postMessage(t+"","*")},s.addEventListener("message",m,!1)):e=g in a("script")?function(t){f.appendChild(a("script"))[g]=function(){f.removeChild(this),b.call(t)}}:function(t){setTimeout(u(b,t,1),0)}),t.exports={set:h,clear:v}},function(t,n,r){"use strict";var e=r(3),i=r(10),o=r(69),u=r(127),c=r(27),f=r(73),a=r(4),s=r(68),l=r(67),h=r(16),v=r(71).f,p=r(11).f,d=r(130),y=r(81),g="ArrayBuffer",b="DataView",m="prototype",x="Wrong length!",w="Wrong index!",S=e[g],_=e[b],O=e.Math,E=e.RangeError,P=e.Infinity,j=S,F=O.abs,M=O.pow,A=O.floor,N=O.log,T=O.LN2,I="buffer",k="byteLength",L="byteOffset",R=i?"_b":I,C=i?"_l":k,D=i?"_o":L,U=function(t,n,r){var e,i,o,u=Array(r),c=8*r-n-1,f=(1<<c)-1,a=f>>1,s=23===n?M(2,-24)-M(2,-77):0,l=0,h=t<0||0===t&&1/t<0?1:0;for(t=F(t),t!=t||t===P?(i=t!=t?1:0,e=f):(e=A(N(t)/T),t*(o=M(2,-e))<1&&(e--,o*=2),t+=e+a>=1?s/o:s*M(2,1-a),t*o>=2&&(e++,o/=2),e+a>=f?(i=0,e=f):e+a>=1?(i=(t*o-1)*M(2,n),e+=a):(i=t*M(2,a-1)*M(2,n),e=0));n>=8;u[l++]=255&i,i/=256,n-=8);for(e=e<<n|i,c+=n;c>0;u[l++]=255&e,e/=256,c-=8);return u[--l]|=128*h,u},W=function(t,n,r){var e,i=8*r-n-1,o=(1<<i)-1,u=o>>1,c=i-7,f=r-1,a=t[f--],s=127&a;for(a>>=7;c>0;s=256*s+t[f],f--,c-=8);for(e=s&(1<<-c)-1,s>>=-c,c+=n;c>0;e=256*e+t[f],f--,c-=8);if(0===s)s=1-u;else{if(s===o)return e?NaN:a?-P:P;e+=M(2,n),s-=u}return(a?-1:1)*e*M(2,s-n)},G=function(t){return t[3]<<24|t[2]<<16|t[1]<<8|t[0]},B=function(t){return[255&t]},V=function(t){return[255&t,t>>8&255]},z=function(t){return[255&t,t>>8&255,t>>16&255,t>>24&255]},q=function(t){return U(t,52,8)},K=function(t){return U(t,23,4)},J=function(t,n,r){p(t[m],n,{get:function(){return this[r]}})},Y=function(t,n,r,e){var i=+r,o=l(i);if(i!=o||o<0||o+n>t[C])throw E(w);var u=t[R]._b,c=o+t[D],f=u.slice(c,c+n);return e?f:f.reverse()},H=function(t,n,r,e,i,o){var u=+r,c=l(u);if(u!=c||c<0||c+n>t[C])throw E(w);for(var f=t[R]._b,a=c+t[D],s=e(+i),h=0;h<n;h++)f[a+h]=s[o?h:n-h-1]},$=function(t,n){s(t,S,g);var r=+n,e=h(r);if(r!=e)throw E(x);return e};if(u.ABV){if(!a(function(){new S})||!a(function(){new S(.5)})){S=function(t){return new j($(this,t))};for(var X,Q=S[m]=j[m],Z=v(j),tt=0;Z.length>tt;)(X=Z[tt++])in S||c(S,X,j[X]);o||(Q.constructor=S)}var nt=new _(new S(2)),rt=_[m].setInt8;nt.setInt8(0,2147483648),nt.setInt8(1,2147483649),!nt.getInt8(0)&&nt.getInt8(1)||f(_[m],{setInt8:function(t,n){rt.call(this,t,n<<24>>24)},setUint8:function(t,n){rt.call(this,t,n<<24>>24)}},!0)}else S=function(t){var n=$(this,t);this._b=d.call(Array(n),0),this[C]=n},_=function(t,n,r){s(this,_,b),s(t,S,b);var e=t[C],i=l(n);if(i<0||i>e)throw E("Wrong offset!");if(r=void 0===r?e-i:h(r),i+r>e)throw E(x);this[R]=t,this[D]=i,this[C]=r},i&&(J(S,k,"_l"),J(_,I,"_b"),J(_,k,"_l"),J(_,L,"_o")),f(_[m],{getInt8:function(t){return Y(this,1,t)[0]<<24>>24},getUint8:function(t){return Y(this,1,t)[0]},getInt16:function(t){var n=Y(this,2,t,arguments[1]);return(n[1]<<8|n[0])<<16>>16},getUint16:function(t){var n=Y(this,2,t,arguments[1]);return n[1]<<8|n[0]},getInt32:function(t){return G(Y(this,4,t,arguments[1]))},getUint32:function(t){return G(Y(this,4,t,arguments[1]))>>>0},getFloat32:function(t){return W(Y(this,4,t,arguments[1]),23,4)},getFloat64:function(t){return W(Y(this,8,t,arguments[1]),52,8)},setInt8:function(t,n){H(this,1,t,B,n)},setUint8:function(t,n){H(this,1,t,B,n)},setInt16:function(t,n){H(this,2,t,V,n,arguments[2])},setUint16:function(t,n){H(this,2,t,V,n,arguments[2])},setInt32:function(t,n){H(this,4,t,z,n,arguments[2])},setUint32:function(t,n){H(this,4,t,z,n,arguments[2])},setFloat32:function(t,n){H(this,4,t,K,n,arguments[2])},setFloat64:function(t,n){H(this,8,t,q,n,arguments[2])}});y(S,g),y(_,b),c(_[m],u.VIEW,!0),n[g]=S,n[b]=_},function(t,n,r){var e=r(3),i=r(52),o=r(69),u=r(182),c=r(11).f;t.exports=function(t){var n=i.Symbol||(i.Symbol=o?{}:e.Symbol||{});"_"==t.charAt(0)||t in n||c(n,t,{value:u.f(t)})}},function(t,n,r){var e=r(114),i=r(7)("iterator"),o=r(80);t.exports=r(52).getIteratorMethod=function(t){if(void 0!=t)return t[i]||t["@@iterator"]||o[e(t)]}},function(t,n,r){"use strict";var e=r(78),i=r(170),o=r(80),u=r(30);t.exports=r(140)(Array,"Array",function(t,n){this._t=u(t),this._i=0,this._k=n},function(){var t=this._t,n=this._k,r=this._i++;return!t||r>=t.length?(this._t=void 0,i(1)):"keys"==n?i(0,r):"values"==n?i(0,t[r]):i(0,[r,t[r]])},"values"),o.Arguments=o.Array,e("keys"),e("values"),e("entries")},function(t,n){function r(t,n){t.classList?t.classList.add(n):t.className+=" "+n}t.exports=r},function(t,n){function r(t,n){if(t.classList)t.classList.remove(n);else{var r=new RegExp("(^|\\b)"+n.split(" ").join("|")+"(\\b|$)","gi");t.className=t.className.replace(r," ")}}t.exports=r},function(t,n){function r(){throw new Error("setTimeout has not been defined")}function e(){throw new Error("clearTimeout has not been defined")}function i(t){if(s===setTimeout)return setTimeout(t,0);if((s===r||!s)&&setTimeout)return s=setTimeout,setTimeout(t,0);try{return s(t,0)}catch(n){try{return s.call(null,t,0)}catch(n){return s.call(this,t,0)}}}function o(t){if(l===clearTimeout)return clearTimeout(t);if((l===e||!l)&&clearTimeout)return l=clearTimeout,clearTimeout(t);try{return l(t)}catch(n){try{return l.call(null,t)}catch(n){return l.call(this,t)}}}function u(){d&&v&&(d=!1,v.length?p=v.concat(p):y=-1,p.length&&c())}function c(){if(!d){var t=i(u);d=!0;for(var n=p.length;n;){for(v=p,p=[];++y<n;)v&&v[y].run();y=-1,n=p.length}v=null,d=!1,o(t)}}function f(t,n){this.fun=t,this.array=n}function a(){}var s,l,h=t.exports={};!function(){try{s="function"==typeof setTimeout?setTimeout:r}catch(t){s=r}try{l="function"==typeof clearTimeout?clearTimeout:e}catch(t){l=e}}();var v,p=[],d=!1,y=-1;h.nextTick=function(t){var n=new Array(arguments.length-1);if(arguments.length>1)for(var r=1;r<arguments.length;r++)n[r-1]=arguments[r];p.push(new f(t,n)),1!==p.length||d||i(c)},f.prototype.run=function(){this.fun.apply(null,this.array)},h.title="browser",h.browser=!0,h.env={},h.argv=[],h.version="",h.versions={},h.on=a,h.addListener=a,h.once=a,h.off=a,h.removeListener=a,h.removeAllListeners=a,h.emit=a,h.prependListener=a,h.prependOnceListener=a,h.listeners=function(t){return[]},h.binding=function(t){throw new Error("process.binding is not supported")},h.cwd=function(){return"/"},h.chdir=function(t){throw new Error("process.chdir is not supported")},h.umask=function(){return 0}},function(t,n,r){var e=r(45);t.exports=function(t,n){if("number"!=typeof t&&"Number"!=e(t))throw TypeError(n);return+t}},function(t,n,r){"use strict";var e=r(17),i=r(75),o=r(16);t.exports=[].copyWithin||function(t,n){var r=e(this),u=o(r.length),c=i(t,u),f=i(n,u),a=arguments.length>2?arguments[2]:void 0,s=Math.min((void 0===a?u:i(a,u))-f,u-c),l=1;for(f<c&&c<f+s&&(l=-1,f+=s-1,c+=s-1);s-- >0;)f in r?r[c]=r[f]:delete r[c],c+=l,f+=l;return r}},function(t,n,r){var e=r(79);t.exports=function(t,n){var r=[];return e(t,!1,r.push,r,n),r}},function(t,n,r){var e=r(26),i=r(17),o=r(115),u=r(16);t.exports=function(t,n,r,c,f){e(n);var a=i(t),s=o(a),l=u(a.length),h=f?l-1:0,v=f?-1:1;if(r<2)for(;;){if(h in s){c=s[h],h+=v;break}if(h+=v,f?h<0:l<=h)throw TypeError("Reduce of empty array with no initial value")}for(;f?h>=0:l>h;h+=v)h in s&&(c=n(c,s[h],h,a));return c}},function(t,n,r){"use strict";var e=r(26),i=r(6),o=r(121),u=[].slice,c={},f=function(t,n,r){if(!(n in c)){for(var e=[],i=0;i<n;i++)e[i]="a["+i+"]";c[n]=Function("F,a","return new F("+e.join(",")+")")}return c[n](t,r)};t.exports=Function.bind||function(t){var n=e(this),r=u.call(arguments,1),c=function(){var e=r.concat(u.call(arguments));return this instanceof c?f(n,e.length,e):o(n,e,t)};return i(n.prototype)&&(c.prototype=n.prototype),c}},function(t,n,r){"use strict";var e=r(11).f,i=r(70),o=r(73),u=r(53),c=r(68),f=r(46),a=r(79),s=r(140),l=r(170),h=r(74),v=r(10),p=r(65).fastKey,d=v?"_s":"size",y=function(t,n){var r,e=p(n);if("F"!==e)return t._i[e];for(r=t._f;r;r=r.n)if(r.k==n)return r};t.exports={getConstructor:function(t,n,r,s){var l=t(function(t,e){c(t,l,n,"_i"),t._i=i(null),t._f=void 0,t._l=void 0,t[d]=0,void 0!=e&&a(e,r,t[s],t)});return o(l.prototype,{clear:function(){for(var t=this,n=t._i,r=t._f;r;r=r.n)r.r=!0,r.p&&(r.p=r.p.n=void 0),delete n[r.i];t._f=t._l=void 0,t[d]=0},delete:function(t){var n=this,r=y(n,t);if(r){var e=r.n,i=r.p;delete n._i[r.i],r.r=!0,i&&(i.n=e),e&&(e.p=i),n._f==r&&(n._f=e),n._l==r&&(n._l=i),n[d]--}return!!r},forEach:function(t){c(this,l,"forEach");for(var n,r=u(t,arguments.length>1?arguments[1]:void 0,3);n=n?n.n:this._f;)for(r(n.v,n.k,this);n&&n.r;)n=n.p},has:function(t){return!!y(this,t)}}),v&&e(l.prototype,"size",{get:function(){return f(this[d])}}),l},def:function(t,n,r){var e,i,o=y(t,n);return o?o.v=r:(t._l=o={i:i=p(n,!0),k:n,v:r,p:e=t._l,n:void 0,r:!1},t._f||(t._f=o),e&&(e.n=o),t[d]++,"F"!==i&&(t._i[i]=o)),t},getEntry:y,setStrong:function(t,n,r){s(t,n,function(t,n){this._t=t,this._k=n,this._l=void 0},function(){for(var t=this,n=t._k,r=t._l;r&&r.r;)r=r.p;return t._t&&(t._l=r=r?r.n:t._t._f)?"keys"==n?l(0,r.k):"values"==n?l(0,r.v):l(0,[r.k,r.v]):(t._t=void 0,l(1))},r?"entries":"values",!r,!0),h(n)}}},function(t,n,r){var e=r(114),i=r(161);t.exports=function(t){return function(){if(e(this)!=t)throw TypeError(t+"#toJSON isn't generic");return i(this)}}},function(t,n,r){"use strict";var e=r(73),i=r(65).getWeak,o=r(2),u=r(6),c=r(68),f=r(79),a=r(48),s=r(24),l=a(5),h=a(6),v=0,p=function(t){return t._l||(t._l=new d)},d=function(){this.a=[]},y=function(t,n){return l(t.a,function(t){return t[0]===n})};d.prototype={get:function(t){var n=y(this,t);if(n)return n[1]},has:function(t){return!!y(this,t)},set:function(t,n){var r=y(this,t);r?r[1]=n:this.a.push([t,n])},delete:function(t){var n=h(this.a,function(n){return n[0]===t});return~n&&this.a.splice(n,1),!!~n}},t.exports={getConstructor:function(t,n,r,o){var a=t(function(t,e){c(t,a,n,"_i"),t._i=v++,t._l=void 0,void 0!=e&&f(e,r,t[o],t)});return e(a.prototype,{delete:function(t){if(!u(t))return!1;var n=i(t);return!0===n?p(this).delete(t):n&&s(n,this._i)&&delete n[this._i]},has:function(t){if(!u(t))return!1;var n=i(t);return!0===n?p(this).has(t):n&&s(n,this._i)}}),a},def:function(t,n,r){var e=i(o(n),!0);return!0===e?p(t).set(n,r):e[t._i]=r,t},ufstore:p}},function(t,n,r){t.exports=!r(10)&&!r(4)(function(){return 7!=Object.defineProperty(r(132)("div"),"a",{get:function(){return 7}}).a})},function(t,n,r){var e=r(6),i=Math.floor;t.exports=function(t){return!e(t)&&isFinite(t)&&i(t)===t}},function(t,n,r){var e=r(2);t.exports=function(t,n,r,i){try{return i?n(e(r)[0],r[1]):n(r)}catch(n){var o=t.return;throw void 0!==o&&e(o.call(t)),n}}},function(t,n){t.exports=function(t,n){return{value:n,done:!!t}}},function(t,n){t.exports=Math.log1p||function(t){return(t=+t)>-1e-8&&t<1e-8?t-t*t/2:Math.log(1+t)}},function(t,n,r){"use strict";var e=r(72),i=r(125),o=r(116),u=r(17),c=r(115),f=Object.assign;t.exports=!f||r(4)(function(){var t={},n={},r=Symbol(),e="abcdefghijklmnopqrst";return t[r]=7,e.split("").forEach(function(t){n[t]=t}),7!=f({},t)[r]||Object.keys(f({},n)).join("")!=e})?function(t,n){for(var r=u(t),f=arguments.length,a=1,s=i.f,l=o.f;f>a;)for(var h,v=c(arguments[a++]),p=s?e(v).concat(s(v)):e(v),d=p.length,y=0;d>y;)l.call(v,h=p[y++])&&(r[h]=v[h]);return r}:f},function(t,n,r){var e=r(11),i=r(2),o=r(72);t.exports=r(10)?Object.defineProperties:function(t,n){i(t);for(var r,u=o(n),c=u.length,f=0;c>f;)e.f(t,r=u[f++],n[r]);return t}},function(t,n,r){var e=r(30),i=r(71).f,o={}.toString,u="object"==typeof window&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[],c=function(t){try{return i(t)}catch(t){return u.slice()}};t.exports.f=function(t){return u&&"[object Window]"==o.call(t)?c(t):i(e(t))}},function(t,n,r){var e=r(24),i=r(30),o=r(117)(!1),u=r(145)("IE_PROTO");t.exports=function(t,n){var r,c=i(t),f=0,a=[];for(r in c)r!=u&&e(c,r)&&a.push(r);for(;n.length>f;)e(c,r=n[f++])&&(~o(a,r)||a.push(r));return a}},function(t,n,r){var e=r(72),i=r(30),o=r(116).f;t.exports=function(t){return function(n){for(var r,u=i(n),c=e(u),f=c.length,a=0,s=[];f>a;)o.call(u,r=c[a++])&&s.push(t?[r,u[r]]:u[r]);return s}}},function(t,n,r){var e=r(71),i=r(125),o=r(2),u=r(3).Reflect;t.exports=u&&u.ownKeys||function(t){var n=e.f(o(t)),r=i.f;return r?n.concat(r(t)):n}},function(t,n,r){var e=r(3).parseFloat,i=r(82).trim;t.exports=1/e(r(150)+"-0")!=-1/0?function(t){var n=i(String(t),3),r=e(n);return 0===r&&"-"==n.charAt(0)?-0:r}:e},function(t,n,r){var e=r(3).parseInt,i=r(82).trim,o=r(150),u=/^[\-+]?0[xX]/;t.exports=8!==e(o+"08")||22!==e(o+"0x16")?function(t,n){var r=i(String(t),3);return e(r,n>>>0||(u.test(r)?16:10))}:e},function(t,n){t.exports=Object.is||function(t,n){return t===n?0!==t||1/t==1/n:t!=t&&n!=n}},function(t,n,r){var e=r(16),i=r(149),o=r(46);t.exports=function(t,n,r,u){var c=String(o(t)),f=c.length,a=void 0===r?" ":String(r),s=e(n);if(s<=f||""==a)return c;var l=s-f,h=i.call(a,Math.ceil(l/a.length));return h.length>l&&(h=h.slice(0,l)),u?h+c:c+h}},function(t,n,r){n.f=r(7)},function(t,n,r){"use strict";var e=r(164);t.exports=r(118)("Map",function(t){return function(){return t(this,arguments.length>0?arguments[0]:void 0)}},{get:function(t){var n=e.getEntry(this,t);return n&&n.v},set:function(t,n){return e.def(this,0===t?0:t,n)}},e,!0)},function(t,n,r){r(10)&&"g"!=/./g.flags&&r(11).f(RegExp.prototype,"flags",{configurable:!0,get:r(120)})},function(t,n,r){"use strict";var e=r(164);t.exports=r(118)("Set",function(t){return function(){return t(this,arguments.length>0?arguments[0]:void 0)}},{add:function(t){return e.def(this,t=0===t?0:t,t)}},e)},function(t,n,r){"use strict";var e,i=r(48)(0),o=r(28),u=r(65),c=r(172),f=r(166),a=r(6),s=u.getWeak,l=Object.isExtensible,h=f.ufstore,v={},p=function(t){return function(){return t(this,arguments.length>0?arguments[0]:void 0)}},d={get:function(t){if(a(t)){var n=s(t);return!0===n?h(this).get(t):n?n[this._i]:void 0}},set:function(t,n){return f.def(this,t,n)}},y=t.exports=r(118)("WeakMap",p,d,f,!0,!0);7!=(new y).set((Object.freeze||Object)(v),7).get(v)&&(e=f.getConstructor(p),c(e.prototype,d),u.NEED=!0,i(["delete","has","get","set"],function(t){var n=y.prototype,r=n[t];o(n,t,function(n,i){if(a(n)&&!l(n)){this._f||(this._f=new e);var o=this._f[t](n,i);return"set"==t?this:o}return r.call(this,n,i)})}))},,,,function(t,n){"use strict";function r(){var t=document.querySelector("#page-nav");if(t&&!document.querySelector("#page-nav .extend.prev")&&(t.innerHTML='<a class="extend prev disabled" rel="prev">&laquo; Prev</a>'+t.innerHTML),t&&!document.querySelector("#page-nav .extend.next")&&(t.innerHTML=t.innerHTML+'<a class="extend next disabled" rel="next">Next &raquo;</a>'),yiliaConfig&&yiliaConfig.open_in_new){document.querySelectorAll(".article-entry a:not(.article-more-a)").forEach(function(t){var n=t.getAttribute("target");n&&""!==n||t.setAttribute("target","_blank")})}if(yiliaConfig&&yiliaConfig.toc_hide_index){document.querySelectorAll(".toc-number").forEach(function(t){t.style.display="none"})}var n=document.querySelector("#js-aboutme");n&&0!==n.length&&(n.innerHTML=n.innerText)}t.exports={init:r}},function(t,n,r){"use strict";function e(t){return t&&t.__esModule?t:{default:t}}function i(t,n){var r=/\/|index.html/g;return t.replace(r,"")===n.replace(r,"")}function o(){for(var t=document.querySelectorAll(".js-header-menu li a"),n=window.location.pathname,r=0,e=t.length;r<e;r++){var o=t[r];i(n,o.getAttribute("href"))&&(0,h.default)(o,"active")}}function u(t){for(var n=t.offsetLeft,r=t.offsetParent;null!==r;)n+=r.offsetLeft,r=r.offsetParent;return n}function c(t){for(var n=t.offsetTop,r=t.offsetParent;null!==r;)n+=r.offsetTop,r=r.offsetParent;return n}function f(t,n,r,e,i){var o=u(t),f=c(t)-n;if(f-r<=i){var a=t.$newDom;a||(a=t.cloneNode(!0),(0,d.default)(t,a),t.$newDom=a,a.style.position="fixed",a.style.top=(r||f)+"px",a.style.left=o+"px",a.style.zIndex=e||2,a.style.width="100%",a.style.color="#fff"),a.style.visibility="visible",t.style.visibility="hidden"}else{t.style.visibility="visible";var s=t.$newDom;s&&(s.style.visibility="hidden")}}function a(){var t=document.querySelector(".js-overlay"),n=document.querySelector(".js-header-menu");f(t,document.body.scrollTop,-63,2,0),f(n,document.body.scrollTop,1,3,0)}function s(){document.querySelector("#container").addEventListener("scroll",function(t){a()}),window.addEventListener("scroll",function(t){a()}),a()}var l=r(156),h=e(l),v=r(157),p=(e(v),r(382)),d=e(p),y=r(128),g=e(y),b=r(190),m=e(b),x=r(129);(function(){g.default.versions.mobile&&window.screen.width<800&&(o(),s())})(),(0,x.addLoadEvent)(function(){m.default.init()}),t.exports={}},,,,function(t,n,r){(function(t){"use strict";function n(t,n,r){t[n]||Object[e](t,n,{writable:!0,configurable:!0,value:r})}if(r(381),r(391),r(198),t._babelPolyfill)throw new Error("only one instance of babel-polyfill is allowed");t._babelPolyfill=!0;var e="defineProperty";n(String.prototype,"padLeft","".padStart),n(String.prototype,"padRight","".padEnd),"pop,reverse,shift,keys,values,entries,indexOf,every,some,forEach,map,filter,find,findIndex,includes,join,slice,concat,push,splice,unshift,sort,lastIndexOf,reduce,reduceRight,copyWithin,fill".split(",").forEach(function(t){[][t]&&n(Array,t,Function.call.bind([][t]))})}).call(n,function(){return this}())},,,function(t,n,r){r(210),t.exports=r(52).RegExp.escape},,,,function(t,n,r){var e=r(6),i=r(138),o=r(7)("species");t.exports=function(t){var n;return i(t)&&(n=t.constructor,"function"!=typeof n||n!==Array&&!i(n.prototype)||(n=void 0),e(n)&&null===(n=n[o])&&(n=void 0)),void 0===n?Array:n}},function(t,n,r){var e=r(202);t.exports=function(t,n){return new(e(t))(n)}},function(t,n,r){"use strict";var e=r(2),i=r(50),o="number";t.exports=function(t){if("string"!==t&&t!==o&&"default"!==t)throw TypeError("Incorrect hint");return i(e(this),t!=o)}},function(t,n,r){var e=r(72),i=r(125),o=r(116);t.exports=function(t){var n=e(t),r=i.f;if(r)for(var u,c=r(t),f=o.f,a=0;c.length>a;)f.call(t,u=c[a++])&&n.push(u);return n}},function(t,n,r){var e=r(72),i=r(30);t.exports=function(t,n){for(var r,o=i(t),u=e(o),c=u.length,f=0;c>f;)if(o[r=u[f++]]===n)return r}},function(t,n,r){"use strict";var e=r(208),i=r(121),o=r(26);t.exports=function(){for(var t=o(this),n=arguments.length,r=Array(n),u=0,c=e._,f=!1;n>u;)(r[u]=arguments[u++])===c&&(f=!0);return function(){var e,o=this,u=arguments.length,a=0,s=0;if(!f&&!u)return i(t,r,o);if(e=r.slice(),f)for(;n>a;a++)e[a]===c&&(e[a]=arguments[s++]);for(;u>s;)e.push(arguments[s++]);return i(t,e,o)}}},function(t,n,r){t.exports=r(3)},function(t,n){t.exports=function(t,n){var r=n===Object(n)?function(t){return n[t]}:n;return function(n){return String(n).replace(t,r)}}},function(t,n,r){var e=r(1),i=r(209)(/[\\^$*+?.()|[\]{}]/g,"\\$&");e(e.S,"RegExp",{escape:function(t){return i(t)}})},function(t,n,r){var e=r(1);e(e.P,"Array",{copyWithin:r(160)}),r(78)("copyWithin")},function(t,n,r){"use strict";var e=r(1),i=r(48)(4);e(e.P+e.F*!r(47)([].every,!0),"Array",{every:function(t){return i(this,t,arguments[1])}})},function(t,n,r){var e=r(1);e(e.P,"Array",{fill:r(130)}),r(78)("fill")},function(t,n,r){"use strict";var e=r(1),i=r(48)(2);e(e.P+e.F*!r(47)([].filter,!0),"Array",{filter:function(t){return i(this,t,arguments[1])}})},function(t,n,r){"use strict";var e=r(1),i=r(48)(6),o="findIndex",u=!0;o in[]&&Array(1)[o](function(){u=!1}),e(e.P+e.F*u,"Array",{findIndex:function(t){return i(this,t,arguments.length>1?arguments[1]:void 0)}}),r(78)(o)},function(t,n,r){"use strict";var e=r(1),i=r(48)(5),o="find",u=!0;o in[]&&Array(1)[o](function(){u=!1}),e(e.P+e.F*u,"Array",{find:function(t){return i(this,t,arguments.length>1?arguments[1]:void 0)}}),r(78)(o)},function(t,n,r){"use strict";var e=r(1),i=r(48)(0),o=r(47)([].forEach,!0);e(e.P+e.F*!o,"Array",{forEach:function(t){return i(this,t,arguments[1])}})},function(t,n,r){"use strict";var e=r(53),i=r(1),o=r(17),u=r(169),c=r(137),f=r(16),a=r(131),s=r(154);i(i.S+i.F*!r(123)(function(t){Array.from(t)}),"Array",{from:function(t){var n,r,i,l,h=o(t),v="function"==typeof this?this:Array,p=arguments.length,d=p>1?arguments[1]:void 0,y=void 0!==d,g=0,b=s(h);if(y&&(d=e(d,p>2?arguments[2]:void 0,2)),void 0==b||v==Array&&c(b))for(n=f(h.length),r=new v(n);n>g;g++)a(r,g,y?d(h[g],g):h[g]);else for(l=b.call(h),r=new v;!(i=l.next()).done;g++)a(r,g,y?u(l,d,[i.value,g],!0):i.value);return r.length=g,r}})},function(t,n,r){"use strict";var e=r(1),i=r(117)(!1),o=[].indexOf,u=!!o&&1/[1].indexOf(1,-0)<0;e(e.P+e.F*(u||!r(47)(o)),"Array",{indexOf:function(t){return u?o.apply(this,arguments)||0:i(this,t,arguments[1])}})},function(t,n,r){var e=r(1);e(e.S,"Array",{isArray:r(138)})},function(t,n,r){"use strict";var e=r(1),i=r(30),o=[].join;e(e.P+e.F*(r(115)!=Object||!r(47)(o)),"Array",{join:function(t){return o.call(i(this),void 0===t?",":t)}})},function(t,n,r){"use strict";var e=r(1),i=r(30),o=r(67),u=r(16),c=[].lastIndexOf,f=!!c&&1/[1].lastIndexOf(1,-0)<0;e(e.P+e.F*(f||!r(47)(c)),"Array",{lastIndexOf:function(t){if(f)return c.apply(this,arguments)||0;var n=i(this),r=u(n.length),e=r-1;for(arguments.length>1&&(e=Math.min(e,o(arguments[1]))),e<0&&(e=r+e);e>=0;e--)if(e in n&&n[e]===t)return e||0;return-1}})},function(t,n,r){"use strict";var e=r(1),i=r(48)(1);e(e.P+e.F*!r(47)([].map,!0),"Array",{map:function(t){return i(this,t,arguments[1])}})},function(t,n,r){"use strict";var e=r(1),i=r(131);e(e.S+e.F*r(4)(function(){function t(){}return!(Array.of.call(t)instanceof t)}),"Array",{of:function(){for(var t=0,n=arguments.length,r=new("function"==typeof this?this:Array)(n);n>t;)i(r,t,arguments[t++]);return r.length=n,r}})},function(t,n,r){"use strict";var e=r(1),i=r(162);e(e.P+e.F*!r(47)([].reduceRight,!0),"Array",{reduceRight:function(t){return i(this,t,arguments.length,arguments[1],!0)}})},function(t,n,r){"use strict";var e=r(1),i=r(162);e(e.P+e.F*!r(47)([].reduce,!0),"Array",{reduce:function(t){return i(this,t,arguments.length,arguments[1],!1)}})},function(t,n,r){"use strict";var e=r(1),i=r(135),o=r(45),u=r(75),c=r(16),f=[].slice;e(e.P+e.F*r(4)(function(){i&&f.call(i)}),"Array",{slice:function(t,n){var r=c(this.length),e=o(this);if(n=void 0===n?r:n,"Array"==e)return f.call(this,t,n);for(var i=u(t,r),a=u(n,r),s=c(a-i),l=Array(s),h=0;h<s;h++)l[h]="String"==e?this.charAt(i+h):this[i+h];return l}})},function(t,n,r){"use strict";var e=r(1),i=r(48)(3);e(e.P+e.F*!r(47)([].some,!0),"Array",{some:function(t){return i(this,t,arguments[1])}})},function(t,n,r){"use strict";var e=r(1),i=r(26),o=r(17),u=r(4),c=[].sort,f=[1,2,3];e(e.P+e.F*(u(function(){f.sort(void 0)})||!u(function(){f.sort(null)})||!r(47)(c)),"Array",{sort:function(t){return void 0===t?c.call(o(this)):c.call(o(this),i(t))}})},function(t,n,r){r(74)("Array")},function(t,n,r){var e=r(1);e(e.S,"Date",{now:function(){return(new Date).getTime()}})},function(t,n,r){"use strict";var e=r(1),i=r(4),o=Date.prototype.getTime,u=function(t){return t>9?t:"0"+t};e(e.P+e.F*(i(function(){return"0385-07-25T07:06:39.999Z"!=new Date(-5e13-1).toISOString()})||!i(function(){new Date(NaN).toISOString()})),"Date",{toISOString:function(){
if(!isFinite(o.call(this)))throw RangeError("Invalid time value");var t=this,n=t.getUTCFullYear(),r=t.getUTCMilliseconds(),e=n<0?"-":n>9999?"+":"";return e+("00000"+Math.abs(n)).slice(e?-6:-4)+"-"+u(t.getUTCMonth()+1)+"-"+u(t.getUTCDate())+"T"+u(t.getUTCHours())+":"+u(t.getUTCMinutes())+":"+u(t.getUTCSeconds())+"."+(r>99?r:"0"+u(r))+"Z"}})},function(t,n,r){"use strict";var e=r(1),i=r(17),o=r(50);e(e.P+e.F*r(4)(function(){return null!==new Date(NaN).toJSON()||1!==Date.prototype.toJSON.call({toISOString:function(){return 1}})}),"Date",{toJSON:function(t){var n=i(this),r=o(n);return"number"!=typeof r||isFinite(r)?n.toISOString():null}})},function(t,n,r){var e=r(7)("toPrimitive"),i=Date.prototype;e in i||r(27)(i,e,r(204))},function(t,n,r){var e=Date.prototype,i="Invalid Date",o="toString",u=e[o],c=e.getTime;new Date(NaN)+""!=i&&r(28)(e,o,function(){var t=c.call(this);return t===t?u.call(this):i})},function(t,n,r){var e=r(1);e(e.P,"Function",{bind:r(163)})},function(t,n,r){"use strict";var e=r(6),i=r(32),o=r(7)("hasInstance"),u=Function.prototype;o in u||r(11).f(u,o,{value:function(t){if("function"!=typeof this||!e(t))return!1;if(!e(this.prototype))return t instanceof this;for(;t=i(t);)if(this.prototype===t)return!0;return!1}})},function(t,n,r){var e=r(11).f,i=r(66),o=r(24),u=Function.prototype,c="name",f=Object.isExtensible||function(){return!0};c in u||r(10)&&e(u,c,{configurable:!0,get:function(){try{var t=this,n=(""+t).match(/^\s*function ([^ (]*)/)[1];return o(t,c)||!f(t)||e(t,c,i(5,n)),n}catch(t){return""}}})},function(t,n,r){var e=r(1),i=r(171),o=Math.sqrt,u=Math.acosh;e(e.S+e.F*!(u&&710==Math.floor(u(Number.MAX_VALUE))&&u(1/0)==1/0),"Math",{acosh:function(t){return(t=+t)<1?NaN:t>94906265.62425156?Math.log(t)+Math.LN2:i(t-1+o(t-1)*o(t+1))}})},function(t,n,r){function e(t){return isFinite(t=+t)&&0!=t?t<0?-e(-t):Math.log(t+Math.sqrt(t*t+1)):t}var i=r(1),o=Math.asinh;i(i.S+i.F*!(o&&1/o(0)>0),"Math",{asinh:e})},function(t,n,r){var e=r(1),i=Math.atanh;e(e.S+e.F*!(i&&1/i(-0)<0),"Math",{atanh:function(t){return 0==(t=+t)?t:Math.log((1+t)/(1-t))/2}})},function(t,n,r){var e=r(1),i=r(142);e(e.S,"Math",{cbrt:function(t){return i(t=+t)*Math.pow(Math.abs(t),1/3)}})},function(t,n,r){var e=r(1);e(e.S,"Math",{clz32:function(t){return(t>>>=0)?31-Math.floor(Math.log(t+.5)*Math.LOG2E):32}})},function(t,n,r){var e=r(1),i=Math.exp;e(e.S,"Math",{cosh:function(t){return(i(t=+t)+i(-t))/2}})},function(t,n,r){var e=r(1),i=r(141);e(e.S+e.F*(i!=Math.expm1),"Math",{expm1:i})},function(t,n,r){var e=r(1),i=r(142),o=Math.pow,u=o(2,-52),c=o(2,-23),f=o(2,127)*(2-c),a=o(2,-126),s=function(t){return t+1/u-1/u};e(e.S,"Math",{fround:function(t){var n,r,e=Math.abs(t),o=i(t);return e<a?o*s(e/a/c)*a*c:(n=(1+c/u)*e,r=n-(n-e),r>f||r!=r?o*(1/0):o*r)}})},function(t,n,r){var e=r(1),i=Math.abs;e(e.S,"Math",{hypot:function(t,n){for(var r,e,o=0,u=0,c=arguments.length,f=0;u<c;)r=i(arguments[u++]),f<r?(e=f/r,o=o*e*e+1,f=r):r>0?(e=r/f,o+=e*e):o+=r;return f===1/0?1/0:f*Math.sqrt(o)}})},function(t,n,r){var e=r(1),i=Math.imul;e(e.S+e.F*r(4)(function(){return-5!=i(4294967295,5)||2!=i.length}),"Math",{imul:function(t,n){var r=65535,e=+t,i=+n,o=r&e,u=r&i;return 0|o*u+((r&e>>>16)*u+o*(r&i>>>16)<<16>>>0)}})},function(t,n,r){var e=r(1);e(e.S,"Math",{log10:function(t){return Math.log(t)/Math.LN10}})},function(t,n,r){var e=r(1);e(e.S,"Math",{log1p:r(171)})},function(t,n,r){var e=r(1);e(e.S,"Math",{log2:function(t){return Math.log(t)/Math.LN2}})},function(t,n,r){var e=r(1);e(e.S,"Math",{sign:r(142)})},function(t,n,r){var e=r(1),i=r(141),o=Math.exp;e(e.S+e.F*r(4)(function(){return-2e-17!=!Math.sinh(-2e-17)}),"Math",{sinh:function(t){return Math.abs(t=+t)<1?(i(t)-i(-t))/2:(o(t-1)-o(-t-1))*(Math.E/2)}})},function(t,n,r){var e=r(1),i=r(141),o=Math.exp;e(e.S,"Math",{tanh:function(t){var n=i(t=+t),r=i(-t);return n==1/0?1:r==1/0?-1:(n-r)/(o(t)+o(-t))}})},function(t,n,r){var e=r(1);e(e.S,"Math",{trunc:function(t){return(t>0?Math.floor:Math.ceil)(t)}})},function(t,n,r){"use strict";var e=r(3),i=r(24),o=r(45),u=r(136),c=r(50),f=r(4),a=r(71).f,s=r(31).f,l=r(11).f,h=r(82).trim,v="Number",p=e[v],d=p,y=p.prototype,g=o(r(70)(y))==v,b="trim"in String.prototype,m=function(t){var n=c(t,!1);if("string"==typeof n&&n.length>2){n=b?n.trim():h(n,3);var r,e,i,o=n.charCodeAt(0);if(43===o||45===o){if(88===(r=n.charCodeAt(2))||120===r)return NaN}else if(48===o){switch(n.charCodeAt(1)){case 66:case 98:e=2,i=49;break;case 79:case 111:e=8,i=55;break;default:return+n}for(var u,f=n.slice(2),a=0,s=f.length;a<s;a++)if((u=f.charCodeAt(a))<48||u>i)return NaN;return parseInt(f,e)}}return+n};if(!p(" 0o1")||!p("0b1")||p("+0x1")){p=function(t){var n=arguments.length<1?0:t,r=this;return r instanceof p&&(g?f(function(){y.valueOf.call(r)}):o(r)!=v)?u(new d(m(n)),r,p):m(n)};for(var x,w=r(10)?a(d):"MAX_VALUE,MIN_VALUE,NaN,NEGATIVE_INFINITY,POSITIVE_INFINITY,EPSILON,isFinite,isInteger,isNaN,isSafeInteger,MAX_SAFE_INTEGER,MIN_SAFE_INTEGER,parseFloat,parseInt,isInteger".split(","),S=0;w.length>S;S++)i(d,x=w[S])&&!i(p,x)&&l(p,x,s(d,x));p.prototype=y,y.constructor=p,r(28)(e,v,p)}},function(t,n,r){var e=r(1);e(e.S,"Number",{EPSILON:Math.pow(2,-52)})},function(t,n,r){var e=r(1),i=r(3).isFinite;e(e.S,"Number",{isFinite:function(t){return"number"==typeof t&&i(t)}})},function(t,n,r){var e=r(1);e(e.S,"Number",{isInteger:r(168)})},function(t,n,r){var e=r(1);e(e.S,"Number",{isNaN:function(t){return t!=t}})},function(t,n,r){var e=r(1),i=r(168),o=Math.abs;e(e.S,"Number",{isSafeInteger:function(t){return i(t)&&o(t)<=9007199254740991}})},function(t,n,r){var e=r(1);e(e.S,"Number",{MAX_SAFE_INTEGER:9007199254740991})},function(t,n,r){var e=r(1);e(e.S,"Number",{MIN_SAFE_INTEGER:-9007199254740991})},function(t,n,r){var e=r(1),i=r(178);e(e.S+e.F*(Number.parseFloat!=i),"Number",{parseFloat:i})},function(t,n,r){var e=r(1),i=r(179);e(e.S+e.F*(Number.parseInt!=i),"Number",{parseInt:i})},function(t,n,r){"use strict";var e=r(1),i=r(67),o=r(159),u=r(149),c=1..toFixed,f=Math.floor,a=[0,0,0,0,0,0],s="Number.toFixed: incorrect invocation!",l="0",h=function(t,n){for(var r=-1,e=n;++r<6;)e+=t*a[r],a[r]=e%1e7,e=f(e/1e7)},v=function(t){for(var n=6,r=0;--n>=0;)r+=a[n],a[n]=f(r/t),r=r%t*1e7},p=function(){for(var t=6,n="";--t>=0;)if(""!==n||0===t||0!==a[t]){var r=String(a[t]);n=""===n?r:n+u.call(l,7-r.length)+r}return n},d=function(t,n,r){return 0===n?r:n%2==1?d(t,n-1,r*t):d(t*t,n/2,r)},y=function(t){for(var n=0,r=t;r>=4096;)n+=12,r/=4096;for(;r>=2;)n+=1,r/=2;return n};e(e.P+e.F*(!!c&&("0.000"!==8e-5.toFixed(3)||"1"!==.9.toFixed(0)||"1.25"!==1.255.toFixed(2)||"1000000000000000128"!==(0xde0b6b3a7640080).toFixed(0))||!r(4)(function(){c.call({})})),"Number",{toFixed:function(t){var n,r,e,c,f=o(this,s),a=i(t),g="",b=l;if(a<0||a>20)throw RangeError(s);if(f!=f)return"NaN";if(f<=-1e21||f>=1e21)return String(f);if(f<0&&(g="-",f=-f),f>1e-21)if(n=y(f*d(2,69,1))-69,r=n<0?f*d(2,-n,1):f/d(2,n,1),r*=4503599627370496,(n=52-n)>0){for(h(0,r),e=a;e>=7;)h(1e7,0),e-=7;for(h(d(10,e,1),0),e=n-1;e>=23;)v(1<<23),e-=23;v(1<<e),h(1,1),v(2),b=p()}else h(0,r),h(1<<-n,0),b=p()+u.call(l,a);return a>0?(c=b.length,b=g+(c<=a?"0."+u.call(l,a-c)+b:b.slice(0,c-a)+"."+b.slice(c-a))):b=g+b,b}})},function(t,n,r){"use strict";var e=r(1),i=r(4),o=r(159),u=1..toPrecision;e(e.P+e.F*(i(function(){return"1"!==u.call(1,void 0)})||!i(function(){u.call({})})),"Number",{toPrecision:function(t){var n=o(this,"Number#toPrecision: incorrect invocation!");return void 0===t?u.call(n):u.call(n,t)}})},function(t,n,r){var e=r(1);e(e.S+e.F,"Object",{assign:r(172)})},function(t,n,r){var e=r(1);e(e.S,"Object",{create:r(70)})},function(t,n,r){var e=r(1);e(e.S+e.F*!r(10),"Object",{defineProperties:r(173)})},function(t,n,r){var e=r(1);e(e.S+e.F*!r(10),"Object",{defineProperty:r(11).f})},function(t,n,r){var e=r(6),i=r(65).onFreeze;r(49)("freeze",function(t){return function(n){return t&&e(n)?t(i(n)):n}})},function(t,n,r){var e=r(30),i=r(31).f;r(49)("getOwnPropertyDescriptor",function(){return function(t,n){return i(e(t),n)}})},function(t,n,r){r(49)("getOwnPropertyNames",function(){return r(174).f})},function(t,n,r){var e=r(17),i=r(32);r(49)("getPrototypeOf",function(){return function(t){return i(e(t))}})},function(t,n,r){var e=r(6);r(49)("isExtensible",function(t){return function(n){return!!e(n)&&(!t||t(n))}})},function(t,n,r){var e=r(6);r(49)("isFrozen",function(t){return function(n){return!e(n)||!!t&&t(n)}})},function(t,n,r){var e=r(6);r(49)("isSealed",function(t){return function(n){return!e(n)||!!t&&t(n)}})},function(t,n,r){var e=r(1);e(e.S,"Object",{is:r(180)})},function(t,n,r){var e=r(17),i=r(72);r(49)("keys",function(){return function(t){return i(e(t))}})},function(t,n,r){var e=r(6),i=r(65).onFreeze;r(49)("preventExtensions",function(t){return function(n){return t&&e(n)?t(i(n)):n}})},function(t,n,r){var e=r(6),i=r(65).onFreeze;r(49)("seal",function(t){return function(n){return t&&e(n)?t(i(n)):n}})},function(t,n,r){var e=r(1);e(e.S,"Object",{setPrototypeOf:r(144).set})},function(t,n,r){"use strict";var e=r(114),i={};i[r(7)("toStringTag")]="z",i+""!="[object z]"&&r(28)(Object.prototype,"toString",function(){return"[object "+e(this)+"]"},!0)},function(t,n,r){var e=r(1),i=r(178);e(e.G+e.F*(parseFloat!=i),{parseFloat:i})},function(t,n,r){var e=r(1),i=r(179);e(e.G+e.F*(parseInt!=i),{parseInt:i})},function(t,n,r){"use strict";var e,i,o,u=r(69),c=r(3),f=r(53),a=r(114),s=r(1),l=r(6),h=r(26),v=r(68),p=r(79),d=r(146),y=r(151).set,g=r(143)(),b="Promise",m=c.TypeError,x=c.process,w=c[b],x=c.process,S="process"==a(x),_=function(){},O=!!function(){try{var t=w.resolve(1),n=(t.constructor={})[r(7)("species")]=function(t){t(_,_)};return(S||"function"==typeof PromiseRejectionEvent)&&t.then(_)instanceof n}catch(t){}}(),E=function(t,n){return t===n||t===w&&n===o},P=function(t){var n;return!(!l(t)||"function"!=typeof(n=t.then))&&n},j=function(t){return E(w,t)?new F(t):new i(t)},F=i=function(t){var n,r;this.promise=new t(function(t,e){if(void 0!==n||void 0!==r)throw m("Bad Promise constructor");n=t,r=e}),this.resolve=h(n),this.reject=h(r)},M=function(t){try{t()}catch(t){return{error:t}}},A=function(t,n){if(!t._n){t._n=!0;var r=t._c;g(function(){for(var e=t._v,i=1==t._s,o=0;r.length>o;)!function(n){var r,o,u=i?n.ok:n.fail,c=n.resolve,f=n.reject,a=n.domain;try{u?(i||(2==t._h&&I(t),t._h=1),!0===u?r=e:(a&&a.enter(),r=u(e),a&&a.exit()),r===n.promise?f(m("Promise-chain cycle")):(o=P(r))?o.call(r,c,f):c(r)):f(e)}catch(t){f(t)}}(r[o++]);t._c=[],t._n=!1,n&&!t._h&&N(t)})}},N=function(t){y.call(c,function(){var n,r,e,i=t._v;if(T(t)&&(n=M(function(){S?x.emit("unhandledRejection",i,t):(r=c.onunhandledrejection)?r({promise:t,reason:i}):(e=c.console)&&e.error&&e.error("Unhandled promise rejection",i)}),t._h=S||T(t)?2:1),t._a=void 0,n)throw n.error})},T=function(t){if(1==t._h)return!1;for(var n,r=t._a||t._c,e=0;r.length>e;)if(n=r[e++],n.fail||!T(n.promise))return!1;return!0},I=function(t){y.call(c,function(){var n;S?x.emit("rejectionHandled",t):(n=c.onrejectionhandled)&&n({promise:t,reason:t._v})})},k=function(t){var n=this;n._d||(n._d=!0,n=n._w||n,n._v=t,n._s=2,n._a||(n._a=n._c.slice()),A(n,!0))},L=function(t){var n,r=this;if(!r._d){r._d=!0,r=r._w||r;try{if(r===t)throw m("Promise can't be resolved itself");(n=P(t))?g(function(){var e={_w:r,_d:!1};try{n.call(t,f(L,e,1),f(k,e,1))}catch(t){k.call(e,t)}}):(r._v=t,r._s=1,A(r,!1))}catch(t){k.call({_w:r,_d:!1},t)}}};O||(w=function(t){v(this,w,b,"_h"),h(t),e.call(this);try{t(f(L,this,1),f(k,this,1))}catch(t){k.call(this,t)}},e=function(t){this._c=[],this._a=void 0,this._s=0,this._d=!1,this._v=void 0,this._h=0,this._n=!1},e.prototype=r(73)(w.prototype,{then:function(t,n){var r=j(d(this,w));return r.ok="function"!=typeof t||t,r.fail="function"==typeof n&&n,r.domain=S?x.domain:void 0,this._c.push(r),this._a&&this._a.push(r),this._s&&A(this,!1),r.promise},catch:function(t){return this.then(void 0,t)}}),F=function(){var t=new e;this.promise=t,this.resolve=f(L,t,1),this.reject=f(k,t,1)}),s(s.G+s.W+s.F*!O,{Promise:w}),r(81)(w,b),r(74)(b),o=r(52)[b],s(s.S+s.F*!O,b,{reject:function(t){var n=j(this);return(0,n.reject)(t),n.promise}}),s(s.S+s.F*(u||!O),b,{resolve:function(t){if(t instanceof w&&E(t.constructor,this))return t;var n=j(this);return(0,n.resolve)(t),n.promise}}),s(s.S+s.F*!(O&&r(123)(function(t){w.all(t).catch(_)})),b,{all:function(t){var n=this,r=j(n),e=r.resolve,i=r.reject,o=M(function(){var r=[],o=0,u=1;p(t,!1,function(t){var c=o++,f=!1;r.push(void 0),u++,n.resolve(t).then(function(t){f||(f=!0,r[c]=t,--u||e(r))},i)}),--u||e(r)});return o&&i(o.error),r.promise},race:function(t){var n=this,r=j(n),e=r.reject,i=M(function(){p(t,!1,function(t){n.resolve(t).then(r.resolve,e)})});return i&&e(i.error),r.promise}})},function(t,n,r){var e=r(1),i=r(26),o=r(2),u=(r(3).Reflect||{}).apply,c=Function.apply;e(e.S+e.F*!r(4)(function(){u(function(){})}),"Reflect",{apply:function(t,n,r){var e=i(t),f=o(r);return u?u(e,n,f):c.call(e,n,f)}})},function(t,n,r){var e=r(1),i=r(70),o=r(26),u=r(2),c=r(6),f=r(4),a=r(163),s=(r(3).Reflect||{}).construct,l=f(function(){function t(){}return!(s(function(){},[],t)instanceof t)}),h=!f(function(){s(function(){})});e(e.S+e.F*(l||h),"Reflect",{construct:function(t,n){o(t),u(n);var r=arguments.length<3?t:o(arguments[2]);if(h&&!l)return s(t,n,r);if(t==r){switch(n.length){case 0:return new t;case 1:return new t(n[0]);case 2:return new t(n[0],n[1]);case 3:return new t(n[0],n[1],n[2]);case 4:return new t(n[0],n[1],n[2],n[3])}var e=[null];return e.push.apply(e,n),new(a.apply(t,e))}var f=r.prototype,v=i(c(f)?f:Object.prototype),p=Function.apply.call(t,v,n);return c(p)?p:v}})},function(t,n,r){var e=r(11),i=r(1),o=r(2),u=r(50);i(i.S+i.F*r(4)(function(){Reflect.defineProperty(e.f({},1,{value:1}),1,{value:2})}),"Reflect",{defineProperty:function(t,n,r){o(t),n=u(n,!0),o(r);try{return e.f(t,n,r),!0}catch(t){return!1}}})},function(t,n,r){var e=r(1),i=r(31).f,o=r(2);e(e.S,"Reflect",{deleteProperty:function(t,n){var r=i(o(t),n);return!(r&&!r.configurable)&&delete t[n]}})},function(t,n,r){"use strict";var e=r(1),i=r(2),o=function(t){this._t=i(t),this._i=0;var n,r=this._k=[];for(n in t)r.push(n)};r(139)(o,"Object",function(){var t,n=this,r=n._k;do{if(n._i>=r.length)return{value:void 0,done:!0}}while(!((t=r[n._i++])in n._t));return{value:t,done:!1}}),e(e.S,"Reflect",{enumerate:function(t){return new o(t)}})},function(t,n,r){var e=r(31),i=r(1),o=r(2);i(i.S,"Reflect",{getOwnPropertyDescriptor:function(t,n){return e.f(o(t),n)}})},function(t,n,r){var e=r(1),i=r(32),o=r(2);e(e.S,"Reflect",{getPrototypeOf:function(t){return i(o(t))}})},function(t,n,r){function e(t,n){var r,c,s=arguments.length<3?t:arguments[2];return a(t)===s?t[n]:(r=i.f(t,n))?u(r,"value")?r.value:void 0!==r.get?r.get.call(s):void 0:f(c=o(t))?e(c,n,s):void 0}var i=r(31),o=r(32),u=r(24),c=r(1),f=r(6),a=r(2);c(c.S,"Reflect",{get:e})},function(t,n,r){var e=r(1);e(e.S,"Reflect",{has:function(t,n){return n in t}})},function(t,n,r){var e=r(1),i=r(2),o=Object.isExtensible;e(e.S,"Reflect",{isExtensible:function(t){return i(t),!o||o(t)}})},function(t,n,r){var e=r(1);e(e.S,"Reflect",{ownKeys:r(177)})},function(t,n,r){var e=r(1),i=r(2),o=Object.preventExtensions;e(e.S,"Reflect",{preventExtensions:function(t){i(t);try{return o&&o(t),!0}catch(t){return!1}}})},function(t,n,r){var e=r(1),i=r(144);i&&e(e.S,"Reflect",{setPrototypeOf:function(t,n){i.check(t,n);try{return i.set(t,n),!0}catch(t){return!1}}})},function(t,n,r){function e(t,n,r){var f,h,v=arguments.length<4?t:arguments[3],p=o.f(s(t),n);if(!p){if(l(h=u(t)))return e(h,n,r,v);p=a(0)}return c(p,"value")?!(!1===p.writable||!l(v)||(f=o.f(v,n)||a(0),f.value=r,i.f(v,n,f),0)):void 0!==p.set&&(p.set.call(v,r),!0)}var i=r(11),o=r(31),u=r(32),c=r(24),f=r(1),a=r(66),s=r(2),l=r(6);f(f.S,"Reflect",{set:e})},function(t,n,r){var e=r(3),i=r(136),o=r(11).f,u=r(71).f,c=r(122),f=r(120),a=e.RegExp,s=a,l=a.prototype,h=/a/g,v=/a/g,p=new a(h)!==h;if(r(10)&&(!p||r(4)(function(){return v[r(7)("match")]=!1,a(h)!=h||a(v)==v||"/a/i"!=a(h,"i")}))){a=function(t,n){var r=this instanceof a,e=c(t),o=void 0===n;return!r&&e&&t.constructor===a&&o?t:i(p?new s(e&&!o?t.source:t,n):s((e=t instanceof a)?t.source:t,e&&o?f.call(t):n),r?this:l,a)};for(var d=u(s),y=0;d.length>y;)!function(t){t in a||o(a,t,{configurable:!0,get:function(){return s[t]},set:function(n){s[t]=n}})}(d[y++]);l.constructor=a,a.prototype=l,r(28)(e,"RegExp",a)}r(74)("RegExp")},function(t,n,r){r(119)("match",1,function(t,n,r){return[function(r){"use strict";var e=t(this),i=void 0==r?void 0:r[n];return void 0!==i?i.call(r,e):new RegExp(r)[n](String(e))},r]})},function(t,n,r){r(119)("replace",2,function(t,n,r){return[function(e,i){"use strict";var o=t(this),u=void 0==e?void 0:e[n];return void 0!==u?u.call(e,o,i):r.call(String(o),e,i)},r]})},function(t,n,r){r(119)("search",1,function(t,n,r){return[function(r){"use strict";var e=t(this),i=void 0==r?void 0:r[n];return void 0!==i?i.call(r,e):new RegExp(r)[n](String(e))},r]})},function(t,n,r){r(119)("split",2,function(t,n,e){"use strict";var i=r(122),o=e,u=[].push,c="split",f="length",a="lastIndex";if("c"=="abbc"[c](/(b)*/)[1]||4!="test"[c](/(?:)/,-1)[f]||2!="ab"[c](/(?:ab)*/)[f]||4!="."[c](/(.?)(.?)/)[f]||"."[c](/()()/)[f]>1||""[c](/.?/)[f]){var s=void 0===/()??/.exec("")[1];e=function(t,n){var r=String(this);if(void 0===t&&0===n)return[];if(!i(t))return o.call(r,t,n);var e,c,l,h,v,p=[],d=(t.ignoreCase?"i":"")+(t.multiline?"m":"")+(t.unicode?"u":"")+(t.sticky?"y":""),y=0,g=void 0===n?4294967295:n>>>0,b=new RegExp(t.source,d+"g");for(s||(e=new RegExp("^"+b.source+"$(?!\\s)",d));(c=b.exec(r))&&!((l=c.index+c[0][f])>y&&(p.push(r.slice(y,c.index)),!s&&c[f]>1&&c[0].replace(e,function(){for(v=1;v<arguments[f]-2;v++)void 0===arguments[v]&&(c[v]=void 0)}),c[f]>1&&c.index<r[f]&&u.apply(p,c.slice(1)),h=c[0][f],y=l,p[f]>=g));)b[a]===c.index&&b[a]++;return y===r[f]?!h&&b.test("")||p.push(""):p.push(r.slice(y)),p[f]>g?p.slice(0,g):p}}else"0"[c](void 0,0)[f]&&(e=function(t,n){return void 0===t&&0===n?[]:o.call(this,t,n)});return[function(r,i){var o=t(this),u=void 0==r?void 0:r[n];return void 0!==u?u.call(r,o,i):e.call(String(o),r,i)},e]})},function(t,n,r){"use strict";r(184);var e=r(2),i=r(120),o=r(10),u="toString",c=/./[u],f=function(t){r(28)(RegExp.prototype,u,t,!0)};r(4)(function(){return"/a/b"!=c.call({source:"a",flags:"b"})})?f(function(){var t=e(this);return"/".concat(t.source,"/","flags"in t?t.flags:!o&&t instanceof RegExp?i.call(t):void 0)}):c.name!=u&&f(function(){return c.call(this)})},function(t,n,r){"use strict";r(29)("anchor",function(t){return function(n){return t(this,"a","name",n)}})},function(t,n,r){"use strict";r(29)("big",function(t){return function(){return t(this,"big","","")}})},function(t,n,r){"use strict";r(29)("blink",function(t){return function(){return t(this,"blink","","")}})},function(t,n,r){"use strict";r(29)("bold",function(t){return function(){return t(this,"b","","")}})},function(t,n,r){"use strict";var e=r(1),i=r(147)(!1);e(e.P,"String",{codePointAt:function(t){return i(this,t)}})},function(t,n,r){"use strict";var e=r(1),i=r(16),o=r(148),u="endsWith",c=""[u];e(e.P+e.F*r(134)(u),"String",{endsWith:function(t){var n=o(this,t,u),r=arguments.length>1?arguments[1]:void 0,e=i(n.length),f=void 0===r?e:Math.min(i(r),e),a=String(t);return c?c.call(n,a,f):n.slice(f-a.length,f)===a}})},function(t,n,r){"use strict";r(29)("fixed",function(t){return function(){return t(this,"tt","","")}})},function(t,n,r){"use strict";r(29)("fontcolor",function(t){return function(n){return t(this,"font","color",n)}})},function(t,n,r){"use strict";r(29)("fontsize",function(t){return function(n){return t(this,"font","size",n)}})},function(t,n,r){var e=r(1),i=r(75),o=String.fromCharCode,u=String.fromCodePoint;e(e.S+e.F*(!!u&&1!=u.length),"String",{fromCodePoint:function(t){for(var n,r=[],e=arguments.length,u=0;e>u;){if(n=+arguments[u++],i(n,1114111)!==n)throw RangeError(n+" is not a valid code point");r.push(n<65536?o(n):o(55296+((n-=65536)>>10),n%1024+56320))}return r.join("")}})},function(t,n,r){"use strict";var e=r(1),i=r(148),o="includes";e(e.P+e.F*r(134)(o),"String",{includes:function(t){return!!~i(this,t,o).indexOf(t,arguments.length>1?arguments[1]:void 0)}})},function(t,n,r){"use strict";r(29)("italics",function(t){return function(){return t(this,"i","","")}})},function(t,n,r){"use strict";var e=r(147)(!0);r(140)(String,"String",function(t){this._t=String(t),this._i=0},function(){var t,n=this._t,r=this._i;return r>=n.length?{value:void 0,done:!0}:(t=e(n,r),this._i+=t.length,{value:t,done:!1})})},function(t,n,r){"use strict";r(29)("link",function(t){return function(n){return t(this,"a","href",n)}})},function(t,n,r){var e=r(1),i=r(30),o=r(16);e(e.S,"String",{raw:function(t){for(var n=i(t.raw),r=o(n.length),e=arguments.length,u=[],c=0;r>c;)u.push(String(n[c++])),c<e&&u.push(String(arguments[c]));return u.join("")}})},function(t,n,r){var e=r(1);e(e.P,"String",{repeat:r(149)})},function(t,n,r){"use strict";r(29)("small",function(t){return function(){return t(this,"small","","")}})},function(t,n,r){"use strict";var e=r(1),i=r(16),o=r(148),u="startsWith",c=""[u];e(e.P+e.F*r(134)(u),"String",{startsWith:function(t){var n=o(this,t,u),r=i(Math.min(arguments.length>1?arguments[1]:void 0,n.length)),e=String(t);return c?c.call(n,e,r):n.slice(r,r+e.length)===e}})},function(t,n,r){"use strict";r(29)("strike",function(t){return function(){return t(this,"strike","","")}})},function(t,n,r){"use strict";r(29)("sub",function(t){return function(){return t(this,"sub","","")}})},function(t,n,r){"use strict";r(29)("sup",function(t){return function(){return t(this,"sup","","")}})},function(t,n,r){"use strict";r(82)("trim",function(t){return function(){return t(this,3)}})},function(t,n,r){"use strict";var e=r(3),i=r(24),o=r(10),u=r(1),c=r(28),f=r(65).KEY,a=r(4),s=r(126),l=r(81),h=r(76),v=r(7),p=r(182),d=r(153),y=r(206),g=r(205),b=r(138),m=r(2),x=r(30),w=r(50),S=r(66),_=r(70),O=r(174),E=r(31),P=r(11),j=r(72),F=E.f,M=P.f,A=O.f,N=e.Symbol,T=e.JSON,I=T&&T.stringify,k="prototype",L=v("_hidden"),R=v("toPrimitive"),C={}.propertyIsEnumerable,D=s("symbol-registry"),U=s("symbols"),W=s("op-symbols"),G=Object[k],B="function"==typeof N,V=e.QObject,z=!V||!V[k]||!V[k].findChild,q=o&&a(function(){return 7!=_(M({},"a",{get:function(){return M(this,"a",{value:7}).a}})).a})?function(t,n,r){var e=F(G,n);e&&delete G[n],M(t,n,r),e&&t!==G&&M(G,n,e)}:M,K=function(t){var n=U[t]=_(N[k]);return n._k=t,n},J=B&&"symbol"==typeof N.iterator?function(t){return"symbol"==typeof t}:function(t){return t instanceof N},Y=function(t,n,r){return t===G&&Y(W,n,r),m(t),n=w(n,!0),m(r),i(U,n)?(r.enumerable?(i(t,L)&&t[L][n]&&(t[L][n]=!1),r=_(r,{enumerable:S(0,!1)})):(i(t,L)||M(t,L,S(1,{})),t[L][n]=!0),q(t,n,r)):M(t,n,r)},H=function(t,n){m(t);for(var r,e=g(n=x(n)),i=0,o=e.length;o>i;)Y(t,r=e[i++],n[r]);return t},$=function(t,n){return void 0===n?_(t):H(_(t),n)},X=function(t){var n=C.call(this,t=w(t,!0));return!(this===G&&i(U,t)&&!i(W,t))&&(!(n||!i(this,t)||!i(U,t)||i(this,L)&&this[L][t])||n)},Q=function(t,n){if(t=x(t),n=w(n,!0),t!==G||!i(U,n)||i(W,n)){var r=F(t,n);return!r||!i(U,n)||i(t,L)&&t[L][n]||(r.enumerable=!0),r}},Z=function(t){for(var n,r=A(x(t)),e=[],o=0;r.length>o;)i(U,n=r[o++])||n==L||n==f||e.push(n);return e},tt=function(t){for(var n,r=t===G,e=A(r?W:x(t)),o=[],u=0;e.length>u;)!i(U,n=e[u++])||r&&!i(G,n)||o.push(U[n]);return o};B||(N=function(){if(this instanceof N)throw TypeError("Symbol is not a constructor!");var t=h(arguments.length>0?arguments[0]:void 0),n=function(r){this===G&&n.call(W,r),i(this,L)&&i(this[L],t)&&(this[L][t]=!1),q(this,t,S(1,r))};return o&&z&&q(G,t,{configurable:!0,set:n}),K(t)},c(N[k],"toString",function(){return this._k}),E.f=Q,P.f=Y,r(71).f=O.f=Z,r(116).f=X,r(125).f=tt,o&&!r(69)&&c(G,"propertyIsEnumerable",X,!0),p.f=function(t){return K(v(t))}),u(u.G+u.W+u.F*!B,{Symbol:N});for(var nt="hasInstance,isConcatSpreadable,iterator,match,replace,search,species,split,toPrimitive,toStringTag,unscopables".split(","),rt=0;nt.length>rt;)v(nt[rt++]);for(var nt=j(v.store),rt=0;nt.length>rt;)d(nt[rt++]);u(u.S+u.F*!B,"Symbol",{for:function(t){return i(D,t+="")?D[t]:D[t]=N(t)},keyFor:function(t){if(J(t))return y(D,t);throw TypeError(t+" is not a symbol!")},useSetter:function(){z=!0},useSimple:function(){z=!1}}),u(u.S+u.F*!B,"Object",{create:$,defineProperty:Y,defineProperties:H,getOwnPropertyDescriptor:Q,getOwnPropertyNames:Z,getOwnPropertySymbols:tt}),T&&u(u.S+u.F*(!B||a(function(){var t=N();return"[null]"!=I([t])||"{}"!=I({a:t})||"{}"!=I(Object(t))})),"JSON",{stringify:function(t){if(void 0!==t&&!J(t)){for(var n,r,e=[t],i=1;arguments.length>i;)e.push(arguments[i++]);return n=e[1],"function"==typeof n&&(r=n),!r&&b(n)||(n=function(t,n){if(r&&(n=r.call(this,t,n)),!J(n))return n}),e[1]=n,I.apply(T,e)}}}),N[k][R]||r(27)(N[k],R,N[k].valueOf),l(N,"Symbol"),l(Math,"Math",!0),l(e.JSON,"JSON",!0)},function(t,n,r){"use strict";var e=r(1),i=r(127),o=r(152),u=r(2),c=r(75),f=r(16),a=r(6),s=r(3).ArrayBuffer,l=r(146),h=o.ArrayBuffer,v=o.DataView,p=i.ABV&&s.isView,d=h.prototype.slice,y=i.VIEW,g="ArrayBuffer";e(e.G+e.W+e.F*(s!==h),{ArrayBuffer:h}),e(e.S+e.F*!i.CONSTR,g,{isView:function(t){return p&&p(t)||a(t)&&y in t}}),e(e.P+e.U+e.F*r(4)(function(){return!new h(2).slice(1,void 0).byteLength}),g,{slice:function(t,n){if(void 0!==d&&void 0===n)return d.call(u(this),t);for(var r=u(this).byteLength,e=c(t,r),i=c(void 0===n?r:n,r),o=new(l(this,h))(f(i-e)),a=new v(this),s=new v(o),p=0;e<i;)s.setUint8(p++,a.getUint8(e++));return o}}),r(74)(g)},function(t,n,r){var e=r(1);e(e.G+e.W+e.F*!r(127).ABV,{DataView:r(152).DataView})},function(t,n,r){r(55)("Float32",4,function(t){return function(n,r,e){return t(this,n,r,e)}})},function(t,n,r){r(55)("Float64",8,function(t){return function(n,r,e){return t(this,n,r,e)}})},function(t,n,r){r(55)("Int16",2,function(t){return function(n,r,e){return t(this,n,r,e)}})},function(t,n,r){r(55)("Int32",4,function(t){return function(n,r,e){return t(this,n,r,e)}})},function(t,n,r){r(55)("Int8",1,function(t){return function(n,r,e){return t(this,n,r,e)}})},function(t,n,r){r(55)("Uint16",2,function(t){return function(n,r,e){return t(this,n,r,e)}})},function(t,n,r){r(55)("Uint32",4,function(t){return function(n,r,e){return t(this,n,r,e)}})},function(t,n,r){r(55)("Uint8",1,function(t){return function(n,r,e){return t(this,n,r,e)}})},function(t,n,r){r(55)("Uint8",1,function(t){return function(n,r,e){return t(this,n,r,e)}},!0)},function(t,n,r){"use strict";var e=r(166);r(118)("WeakSet",function(t){return function(){return t(this,arguments.length>0?arguments[0]:void 0)}},{add:function(t){return e.def(this,t,!0)}},e,!1,!0)},function(t,n,r){"use strict";var e=r(1),i=r(117)(!0);e(e.P,"Array",{includes:function(t){return i(this,t,arguments.length>1?arguments[1]:void 0)}}),r(78)("includes")},function(t,n,r){var e=r(1),i=r(143)(),o=r(3).process,u="process"==r(45)(o);e(e.G,{asap:function(t){var n=u&&o.domain;i(n?n.bind(t):t)}})},function(t,n,r){var e=r(1),i=r(45);e(e.S,"Error",{isError:function(t){return"Error"===i(t)}})},function(t,n,r){var e=r(1);e(e.P+e.R,"Map",{toJSON:r(165)("Map")})},function(t,n,r){var e=r(1);e(e.S,"Math",{iaddh:function(t,n,r,e){var i=t>>>0,o=n>>>0,u=r>>>0;return o+(e>>>0)+((i&u|(i|u)&~(i+u>>>0))>>>31)|0}})},function(t,n,r){var e=r(1);e(e.S,"Math",{imulh:function(t,n){var r=65535,e=+t,i=+n,o=e&r,u=i&r,c=e>>16,f=i>>16,a=(c*u>>>0)+(o*u>>>16);return c*f+(a>>16)+((o*f>>>0)+(a&r)>>16)}})},function(t,n,r){var e=r(1);e(e.S,"Math",{isubh:function(t,n,r,e){var i=t>>>0,o=n>>>0,u=r>>>0;return o-(e>>>0)-((~i&u|~(i^u)&i-u>>>0)>>>31)|0}})},function(t,n,r){var e=r(1);e(e.S,"Math",{umulh:function(t,n){var r=65535,e=+t,i=+n,o=e&r,u=i&r,c=e>>>16,f=i>>>16,a=(c*u>>>0)+(o*u>>>16);return c*f+(a>>>16)+((o*f>>>0)+(a&r)>>>16)}})},function(t,n,r){"use strict";var e=r(1),i=r(17),o=r(26),u=r(11);r(10)&&e(e.P+r(124),"Object",{__defineGetter__:function(t,n){u.f(i(this),t,{get:o(n),enumerable:!0,configurable:!0})}})},function(t,n,r){"use strict";var e=r(1),i=r(17),o=r(26),u=r(11);r(10)&&e(e.P+r(124),"Object",{__defineSetter__:function(t,n){u.f(i(this),t,{set:o(n),enumerable:!0,configurable:!0})}})},function(t,n,r){var e=r(1),i=r(176)(!0);e(e.S,"Object",{entries:function(t){return i(t)}})},function(t,n,r){var e=r(1),i=r(177),o=r(30),u=r(31),c=r(131);e(e.S,"Object",{getOwnPropertyDescriptors:function(t){for(var n,r=o(t),e=u.f,f=i(r),a={},s=0;f.length>s;)c(a,n=f[s++],e(r,n));return a}})},function(t,n,r){"use strict";var e=r(1),i=r(17),o=r(50),u=r(32),c=r(31).f;r(10)&&e(e.P+r(124),"Object",{__lookupGetter__:function(t){var n,r=i(this),e=o(t,!0);do{if(n=c(r,e))return n.get}while(r=u(r))}})},function(t,n,r){"use strict";var e=r(1),i=r(17),o=r(50),u=r(32),c=r(31).f;r(10)&&e(e.P+r(124),"Object",{__lookupSetter__:function(t){var n,r=i(this),e=o(t,!0);do{if(n=c(r,e))return n.set}while(r=u(r))}})},function(t,n,r){var e=r(1),i=r(176)(!1);e(e.S,"Object",{values:function(t){return i(t)}})},function(t,n,r){"use strict";var e=r(1),i=r(3),o=r(52),u=r(143)(),c=r(7)("observable"),f=r(26),a=r(2),s=r(68),l=r(73),h=r(27),v=r(79),p=v.RETURN,d=function(t){return null==t?void 0:f(t)},y=function(t){var n=t._c;n&&(t._c=void 0,n())},g=function(t){return void 0===t._o},b=function(t){g(t)||(t._o=void 0,y(t))},m=function(t,n){a(t),this._c=void 0,this._o=t,t=new x(this);try{var r=n(t),e=r;null!=r&&("function"==typeof r.unsubscribe?r=function(){e.unsubscribe()}:f(r),this._c=r)}catch(n){return void t.error(n)}g(this)&&y(this)};m.prototype=l({},{unsubscribe:function(){b(this)}});var x=function(t){this._s=t};x.prototype=l({},{next:function(t){var n=this._s;if(!g(n)){var r=n._o;try{var e=d(r.next);if(e)return e.call(r,t)}catch(t){try{b(n)}finally{throw t}}}},error:function(t){var n=this._s;if(g(n))throw t;var r=n._o;n._o=void 0;try{var e=d(r.error);if(!e)throw t;t=e.call(r,t)}catch(t){try{y(n)}finally{throw t}}return y(n),t},complete:function(t){var n=this._s;if(!g(n)){var r=n._o;n._o=void 0;try{var e=d(r.complete);t=e?e.call(r,t):void 0}catch(t){try{y(n)}finally{throw t}}return y(n),t}}});var w=function(t){s(this,w,"Observable","_f")._f=f(t)};l(w.prototype,{subscribe:function(t){return new m(t,this._f)},forEach:function(t){var n=this;return new(o.Promise||i.Promise)(function(r,e){f(t);var i=n.subscribe({next:function(n){try{return t(n)}catch(t){e(t),i.unsubscribe()}},error:e,complete:r})})}}),l(w,{from:function(t){var n="function"==typeof this?this:w,r=d(a(t)[c]);if(r){var e=a(r.call(t));return e.constructor===n?e:new n(function(t){return e.subscribe(t)})}return new n(function(n){var r=!1;return u(function(){if(!r){try{if(v(t,!1,function(t){if(n.next(t),r)return p})===p)return}catch(t){if(r)throw t;return void n.error(t)}n.complete()}}),function(){r=!0}})},of:function(){for(var t=0,n=arguments.length,r=Array(n);t<n;)r[t]=arguments[t++];return new("function"==typeof this?this:w)(function(t){var n=!1;return u(function(){if(!n){for(var e=0;e<r.length;++e)if(t.next(r[e]),n)return;t.complete()}}),function(){n=!0}})}}),h(w.prototype,c,function(){return this}),e(e.G,{Observable:w}),r(74)("Observable")},function(t,n,r){var e=r(54),i=r(2),o=e.key,u=e.set;e.exp({defineMetadata:function(t,n,r,e){u(t,n,i(r),o(e))}})},function(t,n,r){var e=r(54),i=r(2),o=e.key,u=e.map,c=e.store;e.exp({deleteMetadata:function(t,n){var r=arguments.length<3?void 0:o(arguments[2]),e=u(i(n),r,!1);if(void 0===e||!e.delete(t))return!1;if(e.size)return!0;var f=c.get(n);return f.delete(r),!!f.size||c.delete(n)}})},function(t,n,r){var e=r(185),i=r(161),o=r(54),u=r(2),c=r(32),f=o.keys,a=o.key,s=function(t,n){var r=f(t,n),o=c(t);if(null===o)return r;var u=s(o,n);return u.length?r.length?i(new e(r.concat(u))):u:r};o.exp({getMetadataKeys:function(t){return s(u(t),arguments.length<2?void 0:a(arguments[1]))}})},function(t,n,r){var e=r(54),i=r(2),o=r(32),u=e.has,c=e.get,f=e.key,a=function(t,n,r){if(u(t,n,r))return c(t,n,r);var e=o(n);return null!==e?a(t,e,r):void 0};e.exp({getMetadata:function(t,n){return a(t,i(n),arguments.length<3?void 0:f(arguments[2]))}})},function(t,n,r){var e=r(54),i=r(2),o=e.keys,u=e.key;e.exp({getOwnMetadataKeys:function(t){
return o(i(t),arguments.length<2?void 0:u(arguments[1]))}})},function(t,n,r){var e=r(54),i=r(2),o=e.get,u=e.key;e.exp({getOwnMetadata:function(t,n){return o(t,i(n),arguments.length<3?void 0:u(arguments[2]))}})},function(t,n,r){var e=r(54),i=r(2),o=r(32),u=e.has,c=e.key,f=function(t,n,r){if(u(t,n,r))return!0;var e=o(n);return null!==e&&f(t,e,r)};e.exp({hasMetadata:function(t,n){return f(t,i(n),arguments.length<3?void 0:c(arguments[2]))}})},function(t,n,r){var e=r(54),i=r(2),o=e.has,u=e.key;e.exp({hasOwnMetadata:function(t,n){return o(t,i(n),arguments.length<3?void 0:u(arguments[2]))}})},function(t,n,r){var e=r(54),i=r(2),o=r(26),u=e.key,c=e.set;e.exp({metadata:function(t,n){return function(r,e){c(t,n,(void 0!==e?i:o)(r),u(e))}}})},function(t,n,r){var e=r(1);e(e.P+e.R,"Set",{toJSON:r(165)("Set")})},function(t,n,r){"use strict";var e=r(1),i=r(147)(!0);e(e.P,"String",{at:function(t){return i(this,t)}})},function(t,n,r){"use strict";var e=r(1),i=r(46),o=r(16),u=r(122),c=r(120),f=RegExp.prototype,a=function(t,n){this._r=t,this._s=n};r(139)(a,"RegExp String",function(){var t=this._r.exec(this._s);return{value:t,done:null===t}}),e(e.P,"String",{matchAll:function(t){if(i(this),!u(t))throw TypeError(t+" is not a regexp!");var n=String(this),r="flags"in f?String(t.flags):c.call(t),e=new RegExp(t.source,~r.indexOf("g")?r:"g"+r);return e.lastIndex=o(t.lastIndex),new a(e,n)}})},function(t,n,r){"use strict";var e=r(1),i=r(181);e(e.P,"String",{padEnd:function(t){return i(this,t,arguments.length>1?arguments[1]:void 0,!1)}})},function(t,n,r){"use strict";var e=r(1),i=r(181);e(e.P,"String",{padStart:function(t){return i(this,t,arguments.length>1?arguments[1]:void 0,!0)}})},function(t,n,r){"use strict";r(82)("trimLeft",function(t){return function(){return t(this,1)}},"trimStart")},function(t,n,r){"use strict";r(82)("trimRight",function(t){return function(){return t(this,2)}},"trimEnd")},function(t,n,r){r(153)("asyncIterator")},function(t,n,r){r(153)("observable")},function(t,n,r){var e=r(1);e(e.S,"System",{global:r(3)})},function(t,n,r){for(var e=r(155),i=r(28),o=r(3),u=r(27),c=r(80),f=r(7),a=f("iterator"),s=f("toStringTag"),l=c.Array,h=["NodeList","DOMTokenList","MediaList","StyleSheetList","CSSRuleList"],v=0;v<5;v++){var p,d=h[v],y=o[d],g=y&&y.prototype;if(g){g[a]||u(g,a,l),g[s]||u(g,s,d),c[d]=l;for(p in e)g[p]||i(g,p,e[p],!0)}}},function(t,n,r){var e=r(1),i=r(151);e(e.G+e.B,{setImmediate:i.set,clearImmediate:i.clear})},function(t,n,r){var e=r(3),i=r(1),o=r(121),u=r(207),c=e.navigator,f=!!c&&/MSIE .\./.test(c.userAgent),a=function(t){return f?function(n,r){return t(o(u,[].slice.call(arguments,2),"function"==typeof n?n:Function(n)),r)}:t};i(i.G+i.B+i.F*f,{setTimeout:a(e.setTimeout),setInterval:a(e.setInterval)})},function(t,n,r){r(330),r(269),r(271),r(270),r(273),r(275),r(280),r(274),r(272),r(282),r(281),r(277),r(278),r(276),r(268),r(279),r(283),r(284),r(236),r(238),r(237),r(286),r(285),r(256),r(266),r(267),r(257),r(258),r(259),r(260),r(261),r(262),r(263),r(264),r(265),r(239),r(240),r(241),r(242),r(243),r(244),r(245),r(246),r(247),r(248),r(249),r(250),r(251),r(252),r(253),r(254),r(255),r(317),r(322),r(329),r(320),r(312),r(313),r(318),r(323),r(325),r(308),r(309),r(310),r(311),r(314),r(315),r(316),r(319),r(321),r(324),r(326),r(327),r(328),r(231),r(233),r(232),r(235),r(234),r(220),r(218),r(224),r(221),r(227),r(229),r(217),r(223),r(214),r(228),r(212),r(226),r(225),r(219),r(222),r(211),r(213),r(216),r(215),r(230),r(155),r(302),r(307),r(184),r(303),r(304),r(305),r(306),r(287),r(183),r(185),r(186),r(342),r(331),r(332),r(337),r(340),r(341),r(335),r(338),r(336),r(339),r(333),r(334),r(288),r(289),r(290),r(291),r(292),r(295),r(293),r(294),r(296),r(297),r(298),r(299),r(301),r(300),r(343),r(369),r(372),r(371),r(373),r(374),r(370),r(375),r(376),r(354),r(357),r(353),r(351),r(352),r(355),r(356),r(346),r(368),r(377),r(345),r(347),r(349),r(348),r(350),r(359),r(360),r(362),r(361),r(364),r(363),r(365),r(366),r(367),r(344),r(358),r(380),r(379),r(378),t.exports=r(52)},function(t,n){function r(t,n){if("string"==typeof n)return t.insertAdjacentHTML("afterend",n);var r=t.nextSibling;return r?t.parentNode.insertBefore(n,r):t.parentNode.appendChild(n)}t.exports=r},,,,,,,,,function(t,n,r){(function(n,r){!function(n){"use strict";function e(t,n,r,e){var i=n&&n.prototype instanceof o?n:o,u=Object.create(i.prototype),c=new p(e||[]);return u._invoke=s(t,r,c),u}function i(t,n,r){try{return{type:"normal",arg:t.call(n,r)}}catch(t){return{type:"throw",arg:t}}}function o(){}function u(){}function c(){}function f(t){["next","throw","return"].forEach(function(n){t[n]=function(t){return this._invoke(n,t)}})}function a(t){function n(r,e,o,u){var c=i(t[r],t,e);if("throw"!==c.type){var f=c.arg,a=f.value;return a&&"object"==typeof a&&m.call(a,"__await")?Promise.resolve(a.__await).then(function(t){n("next",t,o,u)},function(t){n("throw",t,o,u)}):Promise.resolve(a).then(function(t){f.value=t,o(f)},u)}u(c.arg)}function e(t,r){function e(){return new Promise(function(e,i){n(t,r,e,i)})}return o=o?o.then(e,e):e()}"object"==typeof r&&r.domain&&(n=r.domain.bind(n));var o;this._invoke=e}function s(t,n,r){var e=P;return function(o,u){if(e===F)throw new Error("Generator is already running");if(e===M){if("throw"===o)throw u;return y()}for(r.method=o,r.arg=u;;){var c=r.delegate;if(c){var f=l(c,r);if(f){if(f===A)continue;return f}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(e===P)throw e=M,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);e=F;var a=i(t,n,r);if("normal"===a.type){if(e=r.done?M:j,a.arg===A)continue;return{value:a.arg,done:r.done}}"throw"===a.type&&(e=M,r.method="throw",r.arg=a.arg)}}}function l(t,n){var r=t.iterator[n.method];if(r===g){if(n.delegate=null,"throw"===n.method){if(t.iterator.return&&(n.method="return",n.arg=g,l(t,n),"throw"===n.method))return A;n.method="throw",n.arg=new TypeError("The iterator does not provide a 'throw' method")}return A}var e=i(r,t.iterator,n.arg);if("throw"===e.type)return n.method="throw",n.arg=e.arg,n.delegate=null,A;var o=e.arg;return o?o.done?(n[t.resultName]=o.value,n.next=t.nextLoc,"return"!==n.method&&(n.method="next",n.arg=g),n.delegate=null,A):o:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,A)}function h(t){var n={tryLoc:t[0]};1 in t&&(n.catchLoc=t[1]),2 in t&&(n.finallyLoc=t[2],n.afterLoc=t[3]),this.tryEntries.push(n)}function v(t){var n=t.completion||{};n.type="normal",delete n.arg,t.completion=n}function p(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(h,this),this.reset(!0)}function d(t){if(t){var n=t[w];if(n)return n.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var r=-1,e=function n(){for(;++r<t.length;)if(m.call(t,r))return n.value=t[r],n.done=!1,n;return n.value=g,n.done=!0,n};return e.next=e}}return{next:y}}function y(){return{value:g,done:!0}}var g,b=Object.prototype,m=b.hasOwnProperty,x="function"==typeof Symbol?Symbol:{},w=x.iterator||"@@iterator",S=x.asyncIterator||"@@asyncIterator",_=x.toStringTag||"@@toStringTag",O="object"==typeof t,E=n.regeneratorRuntime;if(E)return void(O&&(t.exports=E));E=n.regeneratorRuntime=O?t.exports:{},E.wrap=e;var P="suspendedStart",j="suspendedYield",F="executing",M="completed",A={},N={};N[w]=function(){return this};var T=Object.getPrototypeOf,I=T&&T(T(d([])));I&&I!==b&&m.call(I,w)&&(N=I);var k=c.prototype=o.prototype=Object.create(N);u.prototype=k.constructor=c,c.constructor=u,c[_]=u.displayName="GeneratorFunction",E.isGeneratorFunction=function(t){var n="function"==typeof t&&t.constructor;return!!n&&(n===u||"GeneratorFunction"===(n.displayName||n.name))},E.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,c):(t.__proto__=c,_ in t||(t[_]="GeneratorFunction")),t.prototype=Object.create(k),t},E.awrap=function(t){return{__await:t}},f(a.prototype),a.prototype[S]=function(){return this},E.AsyncIterator=a,E.async=function(t,n,r,i){var o=new a(e(t,n,r,i));return E.isGeneratorFunction(n)?o:o.next().then(function(t){return t.done?t.value:o.next()})},f(k),k[_]="Generator",k.toString=function(){return"[object Generator]"},E.keys=function(t){var n=[];for(var r in t)n.push(r);return n.reverse(),function r(){for(;n.length;){var e=n.pop();if(e in t)return r.value=e,r.done=!1,r}return r.done=!0,r}},E.values=d,p.prototype={constructor:p,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=g,this.done=!1,this.delegate=null,this.method="next",this.arg=g,this.tryEntries.forEach(v),!t)for(var n in this)"t"===n.charAt(0)&&m.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=g)},stop:function(){this.done=!0;var t=this.tryEntries[0],n=t.completion;if("throw"===n.type)throw n.arg;return this.rval},dispatchException:function(t){function n(n,e){return o.type="throw",o.arg=t,r.next=n,e&&(r.method="next",r.arg=g),!!e}if(this.done)throw t;for(var r=this,e=this.tryEntries.length-1;e>=0;--e){var i=this.tryEntries[e],o=i.completion;if("root"===i.tryLoc)return n("end");if(i.tryLoc<=this.prev){var u=m.call(i,"catchLoc"),c=m.call(i,"finallyLoc");if(u&&c){if(this.prev<i.catchLoc)return n(i.catchLoc,!0);if(this.prev<i.finallyLoc)return n(i.finallyLoc)}else if(u){if(this.prev<i.catchLoc)return n(i.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return n(i.finallyLoc)}}}},abrupt:function(t,n){for(var r=this.tryEntries.length-1;r>=0;--r){var e=this.tryEntries[r];if(e.tryLoc<=this.prev&&m.call(e,"finallyLoc")&&this.prev<e.finallyLoc){var i=e;break}}i&&("break"===t||"continue"===t)&&i.tryLoc<=n&&n<=i.finallyLoc&&(i=null);var o=i?i.completion:{};return o.type=t,o.arg=n,i?(this.method="next",this.next=i.finallyLoc,A):this.complete(o)},complete:function(t,n){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&n&&(this.next=n),A},finish:function(t){for(var n=this.tryEntries.length-1;n>=0;--n){var r=this.tryEntries[n];if(r.finallyLoc===t)return this.complete(r.completion,r.afterLoc),v(r),A}},catch:function(t){for(var n=this.tryEntries.length-1;n>=0;--n){var r=this.tryEntries[n];if(r.tryLoc===t){var e=r.completion;if("throw"===e.type){var i=e.arg;v(r)}return i}}throw new Error("illegal catch attempt")},delegateYield:function(t,n,r){return this.delegate={iterator:d(t),resultName:n,nextLoc:r},"next"===this.method&&(this.arg=g),A}}}("object"==typeof n?n:"object"==typeof window?window:"object"==typeof self?self:this)}).call(n,function(){return this}(),r(158))}])</script><script src="/./main.0cf68a.js"></script><script>!function(){!function(e){var t=document.createElement("script");document.getElementsByTagName("body")[0].appendChild(t),t.setAttribute("src",e)}("/slider.e37972.js")}()</script>


    
<div class="tools-col" q-class="show:isShow,hide:isShow|isFalse" q-on="click:stop(e)">
  <div class="tools-nav header-menu">
    
    
      
      
      
    
    

    <ul style="width: 70%">
    
    
      
      <li style="width: 100%" q-on="click: openSlider(e, 'innerArchive')"><a href="javascript:void(0)" q-class="active:innerArchive">所有文章</a></li>
      
        
    </ul>
  </div>
  <div class="tools-wrap">
    
    	<section class="tools-section tools-section-all" q-show="innerArchive">
        <div class="search-wrap">
          <input class="search-ipt" q-model="search" type="text" placeholder="find something…">
          <i class="icon-search icon" q-show="search|isEmptyStr"></i>
          <i class="icon-close icon" q-show="search|isNotEmptyStr" q-on="click:clearChose(e)"></i>
        </div>
        <div class="widget tagcloud search-tag">
          <p class="search-tag-wording">tag:</p>
          <label class="search-switch">
            <input type="checkbox" q-on="click:toggleTag(e)" q-attr="checked:showTags">
          </label>
          <ul class="article-tag-list" q-show="showTags">
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color2">Java基础</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color1">Dubbo</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color1">MySQL</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color1">计算机基础</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">Mybatis</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color1">Redis</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">MQ</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">测试</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">Tool</a>
              </li>
            
            <div class="clearfix"></div>
          </ul>
        </div>
        <ul class="search-ul">
          <p q-show="jsonFail" style="padding: 20px; font-size: 12px;">
            缺失模块。<br/>1、请确保node版本大于6.2<br/>2、在博客根目录（注意不是yilia根目录）执行以下命令：<br/> npm i hexo-generator-json-content --save<br/><br/>
            3、在根目录_config.yml里添加配置：
<pre style="font-size: 12px;" q-show="jsonFail">
  jsonContent:
    meta: false
    pages: false
    posts:
      title: true
      date: true
      path: true
      text: false
      raw: false
      content: false
      slug: false
      updated: false
      comments: false
      link: false
      permalink: false
      excerpt: false
      categories: false
      tags: true
</pre>
          </p>
          <li class="search-li" q-repeat="items" q-show="isShow">
            <a q-attr="href:path|urlformat" class="search-title"><i class="icon-quo-left icon"></i><span q-text="title"></span></a>
            <p class="search-time">
              <i class="icon-calendar icon"></i>
              <span q-text="date|dateformat"></span>
            </p>
            <p class="search-tag">
              <i class="icon-price-tags icon"></i>
              <span q-repeat="tags" q-on="click:choseTag(e, name)" q-text="name|tagformat"></span>
            </p>
          </li>
        </ul>
    	</section>
    

    

    
  </div>
  
</div>
    <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>
  </div>
</body>
</html>